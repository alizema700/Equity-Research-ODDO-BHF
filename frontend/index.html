<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ODDO BHF Sales Intelligence</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Libre+Baskerville:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      /* ODDO BHF Official Color Scheme */
      --primary: #003D39;
      --secondary-red: #cf2014;
      --secondary-grey: #F7F4F2;
      --secondary-green: #55a184;
      --add-green-gray: #b9d3b9;
      --add-green-pine: #305f50;
      --add-mint: #2a7d5e;
      --add-yellow: #F0E689;
      --add-smoked-blue: #9db6c7;
      --add-cinnamon: #ae4e41;
      --soft-greige: #F7F2EE;
      --dark: #272529;
      --light: #ffffff;

      /* Mapped to existing variables */
      --bg: var(--secondary-grey);
      --bg-dark: var(--primary);
      --bg-darker: #182630;
      --card: var(--light);
      --border: #dee2e6;
      --text: var(--dark);
      --text-muted: #8e8e93;
      --accent: var(--primary);
      --accent-light: rgba(0, 61, 57, 0.08);
      --accent-dark: #002825;
      --accent-red: var(--secondary-red);
      --success: var(--secondary-green);
      --warning: #f59e0b;
      --danger: var(--secondary-red);
      --info: var(--add-smoked-blue);
      --hot: var(--secondary-red);
      --greige: var(--soft-greige);
      --radius: 8px;
      --radius-lg: 16px;
      --radius-pill: 99rem;
      --shadow: 0 1px 3px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 12px rgba(0, 61, 57, 0.08);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.1);
      --shadow-glow: 0 0 40px rgba(0, 61, 57, 0.15);

      /* Typography */
      --font-primary: 'Lato', Arial, Verdana, sans-serif;
      --font-serif: 'Libre Baskerville', Georgia, serif;

      /* Glassmorphism */
      --glass-bg: rgba(255, 255, 255, 0.85);
      --glass-border: rgba(255, 255, 255, 0.4);
      --glass-blur: blur(20px);

      /* Gradients */
      --gradient-primary: linear-gradient(135deg, #003D39 0%, #00524d 50%, #006b63 100%);
      --gradient-accent: linear-gradient(135deg, #cf2014 0%, #e63629 100%);
      --gradient-success: linear-gradient(135deg, #10b981 0%, #34d399 100%);
      --gradient-card: linear-gradient(180deg, rgba(255,255,255,1) 0%, rgba(247,244,242,0.5) 100%);
    }

    /* Keyframe Animations */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px rgba(0, 61, 57, 0.2); }
      50% { box-shadow: 0 0 20px rgba(0, 61, 57, 0.4); }
    }

    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    .animate-fade-in-up { animation: fadeInUp 0.4s ease-out; }
    .animate-slide-in { animation: slideInRight 0.3s ease-out; }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-primary);
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    h1, h2, h3 {
      font-family: var(--font-serif);
      font-weight: 700;
      color: var(--primary);
    }

    h4, h5, h6 {
      font-family: var(--font-primary);
      font-weight: 700;
    }

    .serif {
      font-family: var(--font-serif);
      font-weight: 400;
    }

    .lato-light {
      font-family: var(--font-primary);
      font-weight: 300;
    }

    /* === HEADER === */
    .header {
      background: white;
      color: var(--text);
      padding: 16px 32px;
      display: flex;
      align-items: center;
      gap: 24px;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 2px solid var(--primary);
      box-shadow: 0 2px 8px rgba(0, 61, 57, 0.08);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      font-size: 15px;
      letter-spacing: 0.3px;
      color: var(--text);
      flex-shrink: 0;
      margin-right: 32px;
    }

    .logo-img {
      height: 44px;
      width: auto;
    }

    .logo-text {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-muted);
      border-left: 1px solid var(--border);
      padding-left: 12px;
    }

    .search-box {
      flex: 1;
      max-width: 480px;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 12px 18px;
      padding-left: 44px;
      border: 1px solid var(--border);
      border-radius: var(--radius-pill);
      background: var(--soft-greige);
      color: var(--text);
      font-size: 14px;
      font-family: var(--font-primary);
      outline: none;
      transition: all 0.2s ease;
    }

    .search-input::placeholder {
      color: var(--text-muted);
    }

    .search-input:focus {
      background: white;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 61, 57, 0.1);
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 10px 24px;
      border-radius: var(--radius-pill);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
      letter-spacing: 0.3px;
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    .btn-ghost:hover {
      background: var(--greige);
      color: var(--text);
      border-color: var(--primary);
    }

    .btn-primary {
      background: var(--secondary-red);
      color: white;
    }

    .btn-primary:hover {
      background: #a31810;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(207, 32, 20, 0.3);
    }

    .btn-secondary {
      background: var(--primary);
      color: white;
      border: 1px solid var(--primary);
    }

    .btn-secondary:hover {
      background: var(--accent-dark);
      transform: translateY(-1px);
    }

    .status-chip {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      background: var(--greige);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    .status-chip.active {
      background: rgba(85, 161, 132, 0.15);
      color: var(--success);
      border-color: var(--success);
    }

    /* === LAYOUT === */
    .layout {
      display: grid;
      grid-template-columns: 380px 1fr;
      min-height: calc(100vh - 56px);
    }

    /* === SIDEBAR === */
    .sidebar {
      background: var(--card);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      padding: 20px;
    }

    .client-header {
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .client-name {
      font-size: 22px;
      font-weight: 700;
      font-family: var(--font-serif);
      color: var(--primary);
      margin-bottom: 6px;
    }

    .client-meta {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* === METRIC CARDS === */
    .metrics-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .metric-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
    }

    .metric-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .metric-value {
      font-size: 18px;
      font-weight: 700;
      font-family: var(--font-serif);
      color: var(--primary);
    }

    .metric-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
    }

    .badge-high { background: #fef2f2; color: #dc2626; }
    .badge-medium { background: #fffbeb; color: #d97706; }
    .badge-low { background: #f0fdf4; color: #16a34a; }
    .badge-info { background: #f0f9ff; color: #0284c7; }

    /* === EXECUTIVE SUMMARY === */
    .summary-section {
      margin-bottom: 20px;
    }

    .summary-title {
      font-size: 14px;
      font-weight: 700;
      font-family: var(--font-serif);
      text-transform: none;
      letter-spacing: 0;
      color: var(--primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .summary-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
    }

    .summary-card h4 {
      font-size: 15px;
      font-weight: 700;
      font-family: var(--font-serif);
      color: var(--primary);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .summary-text {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.6;
    }

    .summary-bullets {
      list-style: none;
      font-size: 13px;
    }

    .summary-bullets li {
      padding: 6px 0;
      border-bottom: 1px dashed var(--border);
      display: flex;
      justify-content: space-between;
    }

    .summary-bullets li:last-child { border-bottom: none; }

    .expand-btn {
      font-size: 12px;
      color: var(--accent);
      cursor: pointer;
      margin-top: 8px;
      display: inline-block;
    }

    .expand-btn:hover { text-decoration: underline; }

    /* === ACTION SIGNAL === */
    .action-signal {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      color: white;
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 20px;
    }

    .action-signal h4 {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.8;
      margin-bottom: 6px;
    }

    .action-signal p {
      font-size: 15px;
      font-weight: 600;
    }

    /* === LEAD SCORE BANNER === */
    .lead-banner {
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .lead-banner.hot {
      background: linear-gradient(135deg, #cf2014 0%, #a31810 100%);
      color: white;
    }

    .lead-banner.warm {
      background: linear-gradient(135deg, #55a184 0%, #305f50 100%);
      color: white;
    }

    .lead-banner.cold {
      background: var(--greige);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    .lead-score {
      display: flex;
      flex-direction: column;
    }

    .lead-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.8;
    }

    .lead-value {
      font-size: 26px;
      font-weight: 700;
      font-family: var(--font-serif);
    }

    .lead-reason {
      font-size: 11px;
      text-align: right;
      opacity: 0.9;
      max-width: 140px;
    }

    /* === BUY CHIPS === */
    .buy-chips, .interest-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .buy-chip {
      padding: 6px 12px;
      background: linear-gradient(135deg, #55a184 0%, #305f50 100%);
      color: white;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
    }

    .interest-chip {
      padding: 5px 10px;
      background: var(--accent-light);
      color: var(--accent);
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      border: 1px solid var(--border);
    }

    /* === ACTIVITY BAR === */
    .activity-bar {
      display: flex;
      gap: 8px;
    }

    .activity-item {
      flex: 1;
      background: var(--bg);
      border-radius: 8px;
      padding: 12px 8px;
      text-align: center;
      border: 1px solid var(--border);
    }

    .activity-num {
      display: block;
      font-size: 24px;
      font-weight: 700;
      font-family: var(--font-serif);
      color: var(--primary);
    }

    .activity-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* === BADGE VARIANTS === */
    .badge-hot {
      background: var(--hot) !important;
      color: white !important;
    }

    /* === MAIN CONTENT === */
    .main {
      padding: 24px;
      overflow-y: auto;
    }

    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
    }

    .main-title {
      font-size: 28px;
      font-weight: 700;
      font-family: var(--font-serif);
      color: var(--primary);
    }

    .main-subtitle {
      font-size: 14px;
      color: var(--text-muted);
      margin-top: 6px;
      font-family: var(--font-primary);
    }

    /* === TABS === */
    .tabs {
      display: flex;
      gap: 0;
      background: transparent;
      padding: 0;
      border-bottom: 2px solid var(--border);
      margin-bottom: 24px;
      width: fit-content;
    }

    .tab {
      padding: 12px 24px;
      border-radius: 0;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      background: transparent;
      color: var(--text-muted);
      transition: all 0.2s;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
    }

    .tab:hover { color: var(--primary); }
    .tab.active {
      background: transparent;
      color: var(--primary);
      border-bottom-color: var(--secondary-red);
    }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* === INSTRUCTION BOX === */
    .instruction-box {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 20px;
    }

    .instruction-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .instruction-input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 14px;
      font-family: var(--font-primary);
      resize: vertical;
      min-height: 80px;
      transition: all 0.2s ease;
    }

    .instruction-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 61, 57, 0.1);
    }

    .quick-prompts {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .quick-prompt {
      padding: 8px 16px;
      border-radius: var(--radius-pill);
      font-size: 12px;
      font-weight: 500;
      background: var(--soft-greige);
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .quick-prompt:hover {
      border-color: var(--primary);
      background: rgba(0, 61, 57, 0.08);
      color: var(--primary);
    }

    /* === STOCK GRID === */
    .stock-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
    }

    .stock-card {
      background: var(--gradient-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      animation: fadeInUp 0.4s ease-out backwards;
    }

    .stock-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gradient-primary);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .stock-card:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow-glow);
      transform: translateY(-4px);
    }

    .stock-card:hover::before {
      opacity: 1;
    }

    .stock-card.selected {
      border-color: var(--secondary-red);
      border-width: 2px;
      background: linear-gradient(180deg, rgba(207, 32, 20, 0.04) 0%, rgba(255,255,255,1) 100%);
    }

    .stock-card.selected::before {
      background: var(--gradient-accent);
      opacity: 1;
    }

    /* Staggered animation for cards */
    .stock-card:nth-child(1) { animation-delay: 0.05s; }
    .stock-card:nth-child(2) { animation-delay: 0.1s; }
    .stock-card:nth-child(3) { animation-delay: 0.15s; }
    .stock-card:nth-child(4) { animation-delay: 0.2s; }
    .stock-card:nth-child(5) { animation-delay: 0.25s; }
    .stock-card:nth-child(6) { animation-delay: 0.3s; }
    .stock-card:nth-child(7) { animation-delay: 0.35s; }
    .stock-card:nth-child(8) { animation-delay: 0.4s; }
    .stock-card:nth-child(9) { animation-delay: 0.45s; }

    .stock-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .stock-ticker {
      font-size: 20px;
      font-weight: 700;
      font-family: var(--font-serif);
      color: var(--primary);
    }

    .stock-name {
      font-size: 13px;
      color: var(--text-muted);
    }

    .stock-sector {
      font-size: 11px;
      padding: 4px 8px;
      background: var(--bg);
      border-radius: 4px;
      color: var(--text-muted);
    }

    .stock-metrics {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
      font-size: 12px;
    }

    .stock-metric {
      display: flex;
      flex-direction: column;
    }

    .stock-metric-label {
      color: var(--text-muted);
      font-size: 10px;
      text-transform: uppercase;
    }

    .stock-metric-value {
      font-weight: 700;
    }

    .stock-reasons {
      font-size: 12px;
      color: var(--text-muted);
    }

    .stock-reasons li {
      margin-bottom: 4px;
      padding-left: 12px;
      position: relative;
    }

    .stock-reasons li::before {
      content: "â€¢";
      position: absolute;
      left: 0;
      color: var(--accent);
    }

    /* === SIGNAL BADGES === */
    .signal-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .signal-badge.buy {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(52, 211, 153, 0.15) 100%);
      color: #059669;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .signal-badge.sell {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(248, 113, 113, 0.15) 100%);
      color: #dc2626;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .signal-badge.hold {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(251, 191, 36, 0.15) 100%);
      color: #d97706;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .signal-badge.top {
      background: var(--gradient-accent);
      color: white;
      border: none;
      animation: pulse 2s infinite;
    }

    .signal-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    /* === SPARKLINE MINI CHARTS === */
    .stock-sparkline {
      height: 40px;
      margin: 12px 0;
      position: relative;
      overflow: hidden;
      border-radius: 8px;
      background: linear-gradient(180deg, rgba(0, 61, 57, 0.02) 0%, transparent 100%);
    }

    .stock-sparkline canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* === LIVE INDICATOR === */
    .live-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      color: var(--success);
      font-weight: 600;
    }

    .live-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 1.5s infinite;
      box-shadow: 0 0 8px rgba(85, 161, 132, 0.6);
    }

    /* === MARKET PULSE SECTION === */
    .market-pulse {
      background: var(--gradient-primary);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 24px;
      color: white;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      position: relative;
      overflow: hidden;
    }

    .market-pulse::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 300px;
      height: 300px;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      pointer-events: none;
    }

    .pulse-item {
      text-align: center;
      position: relative;
      z-index: 1;
    }

    .pulse-label {
      font-size: 11px;
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .pulse-value {
      font-size: 28px;
      font-weight: 700;
      font-family: var(--font-serif);
    }

    .pulse-change {
      font-size: 12px;
      margin-top: 4px;
    }

    .pulse-change.positive { color: #34d399; }
    .pulse-change.negative { color: #fca5a5; }

    /* === ENHANCED BUTTONS === */
    .btn-glow {
      position: relative;
      overflow: hidden;
    }

    .btn-glow::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn-glow:hover::after {
      width: 300px;
      height: 300px;
    }

    /* === LOADING SKELETON === */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: var(--radius);
    }

    .skeleton-text {
      height: 14px;
      margin-bottom: 8px;
    }

    .skeleton-title {
      height: 24px;
      width: 60%;
      margin-bottom: 12px;
    }

    /* === TOAST NOTIFICATIONS === */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toast {
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 16px 20px;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideInRight 0.3s ease-out;
      min-width: 300px;
    }

    .toast.success { border-left: 4px solid var(--success); }
    .toast.error { border-left: 4px solid var(--danger); }
    .toast.info { border-left: 4px solid var(--primary); }

    .toast-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .toast.success .toast-icon { background: rgba(16, 185, 129, 0.15); color: var(--success); }
    .toast.error .toast-icon { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
    .toast.info .toast-icon { background: rgba(0, 61, 57, 0.15); color: var(--primary); }

    /* === OUTPUT PANEL === */
    .output-panel {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .output-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .output-title {
      font-size: 16px;
      font-weight: 700;
      font-family: var(--font-serif);
      color: var(--primary);
    }

    .output-body {
      padding: 20px;
      max-height: 500px;
      overflow-y: auto;
    }

    .output-text {
      font-size: 14px;
      line-height: 1.7;
      white-space: pre-wrap;
    }

    /* === SEARCH RESULTS MODAL === */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      z-index: 200;
    }

    .modal {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 600px;
      max-height: 70vh;
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      display: none;
      z-index: 201;
    }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-weight: 700;
      font-family: var(--font-serif);
      color: var(--primary);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--text-muted);
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
      max-height: calc(70vh - 60px);
    }

    .search-result {
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .search-result:hover {
      border-color: var(--accent);
      background: var(--accent-light);
    }

    .search-result-name {
      font-weight: 700;
      margin-bottom: 4px;
    }

    .search-result-meta {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* === EMPTY STATE === */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state h3 {
      font-size: 18px;
      margin-bottom: 8px;
      color: var(--text);
    }

    /* === LOADING === */
    .loading {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-muted);
      font-size: 14px;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* === RESPONSIVE === */
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
      .sidebar {
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
    }

    /* === DETAILS MODAL === */
    .details-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      display: none;
    }

    .details-section.open { display: block; }

    .details-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .detail-item {
      font-size: 13px;
    }

    .detail-label {
      color: var(--text-muted);
      font-size: 11px;
      margin-bottom: 2px;
    }

    .detail-value {
      font-weight: 600;
    }

    /* === HISTORY INDICATOR === */
    .history-badge {
      font-size: 10px;
      padding: 2px 6px;
      background: var(--info);
      color: white;
      border-radius: 4px;
      margin-left: 8px;
    }

    /* === DETAILS DRAWER === */
    .drawer-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 300;
      display: none;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .drawer-overlay.open { display: block; opacity: 1; }

    .drawer {
      position: fixed;
      top: 0;
      right: -600px;
      width: 600px;
      max-width: 90vw;
      height: 100vh;
      background: var(--card);
      box-shadow: -4px 0 20px rgba(0,0,0,0.15);
      z-index: 301;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    .drawer.open { right: 0; }

    .drawer-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .drawer-title {
      font-size: 20px;
      font-weight: 700;
      font-family: var(--font-serif);
      color: var(--primary);
    }

    .drawer-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-muted);
      padding: 4px 8px;
    }
    .drawer-close:hover { color: var(--text); }

    .drawer-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .drawer-section {
      margin-bottom: 24px;
    }

    .drawer-section-title {
      font-size: 15px;
      font-weight: 700;
      font-family: var(--font-serif);
      text-transform: none;
      letter-spacing: 0;
      color: var(--primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .drawer-section-title .count {
      background: var(--bg);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
    }

    /* === TABLE DESIGN FOR DETAILS === */
    .detail-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .detail-table th {
      text-align: left;
      padding: 10px 12px;
      background: var(--primary);
      color: white;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
    }

    .detail-table td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }

    .detail-table tr:hover {
      background: var(--accent-light);
    }

    .detail-table .ticker {
      font-weight: 700;
      color: var(--accent);
    }

    .detail-table .date {
      color: var(--text-muted);
      font-size: 11px;
      white-space: nowrap;
    }

    .detail-table .notes {
      max-width: 280px;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-muted);
      font-size: 11px;
      line-height: 1.4;
    }

    .detail-table .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      margin-right: 4px;
    }

    .detail-table .tag.buy { background: #e0f0ea; color: #305f50; }
    .detail-table .tag.sell { background: #fce8e6; color: #cf2014; }
    .detail-table .tag.neutral { background: var(--greige); color: var(--text-muted); }

    .drawer-tabs {
      display: flex;
      border-bottom: 2px solid var(--border);
      margin-bottom: 0;
      background: var(--bg);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .drawer-tab {
      padding: 12px 20px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      background: none;
      color: var(--text-muted);
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s ease;
    }

    .drawer-tab:hover { color: var(--primary); }
    .drawer-tab.active {
      color: var(--primary);
      border-bottom-color: var(--secondary-red);
    }

    .drawer-tab .badge {
      background: var(--bg);
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 10px;
      margin-left: 6px;
    }

    .drawer-panel { display: none; }
    .drawer-panel.active { display: block; }

    .details-btn {
      width: 100%;
      margin-top: 20px;
      padding: 12px 16px;
      background: var(--soft-greige);
      border: 1px solid var(--border);
      border-radius: var(--radius-pill);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: var(--primary);
      transition: all 0.2s ease;
    }
    .details-btn:hover {
      border-color: var(--primary);
      color: white;
      background: var(--primary);
    }

    /* === CLIENT GOALS === */
    .goals-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .goal-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px;
      background: var(--greige);
      border-radius: 8px;
    }
    .goal-icon {
      font-size: 20px;
      line-height: 1;
    }
    .goal-text {
      flex: 1;
    }
    .goal-name {
      font-weight: 700;
      font-size: 14px;
      font-family: var(--font-serif);
      color: var(--primary);
    }
    .goal-desc {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* === BEST CONTACT TIME === */
    .contact-time-box {
      padding: 12px;
      background: linear-gradient(135deg, var(--accent-light), #e0f2f1);
      border-radius: 8px;
      border: 1px solid var(--accent);
    }
    .contact-time-main {
      display: flex;
      align-items: baseline;
      gap: 12px;
      margin-bottom: 8px;
    }
    .contact-day {
      font-size: 22px;
      font-weight: 700;
      font-family: var(--font-serif);
      color: var(--primary);
    }
    .contact-hours {
      font-size: 14px;
      color: var(--text);
      font-weight: 500;
    }
    .contact-confidence {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 4px;
      display: inline-block;
    }
    .confidence-high { background: #dcfce7; color: #16a34a; }
    .confidence-medium { background: #fef9c3; color: #ca8a04; }
    .confidence-low { background: #f3f4f6; color: #6b7280; }

    /* === ANALYST OVERRIDE === */
    .analyst-override-box {
      background: linear-gradient(135deg, #fefce8, #fef3c7);
      border: 1px solid #fbbf24;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .override-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .override-icon {
      font-size: 20px;
    }
    .override-title {
      font-weight: 700;
      font-size: 16px;
      font-family: var(--font-serif);
      color: #92400e;
    }
    .override-subtitle {
      font-size: 12px;
      color: #a16207;
    }
    .override-search {
      position: relative;
    }
    .stock-search-input {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #fbbf24;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      outline: none;
    }
    .stock-search-input:focus {
      border-color: #f59e0b;
      box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.2);
    }
    .stock-search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 100;
      box-shadow: var(--shadow-lg);
      margin-top: 4px;
    }
    .stock-search-item {
      padding: 10px 14px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: background 0.1s;
    }
    .stock-search-item:last-child { border-bottom: none; }
    .stock-search-item:hover {
      background: var(--accent-light);
    }
    .stock-search-ticker {
      font-weight: 700;
      font-size: 14px;
      color: var(--accent);
    }
    .stock-search-name {
      font-size: 13px;
      color: var(--text);
    }
    .stock-search-meta {
      font-size: 11px;
      color: var(--text-muted);
    }
    .empty-search {
      padding: 20px;
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
    }

    /* === STOCK DETAIL MODAL === */
    .stock-detail-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 400;
      display: none;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .stock-detail-overlay.open { display: block; opacity: 1; }

    .stock-detail-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 700px;
      max-height: 85vh;
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25);
      z-index: 401;
      display: none;
      overflow: hidden;
    }
    .stock-detail-modal.open { display: block; }

    .stock-detail-header {
      padding: 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent-dark) 100%);
      color: white;
    }

    .stock-detail-ticker {
      font-size: 32px;
      font-weight: 700;
      font-family: var(--font-serif);
    }

    .stock-detail-name {
      font-size: 14px;
      opacity: 0.85;
      margin-top: 4px;
    }

    .stock-detail-price-container {
      text-align: right;
    }

    .stock-detail-price {
      font-size: 36px;
      font-weight: 700;
      font-family: var(--font-serif);
    }

    .stock-detail-change {
      font-size: 16px;
      font-weight: 600;
      margin-top: 4px;
    }
    .stock-detail-change.positive { color: #4ade80; }
    .stock-detail-change.negative { color: #f87171; }

    .stock-detail-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(255,255,255,0.2);
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      color: white;
      transition: background 0.2s;
    }
    .stock-detail-close:hover { background: rgba(255,255,255,0.3); }

    .stock-detail-body {
      padding: 24px;
      overflow-y: auto;
      max-height: calc(85vh - 160px);
    }

    .stock-detail-metrics {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .stock-metric-box {
      background: var(--bg);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      border: 1px solid var(--border);
    }

    .stock-metric-box .label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .stock-metric-box .value {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
    }

    .stock-detail-section {
      margin-bottom: 24px;
    }

    .stock-detail-section-title {
      font-size: 15px;
      font-weight: 700;
      font-family: var(--font-serif);
      color: var(--primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stock-price-range {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg);
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .price-range-bar {
      flex: 1;
      height: 8px;
      background: linear-gradient(90deg, #f87171 0%, #fbbf24 50%, #4ade80 100%);
      border-radius: 4px;
      position: relative;
    }

    .price-range-marker {
      position: absolute;
      top: -4px;
      width: 16px;
      height: 16px;
      background: var(--primary);
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transform: translateX(-50%);
    }

    .price-range-label {
      font-size: 12px;
      color: var(--text-muted);
      min-width: 50px;
    }
    .price-range-label.high { text-align: right; }

    .news-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .news-item {
      padding: 14px;
      background: var(--bg);
      border-radius: 10px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
    }
    .news-item:hover {
      border-color: var(--primary);
      transform: translateX(4px);
    }

    .news-headline {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
      line-height: 1.4;
    }

    .news-meta {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .news-sentiment {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
    }
    .news-sentiment.positive { background: #dcfce7; color: #16a34a; }
    .news-sentiment.negative { background: #fef2f2; color: #dc2626; }
    .news-sentiment.neutral { background: var(--greige); color: var(--text-muted); }

    .stock-detail-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .stock-detail-error {
      padding: 20px;
      text-align: center;
      color: var(--text-muted);
      background: var(--bg);
      border-radius: 8px;
    }

    .stock-chart-container {
      background: var(--bg);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }

    .stock-chart-container canvas {
      max-height: 200px;
    }

    .chart-period-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .chart-period-btn {
      padding: 6px 12px;
      border: 1px solid var(--border);
      background: white;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .chart-period-btn:hover {
      border-color: var(--primary);
    }

    .chart-period-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    @media (max-width: 600px) {
      .stock-detail-metrics {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div class="logo">
      <img src="/static/Oddo_BHF_logo.svg.png" alt="ODDO BHF" class="logo-img">
    </div>

    <div class="search-box">
      <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input
        type="text"
        class="search-input"
        id="searchInput"
        placeholder="Search client (name, firm, contact)..."
      />
    </div>

    <div class="header-actions">
      <button class="btn btn-ghost" id="settingsBtn">API</button>
      <button class="btn btn-ghost" id="healthBtn">Health</button>
      <span class="status-chip" id="statusChip">No Client</span>
    </div>
  </header>

  <!-- SEARCH MODAL -->
  <div class="modal-overlay" id="modalOverlay"></div>
  <div class="modal" id="searchModal">
    <div class="modal-header">
      <span class="modal-title">Search Results</span>
      <button class="modal-close" id="closeModal">&times;</button>
    </div>
    <div class="modal-body" id="searchResults"></div>
  </div>

  <!-- DETAILS DRAWER -->
  <div class="drawer-overlay" id="drawerOverlay"></div>
  <div class="drawer" id="detailsDrawer">
    <div class="drawer-header">
      <span class="drawer-title">Client Details</span>
      <button class="drawer-close" id="closeDrawer">&times;</button>
    </div>
    <div class="drawer-body" id="drawerBody">
      <!-- Content will be rendered by JS -->
    </div>
  </div>

  <!-- STOCK DETAIL MODAL -->
  <div class="stock-detail-overlay" id="stockDetailOverlay"></div>
  <div class="stock-detail-modal" id="stockDetailModal">
    <button class="stock-detail-close" id="closeStockDetail">&times;</button>
    <div class="stock-detail-header" id="stockDetailHeader">
      <div>
        <div class="stock-detail-ticker" id="detailTicker">-</div>
        <div class="stock-detail-name" id="detailCompanyName">Loading...</div>
      </div>
      <div class="stock-detail-price-container">
        <div class="stock-detail-price" id="detailPrice">-</div>
        <div class="stock-detail-change" id="detailChange">-</div>
      </div>
    </div>
    <div class="stock-detail-body" id="stockDetailBody">
      <div class="stock-detail-loading">
        <div class="spinner"></div>
        <span style="margin-left: 12px;">Loading market data...</span>
      </div>
    </div>
  </div>

  <!-- MAIN LAYOUT -->
  <div class="layout">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div id="sidebarContent">
        <div class="empty-state">
          <h3>No Client Loaded</h3>
          <p>Search for a client to get started.</p>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="main-header">
        <div>
          <h1 class="main-title" id="mainTitle">Workspace</h1>
          <p class="main-subtitle" id="mainSubtitle">Select a client to generate shortlists and stories.</p>
        </div>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-primary" id="generateBtn" disabled>Generate Shortlist</button>
          <button class="btn btn-secondary" id="pdfBtn" disabled>PDF</button>
        </div>
      </div>

      <!-- TABS -->
      <div class="tabs">
        <button class="tab active" data-tab="shortlist">Shortlist</button>
        <button class="tab" data-tab="story">Story</button>
        <button class="tab" data-tab="history">History</button>
      </div>

      <!-- TAB: SHORTLIST -->
      <div class="tab-panel active" id="panel-shortlist">
        <div class="instruction-box">
          <div class="instruction-label">Instructions (optional)</div>
          <textarea
            class="instruction-input"
            id="instruction"
            placeholder="e.g. 'Focus on defensive stocks' or 'Address concerns from last call'..."
          ></textarea>
          <div class="quick-prompts">
            <span class="quick-prompt" data-prompt="Diversify away from top sector">Diversify</span>
            <span class="quick-prompt" data-prompt="Use call notes intensively, address concerns">Use Call Notes</span>
            <span class="quick-prompt" data-prompt="Conservative, prefer low volatility">Conservative</span>
            <span class="quick-prompt" data-prompt="Focus on high conviction stocks">High Conviction</span>
          </div>
        </div>

        <div class="stock-grid" id="stockGrid">
          <div class="empty-state">
            <h3>No Shortlist</h3>
            <p>Click "Generate Shortlist" to get recommendations.</p>
          </div>
        </div>
      </div>

      <!-- TAB: STORY -->
      <div class="tab-panel" id="panel-story">
        <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
          <button class="btn btn-primary" id="storyFullBtn" disabled>Story (Full)</button>
          <button class="btn btn-secondary" id="storyBulletsBtn" disabled>Bullets (Summary)</button>
          <span id="selectedStock" style="margin-left: auto; color: var(--text-muted); font-size: 14px;">
            No Stock Selected
          </span>
        </div>

        <!-- ANALYST STOCK OVERRIDE -->
        <div class="analyst-override-box">
          <div class="override-header">
            <span class="override-icon"></span>
            <span class="override-title">Analyst Override</span>
            <span class="override-subtitle">Select your own stock instead of AI recommendations</span>
          </div>
          <div class="override-search">
            <input
              type="text"
              id="stockSearchInput"
              class="stock-search-input"
              placeholder="Search stock by ticker, name, or sector..."
            />
            <div id="stockSearchResults" class="stock-search-results" style="display: none;"></div>
          </div>
        </div>

        <div class="output-panel" id="outputPanel" style="display: none;">
          <div class="output-header">
            <span class="output-title" id="outputTitle">Output</span>
            <button class="btn btn-secondary" id="copyBtn">Copy</button>
          </div>
          <div class="output-body">
            <div class="output-text" id="outputText"></div>
          </div>
        </div>

        <div class="empty-state" id="storyEmpty">
          <h3>Select a Stock</h3>
          <p>Click on a stock in the shortlist or use Analyst Override above to select your own.</p>
        </div>
      </div>

      <!-- TAB: HISTORY -->
      <div class="tab-panel" id="panel-history">
        <div class="empty-state" id="historyEmpty">
          <h3>No History</h3>
          <p>Generated stories are stored here for compliance.</p>
        </div>
        <div id="historyList"></div>
      </div>
    </main>
  </div>

<script>
// ============================================================================
// STATE
// ============================================================================
let clientId = null;
let clientData = null;
let shortlist = [];
let selectedTicker = null;
let selectedStock = null;
let history = [];

// ============================================================================
// API HELPERS
// ============================================================================
function getApiBase() {
  return localStorage.getItem('api_base') || '';
}

function apiUrl(path) {
  const base = getApiBase();
  return base ? base.replace(/\/+$/, '') + path : path;
}

function authHeaders() {
  const key = localStorage.getItem('api_key') || '';
  return key ? { 'x-api-key': key } : {};
}

// ============================================================================
// UI HELPERS
// ============================================================================
function $(id) { return document.getElementById(id); }
function $$(sel) { return document.querySelectorAll(sel); }

function setStatus(text, type = 'default') {
  const chip = $('statusChip');
  chip.textContent = text;
  chip.className = 'status-chip' + (type === 'active' ? ' active' : '');
}

function showModal() {
  $('modalOverlay').style.display = 'block';
  $('searchModal').style.display = 'block';
}

function hideModal() {
  $('modalOverlay').style.display = 'none';
  $('searchModal').style.display = 'none';
}

// ============================================================================
// DETAILS DRAWER
// ============================================================================
function openDetailsDrawer() {
  if (!clientData) return;
  renderDrawerContent(clientData);
  $('drawerOverlay').classList.add('open');
  $('detailsDrawer').classList.add('open');
}

function closeDetailsDrawer() {
  $('drawerOverlay').classList.remove('open');
  $('detailsDrawer').classList.remove('open');
}

function renderDrawerContent(data) {
  const signals = data.signals || {};
  const holdings = data.holdings || {};

  const calls = signals.recent_calls || [];
  const trades = signals.recent_trades || [];
  const reads = signals.recent_reads_daysdiff || [];
  const positions = holdings.top_positions || [];
  const hints = signals.call_position_hints || [];

  // Tabs + Table Layout
  let html = `
    <div class="drawer-tabs">
      <button class="drawer-tab active" data-panel="calls">Calls <span class="badge">${calls.length}</span></button>
      <button class="drawer-tab" data-panel="trades">Trades <span class="badge">${trades.length}</span></button>
      <button class="drawer-tab" data-panel="reads">Reads <span class="badge">${reads.length}</span></button>
      <button class="drawer-tab" data-panel="positions">Positionen <span class="badge">${positions.length}</span></button>
      <button class="drawer-tab" data-panel="hints">Hints <span class="badge">${hints.length}</span></button>
    </div>
  `;

  // CALLS TABLE
  html += `
    <div class="drawer-panel active" id="drawer-calls">
      <table class="detail-table">
        <thead>
          <tr><th>Date</th><th>Ticker</th><th>Direction</th><th>Duration</th><th>Sector</th><th>Notes</th></tr>
        </thead>
        <tbody>
          ${calls.length === 0 ? '<tr><td colspan="6" style="text-align:center; color: var(--text-muted);">No Calls</td></tr>' : ''}
          ${calls.map(c => `
            <tr>
              <td class="date">${c.call_timestamp ? new Date(c.call_timestamp).toLocaleDateString('en-US') : '-'}</td>
              <td class="ticker">${c.stock_ticker || c.discussed_company || '-'}</td>
              <td><span class="tag neutral">${c.direction || '-'}</span></td>
              <td>${c.duration_minutes ? c.duration_minutes + ' min' : '-'}</td>
              <td>${c.discussed_sector || '-'}</td>
              <td class="notes">${c.notes_raw ? c.notes_raw.substring(0, 120) + '...' : '-'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;

  // TRADES TABLE
  html += `
    <div class="drawer-panel" id="drawer-trades">
      <table class="detail-table">
        <thead>
          <tr><th>Date</th><th>Ticker</th><th>Side</th><th>Size</th><th>Sector</th><th>Theme</th></tr>
        </thead>
        <tbody>
          ${trades.length === 0 ? '<tr><td colspan="6" style="text-align:center; color: var(--text-muted);">No Trades</td></tr>' : ''}
          ${trades.map(t => `
            <tr>
              <td class="date">${t.trade_timestamp ? new Date(t.trade_timestamp).toLocaleDateString('en-US') : '-'}</td>
              <td class="ticker">${t.ticker || '-'}</td>
              <td><span class="tag ${t.side?.toLowerCase() === 'buy' ? 'buy' : 'sell'}">${t.side || '-'}</span></td>
              <td>${t.notional_bucket || '-'}</td>
              <td>${t.sector || '-'}</td>
              <td>${t.theme_tag || '-'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;

  // READS TABLE
  html += `
    <div class="drawer-panel" id="drawer-reads">
      <table class="detail-table">
        <thead>
          <tr><th>Read</th><th>Ticker</th><th>Type</th><th>Sector</th><th>Delay</th><th>Title</th></tr>
        </thead>
        <tbody>
          ${reads.length === 0 ? '<tr><td colspan="6" style="text-align:center; color: var(--text-muted);">No Reads</td></tr>' : ''}
          ${reads.map(r => `
            <tr>
              <td class="date">${r.read_timestamp ? new Date(r.read_timestamp).toLocaleDateString('en-US') : '-'}</td>
              <td class="ticker">${r.report_ticker || '-'}</td>
              <td><span class="tag neutral">${r.report_type || '-'}</span></td>
              <td>${r.report_sector || '-'}</td>
              <td>${r.days_diff !== null ? r.days_diff + 'd' : '-'}</td>
              <td class="notes">${r.report_title || '-'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;

  // POSITIONS TABLE
  html += `
    <div class="drawer-panel" id="drawer-positions">
      <table class="detail-table">
        <thead>
          <tr><th>Ticker</th><th>Name</th><th>Sector</th><th>Weight</th><th>Value</th><th>Theme</th></tr>
        </thead>
        <tbody>
          ${positions.length === 0 ? '<tr><td colspan="6" style="text-align:center; color: var(--text-muted);">No Positions</td></tr>' : ''}
          ${positions.map(p => `
            <tr>
              <td class="ticker">${p.ticker || '-'}</td>
              <td>${p.company_name || '-'}</td>
              <td>${p.sector || '-'}</td>
              <td>${p.weight ? (p.weight * 100).toFixed(1) + '%' : '-'}</td>
              <td>${p.market_value ? Number(p.market_value).toLocaleString('de-DE') + ' ' + (p.currency || '') : '-'}</td>
              <td>${p.theme_tag || '-'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;

  // HINTS TABLE
  html += `
    <div class="drawer-panel" id="drawer-hints">
      <table class="detail-table">
        <thead>
          <tr><th>Ticker</th><th>Mentions</th><th>Hold</th><th>Add</th><th>Reduce</th><th>Diversify</th></tr>
        </thead>
        <tbody>
          ${hints.length === 0 ? '<tr><td colspan="6" style="text-align:center; color: var(--text-muted);">No Hints</td></tr>' : ''}
          ${hints.map(h => `
            <tr>
              <td class="ticker">${h.ticker || '-'}</td>
              <td>${h.mention_count || 0}</td>
              <td>${h.holding_hints || '-'}</td>
              <td>${h.add_hints ? `<span class="tag buy">${h.add_hints}</span>` : '-'}</td>
              <td>${h.reduce_hints ? `<span class="tag sell">${h.reduce_hints}</span>` : '-'}</td>
              <td>${h.diversification_hints || '-'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;

  $('drawerBody').innerHTML = html;

  // Add tab switching
  $$('.drawer-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      $$('.drawer-tab').forEach(t => t.classList.remove('active'));
      $$('.drawer-panel').forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      $('drawer-' + tab.dataset.panel).classList.add('active');
    });
  });
}

function switchTab(tabName) {
  $$('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
  $$('.tab-panel').forEach(p => p.classList.toggle('active', p.id === 'panel-' + tabName));
}

function getRiskBadgeClass(level) {
  if (!level) return 'badge-info';
  const l = level.toLowerCase();
  if (l.includes('high') || l.includes('aggressive')) return 'badge-high';
  if (l.includes('medium') || l.includes('moderate')) return 'badge-medium';
  return 'badge-low';
}

// ============================================================================
// SIDEBAR RENDERING
// ============================================================================
function renderSidebar(data) {
  const client = data.client || {};
  const profile = data.profile || {};
  const enhanced = data.enhanced || {};
  const signals = data.signals || {};
  const risk = enhanced.risk_assessment || {};
  const momentum = enhanced.engagement_momentum || {};
  const conviction = enhanced.conviction || {};
  const readership = enhanced.readership_intelligence || {};
  const portfolio = enhanced.portfolio_risk || {};

  // Calculate Sales-relevant metrics
  const calls30d = momentum.calls_last_30d || 0;
  const trades30d = momentum.trades_last_30d || 0;
  const buyRatio = momentum.recent_buy_ratio || 0;
  const engagementTrend = momentum.engagement_trend || 'Unknown';
  const convictionStock = conviction.top_conviction_stock || '-';

  // Lead Score: Hot (active buyer), Warm (engaged), Cold (dormant)
  let leadScore = 'Cold';
  let leadClass = 'badge-low';
  if (calls30d >= 3 && buyRatio > 0.6) {
    leadScore = 'Hot';
    leadClass = 'badge-hot';
  } else if (calls30d >= 1 || trades30d >= 2) {
    leadScore = 'Warm';
    leadClass = 'badge-medium';
  }

  // Last Contact (from recent calls)
  const recentCalls = signals.recent_calls || [];
  const lastCallDate = recentCalls.length > 0 && recentCalls[0].call_timestamp
    ? new Date(recentCalls[0].call_timestamp).toLocaleDateString('en-US')
    : 'No Contact';

  // Recent Buys (from trades)
  const recentTrades = signals.recent_trades || [];
  const recentBuys = recentTrades.filter(t => t.side?.toLowerCase() === 'buy').slice(0, 3);

  // Top Read Sectors
  const recentReads = signals.recent_reads_daysdiff || [];
  const readSectors = [...new Set(recentReads.map(r => r.report_sector).filter(Boolean))].slice(0, 3);

  $('sidebarContent').innerHTML = `
    <div class="client-header">
      <div class="client-name">${client.primary_contact_name || client.client_name || 'Unknown'}</div>
      <div class="client-meta">${[client.firm_name, client.client_type, client.region].filter(Boolean).join(' Â· ')}</div>
    </div>

    <!-- LEAD SCORE BANNER -->
    <div class="lead-banner ${leadScore.toLowerCase()}">
      <div class="lead-score">
        <span class="lead-label">Lead Score</span>
        <span class="lead-value">${leadScore}</span>
      </div>
      <div class="lead-reason">
        ${leadScore === 'Hot' ? 'Active buyer, high engagement' :
          leadScore === 'Warm' ? 'Regular contact' :
          'Low activity'}
      </div>
    </div>

    <!-- KEY SALES METRICS -->
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-label">Last Contact</div>
        <div class="metric-value" style="font-size: 13px;">${lastCallDate}</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Engagement</div>
        <div class="metric-value">
          <span class="metric-badge ${engagementTrend === 'Accelerating' ? 'badge-high' : engagementTrend === 'Cooling Off' ? 'badge-medium' : 'badge-low'}">${engagementTrend}</span>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Buy Signal</div>
        <div class="metric-value">
          <span class="metric-badge ${buyRatio > 0.6 ? 'badge-high' : buyRatio > 0.3 ? 'badge-medium' : 'badge-low'}">${buyRatio > 0.6 ? 'Bullish' : buyRatio > 0.3 ? 'Neutral' : 'Bearish'}</span>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Top Conviction</div>
        <div class="metric-value" style="font-size: 13px; color: var(--accent);">${convictionStock}</div>
      </div>
    </div>

    <!-- RECENT BUYS -->
    ${recentBuys.length > 0 ? `
    <div class="summary-section">
      <div class="summary-title">Recent Buys</div>
      <div class="buy-chips">
        ${recentBuys.map(b => `
          <span class="buy-chip">${b.ticker || '-'}</span>
        `).join('')}
      </div>
    </div>
    ` : ''}

    <!-- READ INTERESTS -->
    ${readSectors.length > 0 ? `
    <div class="summary-section">
      <div class="summary-title">Reading About</div>
      <div class="interest-chips">
        ${readSectors.map(s => `<span class="interest-chip">${s}</span>`).join('')}
      </div>
    </div>
    ` : ''}

    <div class="summary-section">
      <div class="summary-title">Profile</div>
      <div class="summary-card">
        <ul class="summary-bullets">
          <li><span>Investment Style</span><span>${profile.investment_style || '-'}</span></li>
          <li><span>Risk Appetite</span><span>${profile.risk_appetite || '-'}</span></li>
          <li><span>Focus</span><span>${profile.dominant_topic || '-'}</span></li>
        </ul>
      </div>
    </div>

    <div class="summary-section">
      <div class="summary-title">Activity (30d)</div>
      <div class="activity-bar">
        <div class="activity-item">
          <span class="activity-num">${calls30d}</span>
          <span class="activity-label">Calls</span>
        </div>
        <div class="activity-item">
          <span class="activity-num">${trades30d}</span>
          <span class="activity-label">Trades</span>
        </div>
        <div class="activity-item">
          <span class="activity-num">${recentReads.length}</span>
          <span class="activity-label">Reads</span>
        </div>
      </div>
    </div>

      <div class="summary-card">
        <h4>Portfolio</h4>
        <ul class="summary-bullets">
          <li><span>Top Sector</span><span>${data.portfolio_summary?.top_sector || '-'}</span></li>
          <li><span>Concentration</span><span>${portfolio.concentration_risk_level || '-'}</span></li>
          <li><span>Large Positions</span><span>${portfolio.large_positions || 0}</span></li>
        </ul>
      </div>

      ${conviction.top_conviction_stock ? `
      <div class="summary-card">
        <h4>Conviction: ${conviction.top_conviction_stock}</h4>
        <ul class="summary-bullets">
          <li><span>Trade Count</span><span>${conviction.trade_count || 0}</span></li>
          <li><span>Call Mentions</span><span>${conviction.call_mentions || 0}</span></li>
          <li><span>Sentiment</span><span>${conviction.sentiment_signal || '-'}</span></li>
        </ul>
      </div>
      ` : ''}
    </div>

    <div class="summary-section">
      <div class="summary-title">Avoid Tickers</div>
      <div style="display: flex; flex-wrap: wrap; gap: 6px;">
        ${(data.constraints?.avoid_tickers || []).slice(0, 10).map(t => `
          <span style="padding: 4px 8px; background: #fef2f2; color: #dc2626; border-radius: 4px; font-size: 12px; font-weight: 600;">${t}</span>
        `).join('') || '<span style="color: var(--text-muted); font-size: 13px;">None</span>'}
      </div>
    </div>

    <!-- CLIENT GOALS (loaded async) -->
    <div class="summary-section" id="clientGoalsSection" style="display: none;">
      <div class="summary-title">Investment Goals</div>
      <div id="clientGoals" class="goals-container"></div>
    </div>

    <!-- BEST CONTACT TIME (loaded async) -->
    <div class="summary-section" id="contactTimeSection" style="display: none;">
      <div class="summary-title">Best Contact Time</div>
      <div id="contactTimeInfo" class="contact-time-box"></div>
    </div>

    <button class="details-btn" onclick="openDetailsDrawer()">
      Show All Details (Calls, Trades, Reads, Positions...)
    </button>
  `;

  // Load async data for client goals and best contact time
  loadClientGoals(data.client?.client_id || clientId);
  loadBestContactTime(data.client?.client_id || clientId);
}

// ============================================================================
// CLIENT GOALS & BEST CONTACT TIME
// ============================================================================
async function loadClientGoals(cid) {
  if (!cid) return;
  try {
    const res = await fetch(apiUrl(`/api/client/${cid}/preferences`), { headers: authHeaders() });
    const data = await res.json();
    if (data.error || !data.goals || data.goals.length === 0) return;

    const goalsHtml = data.goals.map(g => `
      <div class="goal-item">
        <span class="goal-icon">${g.icon || ''}</span>
        <div class="goal-text">
          <div class="goal-name">${g.goal}</div>
          <div class="goal-desc">${g.description || ''}</div>
        </div>
      </div>
    `).join('');

    $('clientGoals').innerHTML = goalsHtml;
    $('clientGoalsSection').style.display = 'block';
  } catch (e) {
    console.error('Error loading client goals:', e);
  }
}

async function loadBestContactTime(cid) {
  if (!cid) return;
  try {
    const res = await fetch(apiUrl(`/api/client/${cid}/best_contact_time`), { headers: authHeaders() });
    const data = await res.json();
    if (data.error) return;

    const confidenceClass = data.confidence === 'High' ? 'confidence-high' :
                           data.confidence === 'Medium' ? 'confidence-medium' : 'confidence-low';

    $('contactTimeInfo').innerHTML = `
      <div class="contact-time-main">
        <div class="contact-day">${data.best_day || 'Tuesday'}</div>
        <div class="contact-hours">${data.best_time_range || '09:00 - 11:00'}</div>
      </div>
      <div class="contact-confidence ${confidenceClass}">
        Confidence: ${data.confidence || 'Low'}
      </div>
    `;
    $('contactTimeSection').style.display = 'block';
  } catch (e) {
    console.error('Error loading contact time:', e);
  }
}

// ============================================================================
// ANALYST STOCK OVERRIDE - Manual Selection
// ============================================================================
let manualStockSelected = null;

async function searchAvailableStocks(query) {
  try {
    const res = await fetch(apiUrl(`/api/stocks/available?search=${encodeURIComponent(query)}&limit=50`), {
      headers: authHeaders()
    });
    const data = await res.json();
    return data.stocks || [];
  } catch (e) {
    console.error('Error searching stocks:', e);
    return [];
  }
}

function renderStockSearchResults(stocks) {
  if (stocks.length === 0) {
    $('stockSearchResults').innerHTML = '<div class="empty-search">No stocks found</div>';
    return;
  }

  $('stockSearchResults').innerHTML = stocks.map(s => `
    <div class="stock-search-item" data-stock='${JSON.stringify(s)}'>
      <div class="stock-search-ticker">${s.ticker}</div>
      <div class="stock-search-name">${s.company_name}</div>
      <div class="stock-search-meta">${[s.sector, s.region].filter(Boolean).join(' Â· ')}</div>
    </div>
  `).join('');

  $$('.stock-search-item').forEach(el => {
    el.addEventListener('click', () => {
      const stock = JSON.parse(el.dataset.stock);
      selectManualStock(stock);
    });
  });
}

function selectManualStock(stock) {
  manualStockSelected = stock;
  selectedStock = stock;
  selectedTicker = stock.ticker;

  // Update UI
  $('selectedStock').innerHTML = `<strong>${stock.ticker}</strong> - ${stock.company_name}`;
  $('storyFullBtn').disabled = false;
  $('storyBulletsBtn').disabled = false;

  // Clear search
  $('stockSearchInput').value = '';
  $('stockSearchResults').innerHTML = '';
  $('stockSearchResults').style.display = 'none';

  // Show notification
  setStatus(`Selected: ${stock.ticker}`, 'active');

  // Open stock detail modal with live market data
  openStockDetailModal(stock);
}

// ============================================================================
// SEARCH
// ============================================================================
async function search(query) {
  if (!query || query.length < 2) return;

  setStatus('Suche...', 'default');

  try {
    const res = await fetch(apiUrl(`/api/search?q=${encodeURIComponent(query)}&limit=50`), {
      headers: authHeaders()
    });
    const data = await res.json();
    const results = data.results || [];

    if (results.length === 0) {
      $('searchResults').innerHTML = '<div class="empty-state"><p>No results found.</p></div>';
    } else {
      $('searchResults').innerHTML = results.map(r => `
        <div class="search-result" data-id="${r.client_id}">
          <div class="search-result-name">${r.primary_contact_name || r.client_name}</div>
          <div class="search-result-meta">
            ${[r.firm_name, r.client_type, r.region].filter(Boolean).join(' Â· ')}
          </div>
        </div>
      `).join('');

      $$('.search-result').forEach(el => {
        el.addEventListener('click', () => loadClient(parseInt(el.dataset.id)));
      });
    }

    showModal();
    setStatus('Select Client', 'default');
  } catch (e) {
    setStatus('Error', 'default');
    console.error(e);
  }
}

// ============================================================================
// LOAD CLIENT
// ============================================================================
async function loadClient(id) {
  hideModal();
  setStatus('Lade...', 'default');

  try {
    const res = await fetch(apiUrl(`/api/client/${id}`), { headers: authHeaders() });
    const data = await res.json();

    if (data.error) {
      alert(data.error);
      setStatus('Error', 'default');
      return;
    }

    clientId = id;
    clientData = data;
    shortlist = [];
    selectedTicker = null;
    selectedStock = null;

    renderSidebar(data);

    const client = data.client || {};
    $('mainTitle').textContent = client.firm_name || 'Workspace';
    $('mainSubtitle').textContent = `Client: ${client.primary_contact_name || client.client_name}`;

    $('generateBtn').disabled = false;
    $('stockGrid').innerHTML = '<div class="empty-state"><h3>Ready</h3><p>Click "Generate Shortlist".</p></div>';

    // Load generation history for this client
    await loadHistory();

    setStatus('Client Loaded', 'active');
  } catch (e) {
    setStatus('Error', 'default');
    console.error(e);
  }
}

// ============================================================================
// GENERATE SHORTLIST
// ============================================================================
async function generateShortlist() {
  if (!clientId) return;

  setStatus('Generating...', 'default');
  $('generateBtn').disabled = true;
  $('stockGrid').innerHTML = '<div class="loading"><div class="spinner"></div>Generating Shortlist...</div>';

  const instruction = $('instruction').value.trim();

  try {
    const res = await fetch(apiUrl('/api/shortlist'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', ...authHeaders() },
      body: JSON.stringify({
        client_id: clientId,
        instruction: instruction,
        max_candidates: 120,
        max_words: 320
      })
    });

    const data = await res.json();

    if (data.error) {
      $('stockGrid').innerHTML = `<div class="empty-state"><h3>Fehler</h3><p>${data.error}</p></div>`;
      setStatus('Error', 'default');
      $('generateBtn').disabled = false;
      return;
    }

    shortlist = data.shortlist || [];
    renderShortlist(shortlist, data.top_picks || []);

    $('pdfBtn').disabled = false;
    $('generateBtn').disabled = false;
    setStatus('Shortlist Ready', 'active');

    // Reload history from server (audit trail)
    await loadHistory();

  } catch (e) {
    $('stockGrid').innerHTML = `<div class="empty-state"><h3>Fehler</h3><p>${e.message}</p></div>`;
    setStatus('Error', 'default');
    $('generateBtn').disabled = false;
    console.error(e);
  }
}

function renderShortlist(list, topPicks) {
  if (!list.length) {
    $('stockGrid').innerHTML = '<div class="empty-state"><h3>No Recommendations</h3></div>';
    return;
  }

  $('stockGrid').innerHTML = list.map((s, i) => {
    const isTop = topPicks.includes(s.ticker);
    // Determine signal based on volatility and sector (simplified logic)
    const signal = isTop ? 'top' : (s.vol_60d < 0.25 ? 'buy' : s.vol_60d > 0.35 ? 'hold' : 'buy');
    const signalLabel = isTop ? 'TOP' : (signal === 'buy' ? 'BUY' : signal === 'sell' ? 'SELL' : 'HOLD');

    return `
      <div class="stock-card ${selectedTicker === s.ticker ? 'selected' : ''}" data-idx="${i}" data-ticker="${s.ticker}">
        <div class="stock-header">
          <div>
            <div class="stock-ticker">
              ${s.ticker}
              <span class="signal-badge ${signal}">
                <span class="signal-dot"></span>
                ${signalLabel}
              </span>
            </div>
            <div class="stock-name">${s.company_name}</div>
          </div>
          <span class="stock-sector">${s.sector || '-'}</span>
        </div>
        <div class="stock-sparkline" id="sparkline-${s.ticker.replace(/\./g, '-')}">
          <canvas></canvas>
        </div>
        <div class="stock-metrics">
          <div class="stock-metric">
            <span class="stock-metric-label">Close</span>
            <span class="stock-metric-value">${s.last_close != null ? Number(s.last_close).toFixed(2) : '-'}</span>
          </div>
          <div class="stock-metric">
            <span class="stock-metric-label">Vol 60d</span>
            <span class="stock-metric-value">${s.vol_60d ? (s.vol_60d * 100).toFixed(1) + '%' : '-'}</span>
          </div>
          <div class="stock-metric">
            <span class="stock-metric-label">Risk</span>
            <span class="stock-metric-value">${s.vol_bucket || '-'}</span>
          </div>
        </div>
        <ul class="stock-reasons">
          ${(s.why_bullets || []).slice(0, 3).map(b => `<li>${b.replace(/^[\sâ€¢\-\*]+/, '')}</li>`).join('')}
        </ul>
      </div>
    `;
  }).join('');

  $$('.stock-card').forEach(el => {
    el.addEventListener('click', () => selectStock(parseInt(el.dataset.idx)));
  });

  // Load sparklines for each stock
  list.forEach(s => {
    loadSparkline(s.ticker);
  });
}

// Sparkline mini-charts for stock cards
const sparklineCharts = {};

async function loadSparkline(ticker) {
  const containerId = `sparkline-${ticker.replace(/\./g, '-')}`;
  const container = document.getElementById(containerId);
  if (!container) return;

  const canvas = container.querySelector('canvas');
  if (!canvas) return;

  try {
    const res = await fetch(apiUrl(`/api/stock/${ticker}/history?days=14`), { headers: authHeaders() });
    if (!res.ok) return;

    const data = await res.json();
    const prices = data.prices || [];

    if (prices.length < 2) return;

    const closes = prices.map(p => p.close);
    const isPositive = closes[closes.length - 1] >= closes[0];
    const color = isPositive ? '#10b981' : '#ef4444';

    // Destroy existing chart
    if (sparklineCharts[ticker]) {
      sparklineCharts[ticker].destroy();
    }

    const ctx = canvas.getContext('2d');
    sparklineCharts[ticker] = new Chart(ctx, {
      type: 'line',
      data: {
        labels: prices.map((_, i) => i),
        datasets: [{
          data: closes,
          borderColor: color,
          backgroundColor: isPositive ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)',
          borderWidth: 2,
          fill: true,
          tension: 0.4,
          pointRadius: 0,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { enabled: false } },
        scales: {
          x: { display: false },
          y: { display: false }
        },
        interaction: { intersect: false },
        elements: { line: { borderJoinStyle: 'round' } }
      }
    });
  } catch (e) {
    // Silently fail - sparkline is optional
  }
}

// Toast notification system
function showToast(message, type = 'info') {
  let container = document.querySelector('.toast-container');
  if (!container) {
    container = document.createElement('div');
    container.className = 'toast-container';
    document.body.appendChild(container);
  }

  const icons = {
    success: 'âœ“',
    error: 'âœ•',
    info: 'â„¹'
  };

  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <span class="toast-icon">${icons[type] || icons.info}</span>
    <span>${message}</span>
  `;

  container.appendChild(toast);

  // Auto-remove after 4 seconds
  setTimeout(() => {
    toast.style.animation = 'fadeIn 0.3s ease-out reverse';
    setTimeout(() => toast.remove(), 300);
  }, 4000);
}

function selectStock(idx) {
  const stock = shortlist[idx];
  if (!stock) return;

  selectedTicker = stock.ticker;
  selectedStock = stock;

  $$('.stock-card').forEach((el, i) => el.classList.toggle('selected', i === idx));

  $('selectedStock').textContent = `AusgewÃ¤hlt: ${stock.ticker}`;
  $('storyFullBtn').disabled = false;
  $('storyBulletsBtn').disabled = false;
  $('storyEmpty').style.display = 'none';

  // Open stock detail modal with live market data
  openStockDetailModal(stock);
}

// ============================================================================
// GENERATE STORY
// ============================================================================
async function generateStory(mode) {
  if (!clientId || !selectedTicker) return;

  setStatus('Generiere Story...', 'default');
  $('outputPanel').style.display = 'block';
  $('outputText').textContent = 'Generiere...';

  const instruction = $('instruction').value.trim();

  try {
    const res = await fetch(apiUrl('/api/story_for_stock'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', ...authHeaders() },
      body: JSON.stringify({
        client_id: clientId,
        selected_ticker: selectedTicker,
        mode: mode,
        instruction: instruction,
        max_words: mode === 'BULLETS' ? 220 : 280
      })
    });

    const data = await res.json();

    if (data.error) {
      $('outputText').textContent = 'Fehler: ' + data.error;
      setStatus('Error', 'default');
      return;
    }

    $('outputTitle').textContent = mode === 'BULLETS' ? `Bullets - ${selectedTicker}` : `Story - ${selectedTicker}`;
    $('outputText').textContent = data.story || '(No Output)';

    setStatus('Story Ready', 'active');
    switchTab('story');

    // Reload history from server (audit trail)
    await loadHistory();

  } catch (e) {
    $('outputText').textContent = 'Fehler: ' + e.message;
    setStatus('Error', 'default');
    console.error(e);
  }
}

// ============================================================================
// HISTORY (Server-side audit trail)
// ============================================================================
async function loadHistory() {
  if (!clientId) {
    history = [];
    renderHistory();
    return;
  }

  try {
    const res = await fetch(apiUrl(`/api/history/${clientId}?limit=50`), { headers: authHeaders() });
    const data = await res.json();
    history = (data.history || []).map(h => ({
      id: h.generation_id,
      type: h.generation_type,
      client_id: h.client_id,
      client_name: clientData?.client?.firm_name || 'Unknown',
      timestamp: h.created_at,
      data: {
        ticker: h.ticker,
        mode: h.mode,
        response: h.response_text,
      }
    }));
    renderHistory();
  } catch (e) {
    console.error('Failed to load history:', e);
    history = [];
    renderHistory();
  }
}

function renderHistory() {
  if (history.length === 0) {
    $('historyEmpty').style.display = 'block';
    $('historyList').innerHTML = '';
    return;
  }

  $('historyEmpty').style.display = 'none';
  $('historyList').innerHTML = history.slice(0, 20).map(h => `
    <div class="summary-card" style="margin-bottom: 12px; cursor: pointer;" onclick="showHistoryDetail(${h.id})">
      <h4>${h.type === 'shortlist' ? 'Shortlist' : 'Story'} - ${h.client_name}
        <span class="history-badge">${new Date(h.timestamp).toLocaleString('en-US')}</span>
      </h4>
      <div class="summary-text">
        ${h.type === 'shortlist'
          ? 'Shortlist generated'
          : `${h.data.ticker || '-'} (${h.data.mode || 'FULL'})`
        }
      </div>
    </div>
  `).join('');
}

function showHistoryDetail(id) {
  const entry = history.find(h => h.id === id);
  if (!entry) return;

  // Show the response in the output panel
  switchTab('story');
  $('outputPanel').style.display = 'block';
  $('outputTitle').textContent = `${entry.type === 'shortlist' ? 'Shortlist' : 'Story'} (History #${id})`;
  $('outputText').textContent = entry.data.response || '(No Data)';
}

// ============================================================================
// STOCK DETAIL MODAL
// ============================================================================
function openStockDetailModal(stock) {
  // Set basic info immediately
  $('detailTicker').textContent = stock.ticker;
  $('detailCompanyName').textContent = stock.company_name || 'Loading...';
  $('detailPrice').textContent = stock.last_close ? `$${Number(stock.last_close).toFixed(2)}` : '-';
  $('detailChange').textContent = '-';
  $('detailChange').className = 'stock-detail-change';

  // Show loading state
  $('stockDetailBody').innerHTML = `
    <div class="stock-detail-loading">
      <div class="spinner"></div>
      <span style="margin-left: 12px;">Loading market data...</span>
    </div>
  `;

  // Open modal
  $('stockDetailOverlay').classList.add('open');
  $('stockDetailModal').classList.add('open');

  // Fetch live data
  fetchStockDetails(stock);
}

function closeStockDetailModal() {
  $('stockDetailOverlay').classList.remove('open');
  $('stockDetailModal').classList.remove('open');
}

async function fetchStockDetails(stock) {
  const ticker = stock.ticker;

  try {
    // Fetch quote, news, and history in parallel
    const [quoteRes, newsRes, historyRes] = await Promise.all([
      fetch(apiUrl(`/api/stock/${ticker}/quote`), { headers: authHeaders() }).catch(() => null),
      fetch(apiUrl(`/api/stock/${ticker}/news?days=7`), { headers: authHeaders() }).catch(() => null),
      fetch(apiUrl(`/api/stock/${ticker}/history?days=30`), { headers: authHeaders() }).catch(() => null)
    ]);

    let quote = null;
    let news = [];
    let history = [];

    if (quoteRes && quoteRes.ok) {
      const quoteData = await quoteRes.json();
      quote = quoteData.quote;
    }

    if (newsRes && newsRes.ok) {
      const newsData = await newsRes.json();
      news = newsData.news || [];
    }

    if (historyRes && historyRes.ok) {
      const historyData = await historyRes.json();
      history = historyData.prices || [];
    }

    renderStockDetailContent(stock, quote, news, history);

  } catch (e) {
    console.error('Error fetching stock details:', e);
    renderStockDetailContent(stock, null, [], []);
  }
}

// Global chart instance for cleanup
let stockPriceChart = null;

function renderStockDetailContent(stock, quote, news, history = []) {
  // Get latest day data from history as fallback
  const latestDay = history && history.length > 0 ? history[history.length - 1] : null;

  // Use quote data if available, otherwise fall back to history
  const openPrice = quote?.open || latestDay?.open || null;
  const highPrice = quote?.high || latestDay?.high || null;
  const lowPrice = quote?.low || latestDay?.low || null;
  const closePrice = quote?.price || latestDay?.close || stock.last_close;
  const volume = quote?.volume || latestDay?.volume || null;

  // Update header with live price if available
  if (closePrice) {
    $('detailPrice').textContent = `$${Number(closePrice).toFixed(2)}`;

    // Calculate change from history if no quote
    let changePercent = 0;
    let changeValue = 0;

    if (quote && quote.change_percent) {
      changePercent = parseFloat(quote.change_percent) || 0;
      changeValue = quote.change || 0;
    } else if (history && history.length >= 2) {
      const prevDay = history[history.length - 2];
      if (prevDay && prevDay.close && latestDay && latestDay.close) {
        changeValue = latestDay.close - prevDay.close;
        changePercent = (changeValue / prevDay.close) * 100;
      }
    }

    const changeClass = changePercent >= 0 ? 'positive' : 'negative';
    const changeSign = changePercent >= 0 ? '+' : '';
    $('detailChange').textContent = `${changeSign}${Number(changeValue).toFixed(2)} (${changeSign}${changePercent.toFixed(2)}%)`;
    $('detailChange').className = `stock-detail-change ${changeClass}`;
  }

  // Calculate price range position
  let rangePosition = 50; // Default to middle
  let low = lowPrice || stock.last_close * 0.95;
  let high = highPrice || stock.last_close * 1.05;
  let current = closePrice || stock.last_close;

  if (high > low && current) {
    rangePosition = ((current - low) / (high - low)) * 100;
    rangePosition = Math.max(5, Math.min(95, rangePosition));
  }

  // Build content
  let html = `
    <!-- Price Metrics -->
    <div class="stock-detail-metrics">
      <div class="stock-metric-box">
        <div class="label">Open</div>
        <div class="value">${openPrice ? `$${Number(openPrice).toFixed(2)}` : '-'}</div>
      </div>
      <div class="stock-metric-box">
        <div class="label">High</div>
        <div class="value">${highPrice ? `$${Number(highPrice).toFixed(2)}` : '-'}</div>
      </div>
      <div class="stock-metric-box">
        <div class="label">Low</div>
        <div class="value">${lowPrice ? `$${Number(lowPrice).toFixed(2)}` : '-'}</div>
      </div>
      <div class="stock-metric-box">
        <div class="label">Volume</div>
        <div class="value">${volume ? Number(volume).toLocaleString('de-DE') : '-'}</div>
      </div>
    </div>

    <!-- Day Range -->
    <div class="stock-detail-section">
      <div class="stock-detail-section-title">Day Range</div>
      <div class="stock-price-range">
        <span class="price-range-label">${lowPrice ? `$${Number(lowPrice).toFixed(2)}` : '-'}</span>
        <div class="price-range-bar">
          <div class="price-range-marker" style="left: ${rangePosition}%;"></div>
        </div>
        <span class="price-range-label high">${highPrice ? `$${Number(highPrice).toFixed(2)}` : '-'}</span>
      </div>
    </div>

    <!-- Price Chart -->
    <div class="stock-detail-section">
      <div class="stock-detail-section-title">Price History (30 Days)</div>
      <div class="stock-chart-container">
        <canvas id="stockPriceChartCanvas"></canvas>
      </div>
    </div>

    <!-- Stock Info from Shortlist -->
    <div class="stock-detail-section">
      <div class="stock-detail-section-title">Stock Information</div>
      <div class="stock-detail-metrics" style="grid-template-columns: repeat(3, 1fr);">
        <div class="stock-metric-box">
          <div class="label">Sector</div>
          <div class="value" style="font-size: 14px;">${stock.sector || '-'}</div>
        </div>
        <div class="stock-metric-box">
          <div class="label">Volatility (60d)</div>
          <div class="value">${stock.vol_60d ? (stock.vol_60d * 100).toFixed(1) + '%' : '-'}</div>
        </div>
        <div class="stock-metric-box">
          <div class="label">Risk Bucket</div>
          <div class="value" style="font-size: 14px;">${stock.vol_bucket || '-'}</div>
        </div>
      </div>
    </div>
  `;

  // AI Reasoning (if available)
  if (stock.why_bullets && stock.why_bullets.length > 0) {
    html += `
      <div class="stock-detail-section">
        <div class="stock-detail-section-title">Why This Stock?</div>
        <ul class="stock-reasons" style="font-size: 14px; line-height: 1.8;">
          ${stock.why_bullets.map(b => `<li>${b.replace(/^[\sâ€¢\-\*]+/, '')}</li>`).join('')}
        </ul>
      </div>
    `;
  }

  // News Section
  html += `
    <div class="stock-detail-section">
      <div class="stock-detail-section-title">
        Recent News
        <span style="font-size: 11px; background: var(--bg); padding: 2px 8px; border-radius: 10px; font-family: var(--font-primary);">${news.length}</span>
      </div>
  `;

  if (news.length > 0) {
    html += `<div class="news-list">`;
    news.slice(0, 5).forEach(article => {
      html += `
        <div class="news-item" onclick="window.open('${article.url}', '_blank')">
          <div class="news-headline">${article.headline}</div>
          <div class="news-meta">
            <span class="news-sentiment ${article.sentiment || 'neutral'}">${article.sentiment || 'neutral'}</span>
            <span>${article.source || 'Unknown'}</span>
            <span>${article.datetime || ''}</span>
          </div>
        </div>
      `;
    });
    html += `</div>`;
  } else {
    html += `
      <div class="stock-detail-error">
        No recent news available for ${stock.ticker}
      </div>
    `;
  }

  html += `</div>`;

  // Trading Date
  if (quote?.latest_trading_day) {
    html += `
      <div style="text-align: center; margin-top: 20px; font-size: 11px; color: var(--text-muted);">
        Data as of ${quote.latest_trading_day}
      </div>
    `;
  }

  $('stockDetailBody').innerHTML = html;

  // Render price chart if we have history data
  renderPriceChart(history, stock.ticker);
}

function renderPriceChart(history, ticker) {
  // Destroy previous chart if exists
  if (stockPriceChart) {
    stockPriceChart.destroy();
    stockPriceChart = null;
  }

  const canvas = document.getElementById('stockPriceChartCanvas');
  if (!canvas) return;

  // If no history data, show message
  if (!history || history.length === 0) {
    const ctx = canvas.getContext('2d');
    ctx.font = '14px var(--font-primary)';
    ctx.fillStyle = '#999';
    ctx.textAlign = 'center';
    ctx.fillText('No historical data available', canvas.width / 2, canvas.height / 2);
    return;
  }

  // Prepare data (history is already chronological from API)
  const labels = history.map(p => {
    const date = new Date(p.date);
    return date.toLocaleDateString('de-DE', { month: 'short', day: 'numeric' });
  });
  const prices = history.map(p => p.close);

  // Calculate min/max for better y-axis scaling
  const minPrice = Math.min(...prices) * 0.98;
  const maxPrice = Math.max(...prices) * 1.02;

  // Determine chart color based on price trend
  const isPositive = prices[prices.length - 1] >= prices[0];
  const lineColor = isPositive ? '#10b981' : '#ef4444';
  const bgGradient = isPositive ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';

  const ctx = canvas.getContext('2d');

  stockPriceChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: ticker,
        data: prices,
        borderColor: lineColor,
        backgroundColor: bgGradient,
        borderWidth: 2,
        fill: true,
        tension: 0.3,
        pointRadius: 0,
        pointHoverRadius: 5,
        pointHoverBackgroundColor: lineColor,
        pointHoverBorderColor: '#fff',
        pointHoverBorderWidth: 2,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(0, 61, 57, 0.9)',
          titleFont: { family: 'Lato, sans-serif', size: 12 },
          bodyFont: { family: 'Lato, sans-serif', size: 14, weight: 'bold' },
          padding: 12,
          cornerRadius: 8,
          callbacks: {
            label: function(context) {
              return `$${context.parsed.y.toFixed(2)}`;
            }
          }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: {
            font: { family: 'Lato, sans-serif', size: 10 },
            color: '#999',
            maxRotation: 0,
            maxTicksLimit: 6
          }
        },
        y: {
          min: minPrice,
          max: maxPrice,
          grid: {
            color: 'rgba(0, 0, 0, 0.05)',
            drawBorder: false
          },
          ticks: {
            font: { family: 'Lato, sans-serif', size: 10 },
            color: '#999',
            callback: function(value) {
              return '$' + value.toFixed(0);
            }
          }
        }
      }
    }
  });
}

// ============================================================================
// COPY
// ============================================================================
function copyOutput() {
  const text = $('outputText').textContent;
  navigator.clipboard.writeText(text);
  setStatus('Kopiert!', 'active');
  setTimeout(() => setStatus('Story bereit', 'active'), 1000);
}

// ============================================================================
// HEALTH CHECK
// ============================================================================
async function healthCheck() {
  setStatus('PrÃ¼fe...', 'default');
  try {
    const res = await fetch(apiUrl('/api/health'), { headers: authHeaders() });
    const data = await res.json();
    if (data.ok) {
      setStatus(`OK (${data.clients} Clients)`, 'active');
    } else {
      setStatus('Backend Error', 'default');
    }
  } catch (e) {
    setStatus('Offline', 'default');
  }
}

// ============================================================================
// EVENT LISTENERS
// ============================================================================
$('searchInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') search(e.target.value);
});

$('closeModal').addEventListener('click', hideModal);
$('modalOverlay').addEventListener('click', hideModal);

$('closeDrawer').addEventListener('click', closeDetailsDrawer);
$('drawerOverlay').addEventListener('click', closeDetailsDrawer);

$('closeStockDetail').addEventListener('click', closeStockDetailModal);
$('stockDetailOverlay').addEventListener('click', closeStockDetailModal);

$('generateBtn').addEventListener('click', generateShortlist);
$('storyFullBtn').addEventListener('click', () => generateStory('FULL'));
$('storyBulletsBtn').addEventListener('click', () => generateStory('BULLETS'));
$('copyBtn').addEventListener('click', copyOutput);
$('healthBtn').addEventListener('click', healthCheck);

$$('.tab').forEach(t => t.addEventListener('click', () => switchTab(t.dataset.tab)));

$$('.quick-prompt').forEach(el => {
  el.addEventListener('click', () => {
    const current = $('instruction').value;
    $('instruction').value = current ? current + '\n' + el.dataset.prompt : el.dataset.prompt;
  });
});

// Settings (simple prompt for now)
$('settingsBtn').addEventListener('click', () => {
  const base = prompt('API Base URL (empty = same-origin):', getApiBase());
  if (base !== null) localStorage.setItem('api_base', base);
});

// Stock search for analyst override
let stockSearchDebounce = null;
$('stockSearchInput').addEventListener('input', (e) => {
  const query = e.target.value.trim();
  if (stockSearchDebounce) clearTimeout(stockSearchDebounce);

  if (query.length < 2) {
    $('stockSearchResults').style.display = 'none';
    return;
  }

  stockSearchDebounce = setTimeout(async () => {
    const stocks = await searchAvailableStocks(query);
    $('stockSearchResults').style.display = 'block';
    renderStockSearchResults(stocks);
  }, 300);
});

// Hide stock search results when clicking outside
document.addEventListener('click', (e) => {
  const searchBox = document.querySelector('.override-search');
  if (searchBox && !searchBox.contains(e.target)) {
    $('stockSearchResults').style.display = 'none';
  }
});

// Init
renderHistory();
</script>
</body>
</html>
