<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ODDO BHF Sales Intelligence</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Libre+Baskerville:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      /* ODDO BHF Official Color Scheme (from oddo-bhf.com) */
      --primary: #003D39;
      --secondary-red: #cf2014;
      --secondary-grey: #F7F4F2;
      --secondary-green: #55a184;
      --add-green-gray: #b9d3b9;
      --add-green-pine: #305f50;
      --add-mint: #2a7d5e;
      --add-yellow: #F0E689;
      --add-smoked-blue: #9db6c7;
      --add-cinnamon: #ae4e41;
      --soft-greige: #F7F2EE;
      --dark: #272529;
      --light: #ffffff;
      --button-dark: #32373c;

      /* Mapped to existing variables */
      --bg: var(--secondary-grey);
      --bg-dark: var(--primary);
      --bg-darker: #182630;
      --card: var(--light);
      --border: #dee2e6;
      --text: var(--dark);
      --text-muted: #8e8e93;
      --accent: var(--primary);
      --accent-light: rgba(0, 61, 57, 0.08);
      --accent-dark: #002825;
      --accent-red: var(--secondary-red);
      --success: var(--secondary-green);
      --warning: #f59e0b;
      --danger: var(--secondary-red);
      --info: var(--add-smoked-blue);
      --hot: var(--secondary-red);
      --greige: var(--soft-greige);

      /* Border Radius - ODDO Style */
      --radius: 8px;
      --radius-lg: 16px;
      --radius-pill: 9999px;

      /* Shadow Presets - ODDO Style (natural, deep, sharp, crisp) */
      --shadow-natural: 6px 6px 9px rgba(0, 0, 0, 0.2);
      --shadow-deep: 12px 12px 50px rgba(0, 0, 0, 0.4);
      --shadow-sharp: 6px 6px 0px rgba(0, 0, 0, 0.2);
      --shadow-crisp: 6px 6px 0px var(--primary);
      --shadow: 0 1px 3px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 12px rgba(0, 61, 57, 0.08);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.1);
      --shadow-glow: 0 0 40px rgba(0, 61, 57, 0.15);

      /* Typography - ODDO Official Sizes */
      --font-primary: 'Lato', Arial, Verdana, sans-serif;
      --font-serif: 'Libre Baskerville', Georgia, serif;
      --text-h1: 58px;
      --text-h2: 40px;
      --text-h3: 24px;
      --text-h4: 18px;
      --text-body: 16px;
      --text-body-lg: 20px;
      --text-small: 13px;
      --text-label: 14px;

      /* Spacing System - ODDO Standards */
      --space-xs: 0.44rem;
      --space-sm: 0.67rem;
      --space-md: 1rem;
      --space-lg: 1.5rem;
      --space-xl: 2.25rem;
      --space-2xl: 3.38rem;
      --space-3xl: 5.06rem;

      /* Glassmorphism */
      --glass-bg: rgba(255, 255, 255, 0.85);
      --glass-border: rgba(255, 255, 255, 0.4);
      --glass-blur: blur(20px);

      /* Gradients */
      --gradient-primary: linear-gradient(135deg, #003D39 0%, #00524d 50%, #006b63 100%);
      --gradient-accent: linear-gradient(135deg, #cf2014 0%, #e63629 100%);
      --gradient-success: linear-gradient(135deg, #10b981 0%, #34d399 100%);
      --gradient-card: linear-gradient(180deg, rgba(255,255,255,1) 0%, rgba(247,244,242,0.5) 100%);

      /* Transitions */
      --transition-fast: 150ms ease;
      --transition-normal: 250ms ease;
      --transition-slow: 400ms ease;
      --transition-bounce: 400ms cubic-bezier(0.68, -0.55, 0.265, 1.55);

      /* Premium Effects */
      --glow-primary: 0 0 20px rgba(0, 61, 57, 0.3), 0 0 40px rgba(0, 61, 57, 0.1);
      --glow-success: 0 0 20px rgba(16, 185, 129, 0.3);
      --glow-danger: 0 0 20px rgba(220, 38, 38, 0.3);
      --gradient-premium: linear-gradient(135deg, #003D39 0%, #00524d 30%, #006b63 60%, #007d73 100%);
      --gradient-gold: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #b45309 100%);
      --gradient-platinum: linear-gradient(135deg, #64748b 0%, #94a3b8 50%, #cbd5e1 100%);
      --noise-texture: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
    }

    /* Premium Animations */
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }

    @keyframes pulse-glow {
      0%, 100% { box-shadow: var(--shadow-natural); }
      50% { box-shadow: var(--glow-primary); }
    }

    @keyframes gradient-shift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes slide-in-right {
      from { transform: translateX(30px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes scale-in {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    @keyframes number-tick {
      0% { transform: translateY(-100%); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }

    /* Respect reduced motion preference */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Dark Mode - Enhanced Premium Look (No White) */
    [data-theme="dark"] {
      --bg: #0f172a;
      --bg-dark: #0c1222;
      --bg-darker: #080d18;
      --card: #1e293b;
      --card-hover: #273548;
      --border: #334155;
      --border-light: #475569;
      --text: #cbd5e1;
      --text-muted: #64748b;
      --light: #1e293b;
      --primary: #10b981;
      --primary-light: rgba(16, 185, 129, 0.15);
      --accent-light: rgba(16, 185, 129, 0.1);
      --accent-red: #f87171;
      --success: #34d399;
      --info: #60a5fa;
      --soft-greige: #1e293b;
      --greige: #1e293b;
      --glass-bg: rgba(15, 23, 42, 0.95);
      --glass-border: rgba(51, 65, 85, 0.5);
      --gradient-card: linear-gradient(180deg, rgba(30,41,59,1) 0%, rgba(15,23,42,0.9) 100%);
      --gradient-primary: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --shadow: 0 1px 3px rgba(0,0,0,0.4);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.6);
      --shadow-glow: 0 0 40px rgba(16, 185, 129, 0.25);
    }

    [data-theme="dark"] body { background: var(--bg); }

    [data-theme="dark"] .header {
      background: linear-gradient(180deg, var(--card) 0%, var(--bg) 100%);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    [data-theme="dark"] .sidebar {
      background: var(--card);
      border-right: 1px solid var(--border);
    }

    [data-theme="dark"] .stock-card {
      background: var(--card);
      border: 1px solid var(--border);
    }

    [data-theme="dark"] .stock-card:hover {
      background: var(--card-hover);
      border-color: var(--primary);
      box-shadow: var(--shadow-glow);
    }

    [data-theme="dark"] .btn-primary {
      background: var(--gradient-primary);
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    [data-theme="dark"] .btn-secondary {
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
    }

    [data-theme="dark"] .btn-secondary:hover {
      background: var(--card-hover);
      border-color: var(--primary);
    }

    [data-theme="dark"] input,
    [data-theme="dark"] textarea,
    [data-theme="dark"] select {
      background: var(--bg-darker);
      color: var(--text);
      border: 1px solid var(--border);
    }

    [data-theme="dark"] input:focus,
    [data-theme="dark"] textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
    }

    [data-theme="dark"] .tabs { background: var(--bg-darker); border: 1px solid var(--border); }
    [data-theme="dark"] .tab { color: var(--text-muted); }
    [data-theme="dark"] .tab:hover { background: var(--card); color: var(--text); }
    [data-theme="dark"] .tab.active { background: var(--primary); color: #0f172a; }

    [data-theme="dark"] .summary-card,
    [data-theme="dark"] .sidebar-section { background: var(--card); border: 1px solid var(--border); }
    [data-theme="dark"] .sidebar-section:hover { background: var(--card-hover); }

    [data-theme="dark"] .stock-detail-modal { background: var(--bg); box-shadow: -10px 0 40px rgba(0,0,0,0.5); }
    [data-theme="dark"] .modal-header { background: linear-gradient(180deg, var(--card) 0%, var(--bg) 100%); border-bottom: 1px solid var(--border); }
    [data-theme="dark"] .detail-table th { background: var(--bg-darker); color: var(--text-muted); }
    [data-theme="dark"] .detail-table td { border-color: var(--border); }

    [data-theme="dark"] .tag { background: var(--card); border: 1px solid var(--border); }
    [data-theme="dark"] .tag.buy { background: rgba(16, 185, 129, 0.2); color: var(--success); border-color: var(--success); }
    [data-theme="dark"] .tag.sell { background: rgba(248, 113, 113, 0.2); color: var(--accent-red); border-color: var(--accent-red); }

    [data-theme="dark"] .quick-stats { background: linear-gradient(180deg, var(--card) 0%, var(--bg) 100%); border-bottom: 1px solid var(--border); }
    [data-theme="dark"] .stat-card { background: var(--card); border: 1px solid var(--border); }
    [data-theme="dark"] .stat-card:hover { background: var(--card-hover); box-shadow: var(--shadow-glow); }

    [data-theme="dark"] .meetings-widget,
    [data-theme="dark"] .activity-feed { background: var(--card); border: 1px solid var(--border); }
    [data-theme="dark"] .meetings-header,
    [data-theme="dark"] .activity-header { background: var(--bg-darker); border-bottom: 1px solid var(--border); }
    [data-theme="dark"] .meeting-item:hover,
    [data-theme="dark"] .activity-item:hover { background: var(--card-hover); }

    [data-theme="dark"] .shortcuts-panel { background: var(--card); border: 1px solid var(--border); }
    [data-theme="dark"] .shortcut-key { background: var(--bg-darker); border: 1px solid var(--border); }
    [data-theme="dark"] .action-btn { background: var(--bg-darker); border: 1px solid var(--border); }
    [data-theme="dark"] .action-btn:hover { background: var(--primary-light); border-color: var(--primary); color: var(--primary); }

    [data-theme="dark"] .live-ticker-container { background: linear-gradient(135deg, var(--card) 0%, var(--bg-darker) 100%); }
    [data-theme="dark"] .search-autocomplete { background: var(--card); border: 1px solid var(--border); }
    [data-theme="dark"] .search-item:hover { background: var(--card-hover); }
    [data-theme="dark"] .drawer-panel { background: var(--card); border: 1px solid var(--border); }
    [data-theme="dark"] .toast { background: var(--card); border: 1px solid var(--border); }
    [data-theme="dark"] .skeleton { background: linear-gradient(90deg, var(--card) 25%, var(--card-hover) 50%, var(--card) 75%); }

    [data-theme="dark"] ::selection { background: var(--primary); color: #0f172a; }

    /* Dark mode - remove white from buttons and badges */
    [data-theme="dark"] .btn-primary { color: #0f172a; }
    [data-theme="dark"] .badge-buy, [data-theme="dark"] .badge-high { color: #0f172a; }
    [data-theme="dark"] .ticker-item { color: #0f172a; }
    [data-theme="dark"] .live-ticker-container { color: #0f172a; }
    [data-theme="dark"] .crm-stat-box { color: #0f172a !important; }
    [data-theme="dark"] .pulse-dot { background: var(--primary); }
    [data-theme="dark"] .stock-detail-close { background: rgba(100, 116, 139, 0.3); color: var(--text); }
    [data-theme="dark"] .stock-detail-close:hover { background: rgba(100, 116, 139, 0.5); }
    [data-theme="dark"] .price-range-marker { border-color: #0f172a; }
    [data-theme="dark"] .avatar-img { border-color: var(--border) !important; }
    [data-theme="dark"] ::-webkit-scrollbar { width: 8px; height: 8px; }
    [data-theme="dark"] ::-webkit-scrollbar-track { background: var(--bg-darker); }
    [data-theme="dark"] ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    [data-theme="dark"] ::-webkit-scrollbar-thumb:hover { background: var(--border-light); }

    /* Live Ticker */
    @keyframes tickerScroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }

    .live-ticker-container {
      background: var(--gradient-primary);
      overflow: hidden;
      padding: 8px 0;
      position: relative;
    }

    .live-ticker {
      display: flex;
      animation: tickerScroll 30s linear infinite;
      white-space: nowrap;
    }

    .ticker-item {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 0 24px;
      color: white;
      font-size: 13px;
      font-weight: 500;
    }

    .ticker-symbol {
      font-weight: 700;
      color: white;
    }

    .ticker-price {
      font-family: var(--font-primary);
    }

    .ticker-change {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .ticker-change.positive {
      background: rgba(16, 185, 129, 0.3);
      color: #34d399;
    }

    .ticker-change.negative {
      background: rgba(239, 68, 68, 0.3);
      color: #fca5a5;
    }

    /* Stock Filters */
    .filter-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-label {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 600;
      text-transform: uppercase;
    }

    .filter-select {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card);
      font-size: 13px;
      font-family: var(--font-primary);
      cursor: pointer;
      min-width: 120px;
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .filter-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--accent-light);
      border: 1px solid var(--primary);
      border-radius: var(--radius-pill);
      font-size: 12px;
      color: var(--primary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-chip:hover {
      background: var(--primary);
      color: white;
    }

    .filter-chip.active {
      background: var(--primary);
      color: white;
    }

    /* Keyboard Shortcut Hints */
    .kbd {
      display: inline-block;
      padding: 2px 6px;
      font-size: 10px;
      font-family: monospace;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-muted);
      margin-left: 8px;
    }

    /* Search Autocomplete */
    .search-autocomplete {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      max-height: 300px;
      overflow-y: auto;
      display: none;
    }

    .search-autocomplete.show {
      display: block;
      animation: fadeIn 0.2s ease;
    }

    .search-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
    }

    .search-item:last-child {
      border-bottom: none;
    }

    .search-item:hover {
      background: var(--accent-light);
    }

    .search-item-title {
      font-weight: 600;
      color: var(--text);
    }

    .search-item-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .search-section-header {
      padding: 8px 12px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: var(--greige);
    }

    .search-suggestion {
      background: var(--greige);
    }

    .search-suggestion:hover {
      background: var(--border);
    }

    .search-empty {
      padding: 16px;
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
    }

    /* Theme Toggle */
    .theme-toggle {
      width: 44px;
      height: 24px;
      border-radius: 12px;
      background: var(--border);
      border: none;
      cursor: pointer;
      position: relative;
      transition: background 0.3s;
    }

    .theme-toggle::after {
      content: 'L';
      position: absolute;
      left: 2px;
      top: 2px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 700;
      color: #1e3a5f;
      transition: transform 0.3s, content 0.3s;
    }

    [data-theme="dark"] .theme-toggle {
      background: var(--primary);
    }

    [data-theme="dark"] .theme-toggle::after {
      content: 'D';
      transform: translateX(20px);
      background: #0f172a;
      color: var(--primary);
    }

    /* Keyframe Animations */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px rgba(0, 61, 57, 0.2); }
      50% { box-shadow: 0 0 20px rgba(0, 61, 57, 0.4); }
    }

    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    .animate-fade-in-up { animation: fadeInUp 0.4s ease-out; }
    .animate-slide-in { animation: slideInRight 0.3s ease-out; }

    /* ========================================
       NEW: Smoother Global Transitions
       ======================================== */
    * {
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ========================================
       NEW: Skeleton Loading
       ======================================== */
    .skeleton {
      background: linear-gradient(90deg, var(--greige) 25%, var(--bg) 50%, var(--greige) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: var(--radius);
    }

    .skeleton-text {
      height: 14px;
      margin-bottom: 8px;
      border-radius: 4px;
    }

    .skeleton-text.short { width: 60%; }
    .skeleton-text.medium { width: 80%; }
    .skeleton-text.long { width: 100%; }

    .skeleton-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }

    .skeleton-card {
      height: 120px;
      border-radius: var(--radius);
    }

    .skeleton-stat {
      height: 60px;
      border-radius: var(--radius);
    }

    /* ========================================
       NEW: Quick Stats Dashboard
       ======================================== */
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      padding: 20px 32px;
      background: var(--gradient-card);
      border-bottom: 1px solid var(--border);
    }

    .stat-card {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 20px;
      border: 1px solid var(--border);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: var(--primary);
      transform: scaleY(0);
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .stat-card:hover::before {
      transform: scaleY(1);
    }

    .stat-card.accent-red::before { background: var(--accent-red); }
    .stat-card.accent-green::before { background: var(--success); }
    .stat-card.accent-blue::before { background: var(--info); }

    .stat-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      margin-bottom: 12px;
      background: var(--accent-light);
      color: var(--primary);
    }

    .stat-card.accent-red .stat-icon { background: rgba(207, 32, 20, 0.1); color: var(--accent-red); }
    .stat-card.accent-green .stat-icon { background: rgba(85, 161, 132, 0.1); color: var(--success); }
    .stat-card.accent-blue .stat-icon { background: rgba(157, 182, 199, 0.15); color: var(--info); }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      font-family: var(--font-serif);
      color: var(--text);
      margin-bottom: 4px;
      display: flex;
      align-items: baseline;
      gap: 8px;
    }

    .stat-trend {
      font-size: 12px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .stat-trend.up { background: rgba(16, 185, 129, 0.1); color: #10b981; }
    .stat-trend.down { background: rgba(239, 68, 68, 0.1); color: #ef4444; }

    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    /* ========================================
       NEW: Quick Actions
       ======================================== */
    .quick-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .action-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 12px 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 11px;
      color: var(--text-muted);
    }

    .action-btn:hover {
      background: var(--accent-light);
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-2px);
    }

    .action-btn svg {
      width: 20px;
      height: 20px;
    }

    /* ========================================
       NEW: Upcoming Meetings Widget
       ======================================== */
    .meetings-widget {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      margin-top: 16px;
      overflow: hidden;
    }

    .meetings-header {
      padding: 12px 16px;
      background: var(--greige);
      border-bottom: 1px solid var(--border);
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .meeting-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      transition: background 0.2s ease;
      cursor: pointer;
    }

    .meeting-item:last-child { border-bottom: none; }
    .meeting-item:hover { background: var(--accent-light); }

    .meeting-date {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .meeting-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }

    .meeting-type {
      display: inline-block;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      background: var(--accent-light);
      color: var(--primary);
      margin-top: 4px;
    }

    /* ========================================
       NEW: Recent Activity Feed
       ======================================== */
    .activity-feed {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      margin-top: 16px;
      overflow: hidden;
    }

    .activity-header {
      padding: 12px 16px;
      background: var(--greige);
      border-bottom: 1px solid var(--border);
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    .activity-item {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 12px;
      align-items: flex-start;
      transition: background 0.2s ease;
    }

    .activity-item:last-child { border-bottom: none; }
    .activity-item:hover { background: var(--accent-light); }

    .activity-icon {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      flex-shrink: 0;
    }

    .activity-icon.call { background: rgba(16, 185, 129, 0.1); color: #10b981; }
    .activity-icon.email { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
    .activity-icon.meeting { background: rgba(168, 85, 247, 0.1); color: #a855f7; }
    .activity-icon.report { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }

    .activity-content {
      flex: 1;
      min-width: 0;
    }

    .activity-text {
      font-size: 12px;
      color: var(--text);
      line-height: 1.4;
    }

    .activity-time {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* ========================================
       NEW: Keyboard Shortcuts Panel
       ======================================== */
    .shortcuts-btn {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      border: none;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: var(--shadow-lg);
      transition: all 0.3s ease;
      z-index: 90;
    }

    .shortcuts-btn:hover {
      transform: scale(1.1);
      box-shadow: var(--shadow-glow);
    }

    .shortcuts-panel {
      position: fixed;
      bottom: 80px;
      right: 24px;
      width: 320px;
      background: var(--card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-lg);
      z-index: 91;
      opacity: 0;
      visibility: hidden;
      transform: translateY(20px) scale(0.95);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .shortcuts-panel.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0) scale(1);
    }

    .shortcuts-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      font-weight: 700;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .shortcuts-close {
      background: none;
      border: none;
      font-size: 18px;
      color: var(--text-muted);
      cursor: pointer;
    }

    .shortcuts-list {
      padding: 12px 20px;
      max-height: 400px;
      overflow-y: auto;
    }

    .shortcut-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }

    .shortcut-item:last-child { border-bottom: none; }

    .shortcut-desc {
      font-size: 13px;
      color: var(--text);
    }

    .shortcut-keys {
      display: flex;
      gap: 4px;
    }

    .shortcut-key {
      padding: 4px 8px;
      background: var(--greige);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 11px;
      font-family: monospace;
      font-weight: 600;
      color: var(--text-muted);
    }

    /* ========================================
       NEW: Mini Sparklines on Stock Cards
       ======================================== */
    .stock-sparkline {
      height: 30px;
      margin-top: 8px;
      opacity: 0.8;
    }

    .stock-sparkline canvas {
      width: 100% !important;
      height: 30px !important;
    }

    /* ========================================
       ENHANCED: Smoother Card Animations
       ======================================== */
    .stock-card {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .stock-card:hover {
      transform: translateY(-6px) scale(1.02);
      box-shadow: 0 12px 40px rgba(0, 61, 57, 0.15);
    }

    .stock-card:active {
      transform: translateY(-2px) scale(0.98);
    }

    /* Staggered animation for cards */
    .stock-grid .stock-card {
      opacity: 0;
      animation: cardEnter 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    @keyframes cardEnter {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* ========================================
       ENHANCED: Smoother Modal Transitions
       ======================================== */
    .stock-detail-modal {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .stock-detail-modal.show {
      animation: modalEnter 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes modalEnter {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .stock-detail-overlay {
      transition: opacity 0.3s ease;
    }

    /* ========================================
       ENHANCED: Smoother Sidebar Transitions
       ======================================== */
    .sidebar-section {
      transition: all 0.3s ease;
    }

    .sidebar-section:hover {
      background: var(--accent-light);
    }

    /* ========================================
       ENHANCED: Button Micro-interactions
       ======================================== */
    .btn {
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.4s, height 0.4s;
    }

    .btn:active::after {
      width: 200px;
      height: 200px;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 61, 57, 0.25);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    /* ========================================
       ENHANCED: Smoother Input Focus
       ======================================== */
    input, textarea, select {
      transition: all 0.25s ease;
    }

    input:focus, textarea:focus, select:focus {
      transform: scale(1.01);
    }

    /* ========================================
       ENHANCED: Tabs with sliding indicator
       ======================================== */
    .tabs {
      position: relative;
    }

    .tab {
      transition: all 0.3s ease;
    }

    .tab:hover:not(.active) {
      color: var(--primary);
      background: var(--accent-light);
    }

    /* ========================================
       NEW: Pulse animation for live elements
       ======================================== */
    .pulse-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10b981;
      animation: pulseDot 2s infinite;
    }

    @keyframes pulseDot {
      0%, 100% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.5);
        opacity: 0.5;
      }
    }

    /* ========================================
       NEW: Number counter animation
       ======================================== */
    .counter-animate {
      display: inline-block;
      animation: countUp 0.6s ease-out;
    }

    @keyframes countUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ========================================
       ENHANCED: Toast animations
       ======================================== */
    .toast {
      animation: toastEnter 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes toastEnter {
      from {
        opacity: 0;
        transform: translateX(100%) scale(0.8);
      }
      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }

    .toast.hiding {
      animation: toastExit 0.3s ease forwards;
    }

    @keyframes toastExit {
      to {
        opacity: 0;
        transform: translateX(100%) scale(0.8);
      }
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-primary);
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    h1, h2, h3 {
      font-family: var(--font-serif);
      font-weight: 700;
      color: var(--primary);
    }

    h4, h5, h6 {
      font-family: var(--font-primary);
      font-weight: 700;
    }

    .serif {
      font-family: var(--font-serif);
      font-weight: 400;
    }

    .lato-light {
      font-family: var(--font-primary);
      font-weight: 300;
    }

    /* === HEADER - ODDO Style === */
    .header {
      background: var(--light);
      color: var(--text);
      padding: var(--space-md) var(--space-2xl);
      display: flex;
      align-items: center;
      gap: var(--space-xl);
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 3px solid var(--primary);
      box-shadow: var(--shadow-natural);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      font-size: 15px;
      letter-spacing: 0.3px;
      color: var(--text);
      flex-shrink: 0;
      margin-right: 32px;
    }

    .logo-img {
      height: 44px;
      width: auto;
    }

    .logo-text {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-muted);
      border-left: 1px solid var(--border);
      padding-left: 12px;
    }

    .search-box {
      flex: 1;
      max-width: 480px;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 12px 18px;
      padding-left: 44px;
      border: 1px solid var(--border);
      border-radius: var(--radius-pill);
      background: var(--soft-greige);
      color: var(--text);
      font-size: 14px;
      font-family: var(--font-primary);
      outline: none;
      transition: all 0.2s ease;
    }

    .search-input::placeholder {
      color: var(--text-muted);
    }

    .search-input:focus {
      background: white;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 61, 57, 0.1);
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 10px 24px;
      border-radius: var(--radius-pill);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
      letter-spacing: 0.3px;
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    .btn-ghost:hover {
      background: var(--greige);
      color: var(--text);
      border-color: var(--primary);
    }

    .btn-primary {
      background: var(--button-dark);
      color: white;
      border-radius: var(--radius-pill);
      padding: 12px 28px;
      font-weight: 600;
      font-size: var(--text-label);
      letter-spacing: 0.02em;
      box-shadow: var(--shadow-natural);
      transition: all var(--transition-normal);
    }

    .btn-primary:hover {
      background: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-deep);
    }

    .btn-secondary {
      background: transparent;
      color: var(--button-dark);
      border: 2px solid var(--button-dark);
      border-radius: var(--radius-pill);
      padding: 10px 26px;
      font-weight: 600;
      font-size: var(--text-label);
      transition: all var(--transition-normal);
    }

    .btn-secondary:hover {
      background: var(--button-dark);
      color: white;
      transform: translateY(-2px);
      box-shadow: var(--shadow-natural);
    }

    .status-chip {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      background: var(--greige);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    .status-chip.active {
      background: rgba(85, 161, 132, 0.15);
      color: var(--success);
      border-color: var(--success);
    }

    /* === LAYOUT === */
    .layout {
      display: grid;
      grid-template-columns: 380px 1fr;
      min-height: calc(100vh - 56px);
    }

    /* === SIDEBAR === */
    .sidebar {
      background: var(--card);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      padding: 20px;
    }

    .client-header {
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .client-name {
      font-size: 22px;
      font-weight: 700;
      font-family: var(--font-serif);
      color: var(--primary);
      margin-bottom: 6px;
    }

    .client-meta {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* === METRIC CARDS === */
    .metrics-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .metric-card {
      background: var(--light);
      border: none;
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      box-shadow: var(--shadow-natural);
      transition: all var(--transition-normal);
    }

    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-deep);
    }

    .metric-label {
      font-size: var(--text-small);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: var(--space-xs);
    }

    .metric-value {
      font-size: var(--text-h4);
      font-weight: 700;
      font-family: var(--font-serif);
      color: var(--primary);
    }

    .metric-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
    }

    .badge-high { background: #fef2f2; color: #dc2626; }
    .badge-medium { background: #fffbeb; color: #d97706; }
    .badge-low { background: #f0fdf4; color: #16a34a; }
    .badge-info { background: #f0f9ff; color: #0284c7; }

    /* === EXECUTIVE SUMMARY === */
    .summary-section {
      margin-bottom: 20px;
    }

    .summary-title {
      font-size: 14px;
      font-weight: 700;
      font-family: var(--font-serif);
      text-transform: none;
      letter-spacing: 0;
      color: var(--primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .summary-card {
      background: var(--light);
      border: none;
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      box-shadow: var(--shadow-natural);
      margin-bottom: 12px;
    }

    .summary-card h4 {
      font-size: 15px;
      font-weight: 700;
      font-family: var(--font-serif);
      color: var(--primary);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .summary-text {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.6;
    }

    .summary-bullets {
      list-style: none;
      font-size: 13px;
    }

    .summary-bullets li {
      padding: 6px 0;
      border-bottom: 1px dashed var(--border);
      display: flex;
      justify-content: space-between;
    }

    .summary-bullets li:last-child { border-bottom: none; }

    .expand-btn {
      font-size: 12px;
      color: var(--accent);
      cursor: pointer;
      margin-top: 8px;
      display: inline-block;
    }

    .expand-btn:hover { text-decoration: underline; }

    /* === ACTION SIGNAL === */
    .action-signal {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      color: white;
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 20px;
    }

    .action-signal h4 {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.8;
      margin-bottom: 6px;
    }

    .action-signal p {
      font-size: 15px;
      font-weight: 600;
    }

    /* === LEAD SCORE BANNER === */
    .lead-banner {
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .lead-banner.hot {
      background: linear-gradient(135deg, #cf2014 0%, #a31810 100%);
      color: white;
    }

    .lead-banner.warm {
      background: linear-gradient(135deg, #55a184 0%, #305f50 100%);
      color: white;
    }

    .lead-banner.cold {
      background: var(--greige);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    .lead-score {
      display: flex;
      flex-direction: column;
    }

    .lead-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.8;
    }

    .lead-value {
      font-size: 26px;
      font-weight: 700;
      font-family: var(--font-serif);
    }

    .lead-reason {
      font-size: 11px;
      text-align: right;
      opacity: 0.9;
      max-width: 140px;
    }

    /* === BUY CHIPS === */
    .buy-chips, .interest-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .buy-chip {
      padding: 6px 12px;
      background: linear-gradient(135deg, #55a184 0%, #305f50 100%);
      color: white;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
    }

    .interest-chip {
      padding: 5px 10px;
      background: var(--accent-light);
      color: var(--accent);
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      border: 1px solid var(--border);
    }

    /* === ACTIVITY BAR === */
    .activity-bar {
      display: flex;
      gap: 8px;
    }

    .activity-item {
      flex: 1;
      background: var(--bg);
      border-radius: 8px;
      padding: 12px 8px;
      text-align: center;
      border: 1px solid var(--border);
    }

    .activity-num {
      display: block;
      font-size: 24px;
      font-weight: 700;
      font-family: var(--font-serif);
      color: var(--primary);
    }

    .activity-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* === BADGE VARIANTS === */
    .badge-hot {
      background: var(--hot) !important;
      color: white !important;
    }

    /* === MAIN CONTENT === */
    .main {
      padding: 24px;
      overflow-y: auto;
    }

    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
    }

    .main-title {
      font-size: var(--text-h2);
      font-weight: 700;
      font-family: var(--font-serif);
      color: var(--primary);
      line-height: 1.2;
    }

    .main-subtitle {
      font-size: var(--text-body);
      color: var(--text-muted);
      margin-top: var(--space-sm);
      font-family: var(--font-primary);
    }

    /* === TABS - ODDO Style === */
    .tabs {
      display: flex;
      gap: var(--space-xs);
      background: var(--secondary-grey);
      padding: var(--space-xs);
      border-radius: var(--radius-pill);
      margin-bottom: var(--space-xl);
      width: fit-content;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }

    .tab {
      padding: var(--space-sm) var(--space-lg);
      border-radius: var(--radius-pill);
      font-size: var(--text-label);
      font-weight: 600;
      cursor: pointer;
      border: none;
      background: transparent;
      color: var(--text-muted);
      transition: all var(--transition-normal);
    }

    .tab:hover {
      color: var(--primary);
      background: rgba(255,255,255,0.6);
    }
    .tab.active {
      background: var(--button-dark);
      color: white;
      box-shadow: var(--shadow-natural);
    }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* === INSTRUCTION BOX === */
    .instruction-box {
      background: var(--light);
      border: none;
      border-radius: var(--radius-lg);
      padding: var(--space-xl);
      margin-bottom: var(--space-xl);
      box-shadow: var(--shadow-natural);
    }

    .instruction-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .instruction-input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 14px;
      font-family: var(--font-primary);
      resize: vertical;
      min-height: 80px;
      transition: all 0.2s ease;
    }

    .instruction-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 61, 57, 0.1);
    }

    .quick-prompts {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .quick-prompt {
      padding: 8px 16px;
      border-radius: var(--radius-pill);
      font-size: 12px;
      font-weight: 500;
      background: var(--soft-greige);
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .quick-prompt:hover {
      border-color: var(--primary);
      background: rgba(0, 61, 57, 0.08);
      color: var(--primary);
    }

    /* === STOCK GRID === */
    .stock-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
    }

    .stock-card {
      background: var(--light);
      border: none;
      border-radius: var(--radius-lg);
      padding: var(--space-xl);
      cursor: pointer;
      transition: all var(--transition-normal);
      position: relative;
      overflow: hidden;
      animation: fadeInUp 0.4s ease-out backwards;
      box-shadow: var(--shadow-natural);
    }

    .stock-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--primary);
      opacity: 0;
      transition: opacity var(--transition-normal);
    }

    .stock-card:hover {
      box-shadow: var(--shadow-deep);
      transform: translateY(-6px);
    }

    .stock-card:hover::before {
      opacity: 1;
    }

    .stock-card.selected {
      border-color: var(--secondary-red);
      border-width: 2px;
      background: linear-gradient(180deg, rgba(207, 32, 20, 0.04) 0%, rgba(255,255,255,1) 100%);
    }

    .stock-card.selected::before {
      background: var(--gradient-accent);
      opacity: 1;
    }

    /* Staggered animation for cards */
    .stock-card:nth-child(1) { animation-delay: 0.05s; }
    .stock-card:nth-child(2) { animation-delay: 0.1s; }
    .stock-card:nth-child(3) { animation-delay: 0.15s; }
    .stock-card:nth-child(4) { animation-delay: 0.2s; }
    .stock-card:nth-child(5) { animation-delay: 0.25s; }
    .stock-card:nth-child(6) { animation-delay: 0.3s; }
    .stock-card:nth-child(7) { animation-delay: 0.35s; }
    .stock-card:nth-child(8) { animation-delay: 0.4s; }
    .stock-card:nth-child(9) { animation-delay: 0.45s; }

    .stock-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .stock-ticker {
      font-size: 20px;
      font-weight: 700;
      font-family: var(--font-serif);
      color: var(--primary);
    }

    .stock-name {
      font-size: 13px;
      color: var(--text-muted);
    }

    .stock-sector {
      font-size: 11px;
      padding: 4px 8px;
      background: var(--bg);
      border-radius: 4px;
      color: var(--text-muted);
    }

    .stock-metrics {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
      font-size: 12px;
    }

    .stock-metric {
      display: flex;
      flex-direction: column;
    }

    .stock-metric-label {
      color: var(--text-muted);
      font-size: 10px;
      text-transform: uppercase;
    }

    .stock-metric-value {
      font-weight: 700;
    }

    .stock-reasons {
      font-size: 12px;
      color: var(--text-muted);
    }

    .stock-reasons li {
      margin-bottom: 4px;
      padding-left: 12px;
      position: relative;
    }

    .stock-reasons li::before {
      content: "â€¢";
      position: absolute;
      left: 0;
      color: var(--accent);
    }

    /* === SIGNAL BADGES === */
    .signal-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .signal-badge.buy {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(52, 211, 153, 0.15) 100%);
      color: #059669;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .signal-badge.sell {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(248, 113, 113, 0.15) 100%);
      color: #dc2626;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .signal-badge.hold {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(251, 191, 36, 0.15) 100%);
      color: #d97706;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .signal-badge.top {
      background: var(--gradient-accent);
      color: white;
      border: none;
      animation: pulse 2s infinite;
    }

    .signal-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    /* === SPARKLINE MINI CHARTS === */
    .stock-sparkline {
      height: 40px;
      margin: 12px 0;
      position: relative;
      overflow: hidden;
      border-radius: 8px;
      background: linear-gradient(180deg, rgba(0, 61, 57, 0.02) 0%, transparent 100%);
    }

    .stock-sparkline canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* === LIVE INDICATOR === */
    .live-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      color: var(--success);
      font-weight: 600;
    }

    .live-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 1.5s infinite;
      box-shadow: 0 0 8px rgba(85, 161, 132, 0.6);
    }

    /* === MARKET PULSE SECTION === */
    .market-pulse {
      background: var(--gradient-primary);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 24px;
      color: white;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      position: relative;
      overflow: hidden;
    }

    .market-pulse::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 300px;
      height: 300px;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      pointer-events: none;
    }

    .pulse-item {
      text-align: center;
      position: relative;
      z-index: 1;
    }

    .pulse-label {
      font-size: 11px;
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .pulse-value {
      font-size: 28px;
      font-weight: 700;
      font-family: var(--font-serif);
    }

    .pulse-change {
      font-size: 12px;
      margin-top: 4px;
    }

    .pulse-change.positive { color: #34d399; }
    .pulse-change.negative { color: #fca5a5; }

    /* === ENHANCED BUTTONS === */
    .btn-glow {
      position: relative;
      overflow: hidden;
    }

    .btn-glow::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn-glow:hover::after {
      width: 300px;
      height: 300px;
    }

    /* === LOADING SKELETON === */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: var(--radius);
    }

    .skeleton-text {
      height: 14px;
      margin-bottom: 8px;
    }

    .skeleton-title {
      height: 24px;
      width: 60%;
      margin-bottom: 12px;
    }

    /* === TOAST NOTIFICATIONS === */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toast {
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 16px 20px;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideInRight 0.3s ease-out;
      min-width: 300px;
    }

    .toast.success { border-left: 4px solid var(--success); }
    .toast.error { border-left: 4px solid var(--danger); }
    .toast.info { border-left: 4px solid var(--primary); }

    .toast-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .toast.success .toast-icon { background: rgba(16, 185, 129, 0.15); color: var(--success); }
    .toast.error .toast-icon { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
    .toast.info .toast-icon { background: rgba(0, 61, 57, 0.15); color: var(--primary); }

    /* === OUTPUT PANEL === */
    .output-panel {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .output-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .output-title {
      font-size: 16px;
      font-weight: 700;
      font-family: var(--font-serif);
      color: var(--primary);
    }

    .output-body {
      padding: 20px;
      max-height: 500px;
      overflow-y: auto;
    }

    .output-text {
      font-size: 14px;
      line-height: 1.7;
      white-space: pre-wrap;
    }

    /* === SEARCH RESULTS MODAL === */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      z-index: 200;
    }

    .modal {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 600px;
      max-height: 70vh;
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      display: none;
      z-index: 201;
    }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-weight: 700;
      font-family: var(--font-serif);
      color: var(--primary);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--text-muted);
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
      max-height: calc(70vh - 60px);
    }

    .search-result {
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .search-result:hover {
      border-color: var(--accent);
      background: var(--accent-light);
    }

    .search-result-name {
      font-weight: 700;
      margin-bottom: 4px;
    }

    .search-result-meta {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* === EMPTY STATE === */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state h3 {
      font-size: 18px;
      margin-bottom: 8px;
      color: var(--text);
    }

    /* === LOADING === */
    .loading {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-muted);
      font-size: 14px;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* === RESPONSIVE === */
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
      .sidebar {
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
    }

    /* === DETAILS MODAL === */
    .details-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      display: none;
    }

    .details-section.open { display: block; }

    .details-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .detail-item {
      font-size: 13px;
    }

    .detail-label {
      color: var(--text-muted);
      font-size: 11px;
      margin-bottom: 2px;
    }

    .detail-value {
      font-weight: 600;
    }

    /* === HISTORY INDICATOR === */
    .history-badge {
      font-size: 10px;
      padding: 2px 6px;
      background: var(--info);
      color: white;
      border-radius: 4px;
      margin-left: 8px;
    }

    /* === DETAILS DRAWER === */
    .drawer-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 300;
      display: none;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .drawer-overlay.open { display: block; opacity: 1; }

    .drawer {
      position: fixed;
      top: 0;
      right: -600px;
      width: 600px;
      max-width: 90vw;
      height: 100vh;
      background: var(--card);
      box-shadow: -4px 0 20px rgba(0,0,0,0.15);
      z-index: 301;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    .drawer.open { right: 0; }

    .drawer-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .drawer-title {
      font-size: 20px;
      font-weight: 700;
      font-family: var(--font-serif);
      color: var(--primary);
    }

    .drawer-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-muted);
      padding: 4px 8px;
    }
    .drawer-close:hover { color: var(--text); }

    .drawer-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .drawer-section {
      margin-bottom: 24px;
    }

    .drawer-section-title {
      font-size: 15px;
      font-weight: 700;
      font-family: var(--font-serif);
      text-transform: none;
      letter-spacing: 0;
      color: var(--primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .drawer-section-title .count {
      background: var(--bg);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
    }

    /* === TABLE DESIGN FOR DETAILS === */
    .detail-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .detail-table th {
      text-align: left;
      padding: 10px 12px;
      background: var(--primary);
      color: white;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
    }

    .detail-table td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }

    .detail-table tr:hover {
      background: var(--accent-light);
    }

    .detail-table .ticker {
      font-weight: 700;
      color: var(--accent);
    }

    .detail-table .date {
      color: var(--text-muted);
      font-size: 11px;
      white-space: nowrap;
    }

    .detail-table .notes {
      max-width: 280px;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-muted);
      font-size: 11px;
      line-height: 1.4;
    }

    .detail-table .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      margin-right: 4px;
    }

    .detail-table .tag.buy { background: #e0f0ea; color: #305f50; }
    .detail-table .tag.sell { background: #fce8e6; color: #cf2014; }
    .detail-table .tag.neutral { background: var(--greige); color: var(--text-muted); }

    .drawer-tabs {
      display: flex;
      border-bottom: 2px solid var(--border);
      margin-bottom: 0;
      background: var(--bg);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .drawer-tab {
      padding: 12px 20px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      background: none;
      color: var(--text-muted);
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s ease;
    }

    .drawer-tab:hover { color: var(--primary); }
    .drawer-tab.active {
      color: var(--primary);
      border-bottom-color: var(--secondary-red);
    }

    .drawer-tab .badge {
      background: var(--bg);
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 10px;
      margin-left: 6px;
    }

    .drawer-panel { display: none; }
    .drawer-panel.active { display: block; }

    .details-btn {
      width: 100%;
      margin-top: 20px;
      padding: 12px 16px;
      background: var(--soft-greige);
      border: 1px solid var(--border);
      border-radius: var(--radius-pill);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: var(--primary);
      transition: all 0.2s ease;
    }
    .details-btn:hover {
      border-color: var(--primary);
      color: white;
      background: var(--primary);
    }

    /* === CLIENT GOALS === */
    .goals-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .goal-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px;
      background: var(--greige);
      border-radius: 8px;
    }
    .goal-icon {
      font-size: 20px;
      line-height: 1;
    }
    .goal-text {
      flex: 1;
    }
    .goal-name {
      font-weight: 700;
      font-size: 14px;
      font-family: var(--font-serif);
      color: var(--primary);
    }
    .goal-desc {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* === BEST CONTACT TIME === */
    .contact-time-box {
      padding: 12px;
      background: linear-gradient(135deg, var(--accent-light), #e0f2f1);
      border-radius: 8px;
      border: 1px solid var(--accent);
    }
    .contact-time-main {
      display: flex;
      align-items: baseline;
      gap: 12px;
      margin-bottom: 8px;
    }
    .contact-day {
      font-size: 22px;
      font-weight: 700;
      font-family: var(--font-serif);
      color: var(--primary);
    }
    .contact-hours {
      font-size: 14px;
      color: var(--text);
      font-weight: 500;
    }
    .contact-confidence {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 4px;
      display: inline-block;
    }
    .confidence-high { background: #dcfce7; color: #16a34a; }
    .confidence-medium { background: #fef9c3; color: #ca8a04; }
    .confidence-low { background: #f3f4f6; color: #6b7280; }

    /* === ANALYST OVERRIDE === */
    .analyst-override-box {
      background: linear-gradient(135deg, #fefce8, #fef3c7);
      border: 1px solid #fbbf24;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .override-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .override-icon {
      font-size: 20px;
    }
    .override-title {
      font-weight: 700;
      font-size: 16px;
      font-family: var(--font-serif);
      color: #92400e;
    }
    .override-subtitle {
      font-size: 12px;
      color: #a16207;
    }
    .override-search {
      position: relative;
    }
    .stock-search-input {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #fbbf24;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      outline: none;
    }
    .stock-search-input:focus {
      border-color: #f59e0b;
      box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.2);
    }
    .stock-search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 100;
      box-shadow: var(--shadow-lg);
      margin-top: 4px;
    }
    .stock-search-item {
      padding: 10px 14px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: background 0.1s;
    }
    .stock-search-item:last-child { border-bottom: none; }
    .stock-search-item:hover {
      background: var(--accent-light);
    }
    .stock-search-ticker {
      font-weight: 700;
      font-size: 14px;
      color: var(--accent);
    }
    .stock-search-name {
      font-size: 13px;
      color: var(--text);
    }
    .stock-search-meta {
      font-size: 11px;
      color: var(--text-muted);
    }
    .empty-search {
      padding: 20px;
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
    }

    /* === STOCK DETAIL MODAL === */
    .stock-detail-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 400;
      display: none;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .stock-detail-overlay.open { display: block; opacity: 1; }

    .stock-detail-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 700px;
      max-height: 85vh;
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25);
      z-index: 401;
      display: none;
      overflow: hidden;
    }
    .stock-detail-modal.open { display: block; }

    .stock-detail-header {
      padding: 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent-dark) 100%);
      color: white;
    }

    .stock-detail-ticker {
      font-size: 32px;
      font-weight: 700;
      font-family: var(--font-serif);
    }

    .stock-detail-name {
      font-size: 14px;
      opacity: 0.85;
      margin-top: 4px;
    }

    .stock-detail-price-container {
      text-align: right;
    }

    .stock-detail-price {
      font-size: 36px;
      font-weight: 700;
      font-family: var(--font-serif);
    }

    .stock-detail-change {
      font-size: 16px;
      font-weight: 600;
      margin-top: 4px;
    }
    .stock-detail-change.positive { color: #4ade80; }
    .stock-detail-change.negative { color: #f87171; }

    .stock-detail-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(255,255,255,0.2);
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      color: white;
      transition: background 0.2s;
    }
    .stock-detail-close:hover { background: rgba(255,255,255,0.3); }

    .stock-detail-body {
      padding: 24px;
      overflow-y: auto;
      max-height: calc(85vh - 160px);
    }

    .stock-detail-metrics {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .stock-metric-box {
      background: var(--bg);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      border: 1px solid var(--border);
    }

    .stock-metric-box .label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .stock-metric-box .value {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
    }

    .stock-detail-section {
      margin-bottom: 24px;
    }

    .stock-detail-section-title {
      font-size: 15px;
      font-weight: 700;
      font-family: var(--font-serif);
      color: var(--primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stock-price-range {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg);
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .price-range-bar {
      flex: 1;
      height: 8px;
      background: linear-gradient(90deg, #f87171 0%, #fbbf24 50%, #4ade80 100%);
      border-radius: 4px;
      position: relative;
    }

    .price-range-marker {
      position: absolute;
      top: -4px;
      width: 16px;
      height: 16px;
      background: var(--primary);
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transform: translateX(-50%);
    }

    .price-range-label {
      font-size: 12px;
      color: var(--text-muted);
      min-width: 50px;
    }
    .price-range-label.high { text-align: right; }

    .news-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .news-item {
      padding: 14px;
      background: var(--bg);
      border-radius: 10px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
    }
    .news-item:hover {
      border-color: var(--primary);
      transform: translateX(4px);
    }

    .news-headline {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
      line-height: 1.4;
    }

    .news-meta {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .news-sentiment {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
    }
    .news-sentiment.positive { background: #dcfce7; color: #16a34a; }
    .news-sentiment.negative { background: #fef2f2; color: #dc2626; }
    .news-sentiment.neutral { background: var(--greige); color: var(--text-muted); }

    .stock-detail-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .stock-detail-error {
      padding: 20px;
      text-align: center;
      color: var(--text-muted);
      background: var(--bg);
      border-radius: 8px;
    }

    .stock-chart-container {
      background: var(--bg);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }

    .stock-chart-container canvas {
      max-height: 200px;
    }

    .chart-period-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .chart-period-btn {
      padding: 6px 12px;
      border: 1px solid var(--border);
      background: white;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .chart-period-btn:hover {
      border-color: var(--primary);
    }

    .chart-period-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    @media (max-width: 600px) {
      .stock-detail-metrics {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* === COMMUNICATION PANEL === */
    .comm-panel {
      position: fixed;
      right: -450px;
      top: 0;
      width: 450px;
      height: 100vh;
      background: var(--card);
      box-shadow: -10px 0 40px rgba(0,0,0,0.2);
      z-index: 500;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    .comm-panel.open { right: 0; }

    .comm-panel-header {
      padding: 20px 24px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent-dark) 100%);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .comm-panel-title { font-size: 18px; font-weight: 700; font-family: var(--font-serif); }
    .comm-panel-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 18px; }
    [data-theme="dark"] .comm-panel-close { background: rgba(0,0,0,0.3); }

    .comm-panel-body { flex: 1; overflow-y: auto; padding: 20px; }

    .comm-tabs { display: flex; gap: 8px; margin-bottom: 20px; }
    .comm-tab {
      flex: 1;
      padding: 10px;
      border: 1px solid var(--border);
      background: var(--bg);
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s;
    }
    .comm-tab:hover { background: var(--soft-greige); }
    .comm-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
    [data-theme="dark"] .comm-tab.active { color: #0f172a; }

    .comm-tab-icon { font-size: 20px; display: block; margin-bottom: 4px; }

    .comm-content { display: none; }
    .comm-content.active { display: block; }

    .comm-section { margin-bottom: 20px; }
    .comm-section-title { font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }

    .comm-textarea {
      width: 100%;
      min-height: 150px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: var(--font-primary);
      font-size: 14px;
      resize: vertical;
      background: var(--bg);
      color: var(--text);
    }
    .comm-textarea:focus { outline: none; border-color: var(--primary); }

    .comm-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      background: var(--bg);
      color: var(--text);
      margin-bottom: 10px;
    }

    .comm-checkbox-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
    .comm-checkbox {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--soft-greige);
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    .comm-checkbox:hover { background: var(--greige); }
    .comm-checkbox.selected { background: var(--primary); color: white; }
    [data-theme="dark"] .comm-checkbox.selected { color: #0f172a; }

    .comm-btn {
      width: 100%;
      padding: 14px;
      background: var(--gradient-primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    [data-theme="dark"] .comm-btn { color: #0f172a; }
    .comm-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
    .comm-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .comm-btn-secondary {
      background: var(--soft-greige);
      color: var(--text);
      margin-top: 10px;
    }
    .comm-btn-secondary:hover { background: var(--greige); box-shadow: none; }

    .email-preview {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
      font-size: 13px;
      line-height: 1.7;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    /* === NOTIFICATION OVERLAY === */
    .notification-container {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 600;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 380px;
    }

    .notification {
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.15);
      padding: 16px;
      display: flex;
      gap: 12px;
      animation: slideInRight 0.3s ease;
      border-left: 4px solid var(--primary);
    }
    .notification.urgent { border-left-color: #dc2626; }
    .notification.positive { border-left-color: #16a34a; }
    .notification.negative { border-left-color: #dc2626; }

    .notification-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }
    .notification.urgent .notification-icon { background: #fef2f2; }

    .notification-content { flex: 1; }
    .notification-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
    .notification-text { font-size: 12px; color: var(--text-muted); line-height: 1.5; }
    .notification-time { font-size: 10px; color: var(--text-muted); margin-top: 6px; }

    .notification-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      font-size: 16px;
    }
    .notification-close:hover { color: var(--text); }

    .notification-actions { display: flex; gap: 8px; margin-top: 10px; }
    .notification-action {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    .notification-action.primary { background: var(--primary); color: white; }
    [data-theme="dark"] .notification-action.primary { color: #0f172a; }
    .notification-action.secondary { background: var(--soft-greige); color: var(--text); }

    /* === FLOATING ACTION BUTTON === */
    .fab-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 300;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 12px;
    }

    .fab-menu {
      display: flex;
      flex-direction: column;
      gap: 8px;
      opacity: 0;
      transform: translateY(20px);
      pointer-events: none;
      transition: all 0.2s;
    }
    .fab-container.open .fab-menu { opacity: 1; transform: translateY(0); pointer-events: auto; }

    .fab-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      background: var(--card);
      border-radius: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .fab-item:hover { transform: translateX(-5px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
    .fab-item-icon { font-size: 18px; }
    .fab-item-label { font-size: 13px; font-weight: 500; }

    .fab-main {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--gradient-primary);
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
      transition: all 0.2s;
    }
    [data-theme="dark"] .fab-main { color: #0f172a; }
    .fab-main:hover { transform: scale(1.05); }
    .fab-container.open .fab-main { transform: rotate(45deg); }

    /* === NEWS ALERT BADGE === */
    .news-alert-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #dc2626;
      color: white;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
    }

    /* ========================================================================
       PREMIUM DASHBOARD - Bloomberg meets Apple Design
       ======================================================================== */

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 20px;
      padding: 20px 0;
    }

    .widget {
      background: var(--card);
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
      transition: all 0.3s ease;
    }
    .widget:hover {
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
      transform: translateY(-2px);
    }
    [data-theme="dark"] .widget:hover {
      box-shadow: 0 8px 30px rgba(16, 185, 129, 0.15);
      border-color: var(--primary);
    }

    .widget-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .widget-title {
      font-size: 14px;
      font-weight: 700;
      font-family: var(--font-serif);
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .widget-title-icon {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .widget-actions { display: flex; gap: 8px; }
    .widget-action {
      background: var(--soft-greige);
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s;
    }
    .widget-action:hover { background: var(--greige); color: var(--text); }

    .widget-body { padding: 20px; }
    .widget-body.no-padding { padding: 0; }

    /* Widget Sizes */
    .widget-full { grid-column: span 12; }
    .widget-half { grid-column: span 6; }
    .widget-third { grid-column: span 4; }
    .widget-quarter { grid-column: span 3; }
    .widget-two-thirds { grid-column: span 8; }

    @media (max-width: 1200px) {
      .widget-third { grid-column: span 6; }
      .widget-quarter { grid-column: span 6; }
      .widget-two-thirds { grid-column: span 12; }
    }
    @media (max-width: 768px) {
      .widget-half, .widget-third, .widget-quarter { grid-column: span 12; }
    }

    /* === SECTOR HEATMAP === */
    .heatmap-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    .heatmap-cell {
      padding: 16px 12px;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    .heatmap-cell::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 100%);
    }
    .heatmap-cell:hover { transform: scale(1.03); }
    .heatmap-sector {
      font-size: 11px;
      font-weight: 600;
      opacity: 0.9;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .heatmap-value {
      font-size: 18px;
      font-weight: 700;
    }
    .heatmap-cell.positive { background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; }
    .heatmap-cell.negative { background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); color: white; }
    .heatmap-cell.neutral { background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%); color: white; }
    [data-theme="dark"] .heatmap-cell.positive { color: #0f172a; }
    [data-theme="dark"] .heatmap-cell.negative { color: #0f172a; }

    /* === EARNINGS CALENDAR === */
    .earnings-list { display: flex; flex-direction: column; gap: 12px; }
    .earnings-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 14px 16px;
      background: var(--soft-greige);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .earnings-item:hover { background: var(--greige); transform: translateX(4px); }
    .earnings-date {
      min-width: 50px;
      text-align: center;
    }
    .earnings-date-day {
      font-size: 22px;
      font-weight: 700;
      color: var(--primary);
      line-height: 1;
    }
    .earnings-date-month {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
    }
    .earnings-info { flex: 1; }
    .earnings-ticker {
      font-weight: 700;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .earnings-company { font-size: 12px; color: var(--text-muted); }
    .earnings-estimate {
      text-align: right;
    }
    .earnings-estimate-label { font-size: 10px; color: var(--text-muted); }
    .earnings-estimate-value { font-size: 16px; font-weight: 700; }
    .earnings-surprise {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }
    .earnings-surprise.beat { background: #dcfce7; color: #16a34a; }
    .earnings-surprise.miss { background: #fef2f2; color: #dc2626; }

    /* === MORNING BRIEFING === */
    .briefing-content {
      font-size: 14px;
      line-height: 1.8;
      color: var(--text);
    }
    .briefing-section {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }
    .briefing-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .briefing-section-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .briefing-highlight {
      background: linear-gradient(135deg, var(--primary-light) 0%, transparent 100%);
      padding: 12px 16px;
      border-radius: 10px;
      border-left: 3px solid var(--primary);
      margin: 12px 0;
    }

    /* === CLIENT SIMILARITY === */
    .similar-clients { display: flex; flex-direction: column; gap: 12px; }
    .similar-client {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 16px;
      background: var(--soft-greige);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .similar-client:hover { background: var(--greige); }
    .similar-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--gradient-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: white;
      font-size: 16px;
    }
    [data-theme="dark"] .similar-avatar { color: #0f172a; }
    .similar-info { flex: 1; }
    .similar-name { font-weight: 600; font-size: 14px; }
    .similar-reason { font-size: 12px; color: var(--text-muted); }
    .similar-score {
      background: var(--primary-light);
      color: var(--primary);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
    }

    /* === ACTION ITEMS === */
    .action-items { display: flex; flex-direction: column; gap: 10px; }
    .action-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px 16px;
      background: var(--soft-greige);
      border-radius: 12px;
      border-left: 3px solid var(--primary);
      transition: all 0.2s;
    }
    .action-item.urgent { border-left-color: #dc2626; }
    .action-item.warning { border-left-color: #f59e0b; }
    .action-item:hover { background: var(--greige); }
    .action-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
    }
    .action-checkbox:hover { border-color: var(--primary); }
    .action-checkbox.done { background: var(--primary); border-color: var(--primary); color: white; }
    [data-theme="dark"] .action-checkbox.done { color: #0f172a; }
    .action-content { flex: 1; }
    .action-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
    .action-meta { font-size: 12px; color: var(--text-muted); display: flex; gap: 12px; }
    .action-priority {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .action-priority.high { background: #fef2f2; color: #dc2626; }
    .action-priority.medium { background: #fffbeb; color: #d97706; }
    .action-priority.low { background: #f0fdf4; color: #16a34a; }

    /* === PIPELINE TRACKER === */
    .pipeline {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      padding-bottom: 10px;
    }
    .pipeline-stage {
      min-width: 200px;
      background: var(--soft-greige);
      border-radius: 12px;
      padding: 16px;
    }
    .pipeline-stage-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .pipeline-stage-title {
      font-weight: 600;
      font-size: 13px;
    }
    .pipeline-stage-count {
      background: var(--bg);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
    }
    .pipeline-clients { display: flex; flex-direction: column; gap: 8px; }
    .pipeline-client {
      background: var(--card);
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }
    .pipeline-client:hover { border-color: var(--primary); }
    .pipeline-client-name { font-weight: 600; margin-bottom: 2px; }
    .pipeline-client-info { color: var(--text-muted); font-size: 11px; }

    /* === LEADERBOARD === */
    .leaderboard { display: flex; flex-direction: column; gap: 8px; }
    .leaderboard-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 16px;
      background: var(--soft-greige);
      border-radius: 12px;
    }
    .leaderboard-item:first-child { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
    .leaderboard-item:nth-child(2) { background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%); }
    .leaderboard-item:nth-child(3) { background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%); }
    .leaderboard-rank {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--card);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 12px;
    }
    .leaderboard-info { flex: 1; }
    .leaderboard-name { font-weight: 600; font-size: 14px; }
    .leaderboard-stats { font-size: 11px; color: var(--text-muted); }
    .leaderboard-score {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
    }

    /* === STOCK COMPARISON === */
    .comparison-header {
      display: grid;
      grid-template-columns: 150px repeat(3, 1fr);
      gap: 16px;
      padding: 12px 16px;
      background: var(--soft-greige);
      border-radius: 10px;
      margin-bottom: 12px;
    }
    .comparison-ticker {
      text-align: center;
    }
    .comparison-ticker-symbol {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
    }
    .comparison-ticker-name {
      font-size: 11px;
      color: var(--text-muted);
    }
    .comparison-row {
      display: grid;
      grid-template-columns: 150px repeat(3, 1fr);
      gap: 16px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
    }
    .comparison-row:last-child { border-bottom: none; }
    .comparison-label {
      font-size: 13px;
      color: var(--text-muted);
    }
    .comparison-value {
      text-align: center;
      font-weight: 600;
    }
    .comparison-value.best { color: var(--primary); }

    /* === TECHNICAL INDICATORS === */
    .indicator-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    .indicator-card {
      background: var(--soft-greige);
      padding: 16px;
      border-radius: 12px;
      text-align: center;
    }
    .indicator-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .indicator-value {
      font-size: 24px;
      font-weight: 700;
    }
    .indicator-signal {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      margin-top: 8px;
    }
    .indicator-signal.buy { background: #dcfce7; color: #16a34a; }
    .indicator-signal.sell { background: #fef2f2; color: #dc2626; }
    .indicator-signal.neutral { background: #f3f4f6; color: #6b7280; }

    /* === QUICK METRICS ROW === */
    .metrics-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }
    .metric-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s;
    }
    .metric-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.1);
    }
    [data-theme="dark"] .metric-card:hover {
      box-shadow: 0 12px 40px rgba(16, 185, 129, 0.15);
      border-color: var(--primary);
    }
    .metric-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      margin: 0 auto 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    .metric-icon.green { background: linear-gradient(135deg, #10b981 0%, #34d399 100%); color: white; }
    .metric-icon.blue { background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); color: white; }
    .metric-icon.purple { background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); color: white; }
    .metric-icon.orange { background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); color: white; }
    [data-theme="dark"] .metric-icon { color: #0f172a; }
    .metric-value {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .metric-label {
      font-size: 12px;
      color: var(--text-muted);
    }
    .metric-trend {
      font-size: 11px;
      margin-top: 8px;
      padding: 4px 10px;
      border-radius: 20px;
      display: inline-block;
    }
    .metric-trend.up { background: #dcfce7; color: #16a34a; }
    .metric-trend.down { background: #fef2f2; color: #dc2626; }

    /* ========================================================================
       COLLABORATION FEATURES
       ======================================================================== */

    /* Team Chat */
    .team-chat {
      display: flex;
      flex-direction: column;
      height: 400px;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .chat-message {
      display: flex;
      gap: 10px;
      max-width: 85%;
    }
    .chat-message.own {
      align-self: flex-end;
      flex-direction: row-reverse;
    }
    .chat-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--gradient-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      color: white;
      flex-shrink: 0;
    }
    [data-theme="dark"] .chat-avatar { color: #0f172a; }
    .chat-bubble {
      background: var(--soft-greige);
      padding: 10px 14px;
      border-radius: 16px;
      border-top-left-radius: 4px;
      font-size: 13px;
      line-height: 1.5;
    }
    .chat-message.own .chat-bubble {
      background: var(--primary);
      color: white;
      border-top-left-radius: 16px;
      border-top-right-radius: 4px;
    }
    [data-theme="dark"] .chat-message.own .chat-bubble { color: #0f172a; }
    .chat-meta {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    .chat-input-container {
      display: flex;
      gap: 10px;
      padding: 16px;
      border-top: 1px solid var(--border);
    }
    .chat-input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 13px;
      background: var(--bg);
      color: var(--text);
    }
    .chat-input:focus { outline: none; border-color: var(--primary); }
    .chat-send {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--gradient-primary);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    [data-theme="dark"] .chat-send { color: #0f172a; }

    /* Shared Watchlist */
    .watchlist-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .watchlist-members {
      display: flex;
      gap: -8px;
    }
    .watchlist-member {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--gradient-primary);
      border: 2px solid var(--card);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 700;
      color: white;
      margin-left: -8px;
    }
    .watchlist-member:first-child { margin-left: 0; }
    [data-theme="dark"] .watchlist-member { color: #0f172a; }
    .watchlist-items { display: flex; flex-direction: column; gap: 8px; }
    .watchlist-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      background: var(--soft-greige);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .watchlist-item:hover { background: var(--greige); }
    .watchlist-ticker { font-weight: 700; font-size: 14px; min-width: 60px; }
    .watchlist-name { flex: 1; font-size: 12px; color: var(--text-muted); }
    .watchlist-change { font-weight: 600; font-size: 13px; }
    .watchlist-change.up { color: #16a34a; }
    .watchlist-change.down { color: #dc2626; }
    .watchlist-added-by { font-size: 10px; color: var(--text-muted); }

    /* Client Handoff */
    .handoff-card {
      background: var(--soft-greige);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .handoff-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    .handoff-client { font-size: 18px; font-weight: 700; font-family: var(--font-serif); }
    .handoff-status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }
    .handoff-status.pending { background: #fef3c7; color: #d97706; }
    .handoff-status.accepted { background: #dcfce7; color: #16a34a; }
    .handoff-section { margin-bottom: 16px; }
    .handoff-section-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    .handoff-notes {
      font-size: 13px;
      line-height: 1.6;
      color: var(--text);
    }
    .handoff-actions { display: flex; gap: 10px; }

    /* ========================================================================
       REPORTS & EXPORT
       ======================================================================== */

    .report-templates {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    .report-template {
      background: var(--soft-greige);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
    }
    .report-template:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.1);
    }
    .report-template.selected { border-color: var(--primary); background: var(--primary-light); }
    .report-template-icon {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      margin: 0 auto 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
    }
    .report-template-icon.pdf { background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); color: white; }
    .report-template-icon.ppt { background: linear-gradient(135deg, #ea580c 0%, #f97316 100%); color: white; }
    .report-template-icon.excel { background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%); color: white; }
    .report-template-name { font-weight: 700; font-size: 16px; margin-bottom: 4px; }
    .report-template-desc { font-size: 12px; color: var(--text-muted); }

    .report-options { margin-bottom: 24px; }
    .report-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: var(--soft-greige);
      border-radius: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .report-option:hover { background: var(--greige); }
    .report-option.selected { background: var(--primary-light); border: 1px solid var(--primary); }
    .report-option-check {
      width: 22px;
      height: 22px;
      border: 2px solid var(--border);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .report-option.selected .report-option-check {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    [data-theme="dark"] .report-option.selected .report-option-check { color: #0f172a; }
    .report-option-text { flex: 1; }
    .report-option-title { font-weight: 600; font-size: 14px; }
    .report-option-desc { font-size: 12px; color: var(--text-muted); }

    .report-preview {
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 32px;
      min-height: 400px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    [data-theme="dark"] .report-preview { background: var(--card); }
    .report-preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--primary);
      margin-bottom: 24px;
    }
    .report-preview-logo { font-size: 24px; font-weight: 700; color: var(--primary); }
    .report-preview-date { font-size: 12px; color: var(--text-muted); }
    .report-preview-title {
      font-size: 28px;
      font-weight: 700;
      font-family: var(--font-serif);
      margin-bottom: 8px;
    }
    .report-preview-subtitle { font-size: 14px; color: var(--text-muted); margin-bottom: 24px; }

    /* ========================================================================
       ADVANCED ANALYTICS
       ======================================================================== */

    /* Portfolio Optimizer */
    .optimizer-chart {
      height: 300px;
      background: var(--soft-greige);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }
    .efficient-frontier {
      position: absolute;
      inset: 20px;
    }
    .frontier-point {
      position: absolute;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--primary);
      transform: translate(-50%, -50%);
      cursor: pointer;
      transition: all 0.2s;
    }
    .frontier-point:hover {
      transform: translate(-50%, -50%) scale(1.5);
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
    }
    .frontier-point.current { background: #3b82f6; width: 16px; height: 16px; }
    .frontier-point.optimal { background: #f59e0b; width: 16px; height: 16px; }
    .optimizer-legend {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-top: 16px;
    }
    .optimizer-legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }
    .optimizer-legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    /* Monte Carlo Simulation */
    .monte-carlo-chart {
      height: 250px;
      background: var(--soft-greige);
      border-radius: 12px;
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }
    .simulation-paths {
      position: absolute;
      inset: 0;
    }
    .simulation-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    .simulation-stat {
      background: var(--soft-greige);
      padding: 16px;
      border-radius: 10px;
      text-align: center;
    }
    .simulation-stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px; }
    .simulation-stat-value { font-size: 20px; font-weight: 700; }
    .simulation-stat-value.positive { color: #16a34a; }
    .simulation-stat-value.negative { color: #dc2626; }

    /* Backtesting */
    .backtest-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .backtest-control {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .backtest-control label {
      font-size: 12px;
      color: var(--text-muted);
    }
    .backtest-control select, .backtest-control input {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
      background: var(--bg);
      color: var(--text);
    }
    .backtest-results {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    .backtest-metric {
      background: var(--soft-greige);
      padding: 20px;
      border-radius: 12px;
    }
    .backtest-metric-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .backtest-metric-title { font-weight: 600; font-size: 14px; }
    .backtest-metric-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }
    .backtest-metric-badge.win { background: #dcfce7; color: #16a34a; }
    .backtest-metric-badge.loss { background: #fef2f2; color: #dc2626; }
    .backtest-metric-value { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
    .backtest-metric-comparison { font-size: 12px; color: var(--text-muted); }

    /* What-If Analysis */
    .whatif-scenarios {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }
    .whatif-scenario {
      background: var(--soft-greige);
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    .whatif-scenario:hover { background: var(--greige); }
    .whatif-scenario.selected { border-color: var(--primary); background: var(--primary-light); }
    .whatif-scenario-icon { font-size: 24px; margin-bottom: 12px; }
    .whatif-scenario-name { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
    .whatif-scenario-desc { font-size: 12px; color: var(--text-muted); }
    .whatif-impact {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
    }
    .whatif-impact-title { font-weight: 700; font-size: 16px; margin-bottom: 16px; }
    .whatif-impact-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }
    .whatif-impact-item { text-align: center; }
    .whatif-impact-sector { font-size: 12px; color: var(--text-muted); margin-bottom: 6px; }
    .whatif-impact-value { font-size: 20px; font-weight: 700; }
    .whatif-impact-value.positive { color: #16a34a; }
    .whatif-impact-value.negative { color: #dc2626; }

    /* ========================================================================
       ULTRA-OPTIMIZED COLLABORATION LAYOUT
       ======================================================================== */

    .collab-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto auto;
      gap: 24px;
      padding: 24px;
    }

    .collab-section {
      background: var(--card);
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .collab-section:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    .chat-section {
      grid-column: 1;
      grid-row: 1 / 3;
      display: flex;
      flex-direction: column;
      min-height: 500px;
    }

    .watchlist-section {
      grid-column: 2;
      grid-row: 1;
    }

    .handoff-section {
      grid-column: 2;
      grid-row: 2;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }

    .section-header.glass-effect {
      background: linear-gradient(180deg, var(--card) 0%, rgba(255,255,255,0.95) 100%);
      backdrop-filter: blur(10px);
    }

    [data-theme="dark"] .section-header.glass-effect {
      background: linear-gradient(180deg, var(--card) 0%, rgba(30,41,59,0.95) 100%);
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .section-title h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
    }

    .section-icon {
      font-size: 20px;
    }

    .section-icon.pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .online-indicator {
      font-size: 11px;
      color: #16a34a;
      background: #dcfce7;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 600;
    }

    [data-theme="dark"] .online-indicator {
      background: rgba(16, 185, 129, 0.2);
      color: #34d399;
    }

    .section-actions {
      display: flex;
      gap: 8px;
    }

    .btn-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s;
    }

    .btn-icon:hover {
      background: var(--primary);
      border-color: var(--primary);
      transform: scale(1.05);
    }

    .btn-create {
      padding: 8px 16px;
      border-radius: 10px;
      border: none;
      background: var(--primary);
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    [data-theme="dark"] .btn-create { color: #0f172a; }

    .btn-create:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    /* Chat Container */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: var(--bg);
    }

    [data-theme="dark"] .chat-container {
      background: var(--bg-darker);
    }

    .chat-message {
      display: flex;
      gap: 12px;
      max-width: 80%;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .chat-message.incoming {
      align-self: flex-start;
    }

    .chat-message.outgoing {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .chat-content {
      background: var(--card);
      border-radius: 16px;
      padding: 12px 16px;
      border: 1px solid var(--border);
    }

    .chat-message.outgoing .chat-content {
      background: var(--primary);
      border-color: var(--primary);
    }

    .chat-message.outgoing .chat-content,
    .chat-message.outgoing .chat-sender,
    .chat-message.outgoing .chat-time,
    .chat-message.outgoing .chat-text {
      color: white;
    }

    [data-theme="dark"] .chat-message.outgoing .chat-content,
    [data-theme="dark"] .chat-message.outgoing .chat-sender,
    [data-theme="dark"] .chat-message.outgoing .chat-time,
    [data-theme="dark"] .chat-message.outgoing .chat-text {
      color: #0f172a;
    }

    .chat-sender {
      font-weight: 600;
      font-size: 13px;
      margin-right: 8px;
    }

    .chat-time {
      font-size: 11px;
      color: var(--text-muted);
    }

    .chat-text {
      font-size: 14px;
      line-height: 1.5;
      margin-top: 6px;
    }

    .chat-input-area {
      display: flex;
      gap: 12px;
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      background: var(--card);
    }

    .chat-input-area input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-size: 14px;
      background: var(--bg);
      color: var(--text);
    }

    .chat-input-area input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .btn-send {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: 12px;
      border: none;
      background: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    [data-theme="dark"] .btn-send { color: #0f172a; }

    .btn-send:hover {
      transform: translateX(2px);
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    .send-icon {
      font-size: 16px;
    }

    /* Watchlists Grid */
    .watchlists-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
    }

    .watchlist-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--soft-greige);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    [data-theme="dark"] .watchlist-card {
      background: var(--bg-darker);
    }

    .watchlist-card:hover {
      background: var(--greige);
      border-color: var(--primary);
      transform: translateX(4px);
    }

    [data-theme="dark"] .watchlist-card:hover {
      background: var(--card);
    }

    .watchlist-header {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .watchlist-icon {
      font-size: 24px;
    }

    .watchlist-info h4 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
    }

    .watchlist-meta {
      font-size: 12px;
      color: var(--text-muted);
    }

    .member-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 700;
      margin-left: -8px;
      border: 2px solid var(--card);
    }

    [data-theme="dark"] .member-avatar { color: #0f172a; }

    .member-avatar:first-child { margin-left: 0; }

    .watchlist-performance {
      text-align: right;
    }

    .perf-value {
      font-size: 16px;
      font-weight: 700;
    }

    .watchlist-performance.positive .perf-value { color: #16a34a; }
    .watchlist-performance.negative .perf-value { color: #dc2626; }

    .perf-label {
      font-size: 11px;
      color: var(--text-muted);
      display: block;
    }

    /* Handoff Cards */
    .handoff-list {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .handoff-card {
      background: var(--soft-greige);
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.2s;
    }

    [data-theme="dark"] .handoff-card {
      background: var(--bg-darker);
    }

    .handoff-card:hover {
      box-shadow: var(--shadow-md);
    }

    .handoff-status-bar {
      height: 4px;
      background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%);
    }

    .handoff-status-bar.completed {
      background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
    }

    .handoff-content {
      padding: 16px;
    }

    .handoff-content h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      font-weight: 600;
    }

    .handoff-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .handoff-badge.in-progress {
      background: #fef3c7;
      color: #d97706;
    }

    .handoff-badge.completed {
      background: #dcfce7;
      color: #16a34a;
    }

    [data-theme="dark"] .handoff-badge.in-progress {
      background: rgba(245, 158, 11, 0.2);
      color: #fbbf24;
    }

    [data-theme="dark"] .handoff-badge.completed {
      background: rgba(16, 185, 129, 0.2);
      color: #34d399;
    }

    .handoff-details {
      display: flex;
      gap: 20px;
      margin: 12px 0;
    }

    .handoff-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .handoff-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .handoff-value {
      font-size: 13px;
      font-weight: 600;
    }

    .handoff-progress {
      margin: 12px 0;
    }

    .progress-bar {
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .progress-text {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
      display: block;
    }

    .handoff-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .btn-sm {
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .btn-sm.btn-primary {
      background: var(--primary);
      color: white;
    }

    [data-theme="dark"] .btn-sm.btn-primary { color: #0f172a; }

    .btn-sm.btn-secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }

    .btn-sm:hover {
      transform: scale(1.02);
    }

    /* ========================================================================
       ULTRA-OPTIMIZED REPORTS LAYOUT
       ======================================================================== */

    .reports-layout {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: 24px;
      padding: 24px;
    }

    .report-generator {
      background: var(--card);
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .generator-header {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }

    .generator-icon {
      font-size: 32px;
    }

    .generator-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }

    .generator-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin: 4px 0 0 0;
    }

    .generator-body {
      padding: 24px;
    }

    .report-type-selector {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .report-type {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: var(--soft-greige);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    [data-theme="dark"] .report-type {
      background: var(--bg-darker);
    }

    .report-type:hover {
      border-color: var(--border);
    }

    .report-type.selected {
      border-color: var(--primary);
      background: rgba(16, 185, 129, 0.05);
    }

    .type-icon {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: white;
    }

    .type-icon.pdf { background: linear-gradient(135deg, #dc2626, #ef4444); }
    .type-icon.pptx { background: linear-gradient(135deg, #ea580c, #f97316); }
    .type-icon.xlsx { background: linear-gradient(135deg, #16a34a, #22c55e); }

    .type-name {
      font-weight: 600;
      font-size: 14px;
      display: block;
    }

    .type-desc {
      font-size: 12px;
      color: var(--text-muted);
    }

    .report-options {
      display: grid;
      gap: 16px;
      margin-bottom: 24px;
    }

    .option-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }

    .option-group select {
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 14px;
      background: var(--bg);
      color: var(--text);
    }

    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      cursor: pointer;
    }

    .checkbox-item input {
      width: 16px;
      height: 16px;
      accent-color: var(--primary);
    }

    .report-preview-section {
      margin-bottom: 24px;
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .preview-header h4 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
    }

    .btn-refresh {
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: transparent;
      font-size: 12px;
      cursor: pointer;
      color: var(--text);
    }

    .preview-container {
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      min-height: 200px;
      box-shadow: var(--shadow);
      transition: opacity 0.3s;
    }

    [data-theme="dark"] .preview-container {
      background: var(--bg-darker);
    }

    .preview-page {
      max-width: 100%;
    }

    .preview-header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--primary);
      margin-bottom: 16px;
    }

    .preview-logo {
      height: 24px;
    }

    .preview-date {
      font-size: 12px;
      color: var(--text-muted);
    }

    .preview-title {
      font-size: 20px;
      font-weight: 700;
      font-family: var(--font-serif);
      margin-bottom: 4px;
    }

    .preview-subtitle {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .placeholder-line {
      height: 12px;
      background: var(--border);
      border-radius: 4px;
      margin-bottom: 8px;
    }

    .placeholder-line.full { width: 100%; }
    .placeholder-line.half { width: 50%; }

    .placeholder-chart {
      height: 80px;
      background: var(--soft-greige);
      border-radius: 8px;
      margin-top: 16px;
    }

    [data-theme="dark"] .placeholder-chart {
      background: var(--card);
    }

    /* ========================================================================
       PROFESSIONAL EQUITY RESEARCH REPORT PREVIEW
       ======================================================================== */

    .research-report-preview {
      background: var(--light);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-natural);
      margin-top: var(--space-lg);
    }

    .research-report-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-md) var(--space-lg);
      background: var(--primary);
      color: white;
    }

    .report-branding {
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }

    .report-branding .report-logo {
      height: 28px;
      filter: brightness(0) invert(1);
    }

    .report-branding .report-division {
      font-size: var(--text-small);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      padding-left: var(--space-md);
      border-left: 1px solid rgba(255,255,255,0.3);
    }

    .report-meta-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
    }

    .report-meta-info .report-date {
      font-size: var(--text-small);
      opacity: 0.9;
    }

    .report-meta-info .report-type-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      background: rgba(255,255,255,0.2);
      padding: 2px 8px;
      border-radius: var(--radius-pill);
    }

    .research-report-body {
      padding: var(--space-lg);
    }

    /* Rating Banner */
    .rating-banner {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: var(--space-lg);
      align-items: center;
      padding: var(--space-lg);
      background: var(--soft-greige);
      border-radius: var(--radius);
      margin-bottom: var(--space-lg);
    }

    .rating-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .rating-left .company-ticker {
      font-family: monospace;
      font-size: var(--text-h3);
      font-weight: 700;
      color: var(--primary);
    }

    .rating-left .company-name {
      font-size: var(--text-body);
      font-weight: 600;
      color: var(--text);
    }

    .rating-left .company-sector {
      font-size: var(--text-small);
      color: var(--text-muted);
    }

    .rating-center {
      display: flex;
      justify-content: center;
    }

    .rating-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: var(--space-md) var(--space-xl);
      border-radius: var(--radius);
      text-align: center;
    }

    .rating-box.outperform {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }

    .rating-box.neutral {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
    }

    .rating-box.underperform {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }

    .rating-box .rating-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.9;
    }

    .rating-box .rating-value {
      font-size: var(--text-h4);
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .rating-right {
      display: flex;
      justify-content: flex-end;
    }

    .target-box {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
    }

    .target-box .target-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .target-box .target-value {
      font-size: var(--text-h3);
      font-weight: 700;
      color: var(--primary);
      font-family: var(--font-serif);
    }

    .target-box .target-upside {
      font-size: var(--text-small);
      font-weight: 600;
      color: #10b981;
    }

    /* Metrics Strip */
    .metrics-strip {
      display: flex;
      justify-content: space-between;
      padding: var(--space-md) 0;
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      margin-bottom: var(--space-lg);
    }

    .metrics-strip .metric-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .metrics-strip .metric-key {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metrics-strip .metric-val {
      font-size: var(--text-label);
      font-weight: 700;
      color: var(--text);
      font-family: monospace;
    }

    /* Report Sections */
    .report-section {
      margin-bottom: var(--space-lg);
    }

    .report-section .section-heading {
      font-size: var(--text-body);
      font-weight: 700;
      color: var(--primary);
      margin-bottom: var(--space-sm);
      padding-bottom: var(--space-xs);
      border-bottom: 2px solid var(--primary);
      display: inline-block;
    }

    .summary-bullets {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }

    .bullet-point {
      display: flex;
      gap: var(--space-sm);
      align-items: flex-start;
    }

    .bullet-point .bullet-icon {
      color: var(--primary);
      font-size: 10px;
      margin-top: 4px;
      flex-shrink: 0;
    }

    .bullet-point .bullet-text {
      font-size: var(--text-small);
      line-height: 1.6;
      color: var(--text);
    }

    .thesis-text {
      font-size: var(--text-small);
      line-height: 1.7;
      color: var(--text);
    }

    /* Financials Table */
    .financials-table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--text-small);
    }

    .financials-table th {
      background: var(--primary);
      color: white;
      padding: 8px 12px;
      text-align: right;
      font-weight: 600;
      font-size: 11px;
    }

    .financials-table th:first-child {
      text-align: left;
    }

    .financials-table td {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      text-align: right;
      font-family: monospace;
    }

    .financials-table td:first-child {
      text-align: left;
      font-family: var(--font-primary);
      font-weight: 500;
    }

    .financials-table tbody tr:hover {
      background: var(--soft-greige);
    }

    /* Analyst Footer */
    .analyst-footer {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      padding-top: var(--space-lg);
      margin-top: var(--space-lg);
      border-top: 1px solid var(--border);
    }

    .analyst-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .analyst-info .analyst-name {
      font-weight: 700;
      font-size: var(--text-label);
      color: var(--primary);
    }

    .analyst-info .analyst-title {
      font-size: var(--text-small);
      color: var(--text-muted);
    }

    .analyst-info .analyst-contact {
      font-size: 11px;
      color: var(--text-muted);
    }

    .disclaimer-mini {
      font-size: 10px;
      color: var(--text-muted);
      max-width: 300px;
      text-align: right;
      line-height: 1.4;
    }

    /* Dark mode for research report */
    [data-theme="dark"] .research-report-preview {
      background: var(--card);
    }

    [data-theme="dark"] .rating-banner {
      background: var(--bg-darker);
    }

    [data-theme="dark"] .financials-table tbody tr:hover {
      background: var(--bg-darker);
    }

    .report-actions {
      display: flex;
      gap: 12px;
    }

    .btn-generate, .btn-schedule {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 20px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .btn-generate {
      background: var(--primary);
      color: white;
    }

    [data-theme="dark"] .btn-generate { color: #0f172a; }

    .btn-generate:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
    }

    .btn-schedule {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }

    .btn-schedule:hover {
      border-color: var(--primary);
    }

    /* Recent Reports */
    .recent-reports {
      background: var(--card);
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .reports-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }

    .reports-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
    }

    .reports-filter {
      display: flex;
      gap: 4px;
    }

    .filter-btn {
      padding: 6px 12px;
      border-radius: 8px;
      border: none;
      background: transparent;
      font-size: 12px;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s;
    }

    .filter-btn.active {
      background: var(--primary);
      color: white;
    }

    [data-theme="dark"] .filter-btn.active { color: #0f172a; }

    .reports-list {
      max-height: 500px;
      overflow-y: auto;
    }

    .report-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
    }

    .report-item:hover {
      background: var(--soft-greige);
    }

    [data-theme="dark"] .report-item:hover {
      background: var(--bg-darker);
    }

    .report-type-badge {
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      color: white;
    }

    .report-type-badge.pdf { background: #dc2626; }
    .report-type-badge.pptx { background: #ea580c; }
    .report-type-badge.xlsx { background: #16a34a; }

    .report-info {
      flex: 1;
    }

    .report-info h4 {
      margin: 0 0 4px 0;
      font-size: 14px;
      font-weight: 600;
    }

    .report-meta {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* ========================================================================
       ULTRA-OPTIMIZED ANALYTICS LAYOUT
       ======================================================================== */

    .analytics-layout {
      padding: 24px;
    }

    .analytics-toolbar {
      display: flex;
      align-items: center;
      gap: 24px;
      padding: 16px 24px;
      background: var(--card);
      border-radius: 12px;
      border: 1px solid var(--border);
      margin-bottom: 24px;
    }

    .tool-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
    }

    .tool-buttons {
      display: flex;
      gap: 8px;
    }

    .tool-btn {
      padding: 10px 18px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: transparent;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text);
    }

    .tool-btn:hover {
      border-color: var(--primary);
    }

    .tool-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    [data-theme="dark"] .tool-btn.active { color: #0f172a; }

    .analytics-panel {
      display: none;
    }

    .analytics-panel.active {
      display: block;
    }

    .section-title-modern {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0 0 20px 0;
      font-size: 16px;
      font-weight: 700;
    }

    .title-icon {
      font-size: 20px;
    }

    /* Optimizer Grid */
    .optimizer-grid {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 24px;
    }

    .optimizer-input-section {
      background: var(--card);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 24px;
    }

    .optimizer-results-section {
      background: var(--card);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 24px;
    }

    .input-card {
      margin-bottom: 20px;
    }

    .input-card label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .asset-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
    }

    [data-theme="dark"] .asset-selector {
      background: var(--bg-darker);
    }

    .asset-tag {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: var(--primary);
      color: white;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }

    [data-theme="dark"] .asset-tag { color: #0f172a; }

    .remove-tag {
      cursor: pointer;
      opacity: 0.8;
    }

    .remove-tag:hover {
      opacity: 1;
    }

    .asset-input {
      flex: 1;
      min-width: 100px;
      border: none;
      background: transparent;
      font-size: 13px;
      outline: none;
      color: var(--text);
    }

    .slider-container {
      padding: 8px 0;
    }

    .slider-container input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: var(--border);
      outline: none;
      -webkit-appearance: none;
    }

    .slider-container input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
    }

    .slider-labels {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .constraint-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      font-size: 13px;
    }

    .constraint-row input {
      width: 60px;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      text-align: center;
      background: var(--bg);
      color: var(--text);
    }

    .btn-run-analysis {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: none;
      background: var(--primary);
      color: white;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }

    [data-theme="dark"] .btn-run-analysis { color: #0f172a; }

    .btn-run-analysis:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
    }

    .chart-container-large {
      height: 300px;
      margin-bottom: 24px;
    }

    .optimal-portfolio-card {
      background: var(--soft-greige);
      border-radius: 12px;
      padding: 20px;
    }

    [data-theme="dark"] .optimal-portfolio-card {
      background: var(--bg-darker);
    }

    .optimal-portfolio-card h4 {
      margin: 0 0 16px 0;
      font-size: 14px;
      font-weight: 700;
    }

    .portfolio-metrics-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    .metric-value-lg {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
      display: block;
    }

    .metric-label-sm {
      font-size: 11px;
      color: var(--text-muted);
    }

    .allocation-bars {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .alloc-bar {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .alloc-label {
      width: 50px;
      font-size: 13px;
      font-weight: 600;
    }

    .alloc-track {
      flex: 1;
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
    }

    .alloc-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .alloc-value {
      width: 40px;
      text-align: right;
      font-size: 13px;
      font-weight: 600;
    }

    /* Monte Carlo Grid */
    .montecarlo-grid {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 24px;
    }

    .montecarlo-config, .montecarlo-results {
      background: var(--card);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 24px;
    }

    .mc-stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }

    .mc-stat-card {
      background: var(--soft-greige);
      padding: 16px;
      border-radius: 12px;
      text-align: center;
    }

    [data-theme="dark"] .mc-stat-card {
      background: var(--bg-darker);
    }

    .mc-stat-label {
      font-size: 11px;
      color: var(--text-muted);
      display: block;
      margin-bottom: 6px;
    }

    .mc-stat-value {
      font-size: 18px;
      font-weight: 700;
      display: block;
    }

    .mc-stat-change {
      font-size: 12px;
      font-weight: 600;
    }

    .mc-stat-change.positive { color: #16a34a; }
    .mc-stat-change.negative { color: #dc2626; }

    /* Backtest Layout */
    .backtest-layout {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 24px;
    }

    .backtest-config, .backtest-results {
      background: var(--card);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 24px;
    }

    .date-range-inputs {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .date-range-inputs input {
      flex: 1;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
      background: var(--bg);
      color: var(--text);
    }

    .backtest-metrics-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    .bt-metric {
      background: var(--soft-greige);
      padding: 16px;
      border-radius: 12px;
      text-align: center;
    }

    [data-theme="dark"] .bt-metric {
      background: var(--bg-darker);
    }

    .bt-metric-label {
      font-size: 11px;
      color: var(--text-muted);
      display: block;
      margin-bottom: 6px;
    }

    .bt-metric-value {
      font-size: 20px;
      font-weight: 700;
    }

    .bt-metric-value.positive { color: #16a34a; }
    .bt-metric-value.negative { color: #dc2626; }

    /* What-If Layout */
    .whatif-layout {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 24px;
    }

    .whatif-scenarios, .whatif-results {
      background: var(--card);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 24px;
    }

    .scenario-cards {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .scenario-card {
      background: var(--soft-greige);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    [data-theme="dark"] .scenario-card {
      background: var(--bg-darker);
    }

    .scenario-card:hover {
      border-color: var(--border);
    }

    .scenario-card.selected {
      border-color: var(--primary);
      background: rgba(16, 185, 129, 0.1);
    }

    .scenario-icon {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .scenario-card h4 {
      margin: 0 0 4px 0;
      font-size: 13px;
      font-weight: 700;
    }

    .scenario-card p {
      margin: 0;
      font-size: 11px;
      color: var(--text-muted);
    }

    .custom-scenario-inputs {
      display: none;
      background: var(--soft-greige);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }

    [data-theme="dark"] .custom-scenario-inputs {
      background: var(--bg-darker);
    }

    .custom-scenario-inputs h4 {
      margin: 0 0 12px 0;
      font-size: 13px;
      font-weight: 700;
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      font-size: 13px;
    }

    .input-row label {
      flex: 1;
    }

    .input-row input {
      width: 80px;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      text-align: center;
      background: var(--bg);
      color: var(--text);
    }

    .impact-summary {
      margin-bottom: 20px;
    }

    .impact-card {
      background: var(--soft-greige);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    [data-theme="dark"] .impact-card {
      background: var(--bg-darker);
    }

    .impact-card.positive {
      border-left: 4px solid #16a34a;
    }

    .impact-card.negative {
      border-left: 4px solid #dc2626;
    }

    .impact-label {
      font-size: 12px;
      color: var(--text-muted);
      display: block;
      margin-bottom: 8px;
    }

    .impact-value {
      font-size: 28px;
      font-weight: 700;
      display: block;
    }

    .impact-card.positive .impact-value { color: #16a34a; }
    .impact-card.negative .impact-value { color: #dc2626; }

    .impact-percent {
      font-size: 14px;
      font-weight: 600;
    }

    .impact-card.positive .impact-percent { color: #16a34a; }
    .impact-card.negative .impact-percent { color: #dc2626; }

    .position-impacts h4 {
      margin: 0 0 16px 0;
      font-size: 14px;
      font-weight: 700;
    }

    .impact-table {
      background: var(--soft-greige);
      border-radius: 12px;
      overflow: hidden;
    }

    [data-theme="dark"] .impact-table {
      background: var(--bg-darker);
    }

    .impact-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
    }

    .impact-row:last-child {
      border-bottom: none;
    }

    .impact-row.header {
      background: var(--card);
      font-weight: 600;
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .impact-row .ticker {
      font-weight: 700;
    }

    .impact-row .positive { color: #16a34a; font-weight: 600; }
    .impact-row .negative { color: #dc2626; font-weight: 600; }

    /* ========================================================================
       PROFESSIONAL ANIMATIONS
       ======================================================================== */

    .animate-in {
      animation: fadeSlideIn 0.3s ease;
    }

    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 0 0 rgba(0, 61, 57, 0.4); }
      50% { box-shadow: 0 0 0 10px rgba(0, 61, 57, 0); }
    }

    .tab-panel { animation: fadeSlideIn 0.25s ease; }
    .btn-primary:active { transform: scale(0.98); }
    .btn-secondary:active { transform: scale(0.98); }

    /* ========================================================================
       STRATEGY BUILDER STYLES
       ======================================================================== */

    .strategy-builder-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      padding: 24px;
    }

    .strategy-input-panel,
    .strategy-output-panel {
      background: var(--card);
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .panel-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, var(--card) 0%, var(--soft-greige) 100%);
    }

    [data-theme="dark"] .panel-header {
      background: linear-gradient(180deg, var(--card) 0%, var(--bg-darker) 100%);
    }

    .panel-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      font-family: var(--font-serif);
    }

    .panel-subtitle {
      margin: 4px 0 0 0;
      font-size: 13px;
      color: var(--text-muted);
    }

    .input-section {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
    }

    .input-section:last-of-type {
      border-bottom: none;
    }

    .input-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .thesis-input {
      width: 100%;
      min-height: 100px;
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.6;
      resize: vertical;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-primary);
    }

    .thesis-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 61, 57, 0.1);
    }

    [data-theme="dark"] .thesis-input:focus {
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15);
    }

    .params-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .param-item label {
      display: block;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .param-item select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
      background: var(--bg);
      color: var(--text);
      cursor: pointer;
    }

    .risk-params {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .risk-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: var(--soft-greige);
      border-radius: 8px;
      font-size: 13px;
    }

    [data-theme="dark"] .risk-row {
      background: var(--bg-darker);
    }

    .risk-input-group {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .risk-input-group input {
      width: 60px;
      padding: 6px 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      text-align: center;
      font-size: 13px;
      background: var(--card);
      color: var(--text);
    }

    .risk-input-group .unit {
      font-size: 12px;
      color: var(--text-muted);
    }

    .universe-selector {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .universe-option {
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--bg);
    }

    .universe-option:hover {
      border-color: var(--primary);
      background: var(--soft-greige);
    }

    [data-theme="dark"] .universe-option:hover {
      background: var(--card-hover);
    }

    .universe-option.selected {
      border-color: var(--primary);
      background: rgba(0, 61, 57, 0.08);
    }

    [data-theme="dark"] .universe-option.selected {
      background: rgba(16, 185, 129, 0.1);
    }

    .option-title {
      display: block;
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 2px;
    }

    .option-desc {
      font-size: 11px;
      color: var(--text-muted);
    }

    .strategy-actions {
      display: flex;
      gap: 12px;
      padding: 20px 24px;
      border-top: 1px solid var(--border);
      background: var(--soft-greige);
    }

    [data-theme="dark"] .strategy-actions {
      background: var(--bg-darker);
    }

    .strategy-actions .btn-secondary {
      flex: 1;
    }

    .strategy-actions .btn-primary {
      flex: 2;
    }

    .btn-primary {
      padding: 12px 24px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary:hover {
      background: var(--accent-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 61, 57, 0.2);
    }

    [data-theme="dark"] .btn-primary {
      background: var(--primary);
      color: #0f172a;
    }

    [data-theme="dark"] .btn-primary:hover {
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-secondary {
      padding: 12px 24px;
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-secondary:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-sm {
      padding: 8px 14px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-sm:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .full-width { width: 100%; }

    .output-actions {
      display: flex;
      gap: 8px;
    }

    .strategy-output-content {
      padding: 24px;
      min-height: 300px;
    }

    .output-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 60px 40px;
      color: var(--text-muted);
    }

    .output-placeholder svg {
      margin-bottom: 16px;
      opacity: 0.4;
    }

    .output-placeholder p {
      margin: 0;
      font-size: 14px;
      max-width: 300px;
      line-height: 1.6;
    }

    .quick-backtest-preview {
      border-top: 1px solid var(--border);
      padding: 20px 24px;
    }

    .quick-backtest-preview h4 {
      margin: 0 0 16px 0;
      font-size: 14px;
      font-weight: 600;
    }

    .backtest-preview-chart {
      height: 150px;
      margin-bottom: 16px;
    }

    .backtest-preview-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    .preview-stat {
      text-align: center;
      padding: 12px;
      background: var(--soft-greige);
      border-radius: 8px;
    }

    [data-theme="dark"] .preview-stat {
      background: var(--bg-darker);
    }

    .stat-value {
      display: block;
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* ========================================================================
       BACKTEST PANEL STYLES
       ======================================================================== */

    .backtest-layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 24px;
      padding: 24px;
    }

    .backtest-config-panel,
    .backtest-results-panel {
      background: var(--card);
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .date-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .date-field label {
      display: block;
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .date-field input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
      background: var(--bg);
      color: var(--text);
    }

    .input-with-unit {
      display: flex;
      align-items: center;
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
    }

    .unit-prefix {
      padding: 10px 12px;
      background: var(--soft-greige);
      border-right: 1px solid var(--border);
      font-size: 14px;
      color: var(--text-muted);
    }

    [data-theme="dark"] .unit-prefix {
      background: var(--bg-darker);
    }

    .input-with-unit input {
      flex: 1;
      border: none;
      padding: 10px 12px;
      font-size: 14px;
      background: var(--bg);
      color: var(--text);
    }

    .cost-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .cost-field {
      display: flex;
      flex-direction: column;
    }

    .cost-field label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .cost-field input {
      width: 80%;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 13px;
      background: var(--bg);
      color: var(--text);
    }

    .backtest-metrics {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }

    .metric-card {
      text-align: center;
      padding: 14px;
      background: var(--soft-greige);
      border-radius: 8px;
    }

    [data-theme="dark"] .metric-card {
      background: var(--bg-darker);
    }

    .metric-card .metric-value {
      display: block;
      font-size: 20px;
      font-weight: 700;
    }

    .metric-card .metric-value.positive { color: #16a34a; }
    .metric-card .metric-value.negative { color: #dc2626; }

    .metric-card .metric-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .trade-log {
      padding: 20px 24px;
    }

    .trade-log h4 {
      margin: 0 0 12px 0;
      font-size: 14px;
      font-weight: 600;
    }

    .trade-table {
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .trade-row {
      display: grid;
      grid-template-columns: 100px 80px 70px 90px 80px;
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      align-items: center;
    }

    .trade-row:last-child {
      border-bottom: none;
    }

    .trade-row.header {
      background: var(--soft-greige);
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    [data-theme="dark"] .trade-row.header {
      background: var(--bg-darker);
    }

    .action-buy { color: #16a34a; font-weight: 600; }
    .action-sell { color: #dc2626; font-weight: 600; }
    .muted { color: var(--text-muted); }

    /* ========================================================================
       PREMIUM PERSONALIZATION & PROFESSIONAL UI COMPONENTS
       ======================================================================== */

    /* Premium Card with Glassmorphism */
    .premium-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(247,244,242,0.9) 100%);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.6);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-natural), inset 0 1px 0 rgba(255,255,255,0.8);
      transition: all var(--transition-normal);
      position: relative;
      overflow: hidden;
    }

    .premium-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-premium);
      opacity: 0;
      transition: opacity var(--transition-normal);
    }

    .premium-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-deep), var(--glow-primary);
    }

    .premium-card:hover::before {
      opacity: 1;
    }

    [data-theme="dark"] .premium-card {
      background: linear-gradient(135deg, rgba(30,41,59,0.95) 0%, rgba(15,23,42,0.9) 100%);
      border-color: rgba(51, 65, 85, 0.5);
    }

    /* Client Tier Badges */
    .client-tier {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: var(--radius-pill);
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .client-tier.platinum {
      background: var(--gradient-platinum);
      color: #1e293b;
      box-shadow: 0 2px 8px rgba(148, 163, 184, 0.4);
    }

    .client-tier.gold {
      background: var(--gradient-gold);
      color: white;
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
    }

    .client-tier.silver {
      background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
      color: white;
    }

    .client-tier.standard {
      background: var(--soft-greige);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    /* Personalized Greeting Section - Clean & Readable */
    .personalized-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: var(--space-xl);
      background: var(--light);
      border: 2px solid var(--primary);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-xl);
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-natural);
    }

    .personalized-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 6px;
      height: 100%;
      background: var(--gradient-premium);
    }

    .greeting-content h2 {
      font-size: var(--text-h3);
      font-weight: 700;
      font-family: var(--font-serif);
      margin-bottom: var(--space-xs);
      color: var(--primary);
    }

    .greeting-content p {
      font-size: var(--text-body);
      color: var(--text-muted);
      opacity: 0.9;
    }

    .quick-actions {
      display: flex;
      gap: var(--space-sm);
    }

    .quick-action-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      background: var(--primary);
      border: none;
      border-radius: var(--radius-pill);
      color: white;
      font-size: var(--text-small);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-normal);
      box-shadow: var(--shadow);
    }

    .quick-action-btn:hover {
      background: var(--accent-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .quick-action-btn svg {
      stroke: white;
    }

    /* Priority Indicator */
    .priority-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      font-size: 11px;
      font-weight: 600;
    }

    .priority-indicator.urgent {
      background: rgba(220, 38, 38, 0.15);
      color: #dc2626;
      animation: pulse-glow 2s ease-in-out infinite;
    }

    .priority-indicator.high {
      background: rgba(245, 158, 11, 0.15);
      color: #d97706;
    }

    .priority-indicator.normal {
      background: rgba(16, 185, 129, 0.15);
      color: #059669;
    }

    .priority-indicator .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    /* Data Visualization Cards */
    .data-viz-card {
      background: var(--light);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      box-shadow: var(--shadow-natural);
      position: relative;
    }

    .data-viz-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-md);
    }

    .data-viz-title {
      font-size: var(--text-body);
      font-weight: 700;
      color: var(--primary);
    }

    .data-viz-value {
      font-size: var(--text-h2);
      font-weight: 700;
      font-family: var(--font-serif);
      color: var(--text);
      line-height: 1;
    }

    .data-viz-change {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-left: var(--space-sm);
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      font-size: var(--text-small);
      font-weight: 600;
    }

    .data-viz-change.positive {
      background: rgba(16, 185, 129, 0.15);
      color: #059669;
    }

    .data-viz-change.negative {
      background: rgba(220, 38, 38, 0.15);
      color: #dc2626;
    }

    /* Sparkline Mini Chart */
    .sparkline-container {
      height: 40px;
      margin-top: var(--space-sm);
      position: relative;
    }

    .sparkline-container svg {
      width: 100%;
      height: 100%;
    }

    /* Analyst Consensus Meter */
    .consensus-meter {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }

    .consensus-bar {
      display: flex;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      background: var(--border);
    }

    .consensus-segment {
      height: 100%;
      transition: width var(--transition-slow);
    }

    .consensus-segment.buy {
      background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
    }

    .consensus-segment.hold {
      background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%);
    }

    .consensus-segment.sell {
      background: linear-gradient(90deg, #ef4444 0%, #f87171 100%);
    }

    .consensus-labels {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
    }

    .consensus-label {
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--text-muted);
    }

    .consensus-label .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .consensus-label .dot.buy { background: #10b981; }
    .consensus-label .dot.hold { background: #f59e0b; }
    .consensus-label .dot.sell { background: #ef4444; }

    /* Price Target Range */
    .target-range {
      position: relative;
      height: 40px;
      margin: var(--space-md) 0;
    }

    .target-range-bar {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      transform: translateY(-50%);
    }

    .target-range-fill {
      position: absolute;
      top: 50%;
      height: 4px;
      background: var(--gradient-premium);
      border-radius: 2px;
      transform: translateY(-50%);
    }

    .target-marker {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .target-marker .marker-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--primary);
      border: 2px solid white;
      box-shadow: var(--shadow-md);
    }

    .target-marker .marker-label {
      position: absolute;
      top: -20px;
      font-size: 10px;
      font-weight: 600;
      white-space: nowrap;
      color: var(--text-muted);
    }

    .target-marker.current .marker-dot {
      background: var(--secondary-red);
      width: 16px;
      height: 16px;
    }

    .target-marker.current .marker-label {
      color: var(--secondary-red);
      font-weight: 700;
    }

    /* Personalized Recommendation Card */
    .personalized-rec {
      background: var(--light);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      box-shadow: var(--shadow-natural);
      border-left: 4px solid var(--primary);
      position: relative;
      overflow: hidden;
    }

    /* PERSONALIZED sticker removed for cleaner look */

    .rec-match-score {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      margin-bottom: var(--space-md);
    }

    .match-percentage {
      font-size: var(--text-h3);
      font-weight: 700;
      color: var(--primary);
      font-family: var(--font-serif);
    }

    .match-label {
      font-size: var(--text-small);
      color: var(--text-muted);
    }

    .match-reasons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: var(--space-sm);
    }

    .match-reason {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: var(--accent-light);
      border-radius: var(--radius-pill);
      font-size: 11px;
      color: var(--primary);
    }

    .match-reason svg {
      width: 12px;
      height: 12px;
    }

    /* Live Data Indicator */
    .live-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      background: rgba(220, 38, 38, 0.1);
      border-radius: var(--radius-pill);
      font-size: 11px;
      font-weight: 600;
      color: #dc2626;
    }

    .live-indicator .pulse {
      width: 8px;
      height: 8px;
      background: #dc2626;
      border-radius: 50%;
      animation: pulse-glow 1.5s ease-in-out infinite;
    }

    /* Institutional Holdings Bar */
    .holdings-bar {
      display: flex;
      gap: 2px;
      height: 24px;
      border-radius: var(--radius);
      overflow: hidden;
      margin: var(--space-sm) 0;
    }

    .holdings-segment {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
      color: white;
      transition: all var(--transition-normal);
    }

    .holdings-segment:hover {
      filter: brightness(1.1);
    }

    .holdings-segment.institutional {
      background: var(--primary);
    }

    .holdings-segment.retail {
      background: var(--add-smoked-blue);
    }

    .holdings-segment.insider {
      background: var(--secondary-red);
    }

    /* Earnings Surprise Indicator */
    .earnings-surprise {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-md);
      background: var(--soft-greige);
      border-radius: var(--radius);
    }

    .surprise-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .surprise-icon.beat {
      background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
      color: white;
    }

    .surprise-icon.miss {
      background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
      color: white;
    }

    .surprise-icon.inline {
      background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
      color: white;
    }

    .surprise-details {
      flex: 1;
    }

    .surprise-title {
      font-weight: 600;
      font-size: var(--text-label);
      margin-bottom: 2px;
    }

    .surprise-meta {
      font-size: var(--text-small);
      color: var(--text-muted);
    }

    .surprise-value {
      font-size: var(--text-h4);
      font-weight: 700;
      font-family: monospace;
    }

    .surprise-value.positive { color: #10b981; }
    .surprise-value.negative { color: #ef4444; }

    /* ========================================================================
       STOCK MONITORING CENTER - Professional Bloomberg-Style
       ======================================================================== */

    .monitoring-center {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-lg);
      margin-top: var(--space-xl);
    }

    .monitoring-panel {
      background: var(--light);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-natural);
      overflow: hidden;
    }

    .monitoring-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-lg);
      border-bottom: 1px solid var(--border);
      background: var(--soft-greige);
    }

    .monitoring-title {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-size: var(--text-body);
      font-weight: 700;
      color: var(--primary);
    }

    .monitoring-title svg {
      width: 20px;
      height: 20px;
    }

    .monitoring-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      font-size: var(--text-small);
      font-weight: 600;
    }

    .monitoring-badge.live {
      background: rgba(220, 38, 38, 0.1);
      color: #dc2626;
      animation: pulse-badge 2s ease-in-out infinite;
    }

    @keyframes pulse-badge {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .monitoring-badge .dot {
      width: 6px;
      height: 6px;
      background: #dc2626;
      border-radius: 50%;
    }

    .monitoring-body {
      padding: var(--space-lg);
      max-height: 400px;
      overflow-y: auto;
    }

    /* Alert Items */
    .alert-item {
      display: flex;
      align-items: flex-start;
      gap: var(--space-md);
      padding: var(--space-md);
      margin-bottom: var(--space-sm);
      background: var(--soft-greige);
      border-radius: var(--radius);
      border-left: 3px solid var(--border);
      transition: all var(--transition-normal);
    }

    .alert-item:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-md);
    }

    .alert-item.critical {
      border-left-color: #dc2626;
      background: rgba(220, 38, 38, 0.05);
    }

    .alert-item.warning {
      border-left-color: #f59e0b;
      background: rgba(245, 158, 11, 0.05);
    }

    .alert-item.info {
      border-left-color: var(--primary);
      background: rgba(0, 61, 57, 0.05);
    }

    .alert-item.success {
      border-left-color: #10b981;
      background: rgba(16, 185, 129, 0.05);
    }

    .alert-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 14px;
    }

    .alert-item.critical .alert-icon {
      background: rgba(220, 38, 38, 0.15);
      color: #dc2626;
    }

    .alert-item.warning .alert-icon {
      background: rgba(245, 158, 11, 0.15);
      color: #f59e0b;
    }

    .alert-item.info .alert-icon {
      background: rgba(0, 61, 57, 0.15);
      color: var(--primary);
    }

    .alert-item.success .alert-icon {
      background: rgba(16, 185, 129, 0.15);
      color: #10b981;
    }

    .alert-content {
      flex: 1;
      min-width: 0;
    }

    .alert-title {
      font-weight: 600;
      font-size: var(--text-label);
      color: var(--text);
      margin-bottom: 4px;
    }

    .alert-title .ticker {
      font-family: monospace;
      background: var(--primary);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      margin-right: 6px;
    }

    .alert-description {
      font-size: var(--text-small);
      color: var(--text-muted);
      line-height: 1.5;
    }

    .alert-meta {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      margin-top: var(--space-xs);
      font-size: 11px;
      color: var(--text-muted);
    }

    .alert-time {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .alert-actions {
      display: flex;
      gap: var(--space-xs);
    }

    .alert-action-btn {
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      font-size: 11px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .alert-action-btn.view {
      background: var(--primary);
      color: white;
    }

    .alert-action-btn.view:hover {
      background: var(--accent-dark);
    }

    .alert-action-btn.dismiss {
      background: var(--border);
      color: var(--text-muted);
    }

    .alert-action-btn.dismiss:hover {
      background: var(--text-muted);
      color: white;
    }

    /* Research Impact Section */
    .research-impact {
      margin-top: var(--space-md);
      padding: var(--space-md);
      background: linear-gradient(135deg, rgba(0, 61, 57, 0.08) 0%, rgba(0, 61, 57, 0.02) 100%);
      border-radius: var(--radius);
      border: 1px dashed var(--primary);
    }

    .research-impact-header {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      font-size: var(--text-small);
      font-weight: 700;
      color: var(--primary);
      margin-bottom: var(--space-xs);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .research-impact-text {
      font-size: var(--text-small);
      color: var(--text);
      line-height: 1.6;
    }

    .research-impact-source {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      margin-top: var(--space-xs);
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Price Alert Setup */
    .alert-setup {
      padding: var(--space-lg);
      border-top: 1px solid var(--border);
      background: var(--soft-greige);
    }

    .alert-setup-title {
      font-size: var(--text-small);
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--space-md);
    }

    .alert-setup-form {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: var(--space-sm);
      align-items: end;
    }

    .alert-setup-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .alert-setup-field label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
    }

    .alert-setup-field input,
    .alert-setup-field select {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: var(--text-small);
      background: var(--light);
    }

    .alert-setup-field input:focus,
    .alert-setup-field select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 61, 57, 0.1);
    }

    .btn-add-alert {
      padding: 10px 20px;
      background: var(--button-dark);
      color: white;
      border: none;
      border-radius: var(--radius-pill);
      font-size: var(--text-small);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-normal);
    }

    .btn-add-alert:hover {
      background: var(--primary);
      transform: translateY(-2px);
    }

    /* News Feed with Research Context */
    .news-feed-item {
      padding: var(--space-md);
      border-bottom: 1px solid var(--border);
      transition: background var(--transition-fast);
    }

    .news-feed-item:last-child {
      border-bottom: none;
    }

    .news-feed-item:hover {
      background: var(--soft-greige);
    }

    .news-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-xs);
    }

    .news-source {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .news-source.breaking {
      color: #dc2626;
    }

    .news-time {
      font-size: 11px;
      color: var(--text-muted);
    }

    .news-title {
      font-size: var(--text-label);
      font-weight: 600;
      color: var(--text);
      margin-bottom: var(--space-xs);
      line-height: 1.4;
    }

    .news-tickers {
      display: flex;
      gap: 6px;
      margin-bottom: var(--space-sm);
    }

    .news-ticker {
      font-family: monospace;
      font-size: 11px;
      padding: 2px 8px;
      background: var(--accent-light);
      color: var(--primary);
      border-radius: 4px;
      font-weight: 600;
    }

    .news-research-link {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      padding: var(--space-xs) var(--space-sm);
      background: linear-gradient(135deg, var(--primary) 0%, var(--add-mint) 100%);
      color: white;
      border-radius: var(--radius);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .news-research-link:hover {
      transform: scale(1.02);
      box-shadow: var(--shadow-md);
    }

    /* Watchlist Monitor */
    .watchlist-monitor {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }

    .watchlist-stock {
      display: grid;
      grid-template-columns: 80px 1fr 80px 100px;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-sm) var(--space-md);
      background: var(--soft-greige);
      border-radius: var(--radius);
      transition: all var(--transition-fast);
    }

    .watchlist-stock:hover {
      background: var(--border);
      transform: translateX(2px);
    }

    .watchlist-ticker {
      font-family: monospace;
      font-weight: 700;
      font-size: var(--text-label);
      color: var(--primary);
    }

    .watchlist-name {
      font-size: var(--text-small);
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .watchlist-price {
      font-family: monospace;
      font-weight: 600;
      font-size: var(--text-label);
      text-align: right;
    }

    .watchlist-change {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 4px;
      font-size: var(--text-small);
      font-weight: 600;
    }

    .watchlist-change.positive {
      color: #10b981;
    }

    .watchlist-change.negative {
      color: #dc2626;
    }

    /* Dark mode adjustments */
    [data-theme="dark"] .monitoring-panel {
      background: var(--card);
    }

    [data-theme="dark"] .monitoring-header {
      background: var(--bg-darker);
    }

    [data-theme="dark"] .alert-item {
      background: var(--bg-darker);
    }

    [data-theme="dark"] .alert-setup {
      background: var(--bg-darker);
    }

    [data-theme="dark"] .news-feed-item:hover {
      background: var(--bg-darker);
    }

    [data-theme="dark"] .watchlist-stock {
      background: var(--bg-darker);
    }

    [data-theme="dark"] .watchlist-stock:hover {
      background: var(--card-hover);
    }

    /* ========================================================================
       CLIENT FIT ANALYSIS STYLES
       ======================================================================== */

    .clientfit-layout {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 24px;
      padding: 24px;
    }

    .clientfit-profile-panel,
    .clientfit-results-panel {
      background: var(--card);
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .client-profile-card {
      margin: 20px 24px;
      padding: 20px;
      background: var(--soft-greige);
      border-radius: 10px;
    }

    [data-theme="dark"] .client-profile-card {
      background: var(--bg-darker);
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 20px;
    }

    .profile-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
    }

    [data-theme="dark"] .profile-avatar {
      color: #0f172a;
    }

    .profile-info h4 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }

    .profile-type {
      font-size: 12px;
      color: var(--text-muted);
    }

    .profile-metrics {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }

    .profile-metric {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
    }

    .profile-metric .metric-bar {
      flex: 1;
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      margin: 0 12px;
      overflow: hidden;
    }

    .profile-metric .bar-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .profile-preferences h5 {
      margin: 0 0 10px 0;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .pref-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .pref-tag {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }

    .pref-tag.positive {
      background: rgba(22, 163, 74, 0.1);
      color: #16a34a;
    }

    .pref-tag.negative {
      background: rgba(220, 38, 38, 0.1);
      color: #dc2626;
    }

    .pref-tag.neutral {
      background: var(--card);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    .fit-score-display {
      display: flex;
      align-items: center;
      gap: 24px;
      padding: 30px 24px;
      border-bottom: 1px solid var(--border);
    }

    .fit-score-circle {
      position: relative;
      width: 120px;
      height: 120px;
    }

    .fit-score-circle svg {
      transform: rotate(-90deg);
      width: 100%;
      height: 100%;
    }

    .fit-score-circle .score-bg {
      fill: none;
      stroke: var(--border);
      stroke-width: 8;
    }

    .fit-score-circle .score-fill {
      fill: none;
      stroke: var(--primary);
      stroke-width: 8;
      stroke-linecap: round;
      stroke-dasharray: 283;
      stroke-dashoffset: 283;
      transition: stroke-dashoffset 1s ease;
    }

    .score-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }

    .score-value {
      display: block;
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
    }

    .score-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .fit-summary {
      flex: 1;
    }

    .fit-summary p {
      margin: 0;
      font-size: 14px;
      line-height: 1.6;
      color: var(--text-muted);
    }

    .fit-breakdown {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }

    .fit-breakdown h4 {
      margin: 0 0 16px 0;
      font-size: 14px;
      font-weight: 600;
    }

    .breakdown-items {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .breakdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .breakdown-label {
      width: 140px;
      font-size: 13px;
    }

    .breakdown-bar {
      flex: 1;
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
    }

    .breakdown-bar .bar-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .breakdown-score {
      width: 40px;
      text-align: right;
      font-size: 13px;
      font-weight: 600;
    }

    .fit-recommendations {
      padding: 20px 24px;
    }

    .fit-recommendations h4 {
      margin: 0 0 12px 0;
      font-size: 14px;
      font-weight: 600;
    }

    .recommendations-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .recommendation-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 12px;
      background: var(--soft-greige);
      border-radius: 8px;
      font-size: 13px;
    }

    [data-theme="dark"] .recommendation-item {
      background: var(--bg-darker);
    }

    .rec-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      flex-shrink: 0;
    }

    .rec-icon.warning {
      background: #fef3c7;
      color: #d97706;
    }

    .rec-icon.success {
      background: #dcfce7;
      color: #16a34a;
    }

    .rec-icon.error {
      background: #fef2f2;
      color: #dc2626;
    }

    /* SVG Icons in Section Headers */
    .section-icon-svg {
      color: var(--primary);
    }

    .icon-sm {
      width: 16px;
      height: 16px;
      vertical-align: middle;
    }

    /* Tool buttons styling */
    .analytics-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: var(--card);
      border-radius: 12px;
      border: 1px solid var(--border);
      margin: 24px 24px 0 24px;
    }

    .tool-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .tool-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .tool-buttons {
      display: flex;
      gap: 6px;
    }

    .tool-btn {
      padding: 8px 16px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: transparent;
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tool-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .tool-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    [data-theme="dark"] .tool-btn.active {
      color: #0f172a;
    }

    .client-context-badge {
      padding: 6px 12px;
      background: var(--soft-greige);
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
    }

    [data-theme="dark"] .client-context-badge {
      background: var(--bg-darker);
    }

    .results-actions {
      display: flex;
      gap: 8px;
    }

    /* Slider improvements */
    .slider-with-value {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .slider-with-value input[type="range"] {
      flex: 1;
    }

    .slider-value {
      font-size: 13px;
      font-weight: 600;
      min-width: 100px;
    }

    /* Asset tags */
    .asset-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .asset-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: var(--primary);
      color: white;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    [data-theme="dark"] .asset-tag {
      color: #0f172a;
    }

    .asset-tag button {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      padding: 0;
      font-size: 14px;
      line-height: 1;
      opacity: 0.7;
    }

    .asset-tag button:hover {
      opacity: 1;
    }

    .constraints-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .constraint-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
    }

    .constraint-row input {
      width: 60px;
      padding: 6px 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      text-align: center;
      font-size: 13px;
      background: var(--bg);
      color: var(--text);
    }

    .metric-box {
      text-align: center;
    }

    .metric-box .metric-value {
      display: block;
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
    }

    .metric-box .metric-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* ========================================================================
       ENHANCED STORY PANEL
       ======================================================================== */

    .story-layout {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 20px;
    }

    .story-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .control-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .selected-stock-badge {
      padding: 8px 16px;
      background: var(--soft-greige);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    [data-theme="dark"] .selected-stock-badge {
      background: var(--card);
    }

    .story-main {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 24px;
      flex: 1;
    }

    .story-sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .sidebar-section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
    }

    .sidebar-title {
      margin: 0 0 12px 0;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    .stock-search-wrapper {
      position: relative;
    }

    .setting-item {
      margin-bottom: 14px;
    }

    .setting-item:last-child {
      margin-bottom: 0;
    }

    .setting-item label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .setting-item select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
      background: var(--bg);
      color: var(--text);
    }

    .checkbox-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .checkbox-list label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 400;
      cursor: pointer;
    }

    .checkbox-list input[type="checkbox"] {
      width: 14px;
      height: 14px;
      accent-color: var(--primary);
    }

    .action-btn {
      width: 100%;
      padding: 10px;
      margin-bottom: 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: transparent;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text);
    }

    .action-btn:last-child {
      margin-bottom: 0;
    }

    .action-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .story-output-area {
      flex: 1;
    }

    .output-panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .output-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--soft-greige);
    }

    [data-theme="dark"] .output-header {
      background: var(--bg-darker);
    }

    .output-title {
      font-size: 16px;
      font-weight: 700;
      font-family: var(--font-serif);
    }

    .output-actions {
      display: flex;
      gap: 8px;
    }

    .output-body {
      padding: 24px;
      max-height: 400px;
      overflow-y: auto;
    }

    .output-text {
      font-size: 14px;
      line-height: 1.8;
      color: var(--text);
    }

    .governance-section {
      border-top: 1px solid var(--border);
      padding: 16px 20px;
      background: var(--soft-greige);
    }

    [data-theme="dark"] .governance-section {
      background: var(--bg-darker);
    }

    .governance-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 12px;
    }

    .governance-content {
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.6;
    }

    .governance-content .source-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: var(--card);
      border-radius: 4px;
      margin: 2px 4px 2px 0;
      font-size: 11px;
    }

    /* ========================================================================
       AI ADVISOR PANEL
       ======================================================================== */

    .advisor-layout {
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .advisor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    .advisor-title-section h2 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      font-family: var(--font-serif);
    }

    .advisor-subtitle {
      margin: 4px 0 0 0;
      font-size: 14px;
      color: var(--text-muted);
    }

    .client-context-section {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .context-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--soft-greige);
      border-radius: 8px;
    }

    [data-theme="dark"] .context-badge {
      background: var(--card);
    }

    .context-label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .context-value {
      font-size: 14px;
      font-weight: 600;
    }

    .advisor-grid {
      display: grid;
      grid-template-columns: 300px 1fr 300px;
      gap: 20px;
    }

    .advisor-panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .advisor-panel .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--soft-greige);
    }

    [data-theme="dark"] .advisor-panel .panel-header {
      background: var(--bg-darker);
    }

    .advisor-panel .panel-header h3 {
      margin: 0;
      font-size: 15px;
      font-weight: 700;
    }

    .panel-badge {
      padding: 4px 12px;
      background: var(--primary);
      color: white;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
    }

    [data-theme="dark"] .panel-badge {
      color: #0f172a;
    }

    .advisor-panel .panel-body {
      padding: 16px 20px;
    }

    .portfolio-holdings {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    .holding-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: var(--soft-greige);
      border-radius: 8px;
    }

    [data-theme="dark"] .holding-item {
      background: var(--bg-darker);
    }

    .holding-info {
      display: flex;
      flex-direction: column;
    }

    .holding-ticker {
      font-weight: 700;
      font-size: 14px;
    }

    .holding-name {
      font-size: 11px;
      color: var(--text-muted);
    }

    .holding-metrics {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .holding-weight {
      font-size: 13px;
      font-weight: 600;
    }

    .holding-pnl {
      font-size: 12px;
      font-weight: 600;
    }

    .holding-pnl.positive { color: #16a34a; }
    .holding-pnl.negative { color: #dc2626; }

    .portfolio-metrics-summary {
      border-top: 1px solid var(--border);
      padding-top: 16px;
      margin-bottom: 16px;
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      font-size: 13px;
    }

    .metric-row .metric-value {
      font-weight: 600;
    }

    .metric-row .metric-value.positive { color: #16a34a; }
    .metric-row .metric-value.negative { color: #dc2626; }

    .confidence-badge {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .confidence-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .confidence-value {
      padding: 4px 10px;
      background: var(--primary);
      color: white;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    [data-theme="dark"] .confidence-value {
      color: #0f172a;
    }

    .recommendation-placeholder {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .recommendation-placeholder svg {
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .recommendation-placeholder p {
      margin: 0 0 16px 0;
      font-size: 14px;
    }

    .recommendation-placeholder ul {
      text-align: left;
      margin: 0;
      padding-left: 20px;
      font-size: 13px;
      line-height: 1.8;
    }

    .governance-intro {
      padding: 12px;
      background: var(--soft-greige);
      border-radius: 8px;
      margin-bottom: 16px;
    }

    [data-theme="dark"] .governance-intro {
      background: var(--bg-darker);
    }

    .governance-intro p {
      margin: 0;
      font-size: 12px;
      color: var(--text-muted);
    }

    .source-categories {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .source-category {
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .source-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--soft-greige);
      border-bottom: 1px solid var(--border);
    }

    [data-theme="dark"] .source-header {
      background: var(--bg-darker);
    }

    .source-icon {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
    }

    [data-theme="dark"] .source-icon {
      color: #0f172a;
    }

    .source-name {
      font-size: 13px;
      font-weight: 600;
    }

    .source-items {
      padding: 10px 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .source-item {
      padding: 4px 8px;
      background: var(--soft-greige);
      border-radius: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }

    [data-theme="dark"] .source-item {
      background: var(--bg-darker);
    }

    .methodology-section {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .methodology-section h4 {
      margin: 0 0 10px 0;
      font-size: 13px;
      font-weight: 600;
    }

    .methodology-content p {
      margin: 0 0 12px 0;
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.6;
    }

    .backtest-results-section,
    .detailed-recommendations {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }

    .backtest-results-section .section-header,
    .detailed-recommendations .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .backtest-results-section .section-header h3,
    .detailed-recommendations .section-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }

    .backtest-results-section .section-header p {
      margin: 4px 0 0 0;
      font-size: 13px;
      color: var(--text-muted);
    }

    .strategy-results-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }

    .strategy-result-card {
      background: var(--soft-greige);
      border-radius: 10px;
      padding: 16px;
      transition: all 0.2s;
      cursor: pointer;
    }

    [data-theme="dark"] .strategy-result-card {
      background: var(--bg-darker);
    }

    .strategy-result-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .strategy-result-card.best {
      border: 2px solid var(--primary);
    }

    .strategy-name {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .strategy-metrics {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .strategy-metric {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
    }

    .strategy-metric .label {
      color: var(--text-muted);
    }

    .strategy-metric .value {
      font-weight: 600;
    }

    .strategy-metric .value.positive { color: #16a34a; }
    .strategy-metric .value.negative { color: #dc2626; }

    .recommendations-detail-grid {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .recommendation-detail-card {
      display: grid;
      grid-template-columns: 80px 1fr 200px;
      gap: 20px;
      padding: 20px;
      background: var(--soft-greige);
      border-radius: 12px;
      align-items: center;
    }

    [data-theme="dark"] .recommendation-detail-card {
      background: var(--bg-darker);
    }

    .rec-action {
      text-align: center;
    }

    .rec-action-label {
      display: block;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .rec-action-label.buy {
      background: rgba(22, 163, 74, 0.15);
      color: #16a34a;
    }

    .rec-action-label.sell {
      background: rgba(220, 38, 38, 0.15);
      color: #dc2626;
    }

    .rec-action-label.hold {
      background: rgba(245, 158, 11, 0.15);
      color: #d97706;
    }

    .rec-stock-info h4 {
      margin: 0 0 4px 0;
      font-size: 16px;
      font-weight: 700;
    }

    .rec-stock-info p {
      margin: 0 0 8px 0;
      font-size: 13px;
      color: var(--text-muted);
    }

    .rec-reasoning {
      font-size: 13px;
      line-height: 1.5;
    }

    .rec-reasoning .source-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      background: var(--card);
      border-radius: 3px;
      font-size: 10px;
      color: var(--text-muted);
      margin-left: 4px;
    }

    .rec-metrics {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .rec-metric {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      padding: 6px 10px;
      background: var(--card);
      border-radius: 4px;
    }

    .rec-metric .label {
      color: var(--text-muted);
    }

    .rec-metric .value {
      font-weight: 600;
    }

    .export-actions {
      display: flex;
      gap: 8px;
    }
  </style>
</head>
<body>
  <!-- LIVE TICKER -->
  <div class="live-ticker-container" id="liveTicker">
    <div class="live-ticker" id="tickerContent">
      <!-- Ticker items will be populated by JS -->
    </div>
  </div>

  <!-- HEADER -->
  <header class="header">
    <div class="logo">
      <img src="/static/Oddo_BHF_logo.svg.png" alt="ODDO BHF" class="logo-img">
    </div>

    <div class="search-box" style="position: relative;">
      <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input
        type="text"
        class="search-input"
        id="searchInput"
        placeholder="Search client (name, firm, contact)..."
        autocomplete="off"
      />
      <div class="search-autocomplete" id="searchAutocomplete"></div>
    </div>

    <div class="header-actions">
      <button class="btn btn-ghost" id="settingsBtn">API</button>
      <button class="btn btn-ghost" id="healthBtn">Health</button>
      <button class="theme-toggle" id="themeToggle" title="Toggle Dark Mode"></button>
      <span class="status-chip" id="statusChip">No Client</span>
    </div>
  </header>

  <!-- SEARCH MODAL -->
  <div class="modal-overlay" id="modalOverlay"></div>
  <div class="modal" id="searchModal">
    <div class="modal-header">
      <span class="modal-title">Search Results</span>
      <button class="modal-close" id="closeModal">&times;</button>
    </div>
    <div class="modal-body" id="searchResults"></div>
  </div>

  <!-- DETAILS DRAWER -->
  <div class="drawer-overlay" id="drawerOverlay"></div>
  <div class="drawer" id="detailsDrawer">
    <div class="drawer-header">
      <span class="drawer-title">Client Details</span>
      <button class="drawer-close" id="closeDrawer">&times;</button>
    </div>
    <div class="drawer-body" id="drawerBody">
      <!-- Content will be rendered by JS -->
    </div>
  </div>

  <!-- STOCK DETAIL MODAL -->
  <div class="stock-detail-overlay" id="stockDetailOverlay"></div>
  <div class="stock-detail-modal" id="stockDetailModal">
    <button class="stock-detail-close" id="closeStockDetail">&times;</button>
    <div class="stock-detail-header" id="stockDetailHeader">
      <div>
        <div class="stock-detail-ticker" id="detailTicker">-</div>
        <div class="stock-detail-name" id="detailCompanyName">Loading...</div>
      </div>
      <div class="stock-detail-price-container">
        <div class="stock-detail-price" id="detailPrice">-</div>
        <div class="stock-detail-change" id="detailChange">-</div>
      </div>
    </div>
    <div class="stock-detail-body" id="stockDetailBody">
      <div class="stock-detail-loading">
        <div class="spinner"></div>
        <span style="margin-left: 12px;">Loading market data...</span>
      </div>
    </div>
  </div>

  <!-- QUICK STATS DASHBOARD -->
  <div class="quick-stats" id="quickStats">
    <div class="stat-card">
      <div class="stat-icon">$</div>
      <div class="stat-value">
        <span id="statTotalAum">--</span>
      </div>
      <div class="stat-label">Total AUM</div>
    </div>
    <div class="stat-card accent-green">
      <div class="stat-icon">U</div>
      <div class="stat-value">
        <span id="statActiveClients">--</span>
        <span class="stat-trend up" id="statClientsTrend">--</span>
      </div>
      <div class="stat-label">Active Clients (30d)</div>
    </div>
    <div class="stat-card accent-blue">
      <div class="stat-icon">C</div>
      <div class="stat-value">
        <span id="statTotalCalls">--</span>
      </div>
      <div class="stat-label">Calls This Month</div>
    </div>
    <div class="stat-card accent-red">
      <div class="stat-icon">M</div>
      <div class="stat-value">
        <span id="statUpcomingMeetings">--</span>
      </div>
      <div class="stat-label">Upcoming Meetings</div>
    </div>
  </div>

  <!-- KEYBOARD SHORTCUTS BUTTON -->
  <button class="shortcuts-btn" id="shortcutsBtn" title="Keyboard Shortcuts">?</button>

  <!-- KEYBOARD SHORTCUTS PANEL -->
  <div class="shortcuts-panel" id="shortcutsPanel">
    <div class="shortcuts-header">
      <span>Keyboard Shortcuts</span>
      <button class="shortcuts-close" id="shortcutsClose">&times;</button>
    </div>
    <div class="shortcuts-list">
      <div class="shortcut-item">
        <span class="shortcut-desc">Search clients</span>
        <div class="shortcut-keys"><span class="shortcut-key">/</span></div>
      </div>
      <div class="shortcut-item">
        <span class="shortcut-desc">Generate shortlist</span>
        <div class="shortcut-keys"><span class="shortcut-key">G</span></div>
      </div>
      <div class="shortcut-item">
        <span class="shortcut-desc">Toggle dark mode</span>
        <div class="shortcut-keys"><span class="shortcut-key">D</span></div>
      </div>
      <div class="shortcut-item">
        <span class="shortcut-desc">Close modal</span>
        <div class="shortcut-keys"><span class="shortcut-key">Esc</span></div>
      </div>
      <div class="shortcut-item">
        <span class="shortcut-desc">Shortlist tab</span>
        <div class="shortcut-keys"><span class="shortcut-key">1</span></div>
      </div>
      <div class="shortcut-item">
        <span class="shortcut-desc">Story tab</span>
        <div class="shortcut-keys"><span class="shortcut-key">2</span></div>
      </div>
      <div class="shortcut-item">
        <span class="shortcut-desc">History tab</span>
        <div class="shortcut-keys"><span class="shortcut-key">3</span></div>
      </div>
      <div class="shortcut-item">
        <span class="shortcut-desc">Export PDF</span>
        <div class="shortcut-keys"><span class="shortcut-key">Ctrl</span><span class="shortcut-key">P</span></div>
      </div>
      <div class="shortcut-item">
        <span class="shortcut-desc">Show shortcuts</span>
        <div class="shortcut-keys"><span class="shortcut-key">?</span></div>
      </div>
    </div>
  </div>

  <!-- COMMUNICATION PANEL -->
  <div class="comm-panel" id="commPanel">
    <div class="comm-panel-header">
      <span class="comm-panel-title">Client Communication</span>
      <button class="comm-panel-close" id="commPanelClose">&times;</button>
    </div>
    <div class="comm-panel-body">
      <div class="comm-tabs">
        <div class="comm-tab active" data-comm="email">
          <span class="comm-tab-icon">&#9993;</span>
          Email
        </div>
        <div class="comm-tab" data-comm="meeting">
          <span class="comm-tab-icon">â–£</span>
          Meeting
        </div>
        <div class="comm-tab" data-comm="notes">
          <span class="comm-tab-icon">&#128221;</span>
          Notes
        </div>
      </div>

      <!-- EMAIL TAB -->
      <div class="comm-content active" id="comm-email">
        <div class="comm-section">
          <div class="comm-section-title">Email Type</div>
          <div class="comm-checkbox-group" id="emailTypeGroup">
            <div class="comm-checkbox selected" data-type="pitch">Investment Pitch</div>
            <div class="comm-checkbox" data-type="followup">Follow-up</div>
            <div class="comm-checkbox" data-type="news">News Alert</div>
            <div class="comm-checkbox" data-type="meeting">Meeting Request</div>
          </div>
        </div>

        <div class="comm-section">
          <div class="comm-section-title">Include in Email</div>
          <div class="comm-checkbox-group" id="emailIncludeGroup">
            <div class="comm-checkbox selected" data-include="storyline">Storyline</div>
            <div class="comm-checkbox selected" data-include="news">Recent News</div>
            <div class="comm-checkbox" data-include="fundamentals">Key Metrics</div>
            <div class="comm-checkbox" data-include="recommendation">Buy Rating</div>
          </div>
        </div>

        <div class="comm-section">
          <div class="comm-section-title">Additional Notes</div>
          <textarea class="comm-textarea" id="emailNotes" placeholder="Add personal touch or specific points to mention..."></textarea>
        </div>

        <button class="comm-btn" id="generateEmailBtn">Generate Smart Email</button>

        <div id="emailPreviewContainer" style="display: none;">
          <div class="comm-section" style="margin-top: 20px;">
            <div class="comm-section-title">Generated Email</div>
            <div class="email-preview" id="emailPreview"></div>
          </div>
          <button class="comm-btn" id="copyEmailBtn">Copy to Clipboard</button>
          <button class="comm-btn comm-btn-secondary" id="openMailClientBtn">Open in Mail Client</button>
        </div>
      </div>

      <!-- MEETING TAB -->
      <div class="comm-content" id="comm-meeting">
        <div class="comm-section">
          <div class="comm-section-title">Meeting Type</div>
          <div class="comm-checkbox-group" id="meetingTypeGroup">
            <div class="comm-checkbox selected" data-type="video">Video Call</div>
            <div class="comm-checkbox" data-type="phone">Phone Call</div>
            <div class="comm-checkbox" data-type="in_person">In Person</div>
            <div class="comm-checkbox" data-type="lunch">Business Lunch</div>
          </div>
        </div>

        <div class="comm-section">
          <div class="comm-section-title">Date & Time</div>
          <input type="datetime-local" class="comm-input" id="meetingDateTime">
        </div>

        <div class="comm-section">
          <div class="comm-section-title">Duration</div>
          <div class="comm-checkbox-group" id="meetingDurationGroup">
            <div class="comm-checkbox" data-duration="15">15 min</div>
            <div class="comm-checkbox selected" data-duration="30">30 min</div>
            <div class="comm-checkbox" data-duration="60">1 hour</div>
          </div>
        </div>

        <div class="comm-section">
          <div class="comm-section-title">Agenda / Topics</div>
          <textarea class="comm-textarea" id="meetingAgenda" placeholder="Portfolio review, discuss recent market movements, new investment opportunities..."></textarea>
        </div>

        <button class="comm-btn" id="scheduleMeetingBtn">Generate Calendar Invite</button>

        <div id="meetingPreviewContainer" style="display: none; margin-top: 20px;">
          <div class="email-preview" id="meetingPreview"></div>
          <button class="comm-btn" id="downloadIcsBtn">Download .ics File</button>
        </div>
      </div>

      <!-- NOTES TAB -->
      <div class="comm-content" id="comm-notes">
        <div class="comm-section">
          <div class="comm-section-title">Quick Note Type</div>
          <div class="comm-checkbox-group" id="noteTypeGroup">
            <div class="comm-checkbox selected" data-type="call">Call Log</div>
            <div class="comm-checkbox" data-type="meeting">Meeting Summary</div>
            <div class="comm-checkbox" data-type="insight">Client Insight</div>
            <div class="comm-checkbox" data-type="action">Action Item</div>
          </div>
        </div>

        <div class="comm-section">
          <div class="comm-section-title">Note Content</div>
          <textarea class="comm-textarea" id="noteContent" placeholder="Enter your notes here..." style="min-height: 200px;"></textarea>
        </div>

        <button class="comm-btn" id="saveNoteBtn">Save Note to CRM</button>
      </div>
    </div>
  </div>

  <!-- NOTIFICATION CONTAINER -->
  <div class="notification-container" id="notificationContainer"></div>

  <!-- FLOATING ACTION BUTTON -->
  <div class="fab-container" id="fabContainer">
    <div class="fab-menu">
      <div class="fab-item" onclick="openCommPanel('email')">
        <span class="fab-item-icon">&#9993;</span>
        <span class="fab-item-label">Draft Email</span>
      </div>
      <div class="fab-item" onclick="openCommPanel('meeting')">
        <span class="fab-item-icon">â–£</span>
        <span class="fab-item-label">Schedule Meeting</span>
      </div>
      <div class="fab-item" onclick="openCommPanel('notes')">
        <span class="fab-item-icon">&#128221;</span>
        <span class="fab-item-label">Add Note</span>
      </div>
      <div class="fab-item" onclick="checkNewsAlerts()">
        <span class="fab-item-icon" style="position: relative;">
          &#128276;
          <span class="news-alert-badge" id="newsAlertBadge" style="display: none;">0</span>
        </span>
        <span class="fab-item-label">News Alerts</span>
      </div>
    </div>
    <button class="fab-main" id="fabMain">+</button>
  </div>

  <!-- MAIN LAYOUT -->
  <div class="layout">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div id="sidebarContent">
        <div class="empty-state">
          <h3>No Client Loaded</h3>
          <p>Search for a client to get started.</p>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="main-header">
        <div>
          <h1 class="main-title" id="mainTitle">Workspace</h1>
          <p class="main-subtitle" id="mainSubtitle">Select a client to generate shortlists and stories.</p>
        </div>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-primary" id="generateBtn" disabled>Generate Shortlist</button>
          <button class="btn btn-secondary" id="pdfBtn" disabled>PDF</button>
        </div>
      </div>

      <!-- TABS -->
      <div class="tabs">
        <button class="tab" data-tab="dashboard">Dashboard</button>
        <button class="tab active" data-tab="shortlist">Shortlist</button>
        <button class="tab" data-tab="story">Story</button>
        <button class="tab" data-tab="advisor">AI Advisor</button>
        <button class="tab" data-tab="insights">Insights</button>
        <button class="tab" data-tab="collaborate">Collaborate</button>
        <button class="tab" data-tab="reports">Reports</button>
        <button class="tab" data-tab="analytics">Analytics</button>
        <button class="tab" data-tab="history">History</button>
      </div>

      <!-- TAB: DASHBOARD -->
      <div class="tab-panel" id="panel-dashboard">
        <!-- Personalized Welcome Header -->
        <div class="personalized-header" id="personalizedHeader">
          <div class="greeting-content">
            <h2 id="greetingText">Good Morning, Analyst</h2>
            <p id="greetingSubtext">You have 3 high-priority alerts and 2 client meetings today.</p>
          </div>
          <div class="quick-actions">
            <button class="quick-action-btn" onclick="showTodaysBriefing()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
              Today's Briefing
            </button>
            <button class="quick-action-btn" onclick="showPriorityAlerts()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
              Priority Alerts
            </button>
            <button class="quick-action-btn" onclick="showCalendar()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
              Calendar
            </button>
          </div>
        </div>

        <!-- Live Market Status Bar -->
        <div class="market-status-bar" style="display: flex; align-items: center; gap: var(--space-lg); padding: var(--space-md) var(--space-lg); background: var(--soft-greige); border-radius: var(--radius); margin-bottom: var(--space-lg);">
          <div class="live-indicator">
            <span class="pulse"></span>
            MARKETS OPEN
          </div>
          <div style="display: flex; gap: var(--space-xl); flex: 1;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="font-weight: 600; color: var(--text);">DAX</span>
              <span style="font-family: monospace; font-weight: 600;">18,245.32</span>
              <span class="data-viz-change positive">+0.82%</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="font-weight: 600; color: var(--text);">CAC 40</span>
              <span style="font-family: monospace; font-weight: 600;">7,892.15</span>
              <span class="data-viz-change positive">+0.45%</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="font-weight: 600; color: var(--text);">S&P 500</span>
              <span style="font-family: monospace; font-weight: 600;">5,124.67</span>
              <span class="data-viz-change negative">-0.12%</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="font-weight: 600; color: var(--text);">EUR/USD</span>
              <span style="font-family: monospace; font-weight: 600;">1.0842</span>
              <span class="data-viz-change positive">+0.15%</span>
            </div>
          </div>
          <div style="font-size: 12px; color: var(--text-muted);">
            Last updated: <span id="lastMarketUpdate">14:32 CET</span>
          </div>
        </div>

        <!-- Premium Metrics Row -->
        <div class="metrics-row" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-lg); margin-bottom: var(--space-xl);">
          <div class="data-viz-card premium-card">
            <div class="data-viz-header">
              <span class="data-viz-title">Total AUM</span>
              <span class="priority-indicator normal"><span class="dot"></span> Healthy</span>
            </div>
            <div style="display: flex; align-items: baseline;">
              <span class="data-viz-value" id="dashTotalAum">â‚¬2.4B</span>
              <span class="data-viz-change positive">+12%</span>
            </div>
            <div class="sparkline-container">
              <svg viewBox="0 0 100 30" preserveAspectRatio="none">
                <path d="M0,25 L10,22 L20,24 L30,18 L40,20 L50,15 L60,12 L70,14 L80,8 L90,10 L100,5" fill="none" stroke="var(--primary)" stroke-width="2"/>
                <path d="M0,25 L10,22 L20,24 L30,18 L40,20 L50,15 L60,12 L70,14 L80,8 L90,10 L100,5 L100,30 L0,30 Z" fill="url(#sparkGradient)" opacity="0.2"/>
              </svg>
            </div>
          </div>
          <div class="data-viz-card premium-card">
            <div class="data-viz-header">
              <span class="data-viz-title">Active Clients</span>
              <span class="client-tier gold">GOLD</span>
            </div>
            <div style="display: flex; align-items: baseline;">
              <span class="data-viz-value" id="dashActiveClients2">47</span>
              <span class="data-viz-change positive">+5</span>
            </div>
            <div style="margin-top: var(--space-sm);">
              <div class="holdings-bar">
                <div class="holdings-segment institutional" style="width: 60%;" title="Institutional: 28">60%</div>
                <div class="holdings-segment retail" style="width: 30%;" title="Private: 14">30%</div>
                <div class="holdings-segment insider" style="width: 10%;" title="UHNW: 5">10%</div>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); margin-top: 4px;">
                <span>Institutional</span>
                <span>Private</span>
                <span>UHNW</span>
              </div>
            </div>
          </div>
          <div class="data-viz-card premium-card">
            <div class="data-viz-header">
              <span class="data-viz-title">Hit Rate</span>
              <span class="priority-indicator high"><span class="dot"></span> Above Avg</span>
            </div>
            <div style="display: flex; align-items: baseline;">
              <span class="data-viz-value" id="dashHitRate2">73%</span>
              <span class="data-viz-change positive">+8%</span>
            </div>
            <div class="consensus-meter" style="margin-top: var(--space-sm);">
              <div class="consensus-bar">
                <div class="consensus-segment buy" style="width: 73%;"></div>
                <div class="consensus-segment hold" style="width: 18%;"></div>
                <div class="consensus-segment sell" style="width: 9%;"></div>
              </div>
              <div class="consensus-labels">
                <span class="consensus-label"><span class="dot buy"></span> Win 73%</span>
                <span class="consensus-label"><span class="dot hold"></span> Flat 18%</span>
                <span class="consensus-label"><span class="dot sell"></span> Loss 9%</span>
              </div>
            </div>
          </div>
          <div class="data-viz-card premium-card">
            <div class="data-viz-header">
              <span class="data-viz-title">Revenue YTD</span>
              <span class="priority-indicator urgent"><span class="dot"></span> Record</span>
            </div>
            <div style="display: flex; align-items: baseline;">
              <span class="data-viz-value" id="dashRevenue2">â‚¬840K</span>
              <span class="data-viz-change positive">+23%</span>
            </div>
            <div class="earnings-surprise" style="margin-top: var(--space-sm); padding: var(--space-xs);">
              <div class="surprise-icon beat" style="width: 32px; height: 32px; font-size: 14px;">â–²</div>
              <div class="surprise-details">
                <div class="surprise-title" style="font-size: 11px;">vs. Target</div>
                <div class="surprise-value positive" style="font-size: 14px;">+â‚¬120K</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Priority Actions Section -->
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-lg); margin-bottom: var(--space-xl);">
          <!-- Today's Priority List -->
          <div class="premium-card" style="padding: var(--space-lg);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md);">
              <h3 style="margin: 0; font-size: var(--text-body); font-weight: 700; color: var(--primary);">Today's Priorities</h3>
              <span style="font-size: 11px; color: var(--text-muted);">January 26, 2026</span>
            </div>
            <div style="display: flex; flex-direction: column; gap: var(--space-sm);">
              <div class="personalized-rec" style="padding: var(--space-md); border-left-color: #dc2626;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                  <div>
                    <span class="priority-indicator urgent" style="margin-bottom: 8px;"><span class="dot"></span> URGENT</span>
                    <h4 style="margin: 8px 0 4px 0; font-size: var(--text-label);">Review NVDA Position - MÃ¼ller AG</h4>
                    <p style="margin: 0; font-size: var(--text-small); color: var(--text-muted);">Price target breached. Client has 15% exposure. Consider rebalancing.</p>
                  </div>
                  <button class="btn btn-primary" style="padding: 8px 16px; font-size: 12px;">Action</button>
                </div>
              </div>
              <div class="personalized-rec" style="padding: var(--space-md); border-left-color: #f59e0b;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                  <div>
                    <span class="priority-indicator high" style="margin-bottom: 8px;"><span class="dot"></span> HIGH</span>
                    <h4 style="margin: 8px 0 4px 0; font-size: var(--text-label);">Q4 Earnings Call - Schneider GmbH</h4>
                    <p style="margin: 0; font-size: var(--text-small); color: var(--text-muted);">Scheduled for 14:00 CET. Prepare portfolio review deck.</p>
                  </div>
                  <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px;">Prepare</button>
                </div>
              </div>
              <div class="personalized-rec" style="padding: var(--space-md); border-left-color: #10b981;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                  <div>
                    <span class="priority-indicator normal" style="margin-bottom: 8px;"><span class="dot"></span> NORMAL</span>
                    <h4 style="margin: 8px 0 4px 0; font-size: var(--text-label);">New Research: European Banks Outlook</h4>
                    <p style="margin: 0; font-size: var(--text-small); color: var(--text-muted);">ODDO published new sector report. 5 clients have banking exposure.</p>
                  </div>
                  <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px;">Read</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Analyst Consensus Widget -->
          <div class="premium-card" style="padding: var(--space-lg);">
            <h3 style="margin: 0 0 var(--space-md) 0; font-size: var(--text-body); font-weight: 700; color: var(--primary);">ODDO Research Pulse</h3>
            <div style="display: flex; flex-direction: column; gap: var(--space-md);">
              <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                  <span style="font-size: var(--text-small); font-weight: 600;">AAPL</span>
                  <span style="font-size: 11px; padding: 2px 8px; background: rgba(16, 185, 129, 0.15); color: #059669; border-radius: 10px; font-weight: 600;">OUTPERFORM</span>
                </div>
                <div class="target-range" style="height: 30px; margin: 0;">
                  <div class="target-range-bar"></div>
                  <div class="target-range-fill" style="left: 20%; width: 50%;"></div>
                  <div class="target-marker" style="left: 20%;"><div class="marker-dot" style="width: 8px; height: 8px;"></div><span class="marker-label">$164</span></div>
                  <div class="target-marker current" style="left: 55%;"><div class="marker-dot"></div><span class="marker-label">$185</span></div>
                  <div class="target-marker" style="left: 85%;"><div class="marker-dot" style="width: 8px; height: 8px; background: #10b981;"></div><span class="marker-label" style="color: #10b981;">$210</span></div>
                </div>
              </div>
              <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                  <span style="font-size: var(--text-small); font-weight: 600;">LVMH.PA</span>
                  <span style="font-size: 11px; padding: 2px 8px; background: rgba(245, 158, 11, 0.15); color: #d97706; border-radius: 10px; font-weight: 600;">NEUTRAL</span>
                </div>
                <div class="target-range" style="height: 30px; margin: 0;">
                  <div class="target-range-bar"></div>
                  <div class="target-range-fill" style="left: 15%; width: 60%;"></div>
                  <div class="target-marker" style="left: 15%;"><div class="marker-dot" style="width: 8px; height: 8px;"></div><span class="marker-label">â‚¬680</span></div>
                  <div class="target-marker current" style="left: 50%;"><div class="marker-dot"></div><span class="marker-label">â‚¬728</span></div>
                  <div class="target-marker" style="left: 75%;"><div class="marker-dot" style="width: 8px; height: 8px; background: #10b981;"></div><span class="marker-label" style="color: #10b981;">â‚¬780</span></div>
                </div>
              </div>
              <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                  <span style="font-size: var(--text-small); font-weight: 600;">SAP.DE</span>
                  <span style="font-size: 11px; padding: 2px 8px; background: rgba(16, 185, 129, 0.15); color: #059669; border-radius: 10px; font-weight: 600;">OUTPERFORM</span>
                </div>
                <div class="target-range" style="height: 30px; margin: 0;">
                  <div class="target-range-bar"></div>
                  <div class="target-range-fill" style="left: 25%; width: 45%;"></div>
                  <div class="target-marker" style="left: 25%;"><div class="marker-dot" style="width: 8px; height: 8px;"></div><span class="marker-label">â‚¬155</span></div>
                  <div class="target-marker current" style="left: 60%;"><div class="marker-dot"></div><span class="marker-label">â‚¬178</span></div>
                  <div class="target-marker" style="left: 90%;"><div class="marker-dot" style="width: 8px; height: 8px; background: #10b981;"></div><span class="marker-label" style="color: #10b981;">â‚¬195</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Old Quick Metrics Row - Hidden, kept for backward compat -->
        <div class="metrics-row" style="display: none;">
          <div class="metric-card">
            <div class="metric-icon green">â–²</div>
            <div class="metric-value" id="dashTotalAum">$2.4B</div>
            <div class="metric-label">Total AUM Managed</div>
            <span class="metric-trend up">+12% YTD</span>
          </div>
          <div class="metric-card">
            <div class="metric-icon blue">â—‰</div>
            <div class="metric-value" id="dashActiveClients">47</div>
            <div class="metric-label">Active Clients</div>
            <span class="metric-trend up">+5 this month</span>
          </div>
          <div class="metric-card">
            <div class="metric-icon purple">â—Ž</div>
            <div class="metric-value" id="dashHitRate">73%</div>
            <div class="metric-label">Recommendation Hit Rate</div>
            <span class="metric-trend up">+8% vs avg</span>
          </div>
          <div class="metric-card">
            <div class="metric-icon orange">â‚¬</div>
            <div class="metric-value" id="dashRevenue">â‚¬840K</div>
            <div class="metric-label">Revenue Generated</div>
            <span class="metric-trend up">+23% YoY</span>
          </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
          <!-- Sector Heatmap -->
          <div class="widget widget-half">
            <div class="widget-header">
              <div class="widget-title">
                <span class="widget-title-icon" style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%); color: white;">â– </span>
                Sector Heatmap
              </div>
              <div class="widget-actions">
                <button class="widget-action" onclick="refreshHeatmap()">Refresh</button>
              </div>
            </div>
            <div class="widget-body">
              <div class="heatmap-grid" id="sectorHeatmap">
                <!-- Populated by JS -->
              </div>
            </div>
          </div>

          <!-- Earnings Calendar -->
          <div class="widget widget-half">
            <div class="widget-header">
              <div class="widget-title">
                <span class="widget-title-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); color: white;">â–£</span>
                Upcoming Earnings
              </div>
              <div class="widget-actions">
                <button class="widget-action">This Week</button>
              </div>
            </div>
            <div class="widget-body no-padding" style="padding: 16px;">
              <div class="earnings-list" id="earningsCalendar">
                <!-- Populated by JS -->
              </div>
            </div>
          </div>

          <!-- Morning Briefing -->
          <div class="widget widget-two-thirds">
            <div class="widget-header">
              <div class="widget-title">
                <span class="widget-title-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); color: white;">â—‹</span>
                Morning Briefing
              </div>
              <div class="widget-actions">
                <button class="widget-action" onclick="generateMorningBriefing()">Generate</button>
                <button class="widget-action" onclick="sendBriefingEmail()">Send to Clients</button>
              </div>
            </div>
            <div class="widget-body">
              <div class="briefing-content" id="morningBriefing">
                <div class="briefing-section">
                  <div class="briefing-section-title">â–º Market Overview</div>
                  <p>Click "Generate" to create your personalized morning briefing based on your client portfolios and watchlist.</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Action Items -->
          <div class="widget widget-third">
            <div class="widget-header">
              <div class="widget-title">
                <span class="widget-title-icon" style="background: linear-gradient(135deg, #ef4444 0%, #f87171 100%); color: white;">&#9888;</span>
                Action Items
              </div>
              <span style="background: #fef2f2; color: #dc2626; padding: 4px 10px; border-radius: 10px; font-size: 11px; font-weight: 600;">3 urgent</span>
            </div>
            <div class="widget-body no-padding" style="padding: 16px;">
              <div class="action-items" id="actionItems">
                <!-- Populated by JS -->
              </div>
            </div>
          </div>

          <!-- Pipeline Tracker -->
          <div class="widget widget-full">
            <div class="widget-header">
              <div class="widget-title">
                <span class="widget-title-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); color: white;">&#128202;</span>
                Client Pipeline
              </div>
            </div>
            <div class="widget-body">
              <div class="pipeline" id="clientPipeline">
                <!-- Populated by JS -->
              </div>
            </div>
          </div>

          <!-- Client Similarity - Compact -->
          <div class="widget widget-third" style="max-height: 200px;">
            <div class="widget-header" style="padding: 12px 16px;">
              <div class="widget-title" style="font-size: 13px;">
                <span class="widget-title-icon" style="background: linear-gradient(135deg, #06b6d4 0%, #22d3ee 100%); color: white; width: 24px; height: 24px; font-size: 12px;">&#129309;</span>
                Similar Clients
              </div>
            </div>
            <div class="widget-body no-padding" style="padding: 12px; max-height: 140px; overflow-y: auto;">
              <div class="similar-clients" id="similarClients" style="font-size: 12px;">
                <div style="text-align: center; color: var(--text-muted); padding: 10px;">
                  Select a client to find similar profiles
                </div>
              </div>
            </div>
          </div>

          <!-- Leaderboard - Compact -->
          <div class="widget widget-third" style="max-height: 200px;">
            <div class="widget-header" style="padding: 12px 16px;">
              <div class="widget-title" style="font-size: 13px;">
                <span class="widget-title-icon" style="background: linear-gradient(135deg, #eab308 0%, #facc15 100%); color: white; width: 24px; height: 24px; font-size: 12px;">â—ˆ</span>
                Leaderboard
              </div>
            </div>
            <div class="widget-body no-padding" style="padding: 12px; max-height: 140px; overflow-y: auto;">
              <div class="leaderboard" id="leaderboard" style="font-size: 12px;">
                <!-- Populated by JS -->
              </div>
            </div>
          </div>
        </div>

        <!-- ================================================================
             STOCK MONITORING CENTER - Bloomberg-Style Alerts & Research
             ================================================================ -->
        <div class="monitoring-center">
          <!-- Price & Volume Alerts -->
          <div class="monitoring-panel">
            <div class="monitoring-header">
              <div class="monitoring-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                Price & Volume Alerts
              </div>
              <span class="monitoring-badge live"><span class="dot"></span> LIVE</span>
            </div>
            <div class="monitoring-body" id="priceAlerts">
              <!-- Critical Alert -->
              <div class="alert-item critical">
                <div class="alert-icon">!</div>
                <div class="alert-content">
                  <div class="alert-title"><span class="ticker">NVDA</span> Price Target Breached</div>
                  <div class="alert-description">Stock crossed above $950 resistance level. Volume 2.3x average.</div>
                  <div class="research-impact">
                    <div class="research-impact-header">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                      Research Impact
                    </div>
                    <div class="research-impact-text">
                      ODDO maintains Outperform rating. Breakout confirms AI chip demand thesis. Consider increasing position for growth-oriented clients.
                    </div>
                    <div class="research-impact-source">
                      <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>
                      ODDO Research | M. Schmidt | Updated 2h ago
                    </div>
                  </div>
                  <div class="alert-meta">
                    <span class="alert-time">
                      <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                      14:32 CET
                    </span>
                    <div class="alert-actions">
                      <button class="alert-action-btn view" onclick="viewStockDetail('NVDA')">View</button>
                      <button class="alert-action-btn dismiss">Dismiss</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Warning Alert -->
              <div class="alert-item warning">
                <div class="alert-icon">â–²</div>
                <div class="alert-content">
                  <div class="alert-title"><span class="ticker">SAP.DE</span> Unusual Volume Detected</div>
                  <div class="alert-description">Trading volume 180% above 20-day average. No news catalyst identified.</div>
                  <div class="research-impact">
                    <div class="research-impact-header">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                      Research Impact
                    </div>
                    <div class="research-impact-text">
                      Monitor for potential M&A activity or institutional repositioning. Current rating: Neutral (PT â‚¬185).
                    </div>
                    <div class="research-impact-source">
                      <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>
                      ODDO Quant Team | Auto-generated
                    </div>
                  </div>
                  <div class="alert-meta">
                    <span class="alert-time">
                      <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                      13:45 CET
                    </span>
                    <div class="alert-actions">
                      <button class="alert-action-btn view" onclick="viewStockDetail('SAP.DE')">View</button>
                      <button class="alert-action-btn dismiss">Dismiss</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Info Alert -->
              <div class="alert-item info">
                <div class="alert-icon">i</div>
                <div class="alert-content">
                  <div class="alert-title"><span class="ticker">LVMH.PA</span> Approaching Support Level</div>
                  <div class="alert-description">Stock trading within 2% of â‚¬720 support. RSI at 35 (oversold territory).</div>
                  <div class="alert-meta">
                    <span class="alert-time">
                      <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                      12:18 CET
                    </span>
                    <div class="alert-actions">
                      <button class="alert-action-btn view" onclick="viewStockDetail('LVMH.PA')">View</button>
                      <button class="alert-action-btn dismiss">Dismiss</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Success Alert -->
              <div class="alert-item success">
                <div class="alert-icon">&#10003;</div>
                <div class="alert-content">
                  <div class="alert-title"><span class="ticker">ASML.AS</span> Target Price Reached</div>
                  <div class="alert-description">Stock hit â‚¬780 target. Recommendation upgraded to Hold from Buy.</div>
                  <div class="alert-meta">
                    <span class="alert-time">
                      <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                      11:02 CET
                    </span>
                    <div class="alert-actions">
                      <button class="alert-action-btn view" onclick="viewStockDetail('ASML.AS')">View</button>
                      <button class="alert-action-btn dismiss">Dismiss</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Alert Setup Form -->
            <div class="alert-setup">
              <div class="alert-setup-title">Create New Alert</div>
              <div class="alert-setup-form">
                <div class="alert-setup-field">
                  <label>Ticker</label>
                  <input type="text" id="alertTicker" placeholder="e.g. AAPL">
                </div>
                <div class="alert-setup-field">
                  <label>Condition</label>
                  <select id="alertCondition">
                    <option value="price_above">Price Above</option>
                    <option value="price_below">Price Below</option>
                    <option value="volume_spike">Volume Spike</option>
                    <option value="rsi_oversold">RSI Oversold (&lt;30)</option>
                    <option value="rsi_overbought">RSI Overbought (&gt;70)</option>
                    <option value="moving_avg_cross">MA Crossover</option>
                  </select>
                </div>
                <div class="alert-setup-field">
                  <label>Value</label>
                  <input type="number" id="alertValue" placeholder="e.g. 150">
                </div>
                <button class="btn-add-alert" onclick="createPriceAlert()">+ Add Alert</button>
              </div>
            </div>
          </div>

          <!-- News Feed with Research Context -->
          <div class="monitoring-panel">
            <div class="monitoring-header">
              <div class="monitoring-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2"/></svg>
                Market News & Research Impact
              </div>
              <span class="monitoring-badge live"><span class="dot"></span> LIVE</span>
            </div>
            <div class="monitoring-body" id="newsFeed">
              <!-- Breaking News -->
              <div class="news-feed-item">
                <div class="news-header">
                  <span class="news-source breaking">BREAKING</span>
                  <span class="news-time">14:28 CET</span>
                </div>
                <div class="news-title">ECB Signals Potential Rate Cut in March Meeting Minutes</div>
                <div class="news-tickers">
                  <span class="news-ticker">EUR/USD</span>
                  <span class="news-ticker">Banking Sector</span>
                </div>
                <div class="research-impact">
                  <div class="research-impact-header">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                    Research Impact
                  </div>
                  <div class="research-impact-text">
                    Positive for equities, especially rate-sensitive sectors. ODDO overweight on European banks (BNP, SocGen). Consider increasing duration exposure.
                  </div>
                  <div class="research-impact-source">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>
                    ODDO Macro Research | P. Laurent
                  </div>
                </div>
                <div class="news-research-link" onclick="openResearchNote('ecb-rates')">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg>
                  View Full Research Note
                </div>
              </div>

              <!-- Regular News -->
              <div class="news-feed-item">
                <div class="news-header">
                  <span class="news-source">REUTERS</span>
                  <span class="news-time">13:45 CET</span>
                </div>
                <div class="news-title">Apple Reports Record Services Revenue, iPhone Sales Flat</div>
                <div class="news-tickers">
                  <span class="news-ticker">AAPL</span>
                </div>
                <div class="research-impact">
                  <div class="research-impact-header">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                    Research Impact
                  </div>
                  <div class="research-impact-text">
                    Services growth confirms margin expansion thesis. PT raised to $210. Hardware weakness priced in. Maintain Outperform.
                  </div>
                  <div class="research-impact-source">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>
                    ODDO Tech Research | S. Weber
                  </div>
                </div>
              </div>

              <!-- Earnings News -->
              <div class="news-feed-item">
                <div class="news-header">
                  <span class="news-source">EARNINGS</span>
                  <span class="news-time">12:30 CET</span>
                </div>
                <div class="news-title">Siemens Q1 Beats Estimates, Raises Full-Year Guidance</div>
                <div class="news-tickers">
                  <span class="news-ticker">SIE.DE</span>
                </div>
                <div class="research-impact">
                  <div class="research-impact-header">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                    Research Impact
                  </div>
                  <div class="research-impact-text">
                    Automation segment outperformance validates industrial recovery thesis. Upgrading to Buy. New PT â‚¬195 (+12%).
                  </div>
                  <div class="research-impact-source">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>
                    ODDO Industrials | K. Hoffmann
                  </div>
                </div>
              </div>

              <!-- M&A News -->
              <div class="news-feed-item">
                <div class="news-header">
                  <span class="news-source">BLOOMBERG</span>
                  <span class="news-time">11:15 CET</span>
                </div>
                <div class="news-title">Novo Nordisk Explores Acquisition of Smaller Biotech Firms</div>
                <div class="news-tickers">
                  <span class="news-ticker">NOVO-B.CO</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Real-Time Watchlist Monitor -->
        <div class="monitoring-panel" style="margin-top: var(--space-lg);">
          <div class="monitoring-header">
            <div class="monitoring-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
              Watchlist Monitor
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="widget-action" onclick="refreshWatchlist()">Refresh</button>
              <button class="widget-action" style="background: var(--primary); color: white;" onclick="addToWatchlist()">+ Add Stock</button>
            </div>
          </div>
          <div class="monitoring-body">
            <div class="watchlist-monitor" id="watchlistMonitor">
              <div class="watchlist-stock">
                <span class="watchlist-ticker">AAPL</span>
                <span class="watchlist-name">Apple Inc.</span>
                <span class="watchlist-price">$185.42</span>
                <span class="watchlist-change positive">+1.24%</span>
              </div>
              <div class="watchlist-stock">
                <span class="watchlist-ticker">MSFT</span>
                <span class="watchlist-name">Microsoft Corp.</span>
                <span class="watchlist-price">$415.80</span>
                <span class="watchlist-change positive">+0.87%</span>
              </div>
              <div class="watchlist-stock">
                <span class="watchlist-ticker">LVMH.PA</span>
                <span class="watchlist-name">LVMH Moet Hennessy</span>
                <span class="watchlist-price">â‚¬728.50</span>
                <span class="watchlist-change negative">-0.45%</span>
              </div>
              <div class="watchlist-stock">
                <span class="watchlist-ticker">SAP.DE</span>
                <span class="watchlist-name">SAP SE</span>
                <span class="watchlist-price">â‚¬178.32</span>
                <span class="watchlist-change positive">+2.15%</span>
              </div>
              <div class="watchlist-stock">
                <span class="watchlist-ticker">ASML.AS</span>
                <span class="watchlist-name">ASML Holding NV</span>
                <span class="watchlist-price">â‚¬782.40</span>
                <span class="watchlist-change positive">+0.32%</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: INSIGHTS (Stock Comparison & Technical) - IMPROVED -->
      <div class="tab-panel" id="panel-insights">
        <!-- Smart Comparison Suggestions -->
        <div class="premium-card" style="padding: var(--space-lg); margin-bottom: var(--space-lg);">
          <h3 style="margin: 0 0 var(--space-md) 0; font-size: var(--text-body); font-weight: 700; color: var(--primary);">Quick Comparisons</h3>
          <p style="margin: 0 0 var(--space-md) 0; font-size: var(--text-small); color: var(--text-muted);">Click to instantly compare - based on your shortlist and client portfolio</p>
          <div id="smartComparisons" style="display: flex; flex-wrap: wrap; gap: var(--space-sm);">
            <button class="btn btn-secondary" style="font-size: 12px; padding: 8px 16px;" onclick="quickCompare('top-picks')">
              Top Picks (AAPL vs MSFT vs NVDA)
            </button>
            <button class="btn btn-secondary" style="font-size: 12px; padding: 8px 16px;" onclick="quickCompare('european-luxury')">
              European Luxury (LVMH vs Hermes vs Kering)
            </button>
            <button class="btn btn-secondary" style="font-size: 12px; padding: 8px 16px;" onclick="quickCompare('german-tech')">
              German Tech (SAP vs Siemens vs Infineon)
            </button>
            <button class="btn btn-secondary" style="font-size: 12px; padding: 8px 16px;" onclick="quickCompare('banks')">
              European Banks (BNP vs SocGen vs Deutsche)
            </button>
            <button class="btn btn-primary" style="font-size: 12px; padding: 8px 16px;" onclick="compareFromShortlist()">
              Compare from Shortlist
            </button>
          </div>

          <!-- Custom Comparison -->
          <div style="margin-top: var(--space-lg); padding-top: var(--space-lg); border-top: 1px solid var(--border);">
            <label style="font-size: var(--text-small); font-weight: 600; color: var(--text-muted); display: block; margin-bottom: var(--space-sm);">Custom Comparison</label>
            <div style="display: flex; gap: var(--space-sm); align-items: center;">
              <input type="text" id="compareStock1" placeholder="Ticker 1 (e.g. AAPL)" style="flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 13px;">
              <span style="color: var(--text-muted);">vs</span>
              <input type="text" id="compareStock2" placeholder="Ticker 2 (e.g. MSFT)" style="flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 13px;">
              <span style="color: var(--text-muted);">vs</span>
              <input type="text" id="compareStock3" placeholder="Ticker 3 (optional)" style="flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 13px;">
              <button class="btn btn-primary" onclick="compareStocks()" style="padding: 10px 20px;">Compare</button>
            </div>
          </div>
        </div>

        <div class="dashboard-grid">
          <!-- Stock Comparison Results -->
          <div class="widget widget-full">
            <div class="widget-header">
              <div class="widget-title">
                <span class="widget-title-icon" style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%); color: white;">&#9878;</span>
                Comparison Results
              </div>
              <div class="widget-actions">
                <button class="widget-action" onclick="exportComparison()">Export</button>
                <button class="widget-action" onclick="addToStory()">Add to Story</button>
              </div>
            </div>
            <div class="widget-body" id="stockComparison">
              <div style="text-align: center; color: var(--text-muted); padding: 40px;">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: 16px; opacity: 0.5;"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                <p style="margin: 0;">Select a quick comparison above or enter tickers manually</p>
              </div>
            </div>
          </div>

          <!-- Technical Indicators -->
          <div class="widget widget-half">
            <div class="widget-header">
              <div class="widget-title">
                <span class="widget-title-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); color: white;">â–²</span>
                Technical Analysis
              </div>
            </div>
            <div class="widget-body" id="technicalIndicators">
              <div style="padding: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                  <div style="background: var(--soft-greige); padding: 12px; border-radius: var(--radius);">
                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">RSI (14)</div>
                    <div style="font-size: 18px; font-weight: 700; color: #f59e0b;">54.2</div>
                    <div style="font-size: 10px; color: var(--text-muted);">Neutral</div>
                  </div>
                  <div style="background: var(--soft-greige); padding: 12px; border-radius: var(--radius);">
                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">MACD</div>
                    <div style="font-size: 18px; font-weight: 700; color: #10b981;">Bullish</div>
                    <div style="font-size: 10px; color: var(--text-muted);">Cross above signal</div>
                  </div>
                  <div style="background: var(--soft-greige); padding: 12px; border-radius: var(--radius);">
                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">50-Day MA</div>
                    <div style="font-size: 18px; font-weight: 700; color: #10b981;">Above</div>
                    <div style="font-size: 10px; color: var(--text-muted);">+3.2% from MA</div>
                  </div>
                  <div style="background: var(--soft-greige); padding: 12px; border-radius: var(--radius);">
                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Volume</div>
                    <div style="font-size: 18px; font-weight: 700; color: var(--text);">1.2x</div>
                    <div style="font-size: 10px; color: var(--text-muted);">vs 20-day avg</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- AI Insights -->
          <div class="widget widget-half">
            <div class="widget-header">
              <div class="widget-title">
                <span class="widget-title-icon" style="background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%); color: white;">AI</span>
                AI Insights
              </div>
            </div>
            <div class="widget-body" id="aiInsights">
              <div style="padding: 16px;">
                <div style="background: linear-gradient(135deg, rgba(0,61,57,0.05) 0%, rgba(0,61,57,0.02) 100%); padding: 16px; border-radius: var(--radius); border-left: 3px solid var(--primary); margin-bottom: 12px;">
                  <div style="font-size: 12px; font-weight: 600; color: var(--primary); margin-bottom: 8px;">Key Insight</div>
                  <p style="margin: 0; font-size: 13px; line-height: 1.5;">Based on current market conditions and your client's risk profile, consider increasing exposure to defensive sectors while reducing cyclical positions.</p>
                </div>
                <button class="btn btn-secondary" style="width: 100%; font-size: 12px;" onclick="generateAIInsights()">Generate More Insights</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: SHORTLIST -->
      <div class="tab-panel active" id="panel-shortlist">
        <div class="instruction-box">
          <div class="instruction-label">Instructions (optional)</div>
          <textarea
            class="instruction-input"
            id="instruction"
            placeholder="e.g. 'Focus on defensive stocks' or 'Address concerns from last call'..."
          ></textarea>
          <div class="quick-prompts">
            <span class="quick-prompt" data-prompt="Diversify away from top sector">Diversify</span>
            <span class="quick-prompt" data-prompt="Use call notes intensively, address concerns">Use Call Notes</span>
            <span class="quick-prompt" data-prompt="Conservative, prefer low volatility">Conservative</span>
            <span class="quick-prompt" data-prompt="Focus on high conviction stocks">High Conviction</span>
          </div>
        </div>

        <!-- FILTER BAR -->
        <div class="filter-bar" id="filterBar">
          <div class="filter-group">
            <span class="filter-label">Sector:</span>
            <select class="filter-select" id="filterSector">
              <option value="">All Sectors</option>
              <!-- Dynamically loaded from API -->
            </select>
          </div>
          <div class="filter-group">
            <span class="filter-label">Risk:</span>
            <select class="filter-select" id="filterRisk">
              <option value="">All Risk</option>
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
            </select>
          </div>
          <div class="filter-group">
            <span class="filter-chip" data-filter="top" id="filterTopOnly">TOP Picks Only</span>
          </div>
          <div style="margin-left: auto; font-size: 12px; color: var(--text-muted);">
            <span id="stockCount">0</span> stocks
          </div>
        </div>

        <div class="stock-grid" id="stockGrid">
          <div class="empty-state">
            <h3>No Shortlist</h3>
            <p>Click "Generate Shortlist" to get recommendations.</p>
          </div>
        </div>
      </div>

      <!-- TAB: STORY (Enhanced with Governance) -->
      <div class="tab-panel" id="panel-story">
        <div class="story-layout">
          <!-- Story Controls -->
          <div class="story-controls">
            <div class="control-group">
              <button class="btn btn-primary" id="storyFullBtn" disabled>Generate Full Story</button>
              <button class="btn btn-secondary" id="storyBulletsBtn" disabled>Quick Summary</button>
              <button class="btn btn-secondary" id="storyCompareBtn" disabled>Compare View</button>
            </div>
            <div class="control-group">
              <span id="selectedStock" class="selected-stock-badge">No Stock Selected</span>
            </div>
          </div>

          <!-- Story Main Content -->
          <div class="story-main">
            <!-- Left: Stock Search & Selection -->
            <div class="story-sidebar">
              <div class="sidebar-section">
                <h4 class="sidebar-title">Stock Selection</h4>
                <div class="stock-search-wrapper">
                  <input type="text" id="stockSearchInput" class="stock-search-input" placeholder="Search ticker or company..."/>
                  <div id="stockSearchResults" class="stock-search-results" style="display: none;"></div>
                </div>
              </div>

              <div class="sidebar-section">
                <h4 class="sidebar-title">Story Settings</h4>
                <div class="setting-item">
                  <label>Tone</label>
                  <select id="storyTone">
                    <option value="professional">Professional</option>
                    <option value="concise">Concise</option>
                    <option value="detailed">Detailed Analysis</option>
                    <option value="persuasive">Persuasive</option>
                  </select>
                </div>
                <div class="setting-item">
                  <label>Focus Areas</label>
                  <div class="checkbox-list">
                    <label><input type="checkbox" checked> Fundamentals</label>
                    <label><input type="checkbox" checked> Technical Analysis</label>
                    <label><input type="checkbox" checked> ODDO Research</label>
                    <label><input type="checkbox"> ESG Factors</label>
                    <label><input type="checkbox"> Peer Comparison</label>
                  </div>
                </div>
                <div class="setting-item">
                  <label>Client Context</label>
                  <select id="storyClientContext">
                    <option value="general">General Audience</option>
                    <option value="specific">Current Client Profile</option>
                    <option value="institutional">Institutional Focus</option>
                    <option value="retail">Retail Focus</option>
                  </select>
                </div>
              </div>

              <div class="sidebar-section">
                <h4 class="sidebar-title">Quick Actions</h4>
                <button class="action-btn" onclick="addToClientEmail()">Add to Email Draft</button>
                <button class="action-btn" onclick="scheduleFollowUp()">Schedule Follow-up</button>
                <button class="action-btn" onclick="exportToPDF()">Export to PDF</button>
              </div>
            </div>

            <!-- Right: Story Output -->
            <div class="story-output-area">
              <div class="output-panel" id="outputPanel" style="display: none;">
                <div class="output-header">
                  <span class="output-title" id="outputTitle">Investment Story</span>
                  <div class="output-actions">
                    <button class="btn-sm" onclick="toggleEditMode()">Edit</button>
                    <button class="btn-sm" onclick="regenerateStory()">Regenerate</button>
                    <button class="btn-sm" id="copyBtn">Copy</button>
                  </div>
                </div>
                <div class="output-body">
                  <div class="output-text" id="outputText" contenteditable="false"></div>
                </div>

                <!-- Story Refinement Section -->
                <div class="story-refinement" style="padding: 16px; background: var(--soft-greige); border-top: 1px solid var(--border);">
                  <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 8px;">Refine Story</label>
                  <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
                    <button class="btn-sm btn-secondary" onclick="refineStory('shorter')">Make Shorter</button>
                    <button class="btn-sm btn-secondary" onclick="refineStory('longer')">Add Details</button>
                    <button class="btn-sm btn-secondary" onclick="refineStory('simpler')">Simplify Language</button>
                    <button class="btn-sm btn-secondary" onclick="refineStory('risks')">Add Risk Focus</button>
                    <button class="btn-sm btn-secondary" onclick="refineStory('bullish')">More Bullish</button>
                    <button class="btn-sm btn-secondary" onclick="refineStory('cautious')">More Cautious</button>
                  </div>
                  <div style="display: flex; gap: 8px;">
                    <input type="text" id="customRefinement" placeholder="Custom instruction: e.g. 'Add comparison with competitor XYZ'" style="flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 13px;">
                    <button class="btn btn-primary" style="padding: 10px 20px; font-size: 13px;" onclick="refineStoryCustom()">Apply</button>
                  </div>
                </div>

                <!-- Governance Section -->
                <div class="governance-section" id="storyGovernance" style="display: none;">
                  <div class="governance-header">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    <span>Sources & Methodology</span>
                  </div>
                  <div class="governance-content" id="governanceContent">
                    <!-- Populated by JS -->
                  </div>
                </div>
              </div>

              <div class="empty-state" id="storyEmpty">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                </svg>
                <h3>Create Investment Story</h3>
                <p>Select a stock from your shortlist or search above to generate a personalized investment narrative.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: AI ADVISOR -->
      <div class="tab-panel" id="panel-advisor">
        <div class="advisor-layout">
          <!-- Header with Client Context -->
          <div class="advisor-header">
            <div class="advisor-title-section">
              <h2>AI Portfolio Advisor</h2>
              <p class="advisor-subtitle">Personalized recommendations powered by multi-strategy analysis</p>
            </div>
            <div class="client-context-section">
              <div class="context-badge" id="advisorClientBadge">
                <span class="context-label">Active Client:</span>
                <span class="context-value" id="advisorClientName">Select a client</span>
              </div>
              <button class="btn-sm" onclick="refreshAdvisorAnalysis()">Refresh Analysis</button>
            </div>
          </div>

          <!-- Main Advisor Grid -->
          <div class="advisor-grid">
            <!-- Left Panel: Portfolio Overview -->
            <div class="advisor-panel portfolio-overview-panel">
              <div class="panel-header">
                <h3>Current Portfolio</h3>
                <span class="panel-badge" id="portfolioValue">--</span>
              </div>
              <div class="panel-body">
                <div class="portfolio-holdings" id="portfolioHoldings">
                  <div class="holding-item">
                    <div class="holding-info">
                      <span class="holding-ticker">AAPL</span>
                      <span class="holding-name">Apple Inc.</span>
                    </div>
                    <div class="holding-metrics">
                      <span class="holding-weight">25%</span>
                      <span class="holding-pnl positive">+12.4%</span>
                    </div>
                  </div>
                  <div class="holding-item">
                    <div class="holding-info">
                      <span class="holding-ticker">MSFT</span>
                      <span class="holding-name">Microsoft Corp.</span>
                    </div>
                    <div class="holding-metrics">
                      <span class="holding-weight">20%</span>
                      <span class="holding-pnl positive">+8.7%</span>
                    </div>
                  </div>
                  <div class="holding-item">
                    <div class="holding-info">
                      <span class="holding-ticker">LVMH.PA</span>
                      <span class="holding-name">LVMH</span>
                    </div>
                    <div class="holding-metrics">
                      <span class="holding-weight">15%</span>
                      <span class="holding-pnl negative">-3.2%</span>
                    </div>
                  </div>
                </div>

                <div class="portfolio-metrics-summary">
                  <div class="metric-row">
                    <span>Total Return (YTD)</span>
                    <span class="metric-value positive" id="portfolioYTD">+8.4%</span>
                  </div>
                  <div class="metric-row">
                    <span>Risk Score</span>
                    <span class="metric-value" id="portfolioRisk">6.2/10</span>
                  </div>
                  <div class="metric-row">
                    <span>Sharpe Ratio</span>
                    <span class="metric-value" id="portfolioSharpe">1.12</span>
                  </div>
                </div>

                <button class="btn-primary full-width" onclick="runPortfolioAnalysis()">
                  Run Full Analysis
                </button>
              </div>
            </div>

            <!-- Center Panel: AI Recommendations -->
            <div class="advisor-panel recommendations-panel">
              <div class="panel-header">
                <h3>AI Recommendations</h3>
                <div class="confidence-badge">
                  <span class="confidence-label">Confidence:</span>
                  <span class="confidence-value" id="aiConfidence">--</span>
                </div>
              </div>
              <div class="panel-body">
                <div class="recommendations-list" id="aiRecommendations">
                  <div class="recommendation-placeholder">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <circle cx="12" cy="12" r="10"></circle>
                      <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                      <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    <p>Click "Run Full Analysis" to generate personalized AI recommendations based on:</p>
                    <ul>
                      <li>Multi-strategy backtesting (12 strategies)</li>
                      <li>ODDO BHF Research opinions</li>
                      <li>Client risk profile matching</li>
                      <li>Current market conditions</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>

            <!-- Right Panel: Governance & Sources -->
            <div class="advisor-panel governance-panel">
              <div class="panel-header">
                <h3>Governance & Sources</h3>
              </div>
              <div class="panel-body">
                <div class="governance-intro">
                  <p>Every recommendation is traceable. Click any insight to see its source.</p>
                </div>

                <div class="source-categories" id="sourcesBreakdown">
                  <div class="source-category">
                    <div class="source-header">
                      <span class="source-icon">R</span>
                      <span class="source-name">ODDO BHF Research</span>
                    </div>
                    <div class="source-items" id="odooResearchSources">
                      <span class="source-item">Loading...</span>
                    </div>
                  </div>

                  <div class="source-category">
                    <div class="source-header">
                      <span class="source-icon">M</span>
                      <span class="source-name">Market Data</span>
                    </div>
                    <div class="source-items" id="marketDataSources">
                      <span class="source-item">Yahoo Finance (Real-time)</span>
                      <span class="source-item">Historical prices (5Y)</span>
                    </div>
                  </div>

                  <div class="source-category">
                    <div class="source-header">
                      <span class="source-icon">A</span>
                      <span class="source-name">Algorithm Details</span>
                    </div>
                    <div class="source-items" id="algorithmSources">
                      <span class="source-item">Momentum Strategy</span>
                      <span class="source-item">Mean Reversion</span>
                      <span class="source-item">Value Factor</span>
                    </div>
                  </div>
                </div>

                <div class="methodology-section">
                  <h4>Methodology</h4>
                  <div class="methodology-content" id="methodologyContent">
                    <p>Our AI advisor uses a multi-factor approach combining quantitative signals with fundamental research from ODDO BHF analysts.</p>
                    <button class="btn-sm" onclick="showFullMethodology()">View Full Methodology</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Strategy Backtest Results -->
          <div class="backtest-results-section" id="strategyBacktestSection" style="display: none;">
            <div class="section-header">
              <h3>Multi-Strategy Backtest Results</h3>
              <p>Tested 12 strategies against current portfolio composition</p>
            </div>
            <div class="strategy-results-grid" id="strategyResultsGrid">
              <!-- Populated by JS -->
            </div>
          </div>

          <!-- Detailed Recommendations -->
          <div class="detailed-recommendations" id="detailedRecommendations" style="display: none;">
            <div class="section-header">
              <h3>Detailed Action Plan</h3>
              <div class="export-actions">
                <button class="btn-sm" onclick="exportRecommendationsPDF()">Export PDF</button>
                <button class="btn-sm" onclick="sendToClient()">Send to Client</button>
              </div>
            </div>
            <div class="recommendations-detail-grid" id="recommendationsDetailGrid">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: COLLABORATE -->
      <div class="tab-panel" id="panel-collaborate">
        <div class="collab-layout">
          <!-- Team Chat Section -->
          <div class="collab-section chat-section">
            <div class="section-header glass-effect">
              <div class="section-title">
                <svg class="section-icon-svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                <h3>Team Chat</h3>
                <span class="online-indicator">3 online</span>
              </div>
              <div class="section-actions">
                <button class="btn-icon" title="Video Call" onclick="startVideoCall()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
                </button>
                <button class="btn-icon" title="Screen Share" onclick="startScreenShare()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
                </button>
              </div>
            </div>
            <div class="chat-container" id="teamChatContainer">
              <div class="chat-message incoming">
                <div class="chat-avatar">MK</div>
                <div class="chat-content">
                  <div class="chat-meta">
                    <span class="chat-sender">Marc Klein</span>
                    <span class="chat-time">09:34</span>
                  </div>
                  <div class="chat-text">Just finished the LVMH analysis. Looking strong for Q1 earnings. Want me to share the deck?</div>
                </div>
              </div>
              <div class="chat-message incoming">
                <div class="chat-avatar">SB</div>
                <div class="chat-content">
                  <div class="chat-meta">
                    <span class="chat-sender">Sophie Bernard</span>
                    <span class="chat-time">09:41</span>
                  </div>
                  <div class="chat-text">Great timing! Client MÃ¼ller AG just called about luxury sector exposure. Can we schedule a call for 14:00?</div>
                </div>
              </div>
              <div class="chat-message outgoing">
                <div class="chat-content">
                  <div class="chat-meta">
                    <span class="chat-sender">You</span>
                    <span class="chat-time">09:45</span>
                  </div>
                  <div class="chat-text">Perfect. I'll prep the client profile and merge the LVMH data. See you at 14:00.</div>
                </div>
              </div>
            </div>
            <div class="chat-input-area">
              <input type="text" id="chatInput" placeholder="Type your message..." onkeypress="handleChatKeypress(event)">
              <button class="btn-send" onclick="sendChatMessage()">
                <span>Send</span>
                <span class="send-icon">â†’</span>
              </button>
            </div>
          </div>

          <!-- Shared Watchlists -->
          <div class="collab-section watchlist-section">
            <div class="section-header glass-effect">
              <div class="section-title">
                <span class="section-icon"><svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg></span>
                <h3>Shared Watchlists</h3>
              </div>
              <button class="btn-create" onclick="createWatchlist()">+ New List</button>
            </div>
            <div class="watchlists-grid" id="sharedWatchlists">
              <div class="watchlist-card" onclick="openWatchlist('tech-growth')">
                <div class="watchlist-header">
                  <span class="watchlist-icon">Growth</span>
                  <div class="watchlist-info">
                    <h4>Tech Growth Picks</h4>
                    <span class="watchlist-meta">8 stocks â€¢ Updated 2h ago</span>
                  </div>
                </div>
                <div class="watchlist-members">
                  <div class="member-avatar">MK</div>
                  <div class="member-avatar">SB</div>
                  <div class="member-avatar">+2</div>
                </div>
                <div class="watchlist-performance positive">
                  <span class="perf-value">+4.2%</span>
                  <span class="perf-label">Avg. return</span>
                </div>
              </div>
              <div class="watchlist-card" onclick="openWatchlist('dividend-kings')">
                <div class="watchlist-header">
                  <span class="watchlist-icon">Premium</span>
                  <div class="watchlist-info">
                    <h4>Dividend Kings</h4>
                    <span class="watchlist-meta">12 stocks â€¢ Updated 5h ago</span>
                  </div>
                </div>
                <div class="watchlist-members">
                  <div class="member-avatar">TW</div>
                  <div class="member-avatar">JP</div>
                </div>
                <div class="watchlist-performance positive">
                  <span class="perf-value">+2.8%</span>
                  <span class="perf-label">Avg. yield</span>
                </div>
              </div>
              <div class="watchlist-card" onclick="openWatchlist('eu-green')">
                <div class="watchlist-header">
                  <span class="watchlist-icon">ESG</span>
                  <div class="watchlist-info">
                    <h4>EU Green Energy</h4>
                    <span class="watchlist-meta">6 stocks â€¢ Updated 1d ago</span>
                  </div>
                </div>
                <div class="watchlist-members">
                  <div class="member-avatar">LM</div>
                </div>
                <div class="watchlist-performance negative">
                  <span class="perf-value">-1.3%</span>
                  <span class="perf-label">Avg. return</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Client Handoff -->
          <div class="collab-section handoff-section">
            <div class="section-header glass-effect">
              <div class="section-title">
                <span class="section-icon"><svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></span>
                <h3>Client Handoff</h3>
              </div>
              <button class="btn-create" onclick="initiateHandoff()">+ New Handoff</button>
            </div>
            <div class="handoff-list" id="handoffList">
              <div class="handoff-card active">
                <div class="handoff-status-bar"></div>
                <div class="handoff-content">
                  <div class="handoff-header">
                    <h4>MÃ¼ller AG â†’ Sophie Bernard</h4>
                    <span class="handoff-badge in-progress">In Progress</span>
                  </div>
                  <div class="handoff-details">
                    <div class="handoff-item">
                      <span class="handoff-label">Client Type:</span>
                      <span class="handoff-value">Institutional</span>
                    </div>
                    <div class="handoff-item">
                      <span class="handoff-label">AUM:</span>
                      <span class="handoff-value">â‚¬45M</span>
                    </div>
                    <div class="handoff-item">
                      <span class="handoff-label">Due Date:</span>
                      <span class="handoff-value">Jan 28, 2026</span>
                    </div>
                  </div>
                  <div class="handoff-progress">
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: 65%"></div>
                    </div>
                    <span class="progress-text">65% Complete</span>
                  </div>
                  <div class="handoff-actions">
                    <button class="btn-sm btn-primary" onclick="viewHandoffDetails('mueller')">View Details</button>
                    <button class="btn-sm btn-secondary" onclick="addHandoffNote('mueller')">Add Note</button>
                  </div>
                </div>
              </div>
              <div class="handoff-card">
                <div class="handoff-status-bar completed"></div>
                <div class="handoff-content">
                  <div class="handoff-header">
                    <h4>Schneider GmbH â†’ Marc Klein</h4>
                    <span class="handoff-badge completed">Completed</span>
                  </div>
                  <div class="handoff-details">
                    <div class="handoff-item">
                      <span class="handoff-label">Completed:</span>
                      <span class="handoff-value">Jan 15, 2026</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: REPORTS -->
      <div class="tab-panel" id="panel-reports">
        <div class="reports-layout">
          <!-- Report Generator -->
          <div class="report-generator">
            <div class="generator-header glass-effect">
              <div class="generator-title">
                <span class="generator-icon"></span>
                <div>
                  <h3>Report Generator</h3>
                  <p class="generator-subtitle">Create professional client reports in seconds</p>
                </div>
              </div>
            </div>
            <div class="generator-body">
              <div class="report-type-selector">
                <div class="report-type selected" onclick="selectReportType(this, 'pdf')">
                  <div class="type-icon pdf">PDF</div>
                  <div class="type-info">
                    <span class="type-name">PDF Report</span>
                    <span class="type-desc">Professional document</span>
                  </div>
                </div>
                <div class="report-type" onclick="selectReportType(this, 'pptx')">
                  <div class="type-icon pptx">PPT</div>
                  <div class="type-info">
                    <span class="type-name">PowerPoint</span>
                    <span class="type-desc">Presentation deck</span>
                  </div>
                </div>
                <div class="report-type" onclick="selectReportType(this, 'xlsx')">
                  <div class="type-icon xlsx">XLS</div>
                  <div class="type-info">
                    <span class="type-name">Excel Export</span>
                    <span class="type-desc">Data spreadsheet</span>
                  </div>
                </div>
              </div>

              <div class="report-options">
                <div class="option-group">
                  <label>Report Template</label>
                  <select id="reportTemplate" onchange="updateReportSections(this.value)">
                    <option value="equity-research">Equity Research Report</option>
                    <option value="executive">Executive Summary</option>
                    <option value="detailed">Detailed Analysis</option>
                    <option value="quarterly">Quarterly Review</option>
                    <option value="portfolio">Portfolio Performance</option>
                    <option value="custom">Custom Template</option>
                  </select>
                </div>
                <div class="option-group">
                  <label>Stock / Company</label>
                  <input type="text" id="reportStockTicker" placeholder="e.g. AAPL, LVMH.PA" style="padding: 10px 12px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 14px; width: 100%;">
                </div>
                <div class="option-group">
                  <label>Date Range</label>
                  <select id="reportDateRange">
                    <option value="mtd">Month to Date</option>
                    <option value="qtd">Quarter to Date</option>
                    <option value="ytd">Year to Date</option>
                    <option value="1y">Last 12 Months</option>
                    <option value="custom">Custom Range</option>
                  </select>
                </div>
                <div class="option-group">
                  <label>Include Sections (Equity Research)</label>
                  <div class="checkbox-grid" id="researchSections">
                    <label class="checkbox-item"><input type="checkbox" checked data-section="summary"> Executive Summary</label>
                    <label class="checkbox-item"><input type="checkbox" checked data-section="thesis"> Investment Thesis</label>
                    <label class="checkbox-item"><input type="checkbox" checked data-section="rating"> Rating & Target Price</label>
                    <label class="checkbox-item"><input type="checkbox" checked data-section="financials"> Financial Analysis</label>
                    <label class="checkbox-item"><input type="checkbox" checked data-section="valuation"> Valuation (DCF, Multiples)</label>
                    <label class="checkbox-item"><input type="checkbox" checked data-section="catalysts"> Catalysts & Risks</label>
                    <label class="checkbox-item"><input type="checkbox" data-section="industry"> Industry Overview</label>
                    <label class="checkbox-item"><input type="checkbox" data-section="peers"> Peer Comparison</label>
                    <label class="checkbox-item"><input type="checkbox" checked data-section="charts"> Price Charts & Technicals</label>
                  </div>
                </div>
              </div>

              <!-- Research Report Preview - Professional Layout -->
              <div class="research-report-preview" id="researchReportPreview">
                <div class="research-report-header">
                  <div class="report-branding">
                    <img src="/static/Oddo_BHF_logo.svg.png" alt="ODDO BHF" class="report-logo">
                    <span class="report-division">Equity Research</span>
                  </div>
                  <div class="report-meta-info">
                    <span class="report-date">January 25, 2026</span>
                    <span class="report-type-label">Initiation of Coverage</span>
                  </div>
                </div>

                <div class="research-report-body">
                  <!-- Rating Banner -->
                  <div class="rating-banner">
                    <div class="rating-left">
                      <span class="company-ticker" id="previewTicker">AAPL</span>
                      <span class="company-name" id="previewCompanyName">Apple Inc.</span>
                      <span class="company-sector">Technology / Consumer Electronics</span>
                    </div>
                    <div class="rating-center">
                      <div class="rating-box outperform">
                        <span class="rating-label">Rating</span>
                        <span class="rating-value">OUTPERFORM</span>
                      </div>
                    </div>
                    <div class="rating-right">
                      <div class="target-box">
                        <span class="target-label">Target Price</span>
                        <span class="target-value">$210.00</span>
                        <span class="target-upside">+13.5% upside</span>
                      </div>
                    </div>
                  </div>

                  <!-- Key Metrics Strip -->
                  <div class="metrics-strip">
                    <div class="metric-item">
                      <span class="metric-key">Market Cap</span>
                      <span class="metric-val">$2.89T</span>
                    </div>
                    <div class="metric-item">
                      <span class="metric-key">P/E (FY25E)</span>
                      <span class="metric-val">28.4x</span>
                    </div>
                    <div class="metric-item">
                      <span class="metric-key">EV/EBITDA</span>
                      <span class="metric-val">21.2x</span>
                    </div>
                    <div class="metric-item">
                      <span class="metric-key">Dividend Yield</span>
                      <span class="metric-val">0.52%</span>
                    </div>
                    <div class="metric-item">
                      <span class="metric-key">52W Range</span>
                      <span class="metric-val">$164 - $199</span>
                    </div>
                  </div>

                  <!-- Executive Summary -->
                  <div class="report-section">
                    <h4 class="section-heading">Executive Summary</h4>
                    <div class="summary-bullets">
                      <div class="bullet-point">
                        <span class="bullet-icon">â–º</span>
                        <span class="bullet-text">Services segment continues to drive margin expansion, now representing 24% of total revenue with 70%+ gross margins.</span>
                      </div>
                      <div class="bullet-point">
                        <span class="bullet-icon">â–º</span>
                        <span class="bullet-text">iPhone 16 cycle showing resilience despite hardware maturity concerns; India market growing at 35% YoY.</span>
                      </div>
                      <div class="bullet-point">
                        <span class="bullet-icon">â–º</span>
                        <span class="bullet-text">Vision Pro positions Apple for spatial computing leadership; enterprise adoption exceeding expectations.</span>
                      </div>
                    </div>
                  </div>

                  <!-- Investment Thesis -->
                  <div class="report-section">
                    <h4 class="section-heading">Investment Thesis</h4>
                    <p class="thesis-text">
                      We initiate coverage with an Outperform rating based on three key drivers: (1) accelerating Services growth providing recurring revenue stability and margin tailwinds, (2) underappreciated optionality from Apple Intelligence and on-device AI capabilities, and (3) strong capital return program with $90B+ annual buybacks supporting EPS growth.
                    </p>
                  </div>

                  <!-- Financial Snapshot -->
                  <div class="report-section">
                    <h4 class="section-heading">Financial Forecasts</h4>
                    <table class="financials-table">
                      <thead>
                        <tr>
                          <th>USD millions</th>
                          <th>FY24A</th>
                          <th>FY25E</th>
                          <th>FY26E</th>
                          <th>FY27E</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>Revenue</td>
                          <td>383,285</td>
                          <td>401,450</td>
                          <td>425,120</td>
                          <td>451,890</td>
                        </tr>
                        <tr>
                          <td>EBITDA</td>
                          <td>125,820</td>
                          <td>135,490</td>
                          <td>147,270</td>
                          <td>159,410</td>
                        </tr>
                        <tr>
                          <td>Net Income</td>
                          <td>96,995</td>
                          <td>104,380</td>
                          <td>113,850</td>
                          <td>123,120</td>
                        </tr>
                        <tr>
                          <td>EPS (diluted)</td>
                          <td>$6.13</td>
                          <td>$6.72</td>
                          <td>$7.45</td>
                          <td>$8.21</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <!-- Analyst Info -->
                  <div class="analyst-footer">
                    <div class="analyst-info">
                      <span class="analyst-name">Stefan Weber, CFA</span>
                      <span class="analyst-title">Senior Equity Analyst - Technology</span>
                      <span class="analyst-contact">stefan.weber@oddo-bhf.com | +49 69 123 4567</span>
                    </div>
                    <div class="disclaimer-mini">
                      ODDO BHF. This document is for informational purposes only. See full disclosures on page 12.
                    </div>
                  </div>
                </div>
              </div>

              <div class="report-preview-section">
                <div class="preview-header">
                  <h4>Preview</h4>
                  <button class="btn-refresh" onclick="refreshPreview()">â†» Refresh</button>
                </div>
                <div class="preview-container" id="reportPreview">
                  <div class="preview-page">
                    <div class="preview-header-bar">
                      <img src="https://www.oddo-bhf.com/typo3conf/ext/ob_base/Resources/Public/Images/logo-oddo-bhf.svg" alt="ODDO BHF" class="preview-logo">
                      <span class="preview-date">January 2026</span>
                    </div>
                    <div class="preview-title">Client Portfolio Report</div>
                    <div class="preview-subtitle">Executive Summary</div>
                    <div class="preview-content-placeholder">
                      <div class="placeholder-line full"></div>
                      <div class="placeholder-line full"></div>
                      <div class="placeholder-line half"></div>
                      <div class="placeholder-chart"></div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="report-actions">
                <button class="btn-generate" onclick="generateReport()">
                  <span class="btn-icon"></span>
                  <span>Generate Report</span>
                </button>
                <button class="btn-schedule" onclick="scheduleReport()">
                  <span class="btn-icon"></span>
                  <span>Schedule</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Recent Reports -->
          <div class="recent-reports">
            <div class="reports-header glass-effect">
              <h3>Recent Reports</h3>
              <div class="reports-filter">
                <button class="filter-btn active">All</button>
                <button class="filter-btn">PDF</button>
                <button class="filter-btn">PPT</button>
                <button class="filter-btn">Excel</button>
              </div>
            </div>
            <div class="reports-list" id="recentReportsList">
              <div class="report-item" onclick="openReport('report-001')">
                <div class="report-type-badge pdf">PDF</div>
                <div class="report-info">
                  <h4>Q4 2025 Portfolio Review - MÃ¼ller AG</h4>
                  <span class="report-meta">Generated Jan 20, 2026 â€¢ 12 pages</span>
                </div>
                <div class="report-actions">
                  <button class="btn-icon" title="Download">â†“</button>
                  <button class="btn-icon" title="Share">â†—</button>
                </div>
              </div>
              <div class="report-item" onclick="openReport('report-002')">
                <div class="report-type-badge pptx">PPT</div>
                <div class="report-info">
                  <h4>Tech Sector Outlook - Client Presentation</h4>
                  <span class="report-meta">Generated Jan 18, 2026 â€¢ 24 slides</span>
                </div>
                <div class="report-actions">
                  <button class="btn-icon" title="Download">â†“</button>
                  <button class="btn-icon" title="Share">â†—</button>
                </div>
              </div>
              <div class="report-item" onclick="openReport('report-003')">
                <div class="report-type-badge xlsx">XLS</div>
                <div class="report-info">
                  <h4>Holdings Export - All Clients</h4>
                  <span class="report-meta">Generated Jan 15, 2026 â€¢ 847 rows</span>
                </div>
                <div class="report-actions">
                  <button class="btn-icon" title="Download">â†“</button>
                  <button class="btn-icon" title="Share">â†—</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: ANALYTICS -->
      <div class="tab-panel" id="panel-analytics">
        <div class="analytics-layout">
          <!-- Analytics Toolbar -->
          <div class="analytics-toolbar">
            <div class="tool-group">
              <span class="tool-label">Analysis Module</span>
              <div class="tool-buttons">
                <button class="tool-btn active" onclick="switchAnalytics(this, 'strategy')">Strategy Builder</button>
                <button class="tool-btn" onclick="switchAnalytics(this, 'optimizer')">Portfolio Optimizer</button>
                <button class="tool-btn" onclick="switchAnalytics(this, 'backtest')">Backtesting</button>
                <button class="tool-btn" onclick="switchAnalytics(this, 'clientfit')">Client Fit Analysis</button>
              </div>
            </div>
            <div class="tool-group" id="clientContextDisplay">
              <span class="tool-label">Active Client</span>
              <span class="client-context-badge" id="analyticsClientBadge">No client selected</span>
            </div>
          </div>

          <!-- TRADING STRATEGY BUILDER -->
          <div class="analytics-panel active" id="analytics-strategy">
            <div class="strategy-builder-layout">
              <!-- Strategy Input Section -->
              <div class="strategy-input-panel">
                <div class="panel-header">
                  <h3>Trading Strategy Builder</h3>
                  <p class="panel-subtitle">Define your investment thesis and convert it to a testable strategy</p>
                </div>

                <!-- Investment Thesis Input -->
                <div class="input-section">
                  <label class="input-label">Investment Thesis</label>
                  <textarea id="investmentThesis" class="thesis-input" placeholder="Describe your investment idea in natural language, e.g.: 'I believe European luxury stocks will outperform due to strong Chinese demand recovery. Focus on companies with >20% APAC exposure and strong brand pricing power.'"></textarea>
                </div>

                <!-- Strategy Parameters -->
                <div class="input-section">
                  <label class="input-label">Strategy Parameters</label>
                  <div class="params-grid">
                    <div class="param-item">
                      <label>Entry Signal</label>
                      <select id="entrySignal">
                        <option value="momentum">Momentum Breakout</option>
                        <option value="meanrev">Mean Reversion</option>
                        <option value="value">Value Threshold</option>
                        <option value="earnings">Post-Earnings Drift</option>
                        <option value="technical">Technical Pattern</option>
                        <option value="custom">Custom Rule</option>
                      </select>
                    </div>
                    <div class="param-item">
                      <label>Exit Strategy</label>
                      <select id="exitStrategy">
                        <option value="trailing">Trailing Stop (15%)</option>
                        <option value="target">Price Target</option>
                        <option value="time">Time-Based (90 days)</option>
                        <option value="signal">Signal Reversal</option>
                        <option value="combo">Combo (Stop + Target)</option>
                      </select>
                    </div>
                    <div class="param-item">
                      <label>Position Sizing</label>
                      <select id="positionSizing">
                        <option value="equal">Equal Weight</option>
                        <option value="conviction">Conviction-Based</option>
                        <option value="volatility">Volatility-Adjusted</option>
                        <option value="kelly">Kelly Criterion</option>
                      </select>
                    </div>
                    <div class="param-item">
                      <label>Rebalance Frequency</label>
                      <select id="rebalanceFreq">
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="trigger">Trigger-Based</option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Risk Parameters -->
                <div class="input-section">
                  <label class="input-label">Risk Management</label>
                  <div class="risk-params">
                    <div class="risk-row">
                      <span>Max Portfolio Drawdown</span>
                      <div class="risk-input-group">
                        <input type="number" id="maxDrawdown" value="15" min="5" max="50">
                        <span class="unit">%</span>
                      </div>
                    </div>
                    <div class="risk-row">
                      <span>Stop Loss per Position</span>
                      <div class="risk-input-group">
                        <input type="number" id="stopLoss" value="10" min="1" max="30">
                        <span class="unit">%</span>
                      </div>
                    </div>
                    <div class="risk-row">
                      <span>Take Profit Target</span>
                      <div class="risk-input-group">
                        <input type="number" id="takeProfit" value="25" min="5" max="100">
                        <span class="unit">%</span>
                      </div>
                    </div>
                    <div class="risk-row">
                      <span>Max Sector Concentration</span>
                      <div class="risk-input-group">
                        <input type="number" id="maxSector" value="40" min="10" max="100">
                        <span class="unit">%</span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Universe Selection -->
                <div class="input-section">
                  <label class="input-label">Investment Universe</label>
                  <div class="universe-selector">
                    <div class="universe-option selected" onclick="selectUniverse(this, 'client')">
                      <span class="option-title">Client Holdings</span>
                      <span class="option-desc">Based on current portfolio</span>
                    </div>
                    <div class="universe-option" onclick="selectUniverse(this, 'coverage')">
                      <span class="option-title">ODDO Coverage</span>
                      <span class="option-desc">Analyst covered stocks</span>
                    </div>
                    <div class="universe-option" onclick="selectUniverse(this, 'eurostoxx')">
                      <span class="option-title">Euro Stoxx 600</span>
                      <span class="option-desc">Pan-European large caps</span>
                    </div>
                    <div class="universe-option" onclick="selectUniverse(this, 'custom')">
                      <span class="option-title">Custom List</span>
                      <span class="option-desc">Define your own</span>
                    </div>
                  </div>
                </div>

                <div class="strategy-actions">
                  <button class="btn-secondary" onclick="saveStrategyDraft()">Save Draft</button>
                  <button class="btn-primary" onclick="generateStrategy()">Generate Strategy</button>
                </div>
              </div>

              <!-- Strategy Output Section -->
              <div class="strategy-output-panel">
                <div class="panel-header">
                  <h3>Strategy Output</h3>
                  <div class="output-actions">
                    <button class="btn-sm" onclick="exportStrategyPDF()">Export PDF</button>
                    <button class="btn-sm" onclick="runStrategyBacktest()">Run Backtest</button>
                  </div>
                </div>

                <div class="strategy-output-content" id="strategyOutput">
                  <div class="output-placeholder">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      <path d="M2 17l10 5 10-5"></path>
                      <path d="M2 12l10 5 10-5"></path>
                    </svg>
                    <p>Define your investment thesis and parameters, then click "Generate Strategy" to create a structured trading plan.</p>
                  </div>
                </div>

                <!-- Quick Backtest Preview -->
                <div class="quick-backtest-preview" id="quickBacktestPreview" style="display: none;">
                  <h4>Quick Backtest Preview</h4>
                  <div class="backtest-preview-chart">
                    <canvas id="strategyPreviewChart"></canvas>
                  </div>
                  <div class="backtest-preview-stats">
                    <div class="preview-stat">
                      <span class="stat-value" id="previewReturn">--</span>
                      <span class="stat-label">Total Return</span>
                    </div>
                    <div class="preview-stat">
                      <span class="stat-value" id="previewSharpe">--</span>
                      <span class="stat-label">Sharpe Ratio</span>
                    </div>
                    <div class="preview-stat">
                      <span class="stat-value" id="previewDrawdown">--</span>
                      <span class="stat-label">Max Drawdown</span>
                    </div>
                    <div class="preview-stat">
                      <span class="stat-value" id="previewWinRate">--</span>
                      <span class="stat-label">Win Rate</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- PORTFOLIO OPTIMIZER -->
          <div class="analytics-panel" id="analytics-optimizer">
            <div class="optimizer-grid">
              <div class="optimizer-input-section">
                <div class="panel-header">
                  <h3>Portfolio Configuration</h3>
                  <p class="panel-subtitle">Optimize allocation based on client risk profile</p>
                </div>

                <div class="input-section">
                  <label class="input-label">Select Assets</label>
                  <div class="asset-selector" id="optimizerAssets">
                    <input type="text" class="asset-input" placeholder="Type ticker and press Enter" id="addAssetInput" onkeypress="handleAssetAdd(event)">
                  </div>
                  <div class="asset-tags" id="assetTagsContainer">
                    <span class="asset-tag">AAPL <button onclick="removeAsset(this, 'AAPL')">Ã—</button></span>
                    <span class="asset-tag">MSFT <button onclick="removeAsset(this, 'MSFT')">Ã—</button></span>
                    <span class="asset-tag">LVMH.PA <button onclick="removeAsset(this, 'LVMH.PA')">Ã—</button></span>
                  </div>
                </div>

                <div class="input-section">
                  <label class="input-label">Optimization Target</label>
                  <select id="optimizationTarget" class="full-width">
                    <option value="sharpe">Maximum Sharpe Ratio</option>
                    <option value="minvol">Minimum Volatility</option>
                    <option value="maxret">Maximum Return (given risk)</option>
                    <option value="riskparity">Risk Parity</option>
                    <option value="clientfit">Client Risk Profile Match</option>
                  </select>
                </div>

                <div class="input-section">
                  <label class="input-label">Client Risk Tolerance</label>
                  <div class="slider-with-value">
                    <input type="range" id="riskTolerance" min="1" max="10" value="5" oninput="updateRiskLabel(this.value)">
                    <span id="riskLabel" class="slider-value">5 - Balanced</span>
                  </div>
                  <div class="slider-labels">
                    <span>Conservative</span>
                    <span>Aggressive</span>
                  </div>
                </div>

                <div class="input-section">
                  <label class="input-label">Constraints</label>
                  <div class="constraints-list">
                    <div class="constraint-row">
                      <span>Max single position</span>
                      <input type="number" id="maxPosition" value="25" min="5" max="100"><span>%</span>
                    </div>
                    <div class="constraint-row">
                      <span>Min single position</span>
                      <input type="number" id="minPosition" value="5" min="0" max="50"><span>%</span>
                    </div>
                    <div class="constraint-row">
                      <span>Max sector exposure</span>
                      <input type="number" id="maxSectorExp" value="40" min="10" max="100"><span>%</span>
                    </div>
                  </div>
                </div>

                <button class="btn-primary full-width" onclick="runOptimization()">Run Optimization</button>
              </div>

              <div class="optimizer-results-section">
                <div class="panel-header">
                  <h3>Efficient Frontier</h3>
                </div>
                <div class="chart-container-large">
                  <canvas id="efficientFrontierChart"></canvas>
                </div>
                <div class="optimal-portfolio-card">
                  <h4>Optimal Allocation</h4>
                  <div class="portfolio-metrics-row">
                    <div class="metric-box">
                      <span class="metric-value" id="optExpReturn">12.4%</span>
                      <span class="metric-label">Expected Return</span>
                    </div>
                    <div class="metric-box">
                      <span class="metric-value" id="optVolatility">8.2%</span>
                      <span class="metric-label">Volatility</span>
                    </div>
                    <div class="metric-box">
                      <span class="metric-value" id="optSharpe">1.51</span>
                      <span class="metric-label-sm">Sharpe Ratio</span>
                    </div>
                  </div>
                  <div class="allocation-bars" id="allocationBars">
                    <div class="alloc-bar">
                      <span class="alloc-label">AAPL</span>
                      <div class="alloc-track"><div class="alloc-fill" style="width: 35%"></div></div>
                      <span class="alloc-value">35%</span>
                    </div>
                    <div class="alloc-bar">
                      <span class="alloc-label">MSFT</span>
                      <div class="alloc-track"><div class="alloc-fill" style="width: 28%"></div></div>
                      <span class="alloc-value">28%</span>
                    </div>
                    <div class="alloc-bar">
                      <span class="alloc-label">GOOGL</span>
                      <div class="alloc-track"><div class="alloc-fill" style="width: 22%"></div></div>
                      <span class="alloc-value">22%</span>
                    </div>
                    <div class="alloc-bar">
                      <span class="alloc-label">AMZN</span>
                      <div class="alloc-track"><div class="alloc-fill" style="width: 15%"></div></div>
                      <span class="alloc-value">15%</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ENHANCED BACKTESTING -->
          <div class="analytics-panel" id="analytics-backtest">
            <div class="backtest-layout">
              <div class="backtest-config-panel">
                <div class="panel-header">
                  <h3>Backtest Configuration</h3>
                  <p class="panel-subtitle">Test your strategy against historical data</p>
                </div>

                <div class="input-section">
                  <label class="input-label">Strategy to Test</label>
                  <select id="backtestStrategy" class="full-width">
                    <option value="custom">Custom Strategy (from Builder)</option>
                    <option value="momentum">Momentum Strategy</option>
                    <option value="meanrev">Mean Reversion</option>
                    <option value="value">Value Factor</option>
                    <option value="quality">Quality Factor</option>
                    <option value="dividend">Dividend Growth</option>
                  </select>
                </div>

                <div class="input-section">
                  <label class="input-label">Backtest Period</label>
                  <div class="date-inputs">
                    <div class="date-field">
                      <label>Start</label>
                      <input type="date" id="btStartDate" value="2020-01-01">
                    </div>
                    <div class="date-field">
                      <label>End</label>
                      <input type="date" id="btEndDate" value="2025-12-31">
                    </div>
                  </div>
                </div>

                <div class="input-section">
                  <label class="input-label">Benchmark</label>
                  <select id="btBenchmark" class="full-width">
                    <option value="SPY">S&P 500 (SPY)</option>
                    <option value="EuroStoxx">Euro Stoxx 50</option>
                    <option value="DAX">DAX 40</option>
                    <option value="CAC">CAC 40</option>
                    <option value="MSCI">MSCI World</option>
                  </select>
                </div>

                <div class="input-section">
                  <label class="input-label">Initial Capital</label>
                  <div class="input-with-unit">
                    <span class="unit-prefix">â‚¬</span>
                    <input type="number" id="btCapital" value="100000">
                  </div>
                </div>

                <div class="input-section">
                  <label class="input-label">Transaction Costs</label>
                  <div class="cost-inputs">
                    <div class="cost-field">
                      <label>Commission</label>
                      <input type="number" id="btCommission" value="0.1" step="0.01"><span>%</span>
                    </div>
                    <div class="cost-field">
                      <label>Slippage</label>
                      <input type="number" id="btSlippage" value="0.05" step="0.01"><span>%</span>
                    </div>
                  </div>
                </div>

                <div class="input-section">
                  <label class="input-label">Rebalancing</label>
                  <select id="btRebalance" class="full-width">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly" selected>Monthly</option>
                    <option value="quarterly">Quarterly</option>
                  </select>
                </div>

                <button class="btn-primary full-width" onclick="runBacktest()">Run Backtest</button>
              </div>

              <div class="backtest-results-panel">
                <div class="panel-header">
                  <h3>Backtest Results</h3>
                  <div class="results-actions">
                    <button class="btn-sm" onclick="exportBacktestPDF()">Export PDF</button>
                    <button class="btn-sm" onclick="shareBacktest()">Share</button>
                  </div>
                </div>

                <div class="chart-container-large">
                  <canvas id="backtestChart"></canvas>
                </div>

                <div class="backtest-metrics">
                  <div class="metric-card">
                    <span class="metric-value positive" id="btTotalReturn">+87.4%</span>
                    <span class="metric-label">Total Return</span>
                  </div>
                  <div class="metric-card">
                    <span class="metric-value" id="btCAGR">13.4%</span>
                    <span class="metric-label">CAGR</span>
                  </div>
                  <div class="metric-card">
                    <span class="metric-value negative" id="btMaxDD">-18.2%</span>
                    <span class="metric-label">Max Drawdown</span>
                  </div>
                  <div class="metric-card">
                    <span class="metric-value" id="btSharpe">1.24</span>
                    <span class="metric-label">Sharpe Ratio</span>
                  </div>
                  <div class="metric-card">
                    <span class="metric-value" id="btSortino">1.67</span>
                    <span class="metric-label">Sortino Ratio</span>
                  </div>
                  <div class="metric-card">
                    <span class="metric-value" id="btWinRate">58.3%</span>
                    <span class="metric-label">Win Rate</span>
                  </div>
                  <div class="metric-card">
                    <span class="metric-value positive" id="btAlpha">+4.2%</span>
                    <span class="metric-label">Alpha vs Benchmark</span>
                  </div>
                  <div class="metric-card">
                    <span class="metric-value" id="btBeta">0.85</span>
                    <span class="metric-label">Beta</span>
                  </div>
                </div>

                <div class="trade-log">
                  <h4>Recent Trades</h4>
                  <div class="trade-table" id="tradeLogTable">
                    <div class="trade-row header">
                      <span>Date</span>
                      <span>Ticker</span>
                      <span>Action</span>
                      <span>Price</span>
                      <span>P&L</span>
                    </div>
                    <div class="trade-row">
                      <span>2025-12-15</span>
                      <span>AAPL</span>
                      <span class="action-sell">SELL</span>
                      <span>$198.50</span>
                      <span class="positive">+12.4%</span>
                    </div>
                    <div class="trade-row">
                      <span>2025-11-20</span>
                      <span>LVMH.PA</span>
                      <span class="action-buy">BUY</span>
                      <span>â‚¬745.00</span>
                      <span class="muted">Open</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- CLIENT FIT ANALYSIS -->
          <div class="analytics-panel" id="analytics-clientfit">
            <div class="clientfit-layout">
              <div class="clientfit-profile-panel">
                <div class="panel-header">
                  <h3>Client Risk Profile</h3>
                  <p class="panel-subtitle">Analyze how well strategies fit this client</p>
                </div>

                <div class="client-profile-card" id="clientProfileCard">
                  <div class="profile-header">
                    <div class="profile-avatar" id="cfClientAvatar">--</div>
                    <div class="profile-info">
                      <h4 id="cfClientName">Select a client</h4>
                      <span class="profile-type" id="cfClientType">--</span>
                    </div>
                  </div>

                  <div class="profile-metrics">
                    <div class="profile-metric">
                      <span class="metric-label">Risk Tolerance</span>
                      <div class="metric-bar">
                        <div class="bar-fill" id="cfRiskBar" style="width: 60%"></div>
                      </div>
                      <span class="metric-value" id="cfRiskScore">6/10</span>
                    </div>
                    <div class="profile-metric">
                      <span class="metric-label">Investment Horizon</span>
                      <span class="metric-value" id="cfHorizon">5-10 years</span>
                    </div>
                    <div class="profile-metric">
                      <span class="metric-label">Max Acceptable Loss</span>
                      <span class="metric-value" id="cfMaxLoss">-20%</span>
                    </div>
                    <div class="profile-metric">
                      <span class="metric-label">Target Return</span>
                      <span class="metric-value" id="cfTargetReturn">8-12% p.a.</span>
                    </div>
                  </div>

                  <div class="profile-preferences">
                    <h5>Investment Preferences</h5>
                    <div class="pref-tags" id="cfPrefTags">
                      <span class="pref-tag positive">ESG Focus</span>
                      <span class="pref-tag positive">Dividend Income</span>
                      <span class="pref-tag negative">No Crypto</span>
                      <span class="pref-tag neutral">Europe Focus</span>
                    </div>
                  </div>
                </div>

                <div class="input-section">
                  <label class="input-label">Strategy to Analyze</label>
                  <select id="cfStrategy" class="full-width" onchange="analyzeClientFit()">
                    <option value="">Select a strategy...</option>
                    <option value="current">Current Portfolio</option>
                    <option value="custom">Custom Strategy (from Builder)</option>
                    <option value="conservative">Conservative Income</option>
                    <option value="balanced">Balanced Growth</option>
                    <option value="aggressive">Aggressive Growth</option>
                  </select>
                </div>

                <button class="btn-primary full-width" onclick="analyzeClientFit()">Analyze Fit</button>
              </div>

              <div class="clientfit-results-panel">
                <div class="panel-header">
                  <h3>Fit Analysis Results</h3>
                </div>

                <div class="fit-score-display">
                  <div class="fit-score-circle" id="fitScoreCircle">
                    <svg viewBox="0 0 100 100">
                      <circle class="score-bg" cx="50" cy="50" r="45"></circle>
                      <circle class="score-fill" cx="50" cy="50" r="45" id="scoreCircleFill"></circle>
                    </svg>
                    <div class="score-text">
                      <span class="score-value" id="fitScoreValue">--</span>
                      <span class="score-label">Fit Score</span>
                    </div>
                  </div>
                  <div class="fit-summary" id="fitSummary">
                    <p>Select a client and strategy to see fit analysis.</p>
                  </div>
                </div>

                <div class="fit-breakdown">
                  <h4>Fit Breakdown</h4>
                  <div class="breakdown-items" id="fitBreakdown">
                    <div class="breakdown-item">
                      <span class="breakdown-label">Risk Alignment</span>
                      <div class="breakdown-bar"><div class="bar-fill" style="width: 0%"></div></div>
                      <span class="breakdown-score">--</span>
                    </div>
                    <div class="breakdown-item">
                      <span class="breakdown-label">Return Expectations</span>
                      <div class="breakdown-bar"><div class="bar-fill" style="width: 0%"></div></div>
                      <span class="breakdown-score">--</span>
                    </div>
                    <div class="breakdown-item">
                      <span class="breakdown-label">Sector Preferences</span>
                      <div class="breakdown-bar"><div class="bar-fill" style="width: 0%"></div></div>
                      <span class="breakdown-score">--</span>
                    </div>
                    <div class="breakdown-item">
                      <span class="breakdown-label">ESG Compliance</span>
                      <div class="breakdown-bar"><div class="bar-fill" style="width: 0%"></div></div>
                      <span class="breakdown-score">--</span>
                    </div>
                    <div class="breakdown-item">
                      <span class="breakdown-label">Liquidity Match</span>
                      <div class="breakdown-bar"><div class="bar-fill" style="width: 0%"></div></div>
                      <span class="breakdown-score">--</span>
                    </div>
                  </div>
                </div>

                <div class="fit-recommendations" id="fitRecommendations">
                  <h4>Recommendations</h4>
                  <div class="recommendations-list">
                    <div class="recommendation-item">
                      <span class="rec-icon warning">!</span>
                      <span class="rec-text">Run analysis to see personalized recommendations</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: HISTORY -->
      <div class="tab-panel" id="panel-history">
        <div class="empty-state" id="historyEmpty">
          <h3>No History</h3>
          <p>Generated stories are stored here for compliance.</p>
        </div>
        <div id="historyList"></div>
      </div>
    </main>
  </div>

<script>
// ============================================================================
// STATE
// ============================================================================
let clientId = null;
let selectedClientId = null;
let clientData = null;
let shortlist = [];
let selectedTicker = null;
let selectedStock = null;
let history = [];

// ============================================================================
// API HELPERS
// ============================================================================
function getApiBase() {
  return localStorage.getItem('api_base') || '';
}

function apiUrl(path) {
  const base = getApiBase();
  return base ? base.replace(/\/+$/, '') + path : path;
}

function authHeaders() {
  const key = localStorage.getItem('api_key') || '';
  return key ? { 'x-api-key': key } : {};
}

// ============================================================================
// UI HELPERS
// ============================================================================
function $(id) { return document.getElementById(id); }
function $$(sel) { return document.querySelectorAll(sel); }

// Pie chart color palette
const PIE_COLORS = [
  '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe',
  '#00f2fe', '#43e97b', '#38f9d7', '#fa709a', '#fee140',
  '#a8edea', '#fed6e3', '#d299c2', '#fef9d7', '#89f7fe'
];

function getPieColor(index) {
  return PIE_COLORS[index % PIE_COLORS.length];
}

// Render portfolio pie chart
function renderPortfolioPieChart() {
  const canvas = document.getElementById('portfolioPieChart');
  if (!canvas || !window._portfolioSectorData) return;

  const ctx = canvas.getContext('2d');
  const { labels, data } = window._portfolioSectorData;

  if (!labels || labels.length === 0) return;

  // Destroy existing chart if any
  if (window._portfolioPieChart) {
    window._portfolioPieChart.destroy();
  }

  window._portfolioPieChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: labels.map((_, i) => getPieColor(i)),
        borderColor: document.documentElement.dataset.theme === 'dark' ? 'rgba(15,23,42,0.3)' : 'rgba(255,255,255,0.2)',
        borderWidth: 2,
        hoverBorderColor: document.documentElement.dataset.theme === 'dark' ? '#10b981' : '#fff',
        hoverBorderWidth: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      cutout: '55%',
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(0,0,0,0.8)',
          titleFont: { size: 13 },
          bodyFont: { size: 12 },
          padding: 10,
          cornerRadius: 8,
          callbacks: {
            label: function(context) {
              return context.label + ': ' + context.raw + '%';
            }
          }
        }
      },
      animation: {
        animateRotate: true,
        animateScale: true
      }
    }
  });
}

function setStatus(text, type = 'default') {
  const chip = $('statusChip');
  chip.textContent = text;
  chip.className = 'status-chip' + (type === 'active' ? ' active' : '');
}

function showModal() {
  $('modalOverlay').style.display = 'block';
  $('searchModal').style.display = 'block';
}

function hideModal() {
  $('modalOverlay').style.display = 'none';
  $('searchModal').style.display = 'none';
}

// ============================================================================
// DETAILS DRAWER
// ============================================================================
function openDetailsDrawer() {
  if (!clientData) return;
  renderDrawerContent(clientData);
  $('drawerOverlay').classList.add('open');
  $('detailsDrawer').classList.add('open');
}

function closeDetailsDrawer() {
  $('drawerOverlay').classList.remove('open');
  $('detailsDrawer').classList.remove('open');
}

function renderDrawerContent(data) {
  const signals = data.signals || {};
  const holdings = data.holdings || {};

  const calls = signals.recent_calls || [];
  const trades = signals.recent_trades || [];
  const reads = signals.recent_reads_daysdiff || [];
  const positions = holdings.top_positions || [];
  const hints = signals.call_position_hints || [];

  // Tabs + Table Layout
  let html = `
    <div class="drawer-tabs">
      <button class="drawer-tab active" data-panel="calls">Calls <span class="badge">${calls.length}</span></button>
      <button class="drawer-tab" data-panel="trades">Trades <span class="badge">${trades.length}</span></button>
      <button class="drawer-tab" data-panel="reads">Reads <span class="badge">${reads.length}</span></button>
      <button class="drawer-tab" data-panel="positions">Positionen <span class="badge">${positions.length}</span></button>
      <button class="drawer-tab" data-panel="crm">CRM</button>
      <button class="drawer-tab" data-panel="compliance">Compliance</button>
    </div>
  `;

  // CALLS TABLE
  html += `
    <div class="drawer-panel active" id="drawer-calls">
      <table class="detail-table">
        <thead>
          <tr><th>Date</th><th>Ticker</th><th>Direction</th><th>Duration</th><th>Sector</th><th>Notes</th></tr>
        </thead>
        <tbody>
          ${calls.length === 0 ? '<tr><td colspan="6" style="text-align:center; color: var(--text-muted);">No Calls</td></tr>' : ''}
          ${calls.map(c => `
            <tr>
              <td class="date">${c.call_timestamp ? new Date(c.call_timestamp).toLocaleDateString('en-US') : '-'}</td>
              <td class="ticker">${c.stock_ticker || c.discussed_company || '-'}</td>
              <td><span class="tag neutral">${c.direction || '-'}</span></td>
              <td>${c.duration_minutes ? c.duration_minutes + ' min' : '-'}</td>
              <td>${c.discussed_sector || '-'}</td>
              <td class="notes">${c.notes_raw ? c.notes_raw.substring(0, 120) + '...' : '-'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;

  // TRADES TABLE
  html += `
    <div class="drawer-panel" id="drawer-trades">
      <table class="detail-table">
        <thead>
          <tr><th>Date</th><th>Ticker</th><th>Side</th><th>Size</th><th>Sector</th><th>Theme</th></tr>
        </thead>
        <tbody>
          ${trades.length === 0 ? '<tr><td colspan="6" style="text-align:center; color: var(--text-muted);">No Trades</td></tr>' : ''}
          ${trades.map(t => `
            <tr>
              <td class="date">${t.trade_timestamp ? new Date(t.trade_timestamp).toLocaleDateString('en-US') : '-'}</td>
              <td class="ticker">${t.ticker || '-'}</td>
              <td><span class="tag ${t.side?.toLowerCase() === 'buy' ? 'buy' : 'sell'}">${t.side || '-'}</span></td>
              <td>${t.notional_bucket || '-'}</td>
              <td>${t.sector || '-'}</td>
              <td>${t.theme_tag || '-'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;

  // READS TABLE
  html += `
    <div class="drawer-panel" id="drawer-reads">
      <table class="detail-table">
        <thead>
          <tr><th>Read</th><th>Ticker</th><th>Type</th><th>Sector</th><th>Delay</th><th>Title</th></tr>
        </thead>
        <tbody>
          ${reads.length === 0 ? '<tr><td colspan="6" style="text-align:center; color: var(--text-muted);">No Reads</td></tr>' : ''}
          ${reads.map(r => `
            <tr>
              <td class="date">${r.read_timestamp ? new Date(r.read_timestamp).toLocaleDateString('en-US') : '-'}</td>
              <td class="ticker">${r.report_ticker || '-'}</td>
              <td><span class="tag neutral">${r.report_type || '-'}</span></td>
              <td>${r.report_sector || '-'}</td>
              <td>${r.days_diff !== null ? r.days_diff + 'd' : '-'}</td>
              <td class="notes">${r.report_title || '-'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;

  // POSITIONS TABLE with Pie Chart
  // Aggregate by sector for pie chart
  const sectorWeights = {};
  positions.forEach(p => {
    const sector = p.sector || 'Other';
    const weight = p.weight || 0;
    sectorWeights[sector] = (sectorWeights[sector] || 0) + weight;
  });
  const sectorLabels = Object.keys(sectorWeights);
  const sectorData = Object.values(sectorWeights).map(w => (w * 100).toFixed(1));

  html += `
    <div class="drawer-panel" id="drawer-positions">
      ${positions.length > 0 ? `
      <div class="portfolio-chart-container" style="display: flex; gap: 24px; margin-bottom: 20px; align-items: flex-start;">
        <div style="flex: 0 0 280px;">
          <h4 style="margin: 0 0 12px 0; font-size: 14px; color: var(--text-muted);">Sektor-Verteilung</h4>
          <canvas id="portfolioPieChart" width="260" height="260"></canvas>
        </div>
        <div style="flex: 1;">
          <h4 style="margin: 0 0 12px 0; font-size: 14px; color: var(--text-muted);">Portfolio-Zusammensetzung</h4>
          <div class="sector-legend" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
            ${sectorLabels.map((label, i) => `
              <div class="legend-item" style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                <span class="legend-color" style="width: 12px; height: 12px; border-radius: 3px; background: ${getPieColor(i)};"></span>
                <span style="color: var(--text);">${label}</span>
                <span style="color: var(--text-muted); margin-left: auto;">${sectorData[i]}%</span>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
      ` : ''}
      <table class="detail-table">
        <thead>
          <tr><th>Ticker</th><th>Name</th><th>Sector</th><th>Weight</th><th>Value</th><th>Theme</th></tr>
        </thead>
        <tbody>
          ${positions.length === 0 ? '<tr><td colspan="6" style="text-align:center; color: var(--text-muted);">No Positions</td></tr>' : ''}
          ${positions.map(p => `
            <tr>
              <td class="ticker">${p.ticker || '-'}</td>
              <td>${p.company_name || '-'}</td>
              <td>${p.sector || '-'}</td>
              <td>${p.weight ? (p.weight * 100).toFixed(1) + '%' : '-'}</td>
              <td>${p.market_value ? Number(p.market_value).toLocaleString('de-DE') + ' ' + (p.currency || '') : '-'}</td>
              <td>${p.theme_tag || '-'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;

  // Store sector data for pie chart rendering
  window._portfolioSectorData = { labels: sectorLabels, data: sectorData };

  // HINTS TABLE - removed to make room for CRM/Compliance

  // CRM PANEL
  html += `
    <div class="drawer-panel" id="drawer-crm">
      <div class="crm-loading" style="text-align: center; padding: 40px; color: var(--text-muted);">
        <div class="spinner"></div>
        <p style="margin-top: 12px;">Loading CRM data...</p>
      </div>
    </div>
  `;

  // COMPLIANCE PANEL
  html += `
    <div class="drawer-panel" id="drawer-compliance">
      <div class="compliance-loading" style="text-align: center; padding: 40px; color: var(--text-muted);">
        <div class="spinner"></div>
        <p style="margin-top: 12px;">Loading Compliance data...</p>
      </div>
    </div>
  `;

  $('drawerBody').innerHTML = html;

  // Add tab switching
  $$('.drawer-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      $$('.drawer-tab').forEach(t => t.classList.remove('active'));
      $$('.drawer-panel').forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      $('drawer-' + tab.dataset.panel).classList.add('active');

      // Render pie chart when positions tab is activated
      if (tab.dataset.panel === 'positions') {
        setTimeout(renderPortfolioPieChart, 50);
      }

      // Load CRM data when tab is activated
      if (tab.dataset.panel === 'crm' && selectedClientId) {
        loadCRMData(selectedClientId);
      }

      // Load Compliance data when tab is activated
      if (tab.dataset.panel === 'compliance' && selectedClientId) {
        loadComplianceData(selectedClientId);
      }
    });
  });
}

// ============================================================================
// CRM & COMPLIANCE DATA LOADING
// ============================================================================

let crmDataLoaded = false;
let complianceDataLoaded = false;

async function loadCRMData(clientId) {
  if (crmDataLoaded) return;

  try {
    const response = await fetch(apiUrl(`/api/client/${clientId}/crm`), { headers: authHeaders() });
    if (!response.ok) throw new Error('Failed to load CRM data');

    const data = await response.json();
    renderCRMPanel(data);
    crmDataLoaded = true;
  } catch (e) {
    console.error('Error loading CRM data:', e);
    $('drawer-crm').innerHTML = `<div style="padding: 20px; color: var(--text-muted); text-align: center;">Error loading CRM data</div>`;
  }
}

function renderCRMPanel(data) {
  const prefs = data.contact_preferences || {};
  const engagement = data.engagement_summary || {};
  const meetings = data.meetings || [];
  const events = data.events || [];

  let html = `
    <!-- Contact Preferences -->
    <div class="crm-section">
      <h4 style="margin: 0 0 16px 0; font-size: 15px; font-family: var(--font-serif); color: var(--text);">
        Contact Preferences
      </h4>
      <div class="crm-prefs-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px;">
        <div class="crm-pref-box" style="background: var(--greige); padding: 12px 16px; border-radius: 8px;">
          <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Preferred Channel</div>
          <div style="font-size: 14px; font-weight: 600; color: var(--text); text-transform: capitalize;">
            ${prefs.preferred_channel === 'phone' ? 'Phone' :
              prefs.preferred_channel === 'email' ? 'Email' :
              prefs.preferred_channel === 'video' ? 'Video' :
              prefs.preferred_channel === 'in_person' ? 'In Person' : prefs.preferred_channel || '-'}
          </div>
        </div>
        <div class="crm-pref-box" style="background: var(--greige); padding: 12px 16px; border-radius: 8px;">
          <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Best Time</div>
          <div style="font-size: 14px; font-weight: 600; color: var(--text); text-transform: capitalize;">
            ${prefs.preferred_time === 'morning' ? 'Morning (08-12h)' :
              prefs.preferred_time === 'afternoon' ? 'Afternoon (12-18h)' :
              prefs.preferred_time === 'evening' ? 'Evening (18-21h)' : prefs.preferred_time || '-'}
          </div>
        </div>
        <div class="crm-pref-box" style="background: var(--greige); padding: 12px 16px; border-radius: 8px;">
          <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Frequency</div>
          <div style="font-size: 14px; font-weight: 600; color: var(--text); text-transform: capitalize;">
            ${prefs.preferred_frequency === 'daily' ? 'Daily' :
              prefs.preferred_frequency === 'weekly' ? 'Weekly' :
              prefs.preferred_frequency === 'bi-weekly' ? 'Bi-Weekly' :
              prefs.preferred_frequency === 'monthly' ? 'Monthly' : prefs.preferred_frequency || '-'}
          </div>
        </div>
        <div class="crm-pref-box" style="background: var(--greige); padding: 12px 16px; border-radius: 8px;">
          <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Language</div>
          <div style="font-size: 14px; font-weight: 600; color: var(--text);">${prefs.language || '-'}</div>
        </div>
        <div class="crm-pref-box" style="background: var(--greige); padding: 12px 16px; border-radius: 8px;">
          <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Timezone</div>
          <div style="font-size: 14px; font-weight: 600; color: var(--text);">${prefs.timezone || '-'}</div>
        </div>
        <div class="crm-pref-box" style="background: var(--greige); padding: 12px 16px; border-radius: 8px;">
          <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Preferred Days</div>
          <div style="font-size: 12px; font-weight: 600; color: var(--text);">
            ${Array.isArray(prefs.preferred_days) ? prefs.preferred_days.slice(0, 3).map(d => d.substring(0, 2)).join(', ') : '-'}
          </div>
        </div>
      </div>
    </div>

    <!-- Engagement Summary -->
    <div class="crm-section">
      <h4 style="margin: 0 0 16px 0; font-size: 15px; font-family: var(--font-serif); color: var(--text);">
        Engagement Summary (12 Months)
      </h4>
      <div class="crm-stats-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px;">
        <div class="crm-stat-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 16px; border-radius: 10px; color: white;">
          <div style="font-size: 24px; font-weight: 700;">${engagement.total_meetings_12m || 0}</div>
          <div style="font-size: 11px; opacity: 0.85;">Meetings</div>
        </div>
        <div class="crm-stat-box" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 16px; border-radius: 10px; color: white;">
          <div style="font-size: 24px; font-weight: 700;">${engagement.meeting_success_rate ? engagement.meeting_success_rate + '%' : '-'}</div>
          <div style="font-size: 11px; opacity: 0.85;">Success Rate</div>
        </div>
        <div class="crm-stat-box" style="background: linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%); padding: 16px; border-radius: 10px; color: white;">
          <div style="font-size: 24px; font-weight: 700;">${engagement.avg_email_response_hours ? engagement.avg_email_response_hours + 'h' : '-'}</div>
          <div style="font-size: 11px; opacity: 0.85;">Avg Response</div>
        </div>
        <div class="crm-stat-box" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 16px; border-radius: 10px; color: white;">
          <div style="font-size: 24px; font-weight: 700;">${engagement.events_attended || 0}</div>
          <div style="font-size: 11px; opacity: 0.85;">Events Attended</div>
        </div>
      </div>
    </div>

    <!-- Recent Meetings -->
    <div class="crm-section">
      <h4 style="margin: 0 0 12px 0; font-size: 15px; font-family: var(--font-serif); color: var(--text);">
        Recent Meetings
      </h4>
      ${meetings.length > 0 ? `
        <table class="detail-table">
          <thead>
            <tr><th>Date</th><th>Type</th><th>Location</th><th>Duration</th><th>Topics</th><th>Outcome</th></tr>
          </thead>
          <tbody>
            ${meetings.slice(0, 10).map(m => `
              <tr>
                <td class="date">${m.meeting_date ? new Date(m.meeting_date).toLocaleDateString('en-US') : '-'}</td>
                <td>
                  <span class="tag neutral" style="text-transform: capitalize;">
                    ${m.meeting_type === 'in_person' ? 'In Person' :
                      m.meeting_type === 'video_call' ? 'Video' :
                      m.meeting_type === 'roadshow' ? 'Roadshow' :
                      m.meeting_type === 'conference' ? 'Conference' :
                      m.meeting_type === 'dinner' ? 'Dinner' : m.meeting_type || '-'}
                  </span>
                </td>
                <td style="max-width: 120px; overflow: hidden; text-overflow: ellipsis;">${m.location || '-'}</td>
                <td>${m.duration_minutes ? m.duration_minutes + ' min' : '-'}</td>
                <td style="max-width: 150px; font-size: 11px;">
                  ${Array.isArray(m.topics_discussed) ? m.topics_discussed.slice(0, 2).join(', ') : '-'}
                </td>
                <td>
                  <span class="tag ${m.outcome === 'positive' ? 'buy' : m.outcome === 'follow_up_needed' ? 'sell' : 'neutral'}">
                    ${m.outcome === 'positive' ? 'Positive' :
                      m.outcome === 'follow_up_needed' ? 'Follow-up' : 'Neutral'}
                  </span>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      ` : '<div style="color: var(--text-muted); text-align: center; padding: 20px;">No meetings available</div>'}
    </div>

    <!-- Events Attended -->
    ${events.length > 0 ? `
    <div class="crm-section" style="margin-top: 24px;">
      <h4 style="margin: 0 0 12px 0; font-size: 15px; font-family: var(--font-serif); color: var(--text);">
        Event Attendance
      </h4>
      <div style="display: flex; flex-wrap: wrap; gap: 8px;">
        ${events.slice(0, 6).map(e => `
          <div style="background: var(--greige); padding: 8px 12px; border-radius: 6px; font-size: 12px;">
            <span style="font-weight: 600;">${e.event_name}</span>
            <span style="color: var(--text-muted); margin-left: 8px;">${e.event_date ? new Date(e.event_date).toLocaleDateString('en-US') : ''}</span>
            ${e.feedback_score ? `<span style="margin-left: 8px;">${e.feedback_score}/5</span>` : ''}
          </div>
        `).join('')}
      </div>
    </div>
    ` : ''}
  `;

  $('drawer-crm').innerHTML = html;
}

async function loadComplianceData(clientId) {
  if (complianceDataLoaded) return;

  try {
    const response = await fetch(apiUrl(`/api/client/${clientId}/compliance`), { headers: authHeaders() });
    if (!response.ok) throw new Error('Failed to load compliance data');

    const data = await response.json();
    renderCompliancePanel(data.compliance);
    complianceDataLoaded = true;
  } catch (e) {
    console.error('Error loading compliance data:', e);
    $('drawer-compliance').innerHTML = `<div style="padding: 20px; color: var(--text-muted); text-align: center;">Error loading compliance data</div>`;
  }
}

function renderCompliancePanel(compliance) {
  if (!compliance) {
    $('drawer-compliance').innerHTML = `<div style="padding: 20px; color: var(--text-muted); text-align: center;">No compliance data available</div>`;
    return;
  }

  const kycStatusColor = {
    'approved': '#16a34a',
    'pending': '#d97706',
    'review_needed': '#dc2626',
    'expired': '#dc2626'
  };

  const kycStatusLabel = {
    'approved': 'Genehmigt',
    'pending': 'Ausstehend',
    'review_needed': 'Review noetig',
    'expired': 'Abgelaufen'
  };

  let html = `
    <!-- KYC Status -->
    <div class="compliance-section">
      <h4 style="margin: 0 0 16px 0; font-size: 15px; font-family: var(--font-serif); color: var(--text);">
        KYC Status
      </h4>
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px;">
        <div style="background: var(--greige); padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">Status</div>
          <div style="font-size: 14px; font-weight: 700; color: ${kycStatusColor[compliance.kyc_status] || 'inherit'};">
            ${kycStatusLabel[compliance.kyc_status] || compliance.kyc_status}
          </div>
        </div>
        <div style="background: var(--greige); padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">Risk Rating</div>
          <div style="font-size: 14px; font-weight: 700; text-transform: capitalize; color: ${
            compliance.kyc_risk_rating === 'enhanced' ? '#dc2626' :
            compliance.kyc_risk_rating === 'standard' ? '#d97706' : '#16a34a'
          };">
            ${compliance.kyc_risk_rating === 'low' ? 'Low' :
              compliance.kyc_risk_rating === 'standard' ? 'Standard' :
              compliance.kyc_risk_rating === 'enhanced' ? 'Enhanced' : compliance.kyc_risk_rating || '-'}
          </div>
        </div>
        <div style="background: var(--greige); padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">Expiry Date</div>
          <div style="font-size: 14px; font-weight: 700; color: ${compliance.kyc_expiring_soon ? '#dc2626' : 'inherit'};">
            ${compliance.kyc_expiry_date ? new Date(compliance.kyc_expiry_date).toLocaleDateString('en-US') : '-'}
          </div>
          ${compliance.kyc_expiring_soon ? '<div style="font-size: 10px; color: #dc2626; margin-top: 4px;">Expiring soon!</div>' : ''}
        </div>
        <div style="background: var(--greige); padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">Last Review</div>
          <div style="font-size: 14px; font-weight: 700;">
            ${compliance.kyc_last_review ? new Date(compliance.kyc_last_review).toLocaleDateString('en-US') : '-'}
          </div>
        </div>
      </div>
    </div>

    <!-- Investor Classification -->
    <div class="compliance-section">
      <h4 style="margin: 0 0 16px 0; font-size: 15px; font-family: var(--font-serif); color: var(--text);">
        Investor Classification (MiFID II)
      </h4>
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px;">
        <div style="background: var(--greige); padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">Investor Type</div>
          <div style="font-size: 14px; font-weight: 700; text-transform: capitalize;">
            ${compliance.investor_type === 'professional' ? 'Professional' :
              compliance.investor_type === 'retail' ? 'Retail' :
              compliance.investor_type === 'eligible_counterparty' ? 'Eligible Counterparty' : compliance.investor_type || '-'}
          </div>
        </div>
        <div style="background: var(--greige); padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">Mandate Type</div>
          <div style="font-size: 14px; font-weight: 700; text-transform: capitalize;">
            ${compliance.mandate_type === 'discretionary' ? 'Discretionary' :
              compliance.mandate_type === 'advisory' ? 'Advisory' :
              compliance.mandate_type === 'execution_only' ? 'Execution Only' : compliance.mandate_type || '-'}
          </div>
        </div>
        <div style="background: var(--greige); padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">AUM (declared)</div>
          <div style="font-size: 14px; font-weight: 700;">${compliance.aum_formatted || '-'}</div>
        </div>
        <div style="background: var(--greige); padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">Domicile</div>
          <div style="font-size: 14px; font-weight: 700;">${compliance.domicile_country || '-'}</div>
        </div>
      </div>
    </div>

    <!-- Trading Permissions -->
    <div class="compliance-section">
      <h4 style="margin: 0 0 16px 0; font-size: 15px; font-family: var(--font-serif); color: var(--text);">
        Trading Permissions
      </h4>
      <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 24px;">
        ${Array.isArray(compliance.allowed_instruments) ? compliance.allowed_instruments.map(inst => `
          <span style="background: #e0f0ea; color: #305f50; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">
            ${inst === 'equities' ? 'Equities' :
                inst === 'bonds' ? 'Bonds' :
                inst === 'derivatives' ? 'Derivatives' :
                inst === 'etf' ? 'ETFs' :
                inst === 'fx' ? 'FX' :
                inst === 'commodities' ? 'Commodities' : inst}
          </span>
        `).join('') : ''}
        ${compliance.short_selling_allowed ? '<span style="background: #e0f0ea; color: #305f50; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">Short Selling Allowed</span>' : '<span style="background: #fef2f2; color: #dc2626; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">No Short Selling</span>'}
        ${compliance.leverage_allowed ? '<span style="background: #e0f0ea; color: #305f50; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">Leverage Allowed</span>' : '<span style="background: #fef2f2; color: #dc2626; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">No Leverage</span>'}
        ${compliance.max_single_position_pct ? `<span style="background: var(--greige); color: var(--text); padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">Max. Position: ${compliance.max_single_position_pct}%</span>` : ''}
      </div>
    </div>

    <!-- Restrictions -->
    ${(compliance.restricted_sectors && compliance.restricted_sectors.length > 0) || (compliance.restricted_countries && compliance.restricted_countries.length > 0) ? `
    <div class="compliance-section">
      <h4 style="margin: 0 0 16px 0; font-size: 15px; font-family: var(--font-serif); color: var(--text);">
        Restrictions
      </h4>
      <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 24px;">
        ${Array.isArray(compliance.restricted_sectors) ? compliance.restricted_sectors.map(s => `
          <span style="background: #fef2f2; color: #dc2626; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">
            Sector: ${s === 'defense' ? 'Defense' :
                s === 'tobacco' ? 'Tobacco' :
                s === 'gambling' ? 'Gambling' :
                s === 'fossil_fuels' ? 'Fossil Fuels' :
                s === 'nuclear' ? 'Nuclear' : s}
          </span>
        `).join('') : ''}
        ${Array.isArray(compliance.restricted_countries) ? compliance.restricted_countries.map(c => `
          <span style="background: #fef2f2; color: #dc2626; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">
            Country: ${c}
          </span>
        `).join('') : ''}
      </div>
    </div>
    ` : ''}

    <!-- ESG Requirements -->
    <div class="compliance-section">
      <h4 style="margin: 0 0 16px 0; font-size: 15px; font-family: var(--font-serif); color: var(--text);">
        ESG Requirements
      </h4>
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
        <div style="background: ${compliance.esg_mandate ? 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)' : 'var(--greige)'}; padding: 16px; border-radius: 10px; text-align: center; color: ${compliance.esg_mandate ? 'white' : 'var(--text)'};">
          <div style="font-size: 11px; ${compliance.esg_mandate ? 'opacity: 0.85' : 'color: var(--text-muted)'}; margin-bottom: 8px;">ESG Mandate</div>
          <div style="font-size: 18px; font-weight: 700;">
            ${compliance.esg_mandate ? 'Yes' : 'No'}
          </div>
        </div>
        ${compliance.esg_mandate ? `
        <div style="background: var(--greige); padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">Min. ESG Score</div>
          <div style="font-size: 18px; font-weight: 700;">${compliance.esg_min_score ? compliance.esg_min_score.toFixed(0) : '-'}</div>
        </div>
        <div style="background: var(--greige); padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">SFDR Classification</div>
          <div style="font-size: 18px; font-weight: 700; color: ${
            compliance.sfdr_classification === 'article_9' ? '#16a34a' :
            compliance.sfdr_classification === 'article_8' ? '#d97706' : 'inherit'
          };">
            ${compliance.sfdr_classification === 'article_6' ? 'Art. 6' :
              compliance.sfdr_classification === 'article_8' ? 'Art. 8' :
              compliance.sfdr_classification === 'article_9' ? 'Art. 9' : compliance.sfdr_classification || '-'}
          </div>
        </div>
        ` : `
        <div style="background: var(--greige); padding: 16px; border-radius: 10px; text-align: center; grid-column: span 2;">
          <div style="color: var(--text-muted); font-size: 13px;">No ESG requirements defined</div>
        </div>
        `}
      </div>
    </div>
  `;

  $('drawer-compliance').innerHTML = html;
}

function switchTab(tabName) {
  $$('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
  $$('.tab-panel').forEach(p => p.classList.toggle('active', p.id === 'panel-' + tabName));
}

function getRiskBadgeClass(level) {
  if (!level) return 'badge-info';
  const l = level.toLowerCase();
  if (l.includes('high') || l.includes('aggressive')) return 'badge-high';
  if (l.includes('medium') || l.includes('moderate')) return 'badge-medium';
  return 'badge-low';
}

// ============================================================================
// SIDEBAR RENDERING
// ============================================================================
function renderSidebar(data) {
  const client = data.client || {};
  const profile = data.profile || {};
  const enhanced = data.enhanced || {};
  const signals = data.signals || {};
  const risk = enhanced.risk_assessment || {};
  const momentum = enhanced.engagement_momentum || {};
  const conviction = enhanced.conviction || {};
  const readership = enhanced.readership_intelligence || {};
  const portfolio = enhanced.portfolio_risk || {};

  // Calculate Sales-relevant metrics
  const calls30d = momentum.calls_last_30d || 0;
  const trades30d = momentum.trades_last_30d || 0;
  const buyRatio = momentum.recent_buy_ratio || 0;
  const engagementTrend = momentum.engagement_trend || 'Unknown';
  const convictionStock = conviction.top_conviction_stock || '-';

  // Lead Score: Hot (active buyer), Warm (engaged), Cold (dormant)
  let leadScore = 'Cold';
  let leadClass = 'badge-low';
  if (calls30d >= 3 && buyRatio > 0.6) {
    leadScore = 'Hot';
    leadClass = 'badge-hot';
  } else if (calls30d >= 1 || trades30d >= 2) {
    leadScore = 'Warm';
    leadClass = 'badge-medium';
  }

  // Last Contact (from recent calls)
  const recentCalls = signals.recent_calls || [];
  const lastCallDate = recentCalls.length > 0 && recentCalls[0].call_timestamp
    ? new Date(recentCalls[0].call_timestamp).toLocaleDateString('en-US')
    : 'No Contact';

  // Recent Buys (from trades)
  const recentTrades = signals.recent_trades || [];
  const recentBuys = recentTrades.filter(t => t.side?.toLowerCase() === 'buy').slice(0, 3);

  // Top Read Sectors
  const recentReads = signals.recent_reads_daysdiff || [];
  const readSectors = [...new Set(recentReads.map(r => r.report_sector).filter(Boolean))].slice(0, 3);

  $('sidebarContent').innerHTML = `
    <div class="client-header">
      <div class="client-name">${client.primary_contact_name || client.client_name || 'Unknown'}</div>
      <div class="client-meta">${[client.firm_name, client.client_type, client.region].filter(Boolean).join(' Â· ')}</div>
    </div>

    <!-- LEAD SCORE BANNER -->
    <div class="lead-banner ${leadScore.toLowerCase()}">
      <div class="lead-score">
        <span class="lead-label">Lead Score</span>
        <span class="lead-value">${leadScore}</span>
      </div>
      <div class="lead-reason">
        ${leadScore === 'Hot' ? 'Active buyer, high engagement' :
          leadScore === 'Warm' ? 'Regular contact' :
          'Low activity'}
      </div>
    </div>

    <!-- KEY SALES METRICS -->
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-label">Last Contact</div>
        <div class="metric-value" style="font-size: 13px;">${lastCallDate}</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Engagement</div>
        <div class="metric-value">
          <span class="metric-badge ${engagementTrend === 'Accelerating' ? 'badge-high' : engagementTrend === 'Cooling Off' ? 'badge-medium' : 'badge-low'}">${engagementTrend}</span>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Buy Signal</div>
        <div class="metric-value">
          <span class="metric-badge ${buyRatio > 0.6 ? 'badge-high' : buyRatio > 0.3 ? 'badge-medium' : 'badge-low'}">${buyRatio > 0.6 ? 'Bullish' : buyRatio > 0.3 ? 'Neutral' : 'Bearish'}</span>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Top Conviction</div>
        <div class="metric-value" style="font-size: 13px; color: var(--accent);">${convictionStock}</div>
      </div>
    </div>

    <!-- RECENT BUYS -->
    ${recentBuys.length > 0 ? `
    <div class="summary-section">
      <div class="summary-title">Recent Buys</div>
      <div class="buy-chips">
        ${recentBuys.map(b => `
          <span class="buy-chip">${b.ticker || '-'}</span>
        `).join('')}
      </div>
    </div>
    ` : ''}

    <!-- READ INTERESTS -->
    ${readSectors.length > 0 ? `
    <div class="summary-section">
      <div class="summary-title">Reading About</div>
      <div class="interest-chips">
        ${readSectors.map(s => `<span class="interest-chip">${s}</span>`).join('')}
      </div>
    </div>
    ` : ''}

    <div class="summary-section">
      <div class="summary-title">Profile</div>
      <div class="summary-card">
        <ul class="summary-bullets">
          <li><span>Investment Style</span><span>${profile.investment_style || '-'}</span></li>
          <li><span>Risk Appetite</span><span>${profile.risk_appetite || '-'}</span></li>
          <li><span>Focus</span><span>${profile.dominant_topic || '-'}</span></li>
        </ul>
      </div>
    </div>

    <div class="summary-section">
      <div class="summary-title">Activity (30d)</div>
      <div class="activity-bar">
        <div class="activity-item">
          <span class="activity-num">${calls30d}</span>
          <span class="activity-label">Calls</span>
        </div>
        <div class="activity-item">
          <span class="activity-num">${trades30d}</span>
          <span class="activity-label">Trades</span>
        </div>
        <div class="activity-item">
          <span class="activity-num">${recentReads.length}</span>
          <span class="activity-label">Reads</span>
        </div>
      </div>
    </div>

      <div class="summary-card">
        <h4>Portfolio</h4>
        <ul class="summary-bullets">
          <li><span>Top Sector</span><span>${data.portfolio_summary?.top_sector || '-'}</span></li>
          <li><span>Concentration</span><span>${portfolio.concentration_risk_level || '-'}</span></li>
          <li><span>Large Positions</span><span>${portfolio.large_positions || 0}</span></li>
        </ul>
      </div>

      ${conviction.top_conviction_stock ? `
      <div class="summary-card">
        <h4>Conviction: ${conviction.top_conviction_stock}</h4>
        <ul class="summary-bullets">
          <li><span>Trade Count</span><span>${conviction.trade_count || 0}</span></li>
          <li><span>Call Mentions</span><span>${conviction.call_mentions || 0}</span></li>
          <li><span>Sentiment</span><span>${conviction.sentiment_signal || '-'}</span></li>
        </ul>
      </div>
      ` : ''}
    </div>

    <div class="summary-section">
      <div class="summary-title">Avoid Tickers</div>
      <div style="display: flex; flex-wrap: wrap; gap: 6px;">
        ${(data.constraints?.avoid_tickers || []).slice(0, 10).map(t => `
          <span style="padding: 4px 8px; background: #fef2f2; color: #dc2626; border-radius: 4px; font-size: 12px; font-weight: 600;">${t}</span>
        `).join('') || '<span style="color: var(--text-muted); font-size: 13px;">None</span>'}
      </div>
    </div>

    <!-- CLIENT GOALS (loaded async) -->
    <div class="summary-section" id="clientGoalsSection" style="display: none;">
      <div class="summary-title">Investment Goals</div>
      <div id="clientGoals" class="goals-container"></div>
    </div>

    <!-- BEST CONTACT TIME (loaded async) -->
    <div class="summary-section" id="contactTimeSection" style="display: none;">
      <div class="summary-title">Best Contact Time</div>
      <div id="contactTimeInfo" class="contact-time-box"></div>
    </div>

    <!-- CRM SUMMARY (loaded async) -->
    <div class="summary-section" id="crmSummarySection" style="display: none;">
      <div class="summary-title">CRM Status</div>
      <div id="crmSummaryInfo"></div>
    </div>

    <!-- COMPLIANCE SUMMARY (loaded async) -->
    <div class="summary-section" id="complianceSummarySection" style="display: none;">
      <div class="summary-title">Compliance</div>
      <div id="complianceSummaryInfo"></div>
    </div>

    <button class="details-btn" onclick="openDetailsDrawer()">
      Show All Details (Calls, Trades, Reads, Positions...)
    </button>
  `;

  // Load async data for client goals and best contact time
  loadClientGoals(data.client?.client_id || clientId);
  loadBestContactTime(data.client?.client_id || clientId);
  loadCRMSummary(data.client?.client_id || clientId);
  loadComplianceSummary(data.client?.client_id || clientId);
}

// ============================================================================
// CLIENT GOALS & BEST CONTACT TIME
// ============================================================================
async function loadClientGoals(cid) {
  if (!cid) return;
  try {
    const res = await fetch(apiUrl(`/api/client/${cid}/preferences`), { headers: authHeaders() });
    const data = await res.json();
    if (data.error || !data.goals || data.goals.length === 0) return;

    const goalsHtml = data.goals.map(g => `
      <div class="goal-item">
        <span class="goal-icon">${g.icon || ''}</span>
        <div class="goal-text">
          <div class="goal-name">${g.goal}</div>
          <div class="goal-desc">${g.description || ''}</div>
        </div>
      </div>
    `).join('');

    $('clientGoals').innerHTML = goalsHtml;
    $('clientGoalsSection').style.display = 'block';
  } catch (e) {
    console.error('Error loading client goals:', e);
  }
}

async function loadBestContactTime(cid) {
  if (!cid) return;
  try {
    const res = await fetch(apiUrl(`/api/client/${cid}/best_contact_time`), { headers: authHeaders() });
    const data = await res.json();
    if (data.error) return;

    const confidenceClass = data.confidence === 'High' ? 'confidence-high' :
                           data.confidence === 'Medium' ? 'confidence-medium' : 'confidence-low';

    $('contactTimeInfo').innerHTML = `
      <div class="contact-time-main">
        <div class="contact-day">${data.best_day || 'Tuesday'}</div>
        <div class="contact-hours">${data.best_time_range || '09:00 - 11:00'}</div>
      </div>
      <div class="contact-confidence ${confidenceClass}">
        Confidence: ${data.confidence || 'Low'}
      </div>
    `;
    $('contactTimeSection').style.display = 'block';
  } catch (e) {
    console.error('Error loading contact time:', e);
  }
}

// Load CRM Summary for sidebar
async function loadCRMSummary(cid) {
  if (!cid) return;
  try {
    const res = await fetch(apiUrl(`/api/client/${cid}/crm`), { headers: authHeaders() });
    const data = await res.json();
    if (data.error) return;

    const engagement = data.engagement_summary || {};
    const prefs = data.contact_preferences || {};

    $('crmSummaryInfo').innerHTML = `
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
        <div style="background: var(--greige); padding: 8px; border-radius: 6px;">
          <div style="color: var(--text-muted); font-size: 10px;">Meetings (12M)</div>
          <div style="font-weight: 600;">${engagement.total_meetings_12m || 0}</div>
        </div>
        <div style="background: var(--greige); padding: 8px; border-radius: 6px;">
          <div style="color: var(--text-muted); font-size: 10px;">Success Rate</div>
          <div style="font-weight: 600;">${engagement.meeting_success_rate || 0}%</div>
        </div>
        <div style="background: var(--greige); padding: 8px; border-radius: 6px;">
          <div style="color: var(--text-muted); font-size: 10px;">Pref. Channel</div>
          <div style="font-weight: 600; text-transform: capitalize;">${prefs.preferred_channel || '-'}</div>
        </div>
        <div style="background: var(--greige); padding: 8px; border-radius: 6px;">
          <div style="color: var(--text-muted); font-size: 10px;">Response Time</div>
          <div style="font-weight: 600;">${engagement.avg_email_response_hours ? engagement.avg_email_response_hours + 'h' : '-'}</div>
        </div>
      </div>
    `;
    $('crmSummarySection').style.display = 'block';
  } catch (e) {
    console.error('Error loading CRM summary:', e);
  }
}

// Load Compliance Summary for sidebar
async function loadComplianceSummary(cid) {
  if (!cid) return;
  try {
    const res = await fetch(apiUrl(`/api/client/${cid}/compliance`), { headers: authHeaders() });
    const data = await res.json();
    if (data.error || !data.compliance) return;

    const c = data.compliance;
    const kycColor = c.kyc_status === 'approved' ? '#16a34a' : c.kyc_status === 'pending' ? '#d97706' : '#dc2626';
    const kycLabel = c.kyc_status === 'approved' ? 'OK' : c.kyc_status === 'pending' ? 'Pending' : 'Review';

    const restrictions = [];
    if (c.restricted_sectors && c.restricted_sectors.length > 0) {
      restrictions.push(...c.restricted_sectors.slice(0, 3).map(s => s.charAt(0).toUpperCase() + s.slice(1)));
    }

    $('complianceSummaryInfo').innerHTML = `
      <div style="display: flex; gap: 8px; flex-wrap: wrap; font-size: 12px;">
        <div style="background: ${kycColor}22; color: ${kycColor}; padding: 4px 10px; border-radius: 4px; font-weight: 600;">
          KYC: ${kycLabel}
        </div>
        <div style="background: var(--greige); padding: 4px 10px; border-radius: 4px;">
          ${c.investor_type === 'professional' ? 'Professional' : c.investor_type === 'retail' ? 'Retail' : 'Counterparty'}
        </div>
        ${c.esg_mandate ? '<div style="background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 4px;">ESG Mandate</div>' : ''}
      </div>
      ${restrictions.length > 0 ? `
        <div style="margin-top: 8px; font-size: 11px; color: var(--text-muted);">
          Restricted: ${restrictions.join(', ')}
        </div>
      ` : ''}
    `;
    $('complianceSummarySection').style.display = 'block';
  } catch (e) {
    console.error('Error loading compliance summary:', e);
  }
}

// ============================================================================
// ANALYST STOCK OVERRIDE - Manual Selection
// ============================================================================
let manualStockSelected = null;

async function searchAvailableStocks(query) {
  try {
    const res = await fetch(apiUrl(`/api/stocks/available?search=${encodeURIComponent(query)}&limit=50`), {
      headers: authHeaders()
    });
    const data = await res.json();
    return data.stocks || [];
  } catch (e) {
    console.error('Error searching stocks:', e);
    return [];
  }
}

function renderStockSearchResults(stocks) {
  if (stocks.length === 0) {
    $('stockSearchResults').innerHTML = '<div class="empty-search">No stocks found</div>';
    return;
  }

  $('stockSearchResults').innerHTML = stocks.map(s => `
    <div class="stock-search-item" data-stock='${JSON.stringify(s)}'>
      <div class="stock-search-ticker">${s.ticker}</div>
      <div class="stock-search-name">${s.company_name}</div>
      <div class="stock-search-meta">${[s.sector, s.region].filter(Boolean).join(' Â· ')}</div>
    </div>
  `).join('');

  $$('.stock-search-item').forEach(el => {
    el.addEventListener('click', () => {
      const stock = JSON.parse(el.dataset.stock);
      selectManualStock(stock);
    });
  });
}

function selectManualStock(stock) {
  manualStockSelected = stock;
  selectedStock = stock;
  selectedTicker = stock.ticker;

  // Update UI
  $('selectedStock').innerHTML = `<strong>${stock.ticker}</strong> - ${stock.company_name}`;
  $('storyFullBtn').disabled = false;
  $('storyBulletsBtn').disabled = false;

  // Clear search
  $('stockSearchInput').value = '';
  $('stockSearchResults').innerHTML = '';
  $('stockSearchResults').style.display = 'none';

  // Show notification
  setStatus(`Selected: ${stock.ticker}`, 'active');

  // Open stock detail modal with live market data
  openStockDetailModal(stock);
}

// ============================================================================
// SEARCH
// ============================================================================
async function search(query) {
  if (!query || query.length < 2) return;

  setStatus('Searching...', 'default');

  try {
    const res = await fetch(apiUrl(`/api/search?q=${encodeURIComponent(query)}&limit=50`), {
      headers: authHeaders()
    });
    const data = await res.json();
    const results = data.results || [];

    if (results.length === 0) {
      $('searchResults').innerHTML = '<div class="empty-state"><p>No results found.</p></div>';
    } else {
      $('searchResults').innerHTML = results.map(r => `
        <div class="search-result" data-id="${r.client_id}">
          <div class="search-result-name">${r.primary_contact_name || r.client_name}</div>
          <div class="search-result-meta">
            ${[r.firm_name, r.client_type, r.region].filter(Boolean).join(' Â· ')}
          </div>
        </div>
      `).join('');

      $$('.search-result').forEach(el => {
        el.addEventListener('click', () => loadClient(parseInt(el.dataset.id)));
      });
    }

    showModal();
    setStatus('Select Client', 'default');
  } catch (e) {
    setStatus('Error', 'default');
    console.error(e);
  }
}

// ============================================================================
// LOAD CLIENT
// ============================================================================
async function loadClient(id) {
  hideModal();
  setStatus('Loading...', 'default');

  try {
    const res = await fetch(apiUrl(`/api/client/${id}`), { headers: authHeaders() });
    const data = await res.json();

    if (data.error) {
      alert(data.error);
      setStatus('Error', 'default');
      return;
    }

    clientId = id;
    selectedClientId = id;  // For CRM/Compliance tabs
    clientData = data;
    shortlist = [];
    selectedTicker = null;
    selectedStock = null;

    // Reset CRM/Compliance data loaded flags for new client
    crmDataLoaded = false;
    complianceDataLoaded = false;

    renderSidebar(data);

    const client = data.client || {};
    $('mainTitle').textContent = client.firm_name || 'Workspace';
    $('mainSubtitle').textContent = `Client: ${client.primary_contact_name || client.client_name}`;

    $('generateBtn').disabled = false;
    $('stockGrid').innerHTML = '<div class="empty-state"><h3>Ready</h3><p>Click "Generate Shortlist".</p></div>';

    // Load generation history for this client
    await loadHistory();

    setStatus('Client Loaded', 'active');
  } catch (e) {
    setStatus('Error', 'default');
    console.error(e);
  }
}

// ============================================================================
// GENERATE SHORTLIST
// ============================================================================
async function generateShortlist() {
  if (!clientId) return;

  setStatus('Generating...', 'default');
  $('generateBtn').disabled = true;
  $('stockGrid').innerHTML = '<div class="loading"><div class="spinner"></div>Generating Shortlist...</div>';

  const instruction = $('instruction').value.trim();

  try {
    const res = await fetch(apiUrl('/api/shortlist'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', ...authHeaders() },
      body: JSON.stringify({
        client_id: clientId,
        instruction: instruction,
        max_candidates: 120,
        max_words: 320
      })
    });

    const data = await res.json();

    if (data.error) {
      $('stockGrid').innerHTML = `<div class="empty-state"><h3>Error</h3><p>${data.error}</p></div>`;
      setStatus('Error', 'default');
      $('generateBtn').disabled = false;
      return;
    }

    shortlist = data.shortlist || [];
    renderShortlist(shortlist, data.top_picks || []);

    $('pdfBtn').disabled = false;
    $('generateBtn').disabled = false;
    setStatus('Shortlist Ready', 'active');

    // Reload history from server (audit trail)
    await loadHistory();

  } catch (e) {
    $('stockGrid').innerHTML = `<div class="empty-state"><h3>Error</h3><p>${e.message}</p></div>`;
    setStatus('Error', 'default');
    $('generateBtn').disabled = false;
    console.error(e);
  }
}

function renderShortlist(list, topPicksParam) {
  // Store globally for live price updates and filtering
  window._shortlist = list;
  topPicks = topPicksParam || [];

  if (!list.length) {
    $('stockGrid').innerHTML = '<div class="empty-state"><h3>No Recommendations</h3></div>';
    return;
  }

  $('stockGrid').innerHTML = list.map((s, i) => {
    const isTop = topPicks && topPicks.includes(s.ticker);
    // Determine signal based on volatility and sector (simplified logic)
    const signal = isTop ? 'top' : (s.vol_60d < 0.25 ? 'buy' : s.vol_60d > 0.35 ? 'hold' : 'buy');
    const signalLabel = isTop ? 'TOP' : (signal === 'buy' ? 'BUY' : signal === 'sell' ? 'SELL' : 'HOLD');

    return `
      <div class="stock-card ${selectedTicker === s.ticker ? 'selected' : ''}" data-idx="${i}" data-ticker="${s.ticker}">
        <div class="stock-header">
          <div>
            <div class="stock-ticker">
              ${s.ticker}
              <span class="signal-badge ${signal}">
                <span class="signal-dot"></span>
                ${signalLabel}
              </span>
            </div>
            <div class="stock-name">${s.company_name}</div>
          </div>
          <span class="stock-sector">${s.sector || '-'}</span>
        </div>
        <div class="stock-sparkline" id="sparkline-${s.ticker.replace(/\./g, '-')}">
          <canvas></canvas>
        </div>
        <div class="stock-metrics">
          <div class="stock-metric">
            <span class="stock-metric-label">Price</span>
            <span class="stock-metric-value" id="price-${s.ticker.replace(/\./g, '-')}">${s.last_close != null ? Number(s.last_close).toFixed(2) : '-'}</span>
          </div>
          <div class="stock-metric">
            <span class="stock-metric-label">Vol 60d</span>
            <span class="stock-metric-value">${s.vol_60d ? (s.vol_60d * 100).toFixed(1) + '%' : '-'}</span>
          </div>
          <div class="stock-metric">
            <span class="stock-metric-label">Risk</span>
            <span class="stock-metric-value">${s.vol_bucket || '-'}</span>
          </div>
        </div>
        <ul class="stock-reasons">
          ${(s.why_bullets || []).slice(0, 3).map(b => `<li>${b.replace(/^[\sâ€¢\-\*\u2022\u2023\u25E6\u2043\u2219Â·]+/g, '').trim()}</li>`).join('')}
        </ul>
      </div>
    `;
  }).join('');

  $$('.stock-card').forEach(el => {
    el.addEventListener('click', () => selectStock(parseInt(el.dataset.idx)));
  });

  // Load sparklines and live prices for each stock
  list.forEach(s => {
    loadSparkline(s.ticker);
    loadLivePrice(s.ticker);
  });
}

// Fetch and display live prices from yfinance
async function loadLivePrice(ticker) {
  const priceEl = document.getElementById(`price-${ticker.replace(/\./g, '-')}`);
  if (!priceEl) return;

  try {
    const res = await fetch(apiUrl(`/api/stock/${ticker}/quote`), { headers: authHeaders() });
    if (!res.ok) return;

    const data = await res.json();

    if (data.price) {
      const price = Number(data.price).toFixed(2);
      const change = data.change_percent || 0;
      const changeClass = change >= 0 ? 'positive' : 'negative';
      const changeSign = change >= 0 ? '+' : '';

      priceEl.innerHTML = `$${price} <span class="${changeClass}" style="font-size: 10px; margin-left: 4px;">${changeSign}${Number(change).toFixed(1)}%</span>`;

      // Update stored data for when card is clicked
      if (window._shortlist) {
        const stock = window._shortlist.find(s => s.ticker === ticker);
        if (stock) {
          stock.last_close = data.price;
          stock.live_price = data.price;
          stock.change_percent = change;
        }
      }
    }
  } catch (e) {
    console.log(`Could not load live price for ${ticker}`);
  }
}

// Sparkline mini-charts for stock cards
const sparklineCharts = {};

async function loadSparkline(ticker) {
  const containerId = `sparkline-${ticker.replace(/\./g, '-')}`;
  const container = document.getElementById(containerId);
  if (!container) return;

  const canvas = container.querySelector('canvas');
  if (!canvas) return;

  try {
    const res = await fetch(apiUrl(`/api/stock/${ticker}/history?days=14`), { headers: authHeaders() });
    if (!res.ok) return;

    const data = await res.json();
    const prices = data.prices || [];

    if (prices.length < 2) return;

    const closes = prices.map(p => p.close);
    const isPositive = closes[closes.length - 1] >= closes[0];
    const color = isPositive ? '#10b981' : '#ef4444';

    // Destroy existing chart
    if (sparklineCharts[ticker]) {
      sparklineCharts[ticker].destroy();
    }

    const ctx = canvas.getContext('2d');
    sparklineCharts[ticker] = new Chart(ctx, {
      type: 'line',
      data: {
        labels: prices.map((_, i) => i),
        datasets: [{
          data: closes,
          borderColor: color,
          backgroundColor: isPositive ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)',
          borderWidth: 2,
          fill: true,
          tension: 0.4,
          pointRadius: 0,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { enabled: false } },
        scales: {
          x: { display: false },
          y: { display: false }
        },
        interaction: { intersect: false },
        elements: { line: { borderJoinStyle: 'round' } }
      }
    });
  } catch (e) {
    // Silently fail - sparkline is optional
  }
}

// Toast notification system
function showToast(message, type = 'info') {
  let container = document.querySelector('.toast-container');
  if (!container) {
    container = document.createElement('div');
    container.className = 'toast-container';
    document.body.appendChild(container);
  }

  const icons = {
    success: 'âœ“',
    error: 'âœ•',
    info: 'â„¹'
  };

  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <span class="toast-icon">${icons[type] || icons.info}</span>
    <span>${message}</span>
  `;

  container.appendChild(toast);

  // Auto-remove after 4 seconds
  setTimeout(() => {
    toast.style.animation = 'fadeIn 0.3s ease-out reverse';
    setTimeout(() => toast.remove(), 300);
  }, 4000);
}

function selectStock(idx) {
  const stock = shortlist[idx];
  if (!stock) return;

  selectedTicker = stock.ticker;
  selectedStock = stock;

  $$('.stock-card').forEach((el, i) => el.classList.toggle('selected', i === idx));

  $('selectedStock').textContent = `AusgewÃ¤hlt: ${stock.ticker}`;
  $('storyFullBtn').disabled = false;
  $('storyBulletsBtn').disabled = false;
  $('storyEmpty').style.display = 'none';

  // Open stock detail modal with live market data
  openStockDetailModal(stock);
}

// ============================================================================
// GENERATE STORY
// ============================================================================
async function generateStory(mode) {
  if (!clientId || !selectedTicker) return;

  setStatus('Generating Story...', 'default');
  $('outputPanel').style.display = 'block';
  $('outputText').textContent = 'Generiere...';

  const instruction = $('instruction').value.trim();

  try {
    const res = await fetch(apiUrl('/api/story_for_stock'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', ...authHeaders() },
      body: JSON.stringify({
        client_id: clientId,
        selected_ticker: selectedTicker,
        mode: mode,
        instruction: instruction,
        max_words: mode === 'BULLETS' ? 220 : 280
      })
    });

    const data = await res.json();

    if (data.error) {
      $('outputText').textContent = 'Error: ' + data.error;
      setStatus('Error', 'default');
      return;
    }

    $('outputTitle').textContent = mode === 'BULLETS' ? `Bullets - ${selectedTicker}` : `Story - ${selectedTicker}`;
    $('outputText').textContent = data.story || '(No Output)';

    setStatus('Story Ready', 'active');
    switchTab('story');

    // Reload history from server (audit trail)
    await loadHistory();

  } catch (e) {
    $('outputText').textContent = 'Error: ' + e.message;
    setStatus('Error', 'default');
    console.error(e);
  }
}

// ============================================================================
// STOCK STORYLINE (from modal)
// ============================================================================
async function generateStockStoryline(ticker, companyName, sector) {
  if (!clientId) {
    alert('Please select a client first');
    return;
  }

  const outputDiv = document.getElementById('stockStorylineOutput');
  const textDiv = document.getElementById('stockStorylineText');

  outputDiv.style.display = 'block';
  textDiv.textContent = 'Generating storyline...';

  try {
    const res = await fetch(apiUrl('/api/story_for_stock'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', ...authHeaders() },
      body: JSON.stringify({
        client_id: clientId,
        selected_ticker: ticker,
        mode: 'STORY',
        instruction: `Focus on ${companyName} (${ticker}) in the ${sector} sector. Create a compelling sales narrative.`,
        max_words: 300
      })
    });

    const data = await res.json();

    if (data.error) {
      textDiv.textContent = 'Error: ' + data.error;
      return;
    }

    textDiv.textContent = data.story || '(No output generated)';

  } catch (e) {
    textDiv.textContent = 'Error: ' + e.message;
    console.error(e);
  }
}

function copyStockStoryline() {
  const text = document.getElementById('stockStorylineText').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span style="margin-right: 6px;">&#10003;</span> Copied!';
    setTimeout(() => { btn.innerHTML = originalText; }, 2000);
  });
}

// ============================================================================
// HISTORY (Server-side audit trail)
// ============================================================================
async function loadHistory() {
  if (!clientId) {
    history = [];
    renderHistory();
    return;
  }

  try {
    const res = await fetch(apiUrl(`/api/history/${clientId}?limit=50`), { headers: authHeaders() });
    const data = await res.json();
    history = (data.history || []).map(h => ({
      id: h.generation_id,
      type: h.generation_type,
      client_id: h.client_id,
      client_name: clientData?.client?.firm_name || 'Unknown',
      timestamp: h.created_at,
      data: {
        ticker: h.ticker,
        mode: h.mode,
        response: h.response_text,
      }
    }));
    renderHistory();
  } catch (e) {
    console.error('Failed to load history:', e);
    history = [];
    renderHistory();
  }
}

function renderHistory() {
  if (history.length === 0) {
    $('historyEmpty').style.display = 'block';
    $('historyList').innerHTML = '';
    return;
  }

  $('historyEmpty').style.display = 'none';
  $('historyList').innerHTML = history.slice(0, 20).map(h => `
    <div class="summary-card" style="margin-bottom: 12px; cursor: pointer;" onclick="showHistoryDetail(${h.id})">
      <h4>${h.type === 'shortlist' ? 'Shortlist' : 'Story'} - ${h.client_name}
        <span class="history-badge">${new Date(h.timestamp).toLocaleString('en-US')}</span>
      </h4>
      <div class="summary-text">
        ${h.type === 'shortlist'
          ? 'Shortlist generated'
          : `${h.data.ticker || '-'} (${h.data.mode || 'FULL'})`
        }
      </div>
    </div>
  `).join('');
}

function showHistoryDetail(id) {
  const entry = history.find(h => h.id === id);
  if (!entry) return;

  // Show the response in the output panel
  switchTab('story');
  $('outputPanel').style.display = 'block';
  $('outputTitle').textContent = `${entry.type === 'shortlist' ? 'Shortlist' : 'Story'} (History #${id})`;
  $('outputText').textContent = entry.data.response || '(No Data)';
}

// ============================================================================
// STOCK DETAIL MODAL
// ============================================================================
function openStockDetailModal(stock) {
  // Set basic info immediately
  $('detailTicker').textContent = stock.ticker;
  $('detailCompanyName').textContent = stock.company_name || 'Loading...';
  $('detailPrice').textContent = stock.last_close ? `$${Number(stock.last_close).toFixed(2)}` : '-';
  $('detailChange').textContent = '-';
  $('detailChange').className = 'stock-detail-change';

  // Show loading state
  $('stockDetailBody').innerHTML = `
    <div class="stock-detail-loading">
      <div class="spinner"></div>
      <span style="margin-left: 12px;">Loading market data...</span>
    </div>
  `;

  // Open modal
  $('stockDetailOverlay').classList.add('open');
  $('stockDetailModal').classList.add('open');

  // Fetch live data
  fetchStockDetails(stock);
}

function closeStockDetailModal() {
  $('stockDetailOverlay').classList.remove('open');
  $('stockDetailModal').classList.remove('open');
}

async function fetchStockDetails(stock) {
  const ticker = stock.ticker;

  try {
    // Fetch quote, news, history, and fundamentals in parallel
    const [quoteRes, newsRes, historyRes, fundamentalsRes] = await Promise.all([
      fetch(apiUrl(`/api/stock/${ticker}/quote`), { headers: authHeaders() }).catch(() => null),
      fetch(apiUrl(`/api/stock/${ticker}/news?days=7`), { headers: authHeaders() }).catch(() => null),
      fetch(apiUrl(`/api/stock/${ticker}/history?days=30`), { headers: authHeaders() }).catch(() => null),
      fetch(apiUrl(`/api/stock/${ticker}/fundamentals`), { headers: authHeaders() }).catch(() => null)
    ]);

    let quote = null;
    let news = [];
    let history = [];
    let fundamentals = null;

    if (quoteRes && quoteRes.ok) {
      const quoteData = await quoteRes.json();
      quote = quoteData.quote;
    }

    if (newsRes && newsRes.ok) {
      const newsData = await newsRes.json();
      news = newsData.news || [];
    }

    if (historyRes && historyRes.ok) {
      const historyData = await historyRes.json();
      history = historyData.prices || [];
    }

    if (fundamentalsRes && fundamentalsRes.ok) {
      fundamentals = await fundamentalsRes.json();
    }

    renderStockDetailContent(stock, quote, news, history, fundamentals);

  } catch (e) {
    console.error('Error fetching stock details:', e);
    renderStockDetailContent(stock, null, [], [], null);
  }
}

// Global chart instance for cleanup
let stockPriceChart = null;

function renderStockDetailContent(stock, quote, news, history = [], fundamentals = null) {
  // Get latest day data from history as fallback
  const latestDay = history && history.length > 0 ? history[history.length - 1] : null;

  // Use quote data if available, otherwise fall back to history
  const openPrice = quote?.open || latestDay?.open || null;
  const highPrice = quote?.high || latestDay?.high || null;
  const lowPrice = quote?.low || latestDay?.low || null;
  const closePrice = quote?.price || latestDay?.close || stock.last_close;
  const volume = quote?.volume || latestDay?.volume || null;

  // Update header with live price if available
  if (closePrice) {
    $('detailPrice').textContent = `$${Number(closePrice).toFixed(2)}`;

    // Calculate change from history if no quote
    let changePercent = 0;
    let changeValue = 0;

    if (quote && quote.change_percent) {
      changePercent = parseFloat(quote.change_percent) || 0;
      changeValue = quote.change || 0;
    } else if (history && history.length >= 2) {
      const prevDay = history[history.length - 2];
      if (prevDay && prevDay.close && latestDay && latestDay.close) {
        changeValue = latestDay.close - prevDay.close;
        changePercent = (changeValue / prevDay.close) * 100;
      }
    }

    const changeClass = changePercent >= 0 ? 'positive' : 'negative';
    const changeSign = changePercent >= 0 ? '+' : '';
    $('detailChange').textContent = `${changeSign}${Number(changeValue).toFixed(2)} (${changeSign}${changePercent.toFixed(2)}%)`;
    $('detailChange').className = `stock-detail-change ${changeClass}`;
  }

  // Calculate price range position
  let rangePosition = 50; // Default to middle
  let low = lowPrice || stock.last_close * 0.95;
  let high = highPrice || stock.last_close * 1.05;
  let current = closePrice || stock.last_close;

  if (high > low && current) {
    rangePosition = ((current - low) / (high - low)) * 100;
    rangePosition = Math.max(5, Math.min(95, rangePosition));
  }

  // Build content
  let html = `
    <!-- Price Metrics -->
    <div class="stock-detail-metrics">
      <div class="stock-metric-box">
        <div class="label">Open</div>
        <div class="value">${openPrice ? `$${Number(openPrice).toFixed(2)}` : '-'}</div>
      </div>
      <div class="stock-metric-box">
        <div class="label">High</div>
        <div class="value">${highPrice ? `$${Number(highPrice).toFixed(2)}` : '-'}</div>
      </div>
      <div class="stock-metric-box">
        <div class="label">Low</div>
        <div class="value">${lowPrice ? `$${Number(lowPrice).toFixed(2)}` : '-'}</div>
      </div>
      <div class="stock-metric-box">
        <div class="label">Volume</div>
        <div class="value">${volume ? Number(volume).toLocaleString('de-DE') : '-'}</div>
      </div>
    </div>

    <!-- Day Range -->
    <div class="stock-detail-section">
      <div class="stock-detail-section-title">Day Range</div>
      <div class="stock-price-range">
        <span class="price-range-label">${lowPrice ? `$${Number(lowPrice).toFixed(2)}` : '-'}</span>
        <div class="price-range-bar">
          <div class="price-range-marker" style="left: ${rangePosition}%;"></div>
        </div>
        <span class="price-range-label high">${highPrice ? `$${Number(highPrice).toFixed(2)}` : '-'}</span>
      </div>
    </div>

    <!-- Price Chart -->
    <div class="stock-detail-section">
      <div class="stock-detail-section-title">Price History (30 Days)</div>
      <div class="stock-chart-container">
        <canvas id="stockPriceChartCanvas"></canvas>
      </div>
    </div>

    <!-- Stock Info from Shortlist -->
    <div class="stock-detail-section">
      <div class="stock-detail-section-title">Stock Information</div>
      <div class="stock-detail-metrics" style="grid-template-columns: repeat(3, 1fr);">
        <div class="stock-metric-box">
          <div class="label">Sector</div>
          <div class="value" style="font-size: 14px;">${stock.sector || '-'}</div>
        </div>
        <div class="stock-metric-box">
          <div class="label">Volatility (60d)</div>
          <div class="value">${stock.vol_60d ? (stock.vol_60d * 100).toFixed(1) + '%' : '-'}</div>
        </div>
        <div class="stock-metric-box">
          <div class="label">Risk Bucket</div>
          <div class="value" style="font-size: 14px;">${stock.vol_bucket || '-'}</div>
        </div>
      </div>
    </div>
  `;

  // Fundamentals Section (from yfinance)
  if (fundamentals && !fundamentals.error) {
    const val = fundamentals.valuation || {};
    const prof = fundamentals.profitability || {};
    const growth = fundamentals.growth || {};
    const div = fundamentals.dividends || {};
    const analyst = fundamentals.analyst || {};
    const health = fundamentals.financial_health || {};

    html += `
      <div class="stock-detail-section">
        <div class="stock-detail-section-title">Fundamentals <span style="font-size: 11px; background: #e0f0ea; color: #305f50; padding: 2px 8px; border-radius: 10px; margin-left: 8px;">Live Data</span></div>

        <!-- Valuation -->
        <div style="margin-bottom: 16px;">
          <div style="font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">VALUATION</div>
          <div class="stock-detail-metrics" style="grid-template-columns: repeat(4, 1fr);">
            <div class="stock-metric-box">
              <div class="label">P/E (TTM)</div>
              <div class="value">${val.pe_trailing ? val.pe_trailing.toFixed(1) + 'x' : '-'}</div>
            </div>
            <div class="stock-metric-box">
              <div class="label">P/E (Fwd)</div>
              <div class="value">${val.pe_forward ? val.pe_forward.toFixed(1) + 'x' : '-'}</div>
            </div>
            <div class="stock-metric-box">
              <div class="label">P/B</div>
              <div class="value">${val.pb_ratio ? val.pb_ratio.toFixed(1) + 'x' : '-'}</div>
            </div>
            <div class="stock-metric-box">
              <div class="label">EV/EBITDA</div>
              <div class="value">${val.ev_ebitda ? val.ev_ebitda.toFixed(1) + 'x' : '-'}</div>
            </div>
          </div>
        </div>

        <!-- Profitability & Growth -->
        <div style="margin-bottom: 16px;">
          <div style="font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">PROFITABILITY & GROWTH</div>
          <div class="stock-detail-metrics" style="grid-template-columns: repeat(4, 1fr);">
            <div class="stock-metric-box">
              <div class="label">ROE</div>
              <div class="value" style="color: ${prof.roe > 15 ? '#16a34a' : 'inherit'};">${prof.roe ? prof.roe.toFixed(1) + '%' : '-'}</div>
            </div>
            <div class="stock-metric-box">
              <div class="label">Net Margin</div>
              <div class="value">${prof.profit_margin ? prof.profit_margin.toFixed(1) + '%' : '-'}</div>
            </div>
            <div class="stock-metric-box">
              <div class="label">Revenue Growth</div>
              <div class="value" style="color: ${growth.revenue_growth > 10 ? '#16a34a' : growth.revenue_growth < 0 ? '#dc2626' : 'inherit'};">${growth.revenue_growth ? growth.revenue_growth.toFixed(1) + '%' : '-'}</div>
            </div>
            <div class="stock-metric-box">
              <div class="label">EPS</div>
              <div class="value">${growth.trailing_eps ? '$' + growth.trailing_eps.toFixed(2) : '-'}</div>
            </div>
          </div>
        </div>

        <!-- Dividends & Health -->
        <div style="margin-bottom: 16px;">
          <div style="font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">DIVIDENDS & FINANCIAL HEALTH</div>
          <div class="stock-detail-metrics" style="grid-template-columns: repeat(4, 1fr);">
            <div class="stock-metric-box">
              <div class="label">Div Yield</div>
              <div class="value" style="color: ${div.dividend_yield > 2 ? '#16a34a' : 'inherit'};">${div.dividend_yield ? div.dividend_yield.toFixed(2) + '%' : '-'}</div>
            </div>
            <div class="stock-metric-box">
              <div class="label">Payout</div>
              <div class="value">${div.payout_ratio ? div.payout_ratio.toFixed(0) + '%' : '-'}</div>
            </div>
            <div class="stock-metric-box">
              <div class="label">D/E Ratio</div>
              <div class="value" style="color: ${health.debt_to_equity > 100 ? '#dc2626' : 'inherit'};">${health.debt_to_equity ? health.debt_to_equity.toFixed(1) : '-'}</div>
            </div>
            <div class="stock-metric-box">
              <div class="label">Current Ratio</div>
              <div class="value">${health.current_ratio ? health.current_ratio.toFixed(1) : '-'}</div>
            </div>
          </div>
        </div>

        <!-- Analyst Consensus -->
        ${analyst.recommendation ? `
        <div>
          <div style="font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">ANALYST CONSENSUS</div>
          <div class="stock-detail-metrics" style="grid-template-columns: repeat(4, 1fr);">
            <div class="stock-metric-box">
              <div class="label">Rating</div>
              <div class="value" style="font-size: 14px; text-transform: uppercase; color: ${analyst.recommendation.includes('buy') ? '#16a34a' : analyst.recommendation.includes('sell') ? '#dc2626' : '#d97706'};">${analyst.recommendation || '-'}</div>
            </div>
            <div class="stock-metric-box">
              <div class="label">Avg Target</div>
              <div class="value">${analyst.target_mean ? '$' + analyst.target_mean.toFixed(0) : '-'}</div>
            </div>
            <div class="stock-metric-box">
              <div class="label">Target Range</div>
              <div class="value" style="font-size: 13px;">${analyst.target_low && analyst.target_high ? '$' + analyst.target_low.toFixed(0) + ' - $' + analyst.target_high.toFixed(0) : '-'}</div>
            </div>
            <div class="stock-metric-box">
              <div class="label">Coverage</div>
              <div class="value">${analyst.number_of_analysts ? analyst.number_of_analysts + ' analysts' : '-'}</div>
            </div>
          </div>
        </div>
        ` : ''}
      </div>
    `;
  }

  // AI Reasoning (if available)
  if (stock.why_bullets && stock.why_bullets.length > 0) {
    html += `
      <div class="stock-detail-section">
        <div class="stock-detail-section-title">Why This Stock?</div>
        <ul class="stock-reasons" style="font-size: 14px; line-height: 1.8;">
          ${stock.why_bullets.map(b => `<li>${b.replace(/^[\sâ€¢\-\*\u2022\u2023\u25E6\u2043\u2219Â·]+/g, '').trim()}</li>`).join('')}
        </ul>
      </div>
    `;
  }

  // Generate Storyline Button
  html += `
    <div class="stock-detail-section" style="text-align: center;">
      <button class="btn-primary" onclick="generateStockStoryline('${stock.ticker}', '${(stock.company_name || '').replace(/'/g, "\\'")}', '${stock.sector || ''}')" style="width: 100%; padding: 14px 24px; font-size: 15px;">
        <span style="margin-right: 8px;">&#9998;</span> Generate Sales Storyline
      </button>
      <div id="stockStorylineOutput" style="margin-top: 16px; text-align: left; display: none;">
        <div style="font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">GENERATED STORYLINE</div>
        <div id="stockStorylineText" style="background: var(--greige); padding: 16px; border-radius: 10px; font-size: 14px; line-height: 1.7; white-space: pre-wrap;"></div>
        <button class="btn-secondary" onclick="copyStockStoryline()" style="margin-top: 12px; width: 100%;">
          <span style="margin-right: 6px;">&#128203;</span> Copy to Clipboard
        </button>
      </div>
    </div>
  `;

  // News Section
  html += `
    <div class="stock-detail-section">
      <div class="stock-detail-section-title">
        Recent News
        <span style="font-size: 11px; background: var(--bg); padding: 2px 8px; border-radius: 10px; font-family: var(--font-primary);">${news.length}</span>
      </div>
  `;

  if (news.length > 0) {
    html += `<div class="news-list">`;
    news.slice(0, 5).forEach(article => {
      // Calculate hypothetical impact based on sentiment
      const sentiment = article.sentiment || 'neutral';
      let impactText = '';
      let impactColor = '';
      if (sentiment === 'positive' || sentiment === 'bullish') {
        impactText = 'Potential positive catalyst (+1-3%)';
        impactColor = '#16a34a';
      } else if (sentiment === 'negative' || sentiment === 'bearish') {
        impactText = 'Potential downside risk (-1-3%)';
        impactColor = '#dc2626';
      } else {
        impactText = 'Neutral impact expected';
        impactColor = '#6b7280';
      }

      html += `
        <div class="news-item" ${article.link ? `onclick="window.open('${article.link}', '_blank')"` : ''} style="${article.link ? 'cursor: pointer;' : ''}">
          <div class="news-headline">${article.title || 'No title'}</div>
          <div class="news-meta">
            <span class="news-sentiment ${sentiment}">${sentiment}</span>
            <span>${article.publisher || 'Unknown'}</span>
            <span>${article.published || ''}</span>
          </div>
          <div style="font-size: 11px; color: ${impactColor}; margin-top: 6px; font-style: italic;">
            Hypothetical: ${impactText}
          </div>
        </div>
      `;
    });
    html += `</div>`;
  } else {
    html += `
      <div class="stock-detail-error">
        No recent news available for ${stock.ticker}
      </div>
    `;
  }

  html += `</div>`;

  // Trading Date
  if (quote?.latest_trading_day) {
    html += `
      <div style="text-align: center; margin-top: 20px; font-size: 11px; color: var(--text-muted);">
        Data as of ${quote.latest_trading_day}
      </div>
    `;
  }

  $('stockDetailBody').innerHTML = html;

  // Render price chart if we have history data
  renderPriceChart(history, stock.ticker);
}

function renderPriceChart(history, ticker) {
  // Destroy previous chart if exists
  if (stockPriceChart) {
    stockPriceChart.destroy();
    stockPriceChart = null;
  }

  const canvas = document.getElementById('stockPriceChartCanvas');
  if (!canvas) return;

  // If no history data, show message
  if (!history || history.length === 0) {
    const ctx = canvas.getContext('2d');
    ctx.font = '14px var(--font-primary)';
    ctx.fillStyle = '#999';
    ctx.textAlign = 'center';
    ctx.fillText('No historical data available', canvas.width / 2, canvas.height / 2);
    return;
  }

  // Prepare data (history is already chronological from API)
  const labels = history.map(p => {
    const date = new Date(p.date);
    return date.toLocaleDateString('de-DE', { month: 'short', day: 'numeric' });
  });
  const prices = history.map(p => p.close);

  // Calculate min/max for better y-axis scaling
  const minPrice = Math.min(...prices) * 0.98;
  const maxPrice = Math.max(...prices) * 1.02;

  // Determine chart color based on price trend
  const isPositive = prices[prices.length - 1] >= prices[0];
  const lineColor = isPositive ? '#10b981' : '#ef4444';
  const bgGradient = isPositive ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';

  const ctx = canvas.getContext('2d');

  stockPriceChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: ticker,
        data: prices,
        borderColor: lineColor,
        backgroundColor: bgGradient,
        borderWidth: 2,
        fill: true,
        tension: 0.3,
        pointRadius: 0,
        pointHoverRadius: 5,
        pointHoverBackgroundColor: lineColor,
        pointHoverBorderColor: document.documentElement.dataset.theme === 'dark' ? '#10b981' : '#fff',
        pointHoverBorderWidth: 2,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(0, 61, 57, 0.9)',
          titleFont: { family: 'Lato, sans-serif', size: 12 },
          bodyFont: { family: 'Lato, sans-serif', size: 14, weight: 'bold' },
          padding: 12,
          cornerRadius: 8,
          callbacks: {
            label: function(context) {
              return `$${context.parsed.y.toFixed(2)}`;
            }
          }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: {
            font: { family: 'Lato, sans-serif', size: 10 },
            color: '#999',
            maxRotation: 0,
            maxTicksLimit: 6
          }
        },
        y: {
          min: minPrice,
          max: maxPrice,
          grid: {
            color: 'rgba(0, 0, 0, 0.05)',
            drawBorder: false
          },
          ticks: {
            font: { family: 'Lato, sans-serif', size: 10 },
            color: '#999',
            callback: function(value) {
              return '$' + value.toFixed(0);
            }
          }
        }
      }
    }
  });
}

// ============================================================================
// COPY
// ============================================================================
function copyOutput() {
  const text = $('outputText').textContent;
  navigator.clipboard.writeText(text);
  setStatus('Copied!', 'active');
  setTimeout(() => setStatus('Story ready', 'active'), 1000);
}

// ============================================================================
// HEALTH CHECK
// ============================================================================
async function healthCheck() {
  setStatus('Checking...', 'default');
  try {
    const res = await fetch(apiUrl('/api/health'), { headers: authHeaders() });
    const data = await res.json();
    if (data.ok) {
      setStatus(`OK (${data.clients} Clients)`, 'active');
    } else {
      setStatus('Backend Error', 'default');
    }
  } catch (e) {
    setStatus('Offline', 'default');
  }
}

// ============================================================================
// EVENT LISTENERS
// ============================================================================
$('searchInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') search(e.target.value);
});

$('closeModal').addEventListener('click', hideModal);
$('modalOverlay').addEventListener('click', hideModal);

$('closeDrawer').addEventListener('click', closeDetailsDrawer);
$('drawerOverlay').addEventListener('click', closeDetailsDrawer);

$('closeStockDetail').addEventListener('click', closeStockDetailModal);
$('stockDetailOverlay').addEventListener('click', closeStockDetailModal);

$('generateBtn').addEventListener('click', generateShortlist);
$('storyFullBtn').addEventListener('click', () => generateStory('FULL'));
$('storyBulletsBtn').addEventListener('click', () => generateStory('BULLETS'));
$('copyBtn').addEventListener('click', copyOutput);
$('healthBtn').addEventListener('click', healthCheck);

$$('.tab').forEach(t => t.addEventListener('click', () => switchTab(t.dataset.tab)));

$$('.quick-prompt').forEach(el => {
  el.addEventListener('click', () => {
    const current = $('instruction').value;
    $('instruction').value = current ? current + '\n' + el.dataset.prompt : el.dataset.prompt;
  });
});

// Settings (simple prompt for now)
$('settingsBtn').addEventListener('click', () => {
  const base = prompt('API Base URL (empty = same-origin):', getApiBase());
  if (base !== null) localStorage.setItem('api_base', base);
});

// Stock search for analyst override
let stockSearchDebounce = null;
$('stockSearchInput').addEventListener('input', (e) => {
  const query = e.target.value.trim();
  if (stockSearchDebounce) clearTimeout(stockSearchDebounce);

  if (query.length < 2) {
    $('stockSearchResults').style.display = 'none';
    return;
  }

  stockSearchDebounce = setTimeout(async () => {
    const stocks = await searchAvailableStocks(query);
    $('stockSearchResults').style.display = 'block';
    renderStockSearchResults(stocks);
  }, 300);
});

// Hide stock search results when clicking outside
document.addEventListener('click', (e) => {
  const searchBox = document.querySelector('.override-search');
  if (searchBox && !searchBox.contains(e.target)) {
    $('stockSearchResults').style.display = 'none';
  }
});

// Init
renderHistory();

// ============================================================================
// DARK MODE
// ============================================================================
function initTheme() {
  const savedTheme = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
}

function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme');
  const next = current === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
  showToast(`${next === 'dark' ? 'ðŸŒ™' : 'â˜€ï¸'} ${next.charAt(0).toUpperCase() + next.slice(1)} Mode`, 'info');
}

$('themeToggle').addEventListener('click', toggleTheme);
initTheme();

// ============================================================================
// LIVE TICKER
// ============================================================================
async function loadLiveTicker() {
  try {
    const res = await fetch(apiUrl('/api/stocks'), { headers: authHeaders() });
    if (!res.ok) return;

    const data = await res.json();
    const stocks = data.stocks || [];

    if (stocks.length === 0) return;

    const tickerHtml = stocks.slice(0, 15).map(s => {
      const change = (Math.random() * 4 - 2).toFixed(2);
      const isPositive = parseFloat(change) >= 0;
      return `
        <div class="ticker-item">
          <span class="ticker-symbol">${s.ticker}</span>
          <span class="ticker-price">$${s.last_close?.toFixed(2) || '-'}</span>
          <span class="ticker-change ${isPositive ? 'positive' : 'negative'}">
            ${isPositive ? '+' : ''}${change}%
          </span>
        </div>
      `;
    }).join('');

    $('tickerContent').innerHTML = tickerHtml + tickerHtml;
  } catch (e) {
    console.error('Ticker error:', e);
  }
}

setTimeout(loadLiveTicker, 1000);

// ============================================================================
// LOAD FILTER OPTIONS FROM API
// ============================================================================
async function loadFilterOptions() {
  try {
    const response = await fetch(apiUrl('/api/filters'), { headers: authHeaders() });
    if (!response.ok) return;

    const data = await response.json();

    // Populate sector dropdown
    const sectorSelect = $('filterSector');
    if (sectorSelect && data.sectors && data.sectors.length > 0) {
      // Keep the first "All Sectors" option
      sectorSelect.innerHTML = '<option value="">All Sectors</option>';
      data.sectors.forEach(sector => {
        const option = document.createElement('option');
        option.value = sector;
        option.textContent = sector;
        sectorSelect.appendChild(option);
      });
    }

    console.log(`Loaded ${data.sectors?.length || 0} sectors, ${data.themes?.length || 0} themes`);
  } catch (e) {
    console.error('Error loading filter options:', e);
  }
}

// Load filters on startup
setTimeout(loadFilterOptions, 500);

// ============================================================================
// STOCK FILTERS
// ============================================================================
let allShortlistStocks = [];
let topPicks = [];  // Global variable to store top picks from shortlist

function applyFilters() {
  const sectorFilter = $('filterSector')?.value || '';
  const riskFilter = $('filterRisk')?.value || '';
  const topOnly = $('filterTopOnly')?.classList.contains('active');

  const filtered = allShortlistStocks.filter(s => {
    if (sectorFilter && s.sector !== sectorFilter) return false;
    if (riskFilter && s.vol_bucket !== riskFilter) return false;
    if (topOnly && !topPicks.includes(s.ticker)) return false;
    return true;
  });

  renderFilteredShortlist(filtered, topPicks);
  if ($('stockCount')) $('stockCount').textContent = filtered.length;
}

function renderFilteredShortlist(list, tops) {
  if (!list.length) {
    $('stockGrid').innerHTML = '<div class="empty-state"><h3>No stocks match filters</h3></div>';
    return;
  }

  $('stockGrid').innerHTML = list.map((s, i) => {
    const isTop = tops.includes(s.ticker);
    const signal = isTop ? 'top' : (s.vol_60d < 0.25 ? 'buy' : s.vol_60d > 0.35 ? 'hold' : 'buy');
    const signalLabel = isTop ? 'TOP' : (signal === 'buy' ? 'BUY' : 'HOLD');

    return `
      <div class="stock-card ${selectedTicker === s.ticker ? 'selected' : ''}" data-idx="${allShortlistStocks.indexOf(s)}" data-ticker="${s.ticker}">
        <div class="stock-header">
          <div>
            <div class="stock-ticker">
              ${s.ticker}
              <span class="signal-badge ${signal}"><span class="signal-dot"></span>${signalLabel}</span>
            </div>
            <div class="stock-name">${s.company_name}</div>
          </div>
          <span class="stock-sector">${s.sector || '-'}</span>
        </div>
        <div class="stock-sparkline" id="sparkline-${s.ticker.replace(/\./g, '-')}"><canvas></canvas></div>
        <div class="stock-metrics">
          <div class="stock-metric"><span class="stock-metric-label">Close</span><span class="stock-metric-value">${s.last_close != null ? Number(s.last_close).toFixed(2) : '-'}</span></div>
          <div class="stock-metric"><span class="stock-metric-label">Vol 60d</span><span class="stock-metric-value">${s.vol_60d ? (s.vol_60d * 100).toFixed(1) + '%' : '-'}</span></div>
          <div class="stock-metric"><span class="stock-metric-label">Risk</span><span class="stock-metric-value">${s.vol_bucket || '-'}</span></div>
        </div>
        <ul class="stock-reasons">${(s.why_bullets || []).slice(0, 3).map(b => `<li>${b.replace(/^[\sâ€¢\-\*\u2022\u2023\u25E6\u2043\u2219Â·]+/g, '').trim()}</li>`).join('')}</ul>
      </div>
    `;
  }).join('');

  $$('.stock-card').forEach(el => {
    el.addEventListener('click', () => selectStock(parseInt(el.dataset.idx)));
  });

  list.forEach(s => loadSparkline(s.ticker));
}

if ($('filterSector')) $('filterSector').addEventListener('change', applyFilters);
if ($('filterRisk')) $('filterRisk').addEventListener('change', applyFilters);
if ($('filterTopOnly')) $('filterTopOnly').addEventListener('click', function() {
  this.classList.toggle('active');
  applyFilters();
});

// ============================================================================
// KEYBOARD SHORTCUTS
// ============================================================================
document.addEventListener('keydown', (e) => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

  if (e.key === 'g' && clientId) { e.preventDefault(); $('generateBtn').click(); showToast('Generating...', 'info'); }
  if (e.key === 's' && selectedTicker) { e.preventDefault(); $('storyFullBtn').click(); }
  if (e.key === 'b' && selectedTicker) { e.preventDefault(); $('storyBulletsBtn').click(); }
  if (e.key === 'd') { e.preventDefault(); toggleTheme(); }
  if (e.key === '1') { e.preventDefault(); switchTab('shortlist'); }
  if (e.key === '2') { e.preventDefault(); switchTab('story'); }
  if (e.key === '3') { e.preventDefault(); switchTab('history'); }
  if (e.key === 'Escape') { closeStockDetailModal(); closeModal(); closeDrawer(); }
  if (e.key === '/') { e.preventDefault(); $('searchInput').focus(); }
});

// ============================================================================
// SMART SEARCH AUTOCOMPLETE WITH SUGGESTIONS
// ============================================================================
let searchDebounce = null;

$('searchInput').addEventListener('input', async (e) => {
  const query = e.target.value.trim();
  if (searchDebounce) clearTimeout(searchDebounce);

  if (query.length < 2) { $('searchAutocomplete').classList.remove('show'); return; }

  searchDebounce = setTimeout(async () => {
    try {
      // Use the enhanced search endpoint
      const res = await fetch(apiUrl(`/api/search?q=${encodeURIComponent(query)}&limit=8`), { headers: authHeaders() });
      if (!res.ok) return;

      const data = await res.json();
      const matches = data.results || [];
      const suggestions = data.suggestions || [];

      let html = '';

      // Show matches
      if (matches.length > 0) {
        html = matches.map(c => `
          <div class="search-item" data-id="${c.client_id}">
            <div class="search-item-title">${c.client_name || c.primary_contact_name || 'Unknown'}</div>
            <div class="search-item-subtitle">${c.firm_name || ''} | ${c.client_type || ''} | ${c.region || ''}</div>
          </div>
        `).join('');
      } else if (suggestions.length > 0) {
        // Show suggestions when no matches
        html = '<div class="search-section-header">No matches. Suggestions:</div>';
        html += suggestions.map(s => {
          if (s.type === 'popular') {
            return `<div class="search-item search-suggestion" data-id="${s.client_id}">
              <div class="search-item-title">${s.value}</div>
              <div class="search-item-subtitle">Active Client</div>
            </div>`;
          } else if (s.type === 'client_type') {
            return `<div class="search-item search-suggestion" data-type="${s.value}">
              <div class="search-item-title">Search for: ${s.value}</div>
              <div class="search-item-subtitle">Client Type</div>
            </div>`;
          }
          return '';
        }).join('');
      } else {
        html = '<div class="search-empty">No results found</div>';
      }

      $('searchAutocomplete').innerHTML = html;
      $('searchAutocomplete').classList.add('show');

      // Handle clicks on search results
      $$('#searchAutocomplete .search-item').forEach(el => {
        el.addEventListener('click', () => {
          if (el.dataset.id) {
            loadClient(parseInt(el.dataset.id));
            $('searchAutocomplete').classList.remove('show');
            $('searchInput').value = '';
          } else if (el.dataset.type) {
            // Search by type
            $('searchInput').value = el.dataset.type;
            $('searchInput').dispatchEvent(new Event('input'));
          }
        });
      });
    } catch (e) { console.error('Search error:', e); }
  }, 200);
});

document.addEventListener('click', (e) => {
  if (!e.target.closest('.search-box')) $('searchAutocomplete').classList.remove('show');
});

// Store stocks for filtering
const origGenerateShortlist = generateShortlist;
generateShortlist = async function() {
  await origGenerateShortlist();
  allShortlistStocks = [...shortlist];
  if ($('stockCount')) $('stockCount').textContent = shortlist.length;
};

// ============================================================================
// QUICK STATS DASHBOARD
// ============================================================================
async function loadQuickStats() {
  try {
    const response = await fetch(apiUrl('/api/clients/all'), { headers: authHeaders() });
    if (!response.ok) return;
    const data = await response.json();
    const clients = data.clients || [];

    // Calculate total AUM
    const totalAum = clients.reduce((sum, c) => sum + (c.aum_eur || 0), 0);
    const aumFormatted = totalAum >= 1e12 ? (totalAum / 1e12).toFixed(1) + 'T' :
                         totalAum >= 1e9 ? (totalAum / 1e9).toFixed(0) + 'B' :
                         totalAum >= 1e6 ? (totalAum / 1e6).toFixed(0) + 'M' : totalAum.toFixed(0);

    // Active clients (those with calls in last 30 days)
    const activeClients = clients.filter(c => (c.calls_30d || 0) > 0).length;

    // Total calls this month
    const totalCalls = clients.reduce((sum, c) => sum + (c.calls_30d || 0), 0);

    // Animate number updates
    animateValue('statTotalAum', aumFormatted);
    animateValue('statActiveClients', activeClients);
    animateValue('statTotalCalls', totalCalls);

    // Trend calculation (mock for demo)
    const trend = Math.floor(Math.random() * 15) + 5;
    const trendEl = $('statClientsTrend');
    if (trendEl) {
      trendEl.textContent = '+' + trend + '%';
      trendEl.className = 'stat-trend up';
    }
  } catch (e) { console.error('Error loading quick stats:', e); }
}

async function loadMeetingsCount() {
  try {
    const count = Math.floor(Math.random() * 8) + 3;
    animateValue('statUpcomingMeetings', count);
  } catch (e) { console.error('Error loading meetings count:', e); }
}

function animateValue(elementId, finalValue) {
  const el = $(elementId);
  if (!el) return;
  el.classList.add('counter-animate');
  el.textContent = finalValue;
  setTimeout(() => el.classList.remove('counter-animate'), 600);
}

setTimeout(() => { loadQuickStats(); loadMeetingsCount(); }, 300);

// ============================================================================
// KEYBOARD SHORTCUTS PANEL
// ============================================================================
const shortcutsBtn = $('shortcutsBtn');
const shortcutsPanel = $('shortcutsPanel');
const shortcutsClose = $('shortcutsClose');

if (shortcutsBtn) {
  shortcutsBtn.addEventListener('click', () => shortcutsPanel.classList.toggle('show'));
}
if (shortcutsClose) {
  shortcutsClose.addEventListener('click', () => shortcutsPanel.classList.remove('show'));
}

document.addEventListener('click', (e) => {
  if (shortcutsPanel && !e.target.closest('.shortcuts-panel') && !e.target.closest('.shortcuts-btn')) {
    shortcutsPanel.classList.remove('show');
  }
});

// ============================================================================
// QUICK ACTIONS
// ============================================================================
function renderQuickActions(cd) {
  return `
    <div class="quick-actions">
      <button class="action-btn" onclick="handleQuickAction('call')" title="Log Call">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
        <span>Call</span>
      </button>
      <button class="action-btn" onclick="handleQuickAction('email')" title="Send Email">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
        <span>Email</span>
      </button>
      <button class="action-btn" onclick="handleQuickAction('meeting')" title="Schedule Meeting">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        <span>Meeting</span>
      </button>
      <button class="action-btn" onclick="handleQuickAction('note')" title="Add Note">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        <span>Note</span>
      </button>
    </div>
  `;
}

function handleQuickAction(action) {
  if (!clientId) { showToast('Please select a client first', 'warning'); return; }
  const names = { 'call': 'Call logged', 'email': 'Email draft opened', 'meeting': 'Meeting scheduler opened', 'note': 'Note added' };
  showToast(names[action] + ' for ' + (clientData?.client_name || 'client'), 'success');
}

// ============================================================================
// UPCOMING MEETINGS WIDGET
// ============================================================================
async function loadUpcomingMeetings(cid) {
  try {
    const response = await fetch(apiUrl(`/api/client/${cid}/meetings`), { headers: authHeaders() });
    if (!response.ok) return '';
    const data = await response.json();
    const meetings = (data.meetings || []).slice(0, 3);
    if (meetings.length === 0) return '';

    return `
      <div class="meetings-widget">
        <div class="meetings-header"><span class="pulse-dot"></span> Upcoming Meetings</div>
        ${meetings.map(m => {
          const date = new Date(m.meeting_date);
          const dateStr = date.toLocaleDateString('de-DE', { day: '2-digit', month: 'short' });
          return `<div class="meeting-item">
            <div class="meeting-date">${dateStr}</div>
            <div class="meeting-title">${(m.topics_discussed || []).slice(0, 2).join(', ') || 'Client Meeting'}</div>
            <span class="meeting-type">${m.meeting_type || 'meeting'}</span>
          </div>`;
        }).join('')}
      </div>
    `;
  } catch (e) { return ''; }
}

// ============================================================================
// RECENT ACTIVITY FEED
// ============================================================================
async function loadRecentActivity(cid) {
  try {
    const [histResponse, crmResponse] = await Promise.all([
      fetch(apiUrl(`/api/history/${cid}`), { headers: authHeaders() }),
      fetch(apiUrl(`/api/client/${cid}/crm`), { headers: authHeaders() })
    ]);

    const activities = [];
    if (histResponse.ok) {
      const histData = await histResponse.json();
      (histData.call_logs || []).slice(0, 3).forEach(log => {
        activities.push({ type: 'call', text: log.notes || 'Call with client', time: log.call_date, icon: 'call' });
      });
    }
    if (crmResponse.ok) {
      const crmData = await crmResponse.json();
      (crmData.email_activity || []).slice(0, 2).forEach(email => {
        activities.push({ type: 'email', text: `${email.emails_sent} emails sent`, time: email.month, icon: 'email' });
      });
    }
    if (activities.length === 0) return '';

    activities.sort((a, b) => new Date(b.time) - new Date(a.time));

    return `
      <div class="activity-feed">
        <div class="activity-header">Recent Activity</div>
        ${activities.slice(0, 5).map(a => {
          const timeAgo = getTimeAgo(a.time);
          const icons = { 'call': 'C', 'email': 'E', 'meeting': 'M', 'report': 'R' };
          return `<div class="activity-item">
            <div class="activity-icon ${a.icon}">${icons[a.icon] || 'A'}</div>
            <div class="activity-content">
              <div class="activity-text">${truncateText(a.text, 50)}</div>
              <div class="activity-time">${timeAgo}</div>
            </div>
          </div>`;
        }).join('')}
      </div>
    `;
  } catch (e) { return ''; }
}

function getTimeAgo(dateStr) {
  const diffDays = Math.floor((new Date() - new Date(dateStr)) / (1000 * 60 * 60 * 24));
  if (diffDays === 0) return 'Today';
  if (diffDays === 1) return 'Yesterday';
  if (diffDays < 7) return diffDays + ' days ago';
  if (diffDays < 30) return Math.floor(diffDays / 7) + ' weeks ago';
  return Math.floor(diffDays / 30) + ' months ago';
}

function truncateText(text, maxLen) {
  return text && text.length > maxLen ? text.substring(0, maxLen) + '...' : text || '';
}

// ============================================================================
// SKELETON LOADING
// ============================================================================
function showSidebarSkeleton() {
  return `<div style="padding: 20px;">
    <div class="skeleton skeleton-circle" style="margin-bottom: 16px;"></div>
    <div class="skeleton skeleton-text long"></div>
    <div class="skeleton skeleton-text medium"></div>
    <div class="skeleton skeleton-text short"></div>
    <div style="margin-top: 24px;">
      <div class="skeleton skeleton-stat" style="margin-bottom: 12px;"></div>
      <div class="skeleton skeleton-stat" style="margin-bottom: 12px;"></div>
      <div class="skeleton skeleton-stat"></div>
    </div>
  </div>`;
}

// ============================================================================
// MINI SPARKLINES ON STOCK CARDS
// ============================================================================
async function loadMiniSparkline(ticker, containerId) {
  try {
    const container = document.getElementById(containerId);
    if (!container) return;
    const canvas = container.querySelector('canvas');
    if (!canvas) return;

    const data = Array(20).fill(0).map((_, i) => 100 + Math.sin(i / 5) * 5 + (Math.random() - 0.5) * 3 + i * 0.2);
    const ctx = canvas.getContext('2d');
    const width = container.offsetWidth || 150;
    const height = 30;
    canvas.width = width;
    canvas.height = height;

    const min = Math.min(...data), max = Math.max(...data), range = max - min || 1;
    const isUp = data[data.length - 1] > data[0];
    const color = isUp ? '#10b981' : '#ef4444';

    ctx.clearRect(0, 0, width, height);
    ctx.beginPath();
    ctx.strokeStyle = color;
    ctx.lineWidth = 1.5;
    data.forEach((val, i) => {
      const x = (i / (data.length - 1)) * width;
      const y = height - ((val - min) / range) * (height - 4) - 2;
      if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    });
    ctx.stroke();

    const gradient = ctx.createLinearGradient(0, 0, 0, height);
    gradient.addColorStop(0, isUp ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)');
    gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
    ctx.lineTo(width, height);
    ctx.lineTo(0, height);
    ctx.closePath();
    ctx.fillStyle = gradient;
    ctx.fill();
  } catch (e) { console.error('Sparkline error:', e); }
}

// ============================================================================
// ENHANCED SIDEBAR WITH NEW WIDGETS
// ============================================================================
const originalRenderSidebar = renderSidebar;
renderSidebar = async function(data) {
  $('sidebarContent').innerHTML = showSidebarSkeleton();
  originalRenderSidebar(data);

  const clientInfo = document.querySelector('.sidebar-section');
  if (clientInfo && data.client_id) {
    clientInfo.insertAdjacentHTML('beforeend', renderQuickActions(data));
    const meetingsHtml = await loadUpcomingMeetings(data.client_id);
    if (meetingsHtml) clientInfo.insertAdjacentHTML('afterend', meetingsHtml);
    const activityHtml = await loadRecentActivity(data.client_id);
    if (activityHtml) {
      const lastSection = $('sidebarContent').lastElementChild;
      if (lastSection) lastSection.insertAdjacentHTML('afterend', activityHtml);
    }
  }
};

// ============================================================================
// ENHANCED STOCK CARDS WITH SPARKLINES
// ============================================================================
const originalRenderShortlist = renderShortlist;
renderShortlist = function(list, topPicksParam) {
  originalRenderShortlist(list, topPicksParam);
  const cards = $$('.stock-card');
  cards.forEach((card, i) => { card.style.animationDelay = `${i * 0.08}s`; });
  list.forEach((s, i) => {
    const containerId = `sparkline-${s.ticker.replace(/\./g, '-')}`;
    setTimeout(() => loadMiniSparkline(s.ticker, containerId), i * 50);
  });
};

// ============================================================================
// COMMUNICATION PANEL
// ============================================================================
const commPanel = $('commPanel');
const fabContainer = $('fabContainer');
const fabMain = $('fabMain');

// FAB toggle
fabMain?.addEventListener('click', () => fabContainer.classList.toggle('open'));

// Close comm panel
$('commPanelClose')?.addEventListener('click', () => commPanel.classList.remove('open'));

// Open comm panel with specific tab
function openCommPanel(tab = 'email') {
  commPanel.classList.add('open');
  fabContainer.classList.remove('open');

  // Switch to the right tab
  $$('.comm-tab').forEach(t => t.classList.remove('active'));
  $$('.comm-content').forEach(c => c.classList.remove('active'));

  const targetTab = document.querySelector(`.comm-tab[data-comm="${tab}"]`);
  const targetContent = $(`comm-${tab}`);

  if (targetTab) targetTab.classList.add('active');
  if (targetContent) targetContent.classList.add('active');
}

// Comm tab switching
$$('.comm-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    $$('.comm-tab').forEach(t => t.classList.remove('active'));
    $$('.comm-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    $(`comm-${tab.dataset.comm}`).classList.add('active');
  });
});

// Checkbox group selection
document.querySelectorAll('.comm-checkbox-group').forEach(group => {
  group.querySelectorAll('.comm-checkbox').forEach(checkbox => {
    checkbox.addEventListener('click', () => {
      // For single select groups (type groups)
      if (group.id.includes('Type') || group.id.includes('Duration')) {
        group.querySelectorAll('.comm-checkbox').forEach(c => c.classList.remove('selected'));
        checkbox.classList.add('selected');
      } else {
        // For multi-select groups (include groups)
        checkbox.classList.toggle('selected');
      }
    });
  });
});

// ============================================================================
// SMART EMAIL GENERATOR
// ============================================================================
$('generateEmailBtn')?.addEventListener('click', generateSmartEmail);

async function generateSmartEmail() {
  if (!clientId) {
    showNotification('Please select a client first', 'warning');
    return;
  }

  const btn = $('generateEmailBtn');
  btn.disabled = true;
  btn.textContent = 'Generating...';

  try {
    // Get selected options
    const emailType = document.querySelector('#emailTypeGroup .comm-checkbox.selected')?.dataset.type || 'pitch';
    const includeStoryline = document.querySelector('#emailIncludeGroup .comm-checkbox[data-include="storyline"]')?.classList.contains('selected');
    const includeNews = document.querySelector('#emailIncludeGroup .comm-checkbox[data-include="news"]')?.classList.contains('selected');
    const includeFundamentals = document.querySelector('#emailIncludeGroup .comm-checkbox[data-include="fundamentals"]')?.classList.contains('selected');
    const includeRecommendation = document.querySelector('#emailIncludeGroup .comm-checkbox[data-include="recommendation"]')?.classList.contains('selected');
    const additionalNotes = $('emailNotes')?.value || '';

    // Get client data
    const clientData = window._currentClientData || {};
    const clientName = clientData.client?.client_name || 'Valued Client';

    // Get selected stock info
    const stock = selectedTicker && window._shortlist ? window._shortlist.find(s => s.ticker === selectedTicker) : null;
    const stockInfo = stock ? `${stock.company_name} (${stock.ticker})` : 'our recommended investments';

    // Fetch storyline if needed
    let storylineText = '';
    if (includeStoryline && selectedTicker && clientId) {
      try {
        const storyRes = await fetch(apiUrl('/api/story_for_stock'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify({
            client_id: clientId,
            selected_ticker: selectedTicker,
            mode: 'STORY',
            max_words: 150
          })
        });
        const storyData = await storyRes.json();
        storylineText = storyData.story || '';
      } catch (e) { console.error('Failed to fetch storyline:', e); }
    }

    // Fetch news if needed
    let newsText = '';
    if (includeNews && selectedTicker) {
      try {
        const newsRes = await fetch(apiUrl(`/api/stock/${selectedTicker}/news?limit=3`), { headers: authHeaders() });
        const newsData = await newsRes.json();
        if (newsData.news && newsData.news.length > 0) {
          newsText = newsData.news.slice(0, 3).map(n => `â€¢ ${n.title}`).join('\n');
        }
      } catch (e) { console.error('Failed to fetch news:', e); }
    }

    // Generate email based on type
    let emailContent = generateEmailContent(emailType, {
      clientName,
      stockInfo,
      storylineText,
      newsText,
      additionalNotes,
      includeStoryline,
      includeNews,
      includeFundamentals,
      includeRecommendation,
      stock
    });

    // Show preview
    $('emailPreview').textContent = emailContent;
    $('emailPreviewContainer').style.display = 'block';

  } catch (e) {
    console.error('Email generation error:', e);
    showNotification('Failed to generate email', 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Generate Smart Email';
  }
}

function generateEmailContent(type, data) {
  const { clientName, stockInfo, storylineText, newsText, additionalNotes, stock } = data;

  const greeting = `Dear ${clientName},\n\n`;
  const signature = `\n\nBest regards,\nYour ODDO BHF Investment Team`;

  let body = '';

  switch (type) {
    case 'pitch':
      body = `I hope this email finds you well. I wanted to share an investment opportunity that aligns with your portfolio strategy.\n\n`;
      if (stock) {
        body += `**Investment Highlight: ${stock.company_name} (${stock.ticker})**\n\n`;
      }
      if (storylineText) {
        body += `${storylineText}\n\n`;
      }
      if (newsText) {
        body += `**Recent Developments:**\n${newsText}\n\n`;
      }
      if (additionalNotes) {
        body += `${additionalNotes}\n\n`;
      }
      body += `I would be happy to discuss this opportunity at your convenience. Would you have time for a brief call this week?`;
      break;

    case 'followup':
      body = `I wanted to follow up on our recent conversation about ${stockInfo}.\n\n`;
      if (newsText) {
        body += `Since we last spoke, here are some relevant updates:\n${newsText}\n\n`;
      }
      if (additionalNotes) {
        body += `${additionalNotes}\n\n`;
      }
      body += `Please let me know if you have any questions or would like to discuss further.`;
      break;

    case 'news':
      body = `I wanted to bring to your attention some important market developments that may be relevant to your portfolio.\n\n`;
      if (newsText) {
        body += `**Recent News:**\n${newsText}\n\n`;
      }
      if (storylineText) {
        body += `**Our Analysis:**\n${storylineText}\n\n`;
      }
      body += `I'm monitoring these developments closely and will keep you informed of any significant changes.`;
      break;

    case 'meeting':
      body = `I would like to schedule a meeting to discuss your portfolio and explore new investment opportunities.\n\n`;
      if (stock) {
        body += `In particular, I'd like to present ${stock.company_name} (${stock.ticker}) as a potential addition to your holdings.\n\n`;
      }
      if (additionalNotes) {
        body += `${additionalNotes}\n\n`;
      }
      body += `Please let me know your availability for a 30-minute call or meeting at your earliest convenience.`;
      break;
  }

  return greeting + body + signature;
}

// Copy email to clipboard
$('copyEmailBtn')?.addEventListener('click', () => {
  const email = $('emailPreview').textContent;
  navigator.clipboard.writeText(email).then(() => {
    showNotification('Email copied to clipboard!', 'success');
  });
});

// Open in mail client
$('openMailClientBtn')?.addEventListener('click', () => {
  const email = $('emailPreview').textContent;
  const clientData = window._currentClientData || {};
  const clientEmail = clientData.client?.contact_email || '';
  const subject = selectedTicker ? `Investment Opportunity: ${selectedTicker}` : 'Investment Update';

  const mailtoLink = `mailto:${clientEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(email)}`;
  window.open(mailtoLink);
});

// ============================================================================
// MEETING SCHEDULER
// ============================================================================
$('scheduleMeetingBtn')?.addEventListener('click', generateMeetingInvite);

function generateMeetingInvite() {
  if (!clientId) {
    showNotification('Please select a client first', 'warning');
    return;
  }

  const meetingType = document.querySelector('#meetingTypeGroup .comm-checkbox.selected')?.dataset.type || 'video';
  const dateTime = $('meetingDateTime')?.value;
  const duration = parseInt(document.querySelector('#meetingDurationGroup .comm-checkbox.selected')?.dataset.duration || '30');
  const agenda = $('meetingAgenda')?.value || '';

  if (!dateTime) {
    showNotification('Please select a date and time', 'warning');
    return;
  }

  const clientData = window._currentClientData || {};
  const clientName = clientData.client?.client_name || 'Client';

  const meetingPreview = `
MEETING INVITATION

Title: Investment Discussion with ${clientName}
Type: ${meetingType === 'video' ? 'Video Call' : meetingType === 'phone' ? 'Phone Call' : meetingType === 'in_person' ? 'In Person' : 'Business Lunch'}
Date: ${new Date(dateTime).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
Time: ${new Date(dateTime).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
Duration: ${duration} minutes

Agenda:
${agenda || 'Portfolio review and investment discussion'}

${selectedTicker ? `Topics to discuss: ${selectedTicker} investment opportunity` : ''}
  `.trim();

  $('meetingPreview').textContent = meetingPreview;
  $('meetingPreviewContainer').style.display = 'block';
}

// Download ICS file
$('downloadIcsBtn')?.addEventListener('click', () => {
  const dateTime = $('meetingDateTime')?.value;
  const duration = parseInt(document.querySelector('#meetingDurationGroup .comm-checkbox.selected')?.dataset.duration || '30');
  const agenda = $('meetingAgenda')?.value || 'Investment discussion';
  const clientData = window._currentClientData || {};
  const clientName = clientData.client?.client_name || 'Client';

  if (!dateTime) return;

  const start = new Date(dateTime);
  const end = new Date(start.getTime() + duration * 60000);

  const formatDate = (d) => d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';

  const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//ODDO BHF//Sales Intelligence//EN
BEGIN:VEVENT
UID:${Date.now()}@oddoBhf.com
DTSTAMP:${formatDate(new Date())}
DTSTART:${formatDate(start)}
DTEND:${formatDate(end)}
SUMMARY:Investment Discussion with ${clientName}
DESCRIPTION:${agenda}${selectedTicker ? ` - Discussing ${selectedTicker}` : ''}
END:VEVENT
END:VCALENDAR`;

  const blob = new Blob([icsContent], { type: 'text/calendar' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `meeting-${clientName.replace(/\s/g, '-')}.ics`;
  a.click();
  URL.revokeObjectURL(url);

  showNotification('Calendar invite downloaded!', 'success');
});

// ============================================================================
// NOTES SAVING
// ============================================================================
$('saveNoteBtn')?.addEventListener('click', () => {
  const noteType = document.querySelector('#noteTypeGroup .comm-checkbox.selected')?.dataset.type || 'call';
  const noteContent = $('noteContent')?.value || '';

  if (!noteContent.trim()) {
    showNotification('Please enter a note', 'warning');
    return;
  }

  // In a real implementation, this would save to the backend
  showNotification('Note saved to CRM!', 'success');
  $('noteContent').value = '';
});

// ============================================================================
// NOTIFICATION SYSTEM
// ============================================================================
let notificationCount = 0;

function showNotification(message, type = 'info', options = {}) {
  const container = $('notificationContainer');
  const id = `notification-${Date.now()}`;

  const icons = {
    info: '&#128712;',
    success: '&#10003;',
    warning: '&#9888;',
    error: '&#10060;',
    news: '&#128240;'
  };

  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.id = id;
  notification.innerHTML = `
    <div class="notification-icon">${icons[type] || icons.info}</div>
    <div class="notification-content">
      <div class="notification-title">${options.title || (type === 'success' ? 'Success' : type === 'error' ? 'Error' : 'Notice')}</div>
      <div class="notification-text">${message}</div>
      <div class="notification-time">Just now</div>
      ${options.actions ? `
        <div class="notification-actions">
          ${options.actions.map(a => `<button class="notification-action ${a.primary ? 'primary' : 'secondary'}" onclick="${a.onclick}">${a.label}</button>`).join('')}
        </div>
      ` : ''}
    </div>
    <button class="notification-close" onclick="closeNotification('${id}')">&times;</button>
  `;

  container.appendChild(notification);

  // Auto-dismiss after 5 seconds unless it has actions
  if (!options.actions) {
    setTimeout(() => closeNotification(id), 5000);
  }

  return id;
}

function closeNotification(id) {
  const notification = document.getElementById(id);
  if (notification) {
    notification.style.animation = 'fadeOut 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }
}

// ============================================================================
// PERSONALIZATION & ANALYST TOOLS
// ============================================================================

// Update greeting based on time of day
function updateGreeting() {
  const hour = new Date().getHours();
  const greetingEl = document.getElementById('greetingText');
  const subtextEl = document.getElementById('greetingSubtext');

  if (!greetingEl) return;

  let greeting = 'Good Morning';
  if (hour >= 12 && hour < 17) greeting = 'Good Afternoon';
  else if (hour >= 17) greeting = 'Good Evening';

  // Get analyst name from session or default
  const analystName = localStorage.getItem('analystName') || 'Analyst';
  greetingEl.textContent = `${greeting}, ${analystName}`;

  // Update subtext with dynamic data
  const priorityCount = document.querySelectorAll('.priority-indicator.urgent').length;
  const meetings = Math.floor(Math.random() * 3) + 1;
  subtextEl.textContent = `You have ${priorityCount} high-priority alerts and ${meetings} client meetings today.`;
}

// Initialize greeting on page load
document.addEventListener('DOMContentLoaded', function() {
  updateGreeting();
  updateMarketTime();

  // Update market time every minute
  setInterval(updateMarketTime, 60000);
});

function updateMarketTime() {
  const el = document.getElementById('lastMarketUpdate');
  if (el) {
    const now = new Date();
    el.textContent = now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) + ' CET';
  }
}

function showTodaysBriefing() {
  // Switch to dashboard and generate briefing
  switchTab('dashboard');
  showNotification('Generating your personalized morning briefing...', 'info');

  setTimeout(() => {
    generateMorningBriefing();
    showNotification('Morning briefing ready', 'success');
  }, 1500);
}

function showPriorityAlerts() {
  showNotification('Loading priority alerts...', 'info');

  // Scroll to monitoring center if on dashboard
  const monitoringCenter = document.querySelector('.monitoring-center');
  if (monitoringCenter) {
    monitoringCenter.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  // Highlight critical alerts
  document.querySelectorAll('.alert-item.critical').forEach(item => {
    item.style.animation = 'pulse-glow 1s ease-in-out 3';
  });
}

function showCalendar() {
  showNotification('Calendar integration coming soon', 'info', {
    title: 'Calendar',
    actions: [
      { label: 'Open Outlook', onclick: "window.open('https://outlook.office.com/calendar', '_blank')", primary: true }
    ]
  });
}

// Client Tier Calculator
function calculateClientTier(aum) {
  if (aum >= 50000000) return 'platinum';
  if (aum >= 10000000) return 'gold';
  if (aum >= 1000000) return 'silver';
  return 'standard';
}

// Personalized Stock Match Score
function calculateMatchScore(stock, clientProfile) {
  let score = 50; // Base score

  if (!clientProfile) return score;

  // Risk tolerance match
  const stockRisk = stock.risk_level || 'medium';
  const clientRisk = clientProfile.risk_tolerance || 'medium';
  if (stockRisk === clientRisk) score += 20;
  else if (
    (stockRisk === 'low' && clientRisk === 'medium') ||
    (stockRisk === 'medium' && clientRisk === 'high')
  ) score += 10;

  // Sector preference match
  if (clientProfile.preferred_sectors && clientProfile.preferred_sectors.includes(stock.sector)) {
    score += 15;
  }

  // Dividend preference
  if (clientProfile.prefers_dividends && stock.dividend_yield > 2) {
    score += 10;
  }

  // ESG preference
  if (clientProfile.esg_focus && stock.esg_rating === 'A') {
    score += 10;
  }

  return Math.min(score, 99);
}

// Generate match reasons
function getMatchReasons(stock, clientProfile) {
  const reasons = [];

  if (!clientProfile) return ['General recommendation'];

  if (stock.sector && clientProfile.preferred_sectors?.includes(stock.sector)) {
    reasons.push({ icon: 'â—‰', text: 'Sector match' });
  }

  if (stock.risk_level === clientProfile.risk_tolerance) {
    reasons.push({ icon: 'â—Ž', text: 'Risk aligned' });
  }

  if (stock.dividend_yield > 2 && clientProfile.prefers_dividends) {
    reasons.push({ icon: 'â‚¬', text: 'Dividend yield' });
  }

  if (stock.esg_rating === 'A' && clientProfile.esg_focus) {
    reasons.push({ icon: 'â—', text: 'ESG leader' });
  }

  // ODDO Research match
  if (ODDO_RESEARCH && ODDO_RESEARCH[stock.ticker]) {
    const research = ODDO_RESEARCH[stock.ticker];
    if (research.rating === 'Outperform') {
      reasons.push({ icon: 'â–²', text: 'ODDO Outperform' });
    }
  }

  return reasons.length > 0 ? reasons : [{ icon: 'â—‰', text: 'General fit' }];
}

// Analyst Performance Tracker
const analystPerformance = {
  recommendations: [],

  addRecommendation: function(ticker, action, targetPrice, date) {
    this.recommendations.push({
      ticker,
      action, // 'buy', 'sell', 'hold'
      targetPrice,
      date: date || new Date(),
      status: 'active'
    });
    this.saveToStorage();
  },

  updateStatus: function(ticker, currentPrice) {
    const rec = this.recommendations.find(r => r.ticker === ticker && r.status === 'active');
    if (!rec) return;

    if (rec.action === 'buy' && currentPrice >= rec.targetPrice) {
      rec.status = 'hit';
      rec.hitDate = new Date();
    } else if (rec.action === 'sell' && currentPrice <= rec.targetPrice) {
      rec.status = 'hit';
      rec.hitDate = new Date();
    }

    this.saveToStorage();
  },

  getHitRate: function() {
    const completed = this.recommendations.filter(r => r.status !== 'active');
    if (completed.length === 0) return 0;
    const hits = completed.filter(r => r.status === 'hit').length;
    return Math.round((hits / completed.length) * 100);
  },

  saveToStorage: function() {
    localStorage.setItem('analystRecommendations', JSON.stringify(this.recommendations));
  },

  loadFromStorage: function() {
    const saved = localStorage.getItem('analystRecommendations');
    if (saved) {
      this.recommendations = JSON.parse(saved);
    }
  }
};

// Load analyst performance on startup
document.addEventListener('DOMContentLoaded', function() {
  analystPerformance.loadFromStorage();
});

// Quick Actions
function addQuickNote(clientId) {
  const note = prompt('Enter quick note for this client:');
  if (note) {
    showNotification(`Note saved for client`, 'success');
    // In real implementation, this would save to the backend
  }
}

function scheduleFollowUp(clientId) {
  showNotification('Follow-up scheduling...', 'info', {
    title: 'Schedule Follow-up',
    actions: [
      { label: 'Tomorrow', onclick: `scheduleFollowUpDate('${clientId}', 1)`, primary: false },
      { label: 'Next Week', onclick: `scheduleFollowUpDate('${clientId}', 7)`, primary: true }
    ]
  });
}

function scheduleFollowUpDate(clientId, daysFromNow) {
  const date = new Date();
  date.setDate(date.getDate() + daysFromNow);
  showNotification(`Follow-up scheduled for ${date.toLocaleDateString()}`, 'success');
}

// ============================================================================
// NEWS ALERTS SYSTEM
// ============================================================================
let watchedTickers = [];
let lastNewsCheck = {};

function checkNewsAlerts() {
  if (!window._shortlist || window._shortlist.length === 0) {
    showNotification('Generate a shortlist first to monitor news alerts', 'info');
    return;
  }

  // Check news for all tickers in shortlist
  const tickers = window._shortlist.map(s => s.ticker);
  let alertCount = 0;

  tickers.forEach(async (ticker) => {
    try {
      const res = await fetch(apiUrl(`/api/stock/${ticker}/news?limit=3`), { headers: authHeaders() });
      const data = await res.json();

      if (data.news && data.news.length > 0) {
        const latestNews = data.news[0];
        const lastCheck = lastNewsCheck[ticker];

        // Check if this is new news
        if (!lastCheck || latestNews.title !== lastCheck) {
          lastNewsCheck[ticker] = latestNews.title;

          // Show notification for important news
          if (latestNews.sentiment === 'positive' || latestNews.sentiment === 'negative') {
            alertCount++;
            showNotification(
              `${latestNews.title}`,
              latestNews.sentiment === 'positive' ? 'success' : 'warning',
              {
                title: `${ticker} News Alert`,
                actions: [
                  { label: 'View Details', primary: true, onclick: `openStockByTicker('${ticker}')` },
                  { label: 'Dismiss', onclick: `closeNotification(this.closest('.notification').id)` }
                ]
              }
            );
          }
        }
      }
    } catch (e) { console.error(`News check failed for ${ticker}:`, e); }
  });

  // Update badge
  const badge = $('newsAlertBadge');
  if (badge) {
    if (alertCount > 0) {
      badge.textContent = alertCount;
      badge.style.display = 'block';
    } else {
      badge.style.display = 'none';
      showNotification('No new alerts at this time', 'info');
    }
  }
}

function openStockByTicker(ticker) {
  const stock = window._shortlist?.find(s => s.ticker === ticker);
  if (stock) {
    openStockDetailModal(stock);
  }
}

// Auto-check news every 5 minutes when shortlist is loaded
setInterval(() => {
  if (window._shortlist && window._shortlist.length > 0) {
    checkNewsAlerts();
  }
}, 300000); // 5 minutes

// Store current client data for email generation
window._currentClientData = null;
const originalLoadClient = loadClient;
loadClient = async function(id) {
  const result = await originalLoadClient(id);
  // Fetch and store client data
  try {
    const res = await fetch(apiUrl(`/api/client/${id}`), { headers: authHeaders() });
    window._currentClientData = await res.json();
    // Update similar clients when client is loaded
    loadSimilarClients(id);
  } catch (e) { console.error('Failed to store client data:', e); }
  return result;
};

// ============================================================================
// DASHBOARD FUNCTIONS
// ============================================================================

// Initialize dashboard on load
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    loadSectorHeatmap();
    loadEarningsCalendar();
    loadActionItems();
    loadClientPipeline();
    loadLeaderboard();
  }, 500);
});

// Sector Heatmap
async function loadSectorHeatmap() {
  const container = $('sectorHeatmap');
  if (!container) return;

  // Simulated sector performance data (in production, fetch from API)
  const sectors = [
    { name: 'Technology', change: 2.4 },
    { name: 'Healthcare', change: 1.1 },
    { name: 'Financials', change: -0.8 },
    { name: 'Energy', change: -2.1 },
    { name: 'Consumer', change: 0.5 },
    { name: 'Industrial', change: 1.7 },
    { name: 'Materials', change: -0.3 },
    { name: 'Utilities', change: 0.2 },
  ];

  container.innerHTML = sectors.map(s => {
    const cls = s.change > 0.5 ? 'positive' : s.change < -0.5 ? 'negative' : 'neutral';
    const sign = s.change >= 0 ? '+' : '';
    return `
      <div class="heatmap-cell ${cls}" onclick="filterBySector('${s.name}')">
        <div class="heatmap-sector">${s.name}</div>
        <div class="heatmap-value">${sign}${s.change.toFixed(1)}%</div>
      </div>
    `;
  }).join('');
}

function refreshHeatmap() {
  loadSectorHeatmap();
  showNotification('Heatmap refreshed', 'success');
}

function filterBySector(sector) {
  // Switch to shortlist tab and filter
  switchTab('shortlist');
  const sectorFilter = $('filterSector');
  if (sectorFilter) {
    sectorFilter.value = sector;
    sectorFilter.dispatchEvent(new Event('change'));
  }
}

// Earnings Calendar
async function loadEarningsCalendar() {
  const container = $('earningsCalendar');
  if (!container) return;

  // Simulated earnings data (in production, fetch from API or use yfinance)
  const earnings = [
    { ticker: 'AAPL', company: 'Apple Inc.', date: '2026-01-28', estimate: '$2.35', actual: null },
    { ticker: 'MSFT', company: 'Microsoft Corp.', date: '2026-01-29', estimate: '$3.12', actual: null },
    { ticker: 'GOOGL', company: 'Alphabet Inc.', date: '2026-01-30', estimate: '$1.89', actual: null },
    { ticker: 'AMZN', company: 'Amazon.com', date: '2026-01-30', estimate: '$1.45', actual: null },
    { ticker: 'TSLA', company: 'Tesla Inc.', date: '2026-01-31', estimate: '$0.78', actual: null },
  ];

  container.innerHTML = earnings.map(e => {
    const date = new Date(e.date);
    const day = date.getDate();
    const month = date.toLocaleString('en-US', { month: 'short' });

    return `
      <div class="earnings-item" onclick="openStockByTicker('${e.ticker}')">
        <div class="earnings-date">
          <div class="earnings-date-day">${day}</div>
          <div class="earnings-date-month">${month}</div>
        </div>
        <div class="earnings-info">
          <div class="earnings-ticker">
            ${e.ticker}
            ${e.actual ? `<span class="earnings-surprise ${parseFloat(e.actual) > parseFloat(e.estimate) ? 'beat' : 'miss'}">${parseFloat(e.actual) > parseFloat(e.estimate) ? 'BEAT' : 'MISS'}</span>` : ''}
          </div>
          <div class="earnings-company">${e.company}</div>
        </div>
        <div class="earnings-estimate">
          <div class="earnings-estimate-label">Est. EPS</div>
          <div class="earnings-estimate-value">${e.estimate}</div>
        </div>
      </div>
    `;
  }).join('');
}

// Morning Briefing Generator
async function generateMorningBriefing() {
  const container = $('morningBriefing');
  if (!container) return;

  container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p style="margin-top: 12px;">Generating your briefing...</p></div>';

  // Simulate API call delay
  await new Promise(r => setTimeout(r, 1500));

  const today = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

  container.innerHTML = `
    <div class="briefing-section">
      <div class="briefing-section-title">â–£ ${today}</div>
      <div class="briefing-highlight">
        <strong>Key Focus Today:</strong> Big Tech earnings week continues. Monitor AAPL, MSFT positions across client portfolios. Fed rate decision Wednesday - prepare client talking points.
      </div>
    </div>

    <div class="briefing-section">
      <div class="briefing-section-title">â–² Market Overview</div>
      <p>US futures pointing higher (+0.3%) ahead of earnings. European markets mixed with DAX +0.2%, FTSE -0.1%. Asian markets closed mostly green with Nikkei +1.2%.</p>
      <p style="margin-top: 10px;"><strong>Key Movers:</strong> Tech sector leading (+1.4%), Energy lagging (-0.8%) on oil inventory data.</p>
    </div>

    <div class="briefing-section">
      <div class="briefing-section-title">â‚¬ Client Portfolio Alerts</div>
      <ul style="margin: 0; padding-left: 20px;">
        <li><strong>3 clients</strong> have >15% exposure to AAPL - prepare earnings commentary</li>
        <li><strong>Hans MÃ¼ller</strong> - TSLA position down 8% this week, consider outreach</li>
        <li><strong>5 clients</strong> approaching quarterly review date</li>
      </ul>
    </div>

    <div class="briefing-section">
      <div class="briefing-section-title">â—Ž Today's Priorities</div>
      <ol style="margin: 0; padding-left: 20px;">
        <li>Review AAPL earnings preview for affected clients</li>
        <li>Prepare Fed meeting talking points</li>
        <li>Follow up with inactive clients (7 no contact >2 weeks)</li>
        <li>Complete quarterly reviews for 3 clients</li>
      </ol>
    </div>
  `;

  showNotification('Morning briefing generated!', 'success');
}

function sendBriefingEmail() {
  showNotification('Briefing sent to 12 clients', 'success');
}

// Action Items
function loadActionItems() {
  const container = $('actionItems');
  if (!container) return;

  const actions = [
    { title: 'Call Hans MÃ¼ller - TSLA concerns', client: 'Hans MÃ¼ller', due: 'Today', priority: 'high', urgent: true },
    { title: 'Quarterly review preparation', client: 'Multiple', due: 'Tomorrow', priority: 'high', urgent: true },
    { title: 'Send AAPL earnings preview', client: '3 clients', due: 'Today', priority: 'high', urgent: true },
    { title: 'Follow up on NVO recommendation', client: 'Sophie Laurent', due: 'This week', priority: 'medium', urgent: false },
    { title: 'Update ESG compliance docs', client: 'Admin', due: 'Friday', priority: 'low', urgent: false },
  ];

  container.innerHTML = actions.map((a, i) => `
    <div class="action-item ${a.urgent ? 'urgent' : a.priority === 'medium' ? 'warning' : ''}">
      <div class="action-checkbox" onclick="toggleActionDone(this)" data-idx="${i}"></div>
      <div class="action-content">
        <div class="action-title">${a.title}</div>
        <div class="action-meta">
          <span>${a.client}</span>
          <span>Due: ${a.due}</span>
          <span class="action-priority ${a.priority}">${a.priority}</span>
        </div>
      </div>
    </div>
  `).join('');
}

function toggleActionDone(el) {
  el.classList.toggle('done');
  if (el.classList.contains('done')) {
    el.innerHTML = '&#10003;';
    showNotification('Task completed!', 'success');
  } else {
    el.innerHTML = '';
  }
}

// Client Pipeline
function loadClientPipeline() {
  const container = $('clientPipeline');
  if (!container) return;

  const stages = [
    { name: 'New Leads', clients: [
      { name: 'Tech Ventures AG', info: 'AUM: â‚¬50M' },
      { name: 'Alpine Investments', info: 'AUM: â‚¬120M' },
    ]},
    { name: 'Contacted', clients: [
      { name: 'Nordic Capital', info: 'Meeting scheduled' },
      { name: 'Swiss Family Office', info: 'Sent proposal' },
      { name: 'Munich Wealth', info: 'Follow-up needed' },
    ]},
    { name: 'Proposal Sent', clients: [
      { name: 'Berlin Asset Mgmt', info: 'Waiting response' },
    ]},
    { name: 'Negotiation', clients: [
      { name: 'Hamburg Investments', info: 'Final terms' },
      { name: 'Frankfurt Capital', info: 'Legal review' },
    ]},
    { name: 'Won', clients: [
      { name: 'Vienna Partners', info: 'Onboarding' },
    ]},
  ];

  container.innerHTML = stages.map(stage => `
    <div class="pipeline-stage">
      <div class="pipeline-stage-header">
        <span class="pipeline-stage-title">${stage.name}</span>
        <span class="pipeline-stage-count">${stage.clients.length}</span>
      </div>
      <div class="pipeline-clients">
        ${stage.clients.map(c => `
          <div class="pipeline-client">
            <div class="pipeline-client-name">${c.name}</div>
            <div class="pipeline-client-info">${c.info}</div>
          </div>
        `).join('')}
      </div>
    </div>
  `).join('');
}

// Similar Clients
async function loadSimilarClients(clientId) {
  const container = $('similarClients');
  if (!container || !clientId) return;

  // Simulated similar clients (in production, use ML clustering)
  const similar = [
    { name: 'Heinrich Weber', score: 94, reason: 'Same sector focus, similar AUM' },
    { name: 'Marie Dubois', score: 89, reason: 'Similar risk appetite, ESG mandate' },
    { name: 'Thomas Andersson', score: 85, reason: 'Growth-focused, tech exposure' },
    { name: 'Anna Kowalski', score: 78, reason: 'Similar trading patterns' },
  ];

  container.innerHTML = similar.map(c => `
    <div class="similar-client" onclick="searchAndSelectClient('${c.name}')">
      <div class="similar-avatar">${c.name.split(' ').map(n => n[0]).join('')}</div>
      <div class="similar-info">
        <div class="similar-name">${c.name}</div>
        <div class="similar-reason">${c.reason}</div>
      </div>
      <div class="similar-score">${c.score}%</div>
    </div>
  `).join('');
}

function searchAndSelectClient(name) {
  const searchInput = $('searchInput');
  if (searchInput) {
    searchInput.value = name;
    searchInput.dispatchEvent(new Event('input'));
  }
}

// Leaderboard
function loadLeaderboard() {
  const container = $('leaderboard');
  if (!container) return;

  const leaders = [
    { name: 'You', deals: 12, revenue: 'â‚¬240K', score: 94 },
    { name: 'Maria Schmidt', deals: 11, revenue: 'â‚¬210K', score: 89 },
    { name: 'Thomas MÃ¼ller', deals: 9, revenue: 'â‚¬185K', score: 82 },
    { name: 'Sophie Laurent', deals: 8, revenue: 'â‚¬160K', score: 76 },
    { name: 'Hans Weber', deals: 7, revenue: 'â‚¬140K', score: 71 },
  ];

  container.innerHTML = leaders.map((l, i) => `
    <div class="leaderboard-item">
      <div class="leaderboard-rank">${i + 1}</div>
      <div class="leaderboard-info">
        <div class="leaderboard-name">${l.name}${i === 0 ? ' â­' : ''}</div>
        <div class="leaderboard-stats">${l.deals} deals Â· ${l.revenue}</div>
      </div>
      <div class="leaderboard-score">${l.score}</div>
    </div>
  `).join('');
}

// Stock Comparison
async function compareStocks() {
  const t1 = $('compareStock1')?.value.toUpperCase();
  const t2 = $('compareStock2')?.value.toUpperCase();
  const t3 = $('compareStock3')?.value.toUpperCase();

  const tickers = [t1, t2, t3].filter(t => t);
  if (tickers.length < 2) {
    showNotification('Enter at least 2 tickers to compare', 'warning');
    return;
  }

  const container = $('stockComparison');
  container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div></div>';

  try {
    // Fetch data for each ticker
    const stockData = await Promise.all(tickers.map(async ticker => {
      const [quoteRes, fundRes] = await Promise.all([
        fetch(apiUrl(`/api/stock/${ticker}/quote`), { headers: authHeaders() }),
        fetch(apiUrl(`/api/stock/${ticker}/fundamentals`), { headers: authHeaders() }).catch(() => null)
      ]);

      const quote = quoteRes.ok ? await quoteRes.json() : {};
      const fund = fundRes?.ok ? await fundRes.json() : {};

      return { ticker, quote, fund };
    }));

    // Render comparison table
    const metrics = [
      { label: 'Price', key: 'price', format: v => v ? `$${Number(v).toFixed(2)}` : '-' },
      { label: 'Change %', key: 'change_percent', format: v => v ? `${v >= 0 ? '+' : ''}${Number(v).toFixed(2)}%` : '-' },
      { label: 'Market Cap', key: 'market_cap', format: v => v ? formatLargeNumber(v) : '-' },
      { label: 'P/E Ratio', key: 'pe', format: v => v ? `${Number(v).toFixed(1)}x` : '-' },
      { label: 'Div Yield', key: 'div_yield', format: v => v ? `${Number(v).toFixed(2)}%` : '-' },
      { label: '52W High', key: 'fifty_two_week_high', format: v => v ? `$${Number(v).toFixed(2)}` : '-' },
      { label: '52W Low', key: 'fifty_two_week_low', format: v => v ? `$${Number(v).toFixed(2)}` : '-' },
    ];

    const getValue = (stock, key) => {
      if (key === 'pe') return stock.fund?.valuation?.pe_trailing;
      if (key === 'div_yield') return stock.fund?.dividends?.dividend_yield;
      return stock.quote?.[key];
    };

    container.innerHTML = `
      <div class="comparison-header">
        <div></div>
        ${stockData.map(s => `
          <div class="comparison-ticker">
            <div class="comparison-ticker-symbol">${s.ticker}</div>
            <div class="comparison-ticker-name">${s.quote?.name || ''}</div>
          </div>
        `).join('')}
      </div>
      ${metrics.map(m => {
        const values = stockData.map(s => getValue(s, m.key));
        const numericValues = values.filter(v => v != null && !isNaN(v));
        const bestIdx = m.key === 'change_percent' || m.key === 'div_yield'
          ? values.indexOf(Math.max(...numericValues))
          : -1;

        return `
          <div class="comparison-row">
            <div class="comparison-label">${m.label}</div>
            ${stockData.map((s, i) => `
              <div class="comparison-value ${i === bestIdx ? 'best' : ''}">${m.format(getValue(s, m.key))}</div>
            `).join('')}
          </div>
        `;
      }).join('')}
    `;
  } catch (e) {
    container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 40px;">Failed to load comparison data</div>';
  }
}

function formatLargeNumber(num) {
  if (num >= 1e12) return `$${(num / 1e12).toFixed(1)}T`;
  if (num >= 1e9) return `$${(num / 1e9).toFixed(1)}B`;
  if (num >= 1e6) return `$${(num / 1e6).toFixed(1)}M`;
  return `$${num.toLocaleString()}`;
}

// Technical Indicators
async function loadTechnicalIndicators(ticker) {
  const container = $('technicalIndicators');
  if (!container || !ticker) return;

  container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div></div>';

  // Simulated technical data (in production, calculate from price history)
  await new Promise(r => setTimeout(r, 500));

  const rsi = Math.floor(Math.random() * 40) + 30; // 30-70
  const macd = (Math.random() * 4 - 2).toFixed(2);
  const ma50 = (Math.random() * 20 - 10).toFixed(1);

  const rsiSignal = rsi > 70 ? 'sell' : rsi < 30 ? 'buy' : 'neutral';
  const macdSignal = parseFloat(macd) > 0 ? 'buy' : parseFloat(macd) < 0 ? 'sell' : 'neutral';
  const maSignal = parseFloat(ma50) > 0 ? 'buy' : 'sell';

  container.innerHTML = `
    <div style="text-align: center; margin-bottom: 16px; font-weight: 600;">${ticker} Technical Analysis</div>
    <div class="indicator-grid">
      <div class="indicator-card">
        <div class="indicator-label">RSI (14)</div>
        <div class="indicator-value">${rsi}</div>
        <span class="indicator-signal ${rsiSignal}">${rsiSignal === 'buy' ? 'Oversold' : rsiSignal === 'sell' ? 'Overbought' : 'Neutral'}</span>
      </div>
      <div class="indicator-card">
        <div class="indicator-label">MACD</div>
        <div class="indicator-value">${macd}</div>
        <span class="indicator-signal ${macdSignal}">${macdSignal === 'buy' ? 'Bullish' : macdSignal === 'sell' ? 'Bearish' : 'Neutral'}</span>
      </div>
      <div class="indicator-card">
        <div class="indicator-label">vs MA(50)</div>
        <div class="indicator-value">${ma50}%</div>
        <span class="indicator-signal ${maSignal}">${maSignal === 'buy' ? 'Above' : 'Below'}</span>
      </div>
    </div>
    <div style="margin-top: 20px; padding: 16px; background: var(--soft-greige); border-radius: 10px;">
      <div style="font-weight: 600; margin-bottom: 8px;">Summary</div>
      <p style="font-size: 13px; color: var(--text-muted); margin: 0;">
        ${rsiSignal === 'buy' || macdSignal === 'buy' ?
          `Technical indicators suggest potential buying opportunity for ${ticker}. RSI indicates ${rsiSignal === 'buy' ? 'oversold conditions' : 'neutral momentum'}, while MACD shows ${macdSignal === 'buy' ? 'bullish crossover' : 'bearish pressure'}.` :
          `Technical indicators suggest caution for ${ticker}. Monitor for potential entry points as momentum stabilizes.`
        }
      </p>
    </div>
  `;
}

// Update technical indicators when stock is selected
const originalSelectStock = selectStock;
selectStock = function(idx) {
  originalSelectStock(idx);
  if (window._shortlist && window._shortlist[idx]) {
    loadTechnicalIndicators(window._shortlist[idx].ticker);
  }
};

// AI Market Insights
async function generateAIInsights() {
  const container = $('aiInsights');
  if (!container) return;

  container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p style="margin-top: 12px;">Analyzing market conditions...</p></div>';

  await new Promise(r => setTimeout(r, 2000));

  container.innerHTML = `
    <div style="border-left: 3px solid var(--primary); padding-left: 16px; margin-bottom: 20px;">
      <div style="font-weight: 700; margin-bottom: 8px;">ðŸŽ¯ Key Insight</div>
      <p style="margin: 0; font-size: 14px;">Tech sector showing strong momentum ahead of earnings. Consider increasing exposure for growth-oriented clients while maintaining hedges for conservative portfolios.</p>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
      <div style="background: #dcfce7; padding: 16px; border-radius: 10px;">
        <div style="font-weight: 600; color: #16a34a; margin-bottom: 8px;">Opportunities</div>
        <ul style="margin: 0; padding-left: 18px; font-size: 13px; color: #166534;">
          <li>AI/Semiconductor plays before NVDA earnings</li>
          <li>Healthcare sector showing relative strength</li>
          <li>European value stocks at attractive multiples</li>
        </ul>
      </div>
      <div style="background: #fef2f2; padding: 16px; border-radius: 10px;">
        <div style="font-weight: 600; color: #dc2626; margin-bottom: 8px;">Risks</div>
        <ul style="margin: 0; padding-left: 18px; font-size: 13px; color: #991b1b;">
          <li>Fed policy uncertainty - rate volatility</li>
          <li>China tech regulatory concerns</li>
          <li>Energy sector facing headwinds</li>
        </ul>
      </div>
    </div>

    <div style="margin-top: 20px; padding: 16px; background: var(--soft-greige); border-radius: 10px;">
      <div style="font-weight: 600; margin-bottom: 8px;"><svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg> Sector Rotation Signal</div>
      <p style="margin: 0; font-size: 13px; color: var(--text-muted);">
        Current rotation favors <strong>Technology</strong> and <strong>Healthcare</strong> over <strong>Energy</strong> and <strong>Utilities</strong>.
        Recommend tactical overweight in quality growth names for Q1.
      </p>
    </div>
  `;

  showNotification('AI insights generated!', 'success');
}

// ============================================================================
// COLLABORATION FEATURES
// ============================================================================

function handleChatKeypress(event) {
  if (event.key === 'Enter') {
    sendChatMessage();
  }
}

function sendChatMessage() {
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  if (!message) return;

  const container = document.getElementById('teamChatContainer');
  const now = new Date();
  const time = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');

  container.innerHTML += `
    <div class="chat-message outgoing animate-in">
      <div class="chat-content">
        <div class="chat-meta">
          <span class="chat-sender">You</span>
          <span class="chat-time">${time}</span>
        </div>
        <div class="chat-text">${escapeHtml(message)}</div>
      </div>
    </div>
  `;

  input.value = '';
  container.scrollTop = container.scrollHeight;
  showNotification('Message sent', 'success');
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function startVideoCall() {
  showNotification('Starting video call...', 'info');
  setTimeout(() => {
    showNotification('Video call feature coming soon!', 'info');
  }, 1000);
}

function startScreenShare() {
  showNotification('Screen share initiated', 'info');
}

function createWatchlist() {
  const name = prompt('Enter watchlist name:');
  if (!name) return;

  const container = document.getElementById('sharedWatchlists');
  container.innerHTML += `
    <div class="watchlist-card animate-in" onclick="openWatchlist('new-${Date.now()}')">
      <div class="watchlist-header">
        <span class="watchlist-icon"></span>
        <div class="watchlist-info">
          <h4>${escapeHtml(name)}</h4>
          <span class="watchlist-meta">0 stocks â€¢ Created just now</span>
        </div>
      </div>
      <div class="watchlist-members">
        <div class="member-avatar">You</div>
      </div>
      <div class="watchlist-performance">
        <span class="perf-value">--</span>
        <span class="perf-label">No data yet</span>
      </div>
    </div>
  `;
  showNotification(`Watchlist "${name}" created!`, 'success');
}

function openWatchlist(id) {
  showNotification(`Opening watchlist: ${id}`, 'info');
}

function initiateHandoff() {
  showNotification('Client handoff wizard opening...', 'info');
}

function viewHandoffDetails(clientId) {
  showNotification(`Viewing handoff details for ${clientId}`, 'info');
}

function addHandoffNote(clientId) {
  const note = prompt('Add note for handoff:');
  if (note) {
    showNotification('Note added to handoff', 'success');
  }
}

// ============================================================================
// REPORTS & EXPORT FEATURES
// ============================================================================

function selectReportType(el, type) {
  document.querySelectorAll('.report-type').forEach(t => t.classList.remove('selected'));
  el.classList.add('selected');
  showNotification(`${type.toUpperCase()} format selected`, 'info');
}

function refreshPreview() {
  const preview = document.getElementById('reportPreview');
  preview.style.opacity = '0.5';
  setTimeout(() => {
    preview.style.opacity = '1';
    showNotification('Preview updated', 'success');
  }, 500);
}

function generateReport() {
  const template = document.getElementById('reportTemplate').value;
  const dateRange = document.getElementById('reportDateRange').value;
  const selectedType = document.querySelector('.report-type.selected');
  const format = selectedType ? selectedType.querySelector('.type-icon').textContent.toLowerCase() : 'pdf';

  showNotification('Generating report...', 'info');

  setTimeout(() => {
    // Add to recent reports
    const list = document.getElementById('recentReportsList');
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

    list.insertAdjacentHTML('afterbegin', `
      <div class="report-item animate-in" onclick="openReport('report-${Date.now()}')">
        <div class="report-type-badge ${format}">${format.toUpperCase()}</div>
        <div class="report-info">
          <h4>${template.charAt(0).toUpperCase() + template.slice(1)} Report - ${clientData?.profile?.name || 'Client'}</h4>
          <span class="report-meta">Generated ${dateStr} â€¢ Just now</span>
        </div>
        <div class="report-actions">
          <button class="btn-icon" title="Download">â†“</button>
          <button class="btn-icon" title="Share">â†—</button>
        </div>
      </div>
    `);

    showNotification('Report generated successfully!', 'success');
  }, 2000);
}

function scheduleReport() {
  showNotification('Report scheduling panel opening...', 'info');
}

function openReport(reportId) {
  showNotification(`Opening report: ${reportId}`, 'info');
}

// ============================================================================
// QUICK COMPARISON FUNCTIONS
// ============================================================================

const COMPARISON_PRESETS = {
  'top-picks': ['AAPL', 'MSFT', 'NVDA'],
  'european-luxury': ['MC.PA', 'RMS.PA', 'KER.PA'],
  'german-tech': ['SAP.DE', 'SIE.DE', 'IFX.DE'],
  'banks': ['BNP.PA', 'GLE.PA', 'DBK.DE']
};

function quickCompare(preset) {
  const tickers = COMPARISON_PRESETS[preset];
  if (!tickers) return;

  document.getElementById('compareStock1').value = tickers[0] || '';
  document.getElementById('compareStock2').value = tickers[1] || '';
  document.getElementById('compareStock3').value = tickers[2] || '';

  compareStocks();
  showNotification(`Comparing: ${tickers.join(' vs ')}`, 'info');
}

function compareFromShortlist() {
  if (!window._shortlist || window._shortlist.length < 2) {
    showNotification('Need at least 2 stocks in shortlist to compare', 'warning');
    return;
  }

  const top3 = window._shortlist.slice(0, 3).map(s => s.ticker);
  document.getElementById('compareStock1').value = top3[0] || '';
  document.getElementById('compareStock2').value = top3[1] || '';
  document.getElementById('compareStock3').value = top3[2] || '';

  compareStocks();
  showNotification(`Comparing top shortlist picks`, 'success');
}

function exportComparison() {
  showNotification('Preparing comparison export...', 'info');
  setTimeout(() => {
    const blob = new Blob([document.getElementById('stockComparison').innerText], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'stock-comparison.txt';
    a.click();
    URL.revokeObjectURL(url);
    showNotification('Comparison exported', 'success');
  }, 500);
}

function addToStory() {
  const comparison = document.getElementById('stockComparison').innerText;
  if (!comparison || comparison.includes('Select a quick comparison')) {
    showNotification('Generate a comparison first', 'warning');
    return;
  }
  // Store for story use
  window._comparisonData = comparison;
  switchTab('story');
  showNotification('Comparison data ready - generate your story', 'success');
}

// ============================================================================
// STORY REFINEMENT FUNCTIONS
// ============================================================================

let storyHistory = [];

function toggleEditMode() {
  const outputText = document.getElementById('outputText');
  const isEditable = outputText.contentEditable === 'true';

  outputText.contentEditable = !isEditable;
  outputText.style.border = isEditable ? 'none' : '2px dashed var(--primary)';
  outputText.style.padding = isEditable ? '0' : '12px';
  outputText.style.background = isEditable ? 'transparent' : 'rgba(0,61,57,0.02)';

  showNotification(isEditable ? 'Edit mode disabled' : 'Edit mode enabled - click text to edit', 'info');
}

function refineStory(type) {
  const currentStory = document.getElementById('outputText').innerText;
  if (!currentStory) {
    showNotification('Generate a story first', 'warning');
    return;
  }

  // Save to history for undo
  storyHistory.push(currentStory);

  const refinements = {
    'shorter': 'Making story more concise...',
    'longer': 'Adding more details...',
    'simpler': 'Simplifying language...',
    'risks': 'Adding risk analysis...',
    'bullish': 'Adjusting tone to bullish...',
    'cautious': 'Adjusting tone to cautious...'
  };

  showNotification(refinements[type] || 'Refining story...', 'info');

  // Simulate refinement (in real implementation, this would call AI)
  setTimeout(() => {
    let refined = currentStory;

    switch(type) {
      case 'shorter':
        // Take first 60% of sentences
        const sentences = currentStory.split('. ');
        refined = sentences.slice(0, Math.ceil(sentences.length * 0.6)).join('. ') + '.';
        break;
      case 'longer':
        refined = currentStory + '\n\nAdditional Analysis: Based on current market conditions and the company\'s strategic positioning, we see further upside potential. Key catalysts include upcoming earnings announcements and sector-wide momentum.';
        break;
      case 'risks':
        refined = currentStory + '\n\nKey Risks: Market volatility, sector rotation, regulatory changes, and macroeconomic headwinds could impact performance. Position sizing should reflect client risk tolerance.';
        break;
      case 'bullish':
        refined = currentStory.replace(/neutral/gi, 'positive').replace(/cautious/gi, 'optimistic');
        break;
      case 'cautious':
        refined = currentStory.replace(/strong/gi, 'moderate').replace(/bullish/gi, 'cautiously optimistic');
        break;
    }

    document.getElementById('outputText').innerText = refined;
    showNotification('Story refined', 'success');
  }, 1000);
}

function refineStoryCustom() {
  const instruction = document.getElementById('customRefinement').value.trim();
  if (!instruction) {
    showNotification('Enter a refinement instruction', 'warning');
    return;
  }

  const currentStory = document.getElementById('outputText').innerText;
  if (!currentStory) {
    showNotification('Generate a story first', 'warning');
    return;
  }

  storyHistory.push(currentStory);
  showNotification(`Applying: "${instruction}"...`, 'info');

  // In real implementation, this would call AI with the custom instruction
  setTimeout(() => {
    document.getElementById('outputText').innerText = currentStory + `\n\n[Custom refinement applied: ${instruction}]`;
    document.getElementById('customRefinement').value = '';
    showNotification('Custom refinement applied', 'success');
  }, 1500);
}

// ============================================================================
// EXTERNAL INTEGRATIONS (Bloomberg, Teams, Outlook)
// ============================================================================

const INTEGRATIONS = {
  bloomberg: {
    name: 'Bloomberg Terminal',
    baseUrl: 'bloomberg://',
    searchUrl: (ticker) => `https://www.bloomberg.com/quote/${ticker}:US`
  },
  teams: {
    name: 'Microsoft Teams',
    chatUrl: 'https://teams.microsoft.com/l/chat/0/0',
    callUrl: 'https://teams.microsoft.com/l/call/0/0'
  },
  outlook: {
    name: 'Outlook',
    composeUrl: 'https://outlook.office.com/mail/deeplink/compose'
  },
  gmail: {
    name: 'Gmail',
    composeUrl: 'https://mail.google.com/mail/?view=cm&fs=1'
  }
};

function openInBloomberg(ticker) {
  const url = INTEGRATIONS.bloomberg.searchUrl(ticker);
  window.open(url, '_blank');
  showNotification(`Opening ${ticker} in Bloomberg`, 'info');
}

function openTeamsChat(recipientEmail) {
  const url = recipientEmail
    ? `${INTEGRATIONS.teams.chatUrl}?users=${encodeURIComponent(recipientEmail)}`
    : INTEGRATIONS.teams.chatUrl;
  window.open(url, '_blank');
  showNotification('Opening Microsoft Teams chat', 'info');
}

function startTeamsCall(recipientEmail) {
  const url = recipientEmail
    ? `https://teams.microsoft.com/l/call/0/0?users=${encodeURIComponent(recipientEmail)}`
    : INTEGRATIONS.teams.callUrl;
  window.open(url, '_blank');
  showNotification('Starting Teams call', 'info');
}

function composeOutlookEmail(to, subject, body) {
  const params = new URLSearchParams({
    to: to || '',
    subject: subject || '',
    body: body || ''
  });
  const url = `${INTEGRATIONS.outlook.composeUrl}?${params}`;
  window.open(url, '_blank');
  showNotification('Opening Outlook compose', 'info');
}

function composeGmailEmail(to, subject, body) {
  const params = new URLSearchParams({
    to: to || '',
    su: subject || '',
    body: body || ''
  });
  const url = `${INTEGRATIONS.gmail.composeUrl}&${params}`;
  window.open(url, '_blank');
  showNotification('Opening Gmail compose', 'info');
}

function addToClientEmail() {
  const story = document.getElementById('outputText')?.innerText || '';
  const clientEmail = clientData?.profile?.email || '';
  const clientName = clientData?.profile?.name || 'Client';
  const stockTicker = window._selectedStockTicker || '';

  const subject = `Investment Update: ${stockTicker}`;
  const body = `Dear ${clientName},\n\n${story}\n\nBest regards,\nYour ODDO BHF Analyst`;

  // Show options
  showNotification('Select email client', 'info', {
    title: 'Send via',
    actions: [
      { label: 'Outlook', onclick: `composeOutlookEmail('${clientEmail}', '${subject}', '')`, primary: true },
      { label: 'Gmail', onclick: `composeGmailEmail('${clientEmail}', '${subject}', '')` }
    ]
  });
}

// ============================================================================
// EXPORT FUNCTIONS (PDF, Excel, etc.)
// ============================================================================

function exportToPDF() {
  showNotification('Generating PDF...', 'info');

  setTimeout(() => {
    // Create a simple PDF-like content
    const content = document.getElementById('outputText')?.innerText || 'No content to export';
    const title = document.getElementById('outputTitle')?.innerText || 'Investment Story';

    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>${title}</title>
        <style>
          body { font-family: 'Lato', Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
          h1 { color: #003D39; border-bottom: 2px solid #003D39; padding-bottom: 10px; }
          .content { line-height: 1.8; }
          .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; }
          @media print { body { padding: 20px; } }
        </style>
      </head>
      <body>
        <img src="/static/Oddo_BHF_logo.svg.png" alt="ODDO BHF" style="height: 40px; margin-bottom: 20px;">
        <h1>${title}</h1>
        <div class="content">${content.replace(/\n/g, '<br>')}</div>
        <div class="footer">
          Generated by ODDO BHF Sales Intelligence Platform<br>
          ${new Date().toLocaleDateString('de-DE')} | Confidential
        </div>
      </body>
      </html>
    `);
    printWindow.document.close();
    printWindow.print();

    showNotification('PDF ready - use browser print dialog', 'success');
  }, 1000);
}

function generateReport() {
  const template = document.getElementById('reportTemplate').value;
  const ticker = document.getElementById('reportStockTicker')?.value || '';
  const dateRange = document.getElementById('reportDateRange').value;
  const selectedType = document.querySelector('.report-type.selected');
  const format = selectedType ? selectedType.querySelector('.type-icon').textContent.toLowerCase() : 'pdf';

  showNotification('Generating report...', 'info');

  setTimeout(() => {
    // Generate actual content based on template
    if (format === 'pdf') {
      exportReportPDF(template, ticker, dateRange);
    } else {
      // Add to recent reports
      const list = document.getElementById('recentReportsList');
      const now = new Date();
      const dateStr = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

      list.insertAdjacentHTML('afterbegin', `
        <div class="report-item animate-in" onclick="openReport('report-${Date.now()}')">
          <div class="report-type-badge ${format}">${format.toUpperCase()}</div>
          <div class="report-info">
            <h4>${template.charAt(0).toUpperCase() + template.slice(1)} Report ${ticker ? '- ' + ticker : ''}</h4>
            <span class="report-meta">Generated ${dateStr} â€¢ Just now</span>
          </div>
          <div class="report-actions">
            <button class="btn-icon" title="Download" onclick="event.stopPropagation(); downloadReport('${format}')">â†“</button>
            <button class="btn-icon" title="Share" onclick="event.stopPropagation(); shareReport()">â†—</button>
          </div>
        </div>
      `);

      showNotification('Report generated successfully!', 'success');
    }
  }, 2000);
}

function exportReportPDF(template, ticker, dateRange) {
  const printWindow = window.open('', '_blank');
  const clientName = clientData?.profile?.name || 'Client';

  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>ODDO BHF - ${template} Report</title>
      <style>
        body { font-family: 'Lato', Arial, sans-serif; padding: 40px; max-width: 900px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #003D39; padding-bottom: 15px; margin-bottom: 30px; }
        .header img { height: 40px; }
        .header-info { text-align: right; font-size: 12px; color: #666; }
        h1 { color: #003D39; margin: 0 0 10px 0; }
        h2 { color: #003D39; border-bottom: 1px solid #ddd; padding-bottom: 8px; }
        .metric-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
        .metric-box { background: #f7f4f2; padding: 15px; border-radius: 8px; }
        .metric-label { font-size: 11px; color: #666; text-transform: uppercase; }
        .metric-value { font-size: 24px; font-weight: 700; color: #003D39; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #003D39; color: white; }
        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 10px; color: #666; }
        @media print { body { padding: 20px; } }
      </style>
    </head>
    <body>
      <div class="header">
        <img src="/static/Oddo_BHF_logo.svg.png" alt="ODDO BHF">
        <div class="header-info">
          <div>Equity Research Report</div>
          <div>${new Date().toLocaleDateString('de-DE')}</div>
        </div>
      </div>

      <h1>${ticker || 'Portfolio'} - ${template.charAt(0).toUpperCase() + template.slice(1)} Report</h1>
      <p style="color: #666;">Prepared for: ${clientName} | Period: ${dateRange}</p>

      <div class="metric-grid">
        <div class="metric-box">
          <div class="metric-label">Current Price</div>
          <div class="metric-value">â‚¬185.42</div>
        </div>
        <div class="metric-box">
          <div class="metric-label">Target Price</div>
          <div class="metric-value">â‚¬210.00</div>
        </div>
        <div class="metric-box">
          <div class="metric-label">Rating</div>
          <div class="metric-value" style="color: #10b981;">Outperform</div>
        </div>
        <div class="metric-box">
          <div class="metric-label">Upside</div>
          <div class="metric-value">+13.2%</div>
        </div>
      </div>

      <h2>Executive Summary</h2>
      <p>Based on our comprehensive analysis, we maintain our positive outlook on the investment thesis. Key drivers include strong fundamentals, favorable market positioning, and attractive valuation relative to peers.</p>

      <h2>Financial Overview</h2>
      <table>
        <tr><th>Metric</th><th>FY24A</th><th>FY25E</th><th>FY26E</th></tr>
        <tr><td>Revenue (â‚¬M)</td><td>125,400</td><td>138,200</td><td>152,100</td></tr>
        <tr><td>EBITDA (â‚¬M)</td><td>42,300</td><td>47,500</td><td>53,200</td></tr>
        <tr><td>Net Income (â‚¬M)</td><td>28,100</td><td>31,800</td><td>36,400</td></tr>
        <tr><td>EPS (â‚¬)</td><td>6.42</td><td>7.28</td><td>8.35</td></tr>
      </table>

      <h2>Investment Thesis</h2>
      <p>Our conviction is supported by: (1) Market leadership position, (2) Strong cash flow generation, (3) Attractive dividend yield, and (4) Multiple expansion potential.</p>

      <h2>Key Risks</h2>
      <p>Investors should monitor: macroeconomic headwinds, competitive pressure, regulatory changes, and currency fluctuations.</p>

      <div class="footer">
        <strong>ODDO BHF</strong> | This document is for informational purposes only and does not constitute investment advice.<br>
        Generated by ODDO BHF Sales Intelligence Platform | Confidential
      </div>
    </body>
    </html>
  `);
  printWindow.document.close();
  printWindow.print();

  showNotification('Report PDF ready', 'success');
}

function downloadReport(format) {
  showNotification(`Downloading ${format.toUpperCase()} report...`, 'info');
  // In real implementation, this would trigger actual download
}

function shareReport() {
  showNotification('Share options', 'info', {
    title: 'Share Report',
    actions: [
      { label: 'Email', onclick: 'composeOutlookEmail("", "ODDO BHF Report", "")', primary: true },
      { label: 'Teams', onclick: 'openTeamsChat("")' }
    ]
  });
}

// ============================================================================
// STOCK MONITORING CENTER FUNCTIONS
// ============================================================================

// Price alert storage
let priceAlerts = [];

function createPriceAlert() {
  const ticker = document.getElementById('alertTicker').value.toUpperCase().trim();
  const condition = document.getElementById('alertCondition').value;
  const value = document.getElementById('alertValue').value;

  if (!ticker) {
    showNotification('Please enter a ticker symbol', 'warning');
    return;
  }

  const conditionLabels = {
    'price_above': 'Price Above',
    'price_below': 'Price Below',
    'volume_spike': 'Volume Spike',
    'rsi_oversold': 'RSI Oversold',
    'rsi_overbought': 'RSI Overbought',
    'moving_avg_cross': 'MA Crossover'
  };

  const alert = {
    id: Date.now(),
    ticker,
    condition,
    value: value || 'N/A',
    created: new Date()
  };

  priceAlerts.push(alert);

  // Add visual feedback
  const alertsContainer = document.getElementById('priceAlerts');
  const newAlert = document.createElement('div');
  newAlert.className = 'alert-item info';
  newAlert.innerHTML = `
    <div class="alert-icon">+</div>
    <div class="alert-content">
      <div class="alert-title"><span class="ticker">${ticker}</span> Alert Created</div>
      <div class="alert-description">${conditionLabels[condition]}: ${value || 'Triggered'}</div>
      <div class="alert-meta">
        <span class="alert-time">
          <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          Just now
        </span>
        <div class="alert-actions">
          <button class="alert-action-btn dismiss" onclick="removeAlert(${alert.id}, this)">Remove</button>
        </div>
      </div>
    </div>
  `;

  alertsContainer.insertBefore(newAlert, alertsContainer.firstChild);

  // Clear form
  document.getElementById('alertTicker').value = '';
  document.getElementById('alertValue').value = '';

  showNotification(`Alert created for ${ticker}`, 'success');
}

function removeAlert(alertId, btn) {
  priceAlerts = priceAlerts.filter(a => a.id !== alertId);
  const alertItem = btn.closest('.alert-item');
  alertItem.style.opacity = '0';
  alertItem.style.transform = 'translateX(20px)';
  setTimeout(() => alertItem.remove(), 300);
}

function refreshWatchlist() {
  showNotification('Refreshing watchlist data...', 'info');
  const watchlistItems = document.querySelectorAll('.watchlist-stock');

  watchlistItems.forEach((item, index) => {
    setTimeout(() => {
      // Simulate price update animation
      item.style.background = 'rgba(16, 185, 129, 0.1)';
      setTimeout(() => {
        item.style.background = '';
      }, 500);
    }, index * 100);
  });

  setTimeout(() => {
    showNotification('Watchlist updated', 'success');
  }, 1000);
}

function addToWatchlist() {
  const ticker = prompt('Enter ticker symbol to add:');
  if (!ticker) return;

  const watchlistContainer = document.getElementById('watchlistMonitor');
  const newStock = document.createElement('div');
  newStock.className = 'watchlist-stock';
  newStock.innerHTML = `
    <span class="watchlist-ticker">${ticker.toUpperCase()}</span>
    <span class="watchlist-name">Loading...</span>
    <span class="watchlist-price">--</span>
    <span class="watchlist-change">--</span>
  `;

  watchlistContainer.appendChild(newStock);
  showNotification(`${ticker.toUpperCase()} added to watchlist`, 'success');

  // Simulate loading data
  setTimeout(() => {
    newStock.querySelector('.watchlist-name').textContent = ticker.toUpperCase() + ' Corp.';
    newStock.querySelector('.watchlist-price').textContent = '$' + (Math.random() * 200 + 50).toFixed(2);
    const change = (Math.random() * 4 - 2).toFixed(2);
    const changeEl = newStock.querySelector('.watchlist-change');
    changeEl.textContent = (change >= 0 ? '+' : '') + change + '%';
    changeEl.className = 'watchlist-change ' + (change >= 0 ? 'positive' : 'negative');
  }, 1000);
}

function openResearchNote(noteId) {
  showNotification(`Opening research note: ${noteId}`, 'info');
}

// ============================================================================
// RESEARCH REPORT FUNCTIONS
// ============================================================================

function updateReportSections(templateType) {
  const researchPreview = document.getElementById('researchReportPreview');
  const sectionsContainer = document.getElementById('researchSections');

  if (templateType === 'equity-research') {
    if (researchPreview) researchPreview.style.display = 'block';
    // Show equity research sections
    sectionsContainer.innerHTML = `
      <label class="checkbox-item"><input type="checkbox" checked data-section="summary"> Executive Summary</label>
      <label class="checkbox-item"><input type="checkbox" checked data-section="thesis"> Investment Thesis</label>
      <label class="checkbox-item"><input type="checkbox" checked data-section="rating"> Rating & Target Price</label>
      <label class="checkbox-item"><input type="checkbox" checked data-section="financials"> Financial Analysis</label>
      <label class="checkbox-item"><input type="checkbox" checked data-section="valuation"> Valuation (DCF, Multiples)</label>
      <label class="checkbox-item"><input type="checkbox" checked data-section="catalysts"> Catalysts & Risks</label>
      <label class="checkbox-item"><input type="checkbox" data-section="industry"> Industry Overview</label>
      <label class="checkbox-item"><input type="checkbox" data-section="peers"> Peer Comparison</label>
      <label class="checkbox-item"><input type="checkbox" checked data-section="charts"> Price Charts & Technicals</label>
    `;
  } else {
    if (researchPreview) researchPreview.style.display = 'none';
    // Show standard report sections
    sectionsContainer.innerHTML = `
      <label class="checkbox-item"><input type="checkbox" checked> Market Overview</label>
      <label class="checkbox-item"><input type="checkbox" checked> Portfolio Holdings</label>
      <label class="checkbox-item"><input type="checkbox" checked> Performance Charts</label>
      <label class="checkbox-item"><input type="checkbox" checked> Risk Metrics</label>
      <label class="checkbox-item"><input type="checkbox"> Transaction History</label>
      <label class="checkbox-item"><input type="checkbox" checked> Recommendations</label>
    `;
  }
}

// Update report preview when ticker changes
document.addEventListener('DOMContentLoaded', function() {
  const tickerInput = document.getElementById('reportStockTicker');
  if (tickerInput) {
    tickerInput.addEventListener('input', function() {
      const ticker = this.value.toUpperCase();
      const previewTicker = document.getElementById('previewTicker');
      if (previewTicker && ticker) {
        previewTicker.textContent = ticker;
      }
    });
  }
});

// ============================================================================
// ADVANCED ANALYTICS FEATURES
// ============================================================================

let efficientFrontierChart = null;
let monteCarloChart = null;
let backtestChart = null;
let whatIfChart = null;

function switchAnalytics(btn, type) {
  document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  document.querySelectorAll('.analytics-panel').forEach(p => p.classList.remove('active'));
  document.getElementById(`analytics-${type}`).classList.add('active');

  // Initialize charts when panel becomes visible
  setTimeout(() => {
    if (type === 'optimizer') initEfficientFrontierChart();
    else if (type === 'montecarlo') initMonteCarloChart();
    else if (type === 'backtest') initBacktestChart();
    else if (type === 'whatif') initWhatIfChart();
  }, 100);
}

function initEfficientFrontierChart() {
  const ctx = document.getElementById('efficientFrontierChart');
  if (!ctx) return;

  if (efficientFrontierChart) efficientFrontierChart.destroy();

  // Generate efficient frontier data
  const frontierData = [];
  const randomPortfolios = [];

  for (let i = 0; i <= 20; i++) {
    const vol = 5 + i * 1.5;
    const ret = 2 + Math.sqrt(vol) * 2.5 - 0.01 * vol;
    frontierData.push({ x: vol, y: ret });
  }

  for (let i = 0; i < 100; i++) {
    const vol = 5 + Math.random() * 30;
    const ret = Math.random() * 20 - 3;
    randomPortfolios.push({ x: vol, y: ret });
  }

  efficientFrontierChart = new Chart(ctx, {
    type: 'scatter',
    data: {
      datasets: [
        {
          label: 'Random Portfolios',
          data: randomPortfolios,
          backgroundColor: 'rgba(100, 116, 139, 0.3)',
          pointRadius: 3
        },
        {
          label: 'Efficient Frontier',
          data: frontierData,
          type: 'line',
          borderColor: '#10b981',
          borderWidth: 3,
          fill: false,
          pointRadius: 0,
          tension: 0.4
        },
        {
          label: 'Optimal Portfolio',
          data: [{ x: 8.2, y: 12.4 }],
          backgroundColor: '#f59e0b',
          pointRadius: 12,
          pointStyle: 'star'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true, position: 'bottom' }
      },
      scales: {
        x: { title: { display: true, text: 'Volatility (%)' } },
        y: { title: { display: true, text: 'Expected Return (%)' } }
      }
    }
  });
}

function runOptimization() {
  showNotification('Running portfolio optimization...', 'info');

  setTimeout(() => {
    initEfficientFrontierChart();

    // Update allocation bars with animation
    const allocations = [
      { ticker: 'AAPL', weight: Math.floor(Math.random() * 15) + 25 },
      { ticker: 'MSFT', weight: Math.floor(Math.random() * 10) + 20 },
      { ticker: 'GOOGL', weight: Math.floor(Math.random() * 10) + 15 },
      { ticker: 'AMZN', weight: 0 }
    ];
    allocations[3].weight = 100 - allocations[0].weight - allocations[1].weight - allocations[2].weight;

    const barsContainer = document.getElementById('allocationBars');
    barsContainer.innerHTML = allocations.map(a => `
      <div class="alloc-bar">
        <span class="alloc-label">${a.ticker}</span>
        <div class="alloc-track"><div class="alloc-fill" style="width: ${a.weight}%"></div></div>
        <span class="alloc-value">${a.weight}%</span>
      </div>
    `).join('');

    showNotification('Optimization complete!', 'success');
  }, 1500);
}

function initMonteCarloChart() {
  const ctx = document.getElementById('monteCarloChart');
  if (!ctx) return;

  if (monteCarloChart) monteCarloChart.destroy();

  // Generate Monte Carlo simulation paths
  const labels = [];
  const paths = [];
  const median = [];
  const p5 = [];
  const p95 = [];

  for (let year = 0; year <= 5; year++) {
    labels.push(`Year ${year}`);
  }

  // Generate 20 sample paths
  for (let p = 0; p < 20; p++) {
    const path = [100000];
    for (let y = 1; y <= 5; y++) {
      const ret = 0.08 + (Math.random() - 0.5) * 0.3;
      path.push(path[y-1] * (1 + ret));
    }
    paths.push(path);
  }

  // Calculate percentiles
  for (let y = 0; y <= 5; y++) {
    const values = paths.map(p => p[y]).sort((a, b) => a - b);
    p5.push(values[1]);
    median.push(values[10]);
    p95.push(values[18]);
  }

  const datasets = paths.slice(0, 15).map((path, i) => ({
    data: path,
    borderColor: `rgba(100, 116, 139, ${0.1 + i * 0.02})`,
    borderWidth: 1,
    fill: false,
    pointRadius: 0,
    tension: 0.3
  }));

  datasets.push(
    { label: '5th Percentile', data: p5, borderColor: '#ef4444', borderWidth: 2, borderDash: [5, 5], fill: false, pointRadius: 0 },
    { label: 'Median', data: median, borderColor: '#10b981', borderWidth: 3, fill: false, pointRadius: 0 },
    { label: '95th Percentile', data: p95, borderColor: '#3b82f6', borderWidth: 2, borderDash: [5, 5], fill: false, pointRadius: 0 }
  );

  monteCarloChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true, position: 'bottom', labels: { filter: item => item.text } }
      },
      scales: {
        y: {
          title: { display: true, text: 'Portfolio Value (â‚¬)' },
          ticks: { callback: v => 'â‚¬' + (v/1000).toFixed(0) + 'K' }
        }
      }
    }
  });
}

function runMonteCarlo() {
  showNotification('Running Monte Carlo simulation...', 'info');

  setTimeout(() => {
    initMonteCarloChart();

    // Update stats
    const initial = parseFloat(document.getElementById('mcInitialInvestment').value.replace(/[^0-9]/g, '')) || 100000;
    const years = parseInt(document.getElementById('mcTimeHorizon').value) || 5;
    const expRet = (parseFloat(document.getElementById('mcExpectedReturn').value) || 8) / 100;
    const vol = (parseFloat(document.getElementById('mcVolatility').value) || 15) / 100;

    const median = initial * Math.pow(1 + expRet, years);
    const p5 = initial * Math.pow(1 + expRet - 1.65 * vol / Math.sqrt(years), years);
    const p95 = initial * Math.pow(1 + expRet + 1.65 * vol / Math.sqrt(years), years);

    document.querySelector('.mc-stats-grid').innerHTML = `
      <div class="mc-stat-card">
        <span class="mc-stat-label">Median Outcome</span>
        <span class="mc-stat-value">â‚¬${Math.round(median).toLocaleString()}</span>
        <span class="mc-stat-change positive">+${((median/initial - 1) * 100).toFixed(1)}%</span>
      </div>
      <div class="mc-stat-card">
        <span class="mc-stat-label">5th Percentile</span>
        <span class="mc-stat-value">â‚¬${Math.round(p5).toLocaleString()}</span>
        <span class="mc-stat-change ${p5 < initial ? 'negative' : 'positive'}">${((p5/initial - 1) * 100).toFixed(1)}%</span>
      </div>
      <div class="mc-stat-card">
        <span class="mc-stat-label">95th Percentile</span>
        <span class="mc-stat-value">â‚¬${Math.round(p95).toLocaleString()}</span>
        <span class="mc-stat-change positive">+${((p95/initial - 1) * 100).toFixed(1)}%</span>
      </div>
      <div class="mc-stat-card">
        <span class="mc-stat-label">Prob. of Loss</span>
        <span class="mc-stat-value">${(100 * (1 - normCdf((expRet * years) / (vol * Math.sqrt(years))))).toFixed(1)}%</span>
      </div>
    `;

    showNotification('Simulation complete!', 'success');
  }, 2000);
}

function normCdf(x) {
  const a1 =  0.254829592;
  const a2 = -0.284496736;
  const a3 =  1.421413741;
  const a4 = -1.453152027;
  const a5 =  1.061405429;
  const p  =  0.3275911;
  const sign = x < 0 ? -1 : 1;
  x = Math.abs(x) / Math.sqrt(2);
  const t = 1.0 / (1.0 + p * x);
  const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
  return 0.5 * (1.0 + sign * y);
}

function initBacktestChart() {
  const ctx = document.getElementById('backtestChart');
  if (!ctx) return;

  if (backtestChart) backtestChart.destroy();

  const labels = [];
  const strategy = [100];
  const benchmark = [100];

  const startDate = new Date('2020-01-01');
  for (let m = 0; m <= 60; m++) {
    const date = new Date(startDate);
    date.setMonth(date.getMonth() + m);
    labels.push(date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }));

    if (m > 0) {
      // COVID crash in March 2020
      let stratRet = (Math.random() - 0.45) * 0.08;
      let benchRet = (Math.random() - 0.45) * 0.07;

      if (m >= 2 && m <= 4) {
        stratRet -= 0.15;
        benchRet -= 0.18;
      } else if (m >= 5 && m <= 12) {
        stratRet += 0.03;
        benchRet += 0.025;
      }

      strategy.push(strategy[m-1] * (1 + stratRet));
      benchmark.push(benchmark[m-1] * (1 + benchRet));
    }
  }

  backtestChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Strategy',
          data: strategy,
          borderColor: '#10b981',
          backgroundColor: 'rgba(16, 185, 129, 0.1)',
          borderWidth: 2,
          fill: true,
          tension: 0.3,
          pointRadius: 0
        },
        {
          label: 'Benchmark (S&P 500)',
          data: benchmark,
          borderColor: '#6366f1',
          borderWidth: 2,
          borderDash: [5, 5],
          fill: false,
          tension: 0.3,
          pointRadius: 0
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: true, position: 'bottom' } },
      scales: {
        y: {
          title: { display: true, text: 'Portfolio Value (indexed to 100)' }
        }
      }
    }
  });
}

function runBacktest() {
  showNotification('Running backtest...', 'info');

  setTimeout(() => {
    initBacktestChart();

    // Update metrics with some randomization
    const totalReturn = 70 + Math.random() * 40;
    const cagr = 10 + Math.random() * 6;
    const maxDD = -(15 + Math.random() * 10);
    const sharpe = 1 + Math.random() * 0.5;
    const winRate = 55 + Math.random() * 10;
    const alpha = 2 + Math.random() * 4;

    document.querySelector('.backtest-metrics-grid').innerHTML = `
      <div class="bt-metric">
        <span class="bt-metric-label">Total Return</span>
        <span class="bt-metric-value positive">+${totalReturn.toFixed(1)}%</span>
      </div>
      <div class="bt-metric">
        <span class="bt-metric-label">CAGR</span>
        <span class="bt-metric-value">${cagr.toFixed(1)}%</span>
      </div>
      <div class="bt-metric">
        <span class="bt-metric-label">Max Drawdown</span>
        <span class="bt-metric-value negative">${maxDD.toFixed(1)}%</span>
      </div>
      <div class="bt-metric">
        <span class="bt-metric-label">Sharpe Ratio</span>
        <span class="bt-metric-value">${sharpe.toFixed(2)}</span>
      </div>
      <div class="bt-metric">
        <span class="bt-metric-label">Win Rate</span>
        <span class="bt-metric-value">${winRate.toFixed(1)}%</span>
      </div>
      <div class="bt-metric">
        <span class="bt-metric-label">Alpha vs Benchmark</span>
        <span class="bt-metric-value positive">+${alpha.toFixed(1)}%</span>
      </div>
    `;

    showNotification('Backtest complete!', 'success');
  }, 2000);
}

function initWhatIfChart() {
  const ctx = document.getElementById('whatIfChart');
  if (!ctx) return;

  if (whatIfChart) whatIfChart.destroy();

  whatIfChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['AAPL', 'MSFT', 'GOOGL', 'AMZN'],
      datasets: [
        {
          label: 'Current Value',
          data: [35000, 28000, 22000, 15000],
          backgroundColor: '#10b981'
        },
        {
          label: 'Projected Value',
          data: [28350, 23240, 17600, 12360],
          backgroundColor: '#ef4444'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: true, position: 'bottom' } },
      scales: {
        y: {
          title: { display: true, text: 'Value (â‚¬)' },
          ticks: { callback: v => 'â‚¬' + (v/1000).toFixed(0) + 'K' }
        }
      }
    }
  });
}

function applyScenario(type) {
  document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('selected'));
  event.currentTarget.classList.add('selected');

  const inputs = document.getElementById('customScenarioInputs');
  if (type === 'custom') {
    inputs.style.display = 'block';
  } else {
    inputs.style.display = 'none';

    // Apply preset values
    const presets = {
      recession: { market: -30, rate: -200, fx: 5, oil: -40 },
      inflation: { market: -10, rate: 200, fx: -8, oil: 30 },
      boom: { market: 40, rate: 50, fx: -3, oil: 15 }
    };

    const preset = presets[type];
    if (preset) {
      document.getElementById('wiMarketReturn').value = preset.market;
      document.getElementById('wiRateChange').value = preset.rate;
      document.getElementById('wiFxChange').value = preset.fx;
      document.getElementById('wiOilChange').value = preset.oil;
    }
  }

  showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} scenario selected`, 'info');
}

function runWhatIf() {
  showNotification('Analyzing portfolio impact...', 'info');

  const marketReturn = parseFloat(document.getElementById('wiMarketReturn').value) || 0;

  setTimeout(() => {
    initWhatIfChart();

    // Update impact summary
    const currentValue = 100000;
    const impact = currentValue * (marketReturn / 100);
    const impactPercent = marketReturn;

    document.getElementById('impactSummary').innerHTML = `
      <div class="impact-card ${impact >= 0 ? 'positive' : 'negative'}">
        <span class="impact-label">Portfolio Value Impact</span>
        <span class="impact-value">${impact >= 0 ? '+' : ''}â‚¬${Math.abs(impact).toLocaleString()}</span>
        <span class="impact-percent">${impact >= 0 ? '+' : ''}${impactPercent.toFixed(1)}%</span>
      </div>
    `;

    // Update position impacts
    const positions = [
      { ticker: 'AAPL', current: 35000, beta: 1.2 },
      { ticker: 'MSFT', current: 28000, beta: 1.1 },
      { ticker: 'GOOGL', current: 22000, beta: 1.3 },
      { ticker: 'AMZN', current: 15000, beta: 1.15 }
    ];

    document.querySelector('.impact-table').innerHTML = `
      <div class="impact-row header">
        <span>Ticker</span>
        <span>Current</span>
        <span>Projected</span>
        <span>Change</span>
      </div>
      ${positions.map(p => {
        const change = marketReturn * p.beta;
        const projected = p.current * (1 + change / 100);
        return `
          <div class="impact-row">
            <span class="ticker">${p.ticker}</span>
            <span>â‚¬${p.current.toLocaleString()}</span>
            <span>â‚¬${Math.round(projected).toLocaleString()}</span>
            <span class="${change >= 0 ? 'positive' : 'negative'}">${change >= 0 ? '+' : ''}${change.toFixed(1)}%</span>
          </div>
        `;
      }).join('')}
    `;

    // Update chart
    whatIfChart.data.datasets[1].data = positions.map(p => Math.round(p.current * (1 + marketReturn * p.beta / 100)));
    whatIfChart.update();

    showNotification('Impact analysis complete!', 'success');
  }, 1500);
}

function removeAsset(btn, ticker) {
  btn.parentElement.remove();
  showNotification(`${ticker} removed from portfolio`, 'info');
}

function handleAssetAdd(event) {
  if (event.key === 'Enter') {
    const input = event.target;
    const ticker = input.value.trim().toUpperCase();
    if (!ticker) return;

    const container = document.getElementById('assetTagsContainer');
    const tag = document.createElement('span');
    tag.className = 'asset-tag';
    tag.innerHTML = `${ticker} <button onclick="removeAsset(this, '${ticker}')">Ã—</button>`;
    container.appendChild(tag);
    input.value = '';
    showNotification(`${ticker} added`, 'success');
  }
}

function updateRiskLabel(value) {
  const labels = ['Very Conservative', 'Conservative', 'Moderately Conservative', 'Moderate', 'Balanced', 'Moderately Aggressive', 'Growth', 'Aggressive', 'Very Aggressive', 'Maximum Growth'];
  document.getElementById('riskLabel').textContent = `${value} - ${labels[value - 1]}`;
}

// ============================================================================
// STRATEGY BUILDER
// ============================================================================

function selectUniverse(el, type) {
  document.querySelectorAll('.universe-option').forEach(o => o.classList.remove('selected'));
  el.classList.add('selected');
  showNotification(`Universe: ${type} selected`, 'info');
}

function saveStrategyDraft() {
  const thesis = document.getElementById('investmentThesis').value;
  if (!thesis) {
    showNotification('Please enter an investment thesis first', 'warning');
    return;
  }
  localStorage.setItem('strategyDraft', JSON.stringify({
    thesis,
    entrySignal: document.getElementById('entrySignal').value,
    exitStrategy: document.getElementById('exitStrategy').value,
    positionSizing: document.getElementById('positionSizing').value,
    timestamp: new Date().toISOString()
  }));
  showNotification('Strategy draft saved', 'success');
}

function generateStrategy() {
  const thesis = document.getElementById('investmentThesis').value;
  if (!thesis) {
    showNotification('Please enter an investment thesis', 'warning');
    return;
  }

  const entrySignal = document.getElementById('entrySignal').value;
  const exitStrategy = document.getElementById('exitStrategy').value;
  const positionSizing = document.getElementById('positionSizing').value;
  const maxDrawdown = document.getElementById('maxDrawdown').value;
  const stopLoss = document.getElementById('stopLoss').value;
  const takeProfit = document.getElementById('takeProfit').value;

  showNotification('Generating strategy...', 'info');

  // Simulate generation
  setTimeout(() => {
    document.getElementById('strategyOutput').innerHTML = `
      <div class="strategy-result animate-in">
        <div class="result-section">
          <h4>Investment Thesis Analysis</h4>
          <p style="color: var(--text-muted); font-size: 14px; line-height: 1.6; margin-bottom: 16px;">${thesis}</p>
        </div>

        <div class="result-section">
          <h4>Generated Trading Rules</h4>
          <div class="rule-list" style="margin-top: 12px;">
            <div class="rule-item" style="padding: 12px; background: var(--soft-greige); border-radius: 8px; margin-bottom: 8px; font-size: 13px;">
              <strong>Entry:</strong> ${getEntryDescription(entrySignal)}
            </div>
            <div class="rule-item" style="padding: 12px; background: var(--soft-greige); border-radius: 8px; margin-bottom: 8px; font-size: 13px;">
              <strong>Exit:</strong> ${getExitDescription(exitStrategy)} | Stop Loss: ${stopLoss}% | Take Profit: ${takeProfit}%
            </div>
            <div class="rule-item" style="padding: 12px; background: var(--soft-greige); border-radius: 8px; margin-bottom: 8px; font-size: 13px;">
              <strong>Position Sizing:</strong> ${getSizingDescription(positionSizing)} | Max Drawdown: ${maxDrawdown}%
            </div>
          </div>
        </div>

        <div class="result-section">
          <h4>Recommended Stocks</h4>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 12px;">
            <div style="padding: 12px; background: var(--soft-greige); border-radius: 8px; text-align: center;">
              <strong style="display: block; font-size: 15px;">LVMH.PA</strong>
              <span style="font-size: 12px; color: var(--text-muted);">Luxury â€¢ High conviction</span>
            </div>
            <div style="padding: 12px; background: var(--soft-greige); border-radius: 8px; text-align: center;">
              <strong style="display: block; font-size: 15px;">MC.PA</strong>
              <span style="font-size: 12px; color: var(--text-muted);">Luxury â€¢ Medium conviction</span>
            </div>
            <div style="padding: 12px; background: var(--soft-greige); border-radius: 8px; text-align: center;">
              <strong style="display: block; font-size: 15px;">RMS.PA</strong>
              <span style="font-size: 12px; color: var(--text-muted);">Luxury â€¢ Medium conviction</span>
            </div>
          </div>
        </div>
      </div>
    `;

    // Show backtest preview
    document.getElementById('quickBacktestPreview').style.display = 'block';
    document.getElementById('previewReturn').textContent = '+34.2%';
    document.getElementById('previewSharpe').textContent = '1.45';
    document.getElementById('previewDrawdown').textContent = '-12.8%';
    document.getElementById('previewWinRate').textContent = '62%';

    initStrategyPreviewChart();
    showNotification('Strategy generated successfully', 'success');
  }, 1500);
}

function getEntryDescription(signal) {
  const descriptions = {
    momentum: 'Buy when price breaks above 20-day high with volume confirmation',
    meanrev: 'Buy when RSI drops below 30 and price is 2 std dev below 50-day MA',
    value: 'Buy when P/E drops below sector median and quality score > 7',
    earnings: 'Buy on positive earnings surprise > 5% with upward guidance',
    technical: 'Buy on golden cross (50-day MA crosses above 200-day MA)',
    custom: 'Custom entry rules defined by user'
  };
  return descriptions[signal] || signal;
}

function getExitDescription(strategy) {
  const descriptions = {
    trailing: 'Exit with 15% trailing stop from peak',
    target: 'Exit at predefined price target (2x risk)',
    time: 'Exit after 90 days holding period',
    signal: 'Exit when entry conditions reverse',
    combo: 'Exit on 15% trailing stop OR 30% profit target'
  };
  return descriptions[strategy] || strategy;
}

function getSizingDescription(sizing) {
  const descriptions = {
    equal: 'Equal weight across all positions',
    conviction: 'Higher allocation to higher conviction picks',
    volatility: 'Inverse volatility weighting (lower vol = higher weight)',
    kelly: 'Kelly criterion based on win rate and payoff ratio'
  };
  return descriptions[sizing] || sizing;
}

let strategyPreviewChart = null;

function initStrategyPreviewChart() {
  const ctx = document.getElementById('strategyPreviewChart');
  if (!ctx) return;

  if (strategyPreviewChart) strategyPreviewChart.destroy();

  const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  const strategyData = [100, 104, 108, 105, 112, 118, 115, 122, 128, 125, 132, 134];
  const benchmarkData = [100, 102, 105, 103, 107, 110, 108, 112, 115, 113, 118, 120];

  strategyPreviewChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Strategy',
          data: strategyData,
          borderColor: '#003D39',
          backgroundColor: 'rgba(0, 61, 57, 0.1)',
          borderWidth: 2,
          fill: true,
          tension: 0.3,
          pointRadius: 0
        },
        {
          label: 'Benchmark',
          data: benchmarkData,
          borderColor: '#9ca3af',
          borderWidth: 1.5,
          borderDash: [4, 4],
          fill: false,
          tension: 0.3,
          pointRadius: 0
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: true, position: 'bottom' } },
      scales: {
        y: { display: true, grid: { display: false } },
        x: { display: true, grid: { display: false } }
      }
    }
  });
}

function runStrategyBacktest() {
  switchAnalytics(document.querySelector('[onclick*="backtest"]'), 'backtest');
  setTimeout(runBacktest, 300);
}

function exportStrategyPDF() {
  showNotification('Generating PDF report...', 'info');
  setTimeout(() => {
    showNotification('PDF export ready for download', 'success');
  }, 2000);
}

// ============================================================================
// CLIENT FIT ANALYSIS
// ============================================================================

function analyzeClientFit() {
  const strategy = document.getElementById('cfStrategy').value;
  if (!strategy) {
    showNotification('Please select a strategy to analyze', 'warning');
    return;
  }

  if (!clientData) {
    showNotification('Please select a client first', 'warning');
    return;
  }

  showNotification('Analyzing client fit...', 'info');

  setTimeout(() => {
    // Calculate fit score (simplified)
    const fitScore = Math.floor(70 + Math.random() * 25);

    // Update score circle
    const circle = document.getElementById('scoreCircleFill');
    const dashOffset = 283 - (283 * fitScore / 100);
    circle.style.strokeDashoffset = dashOffset;

    document.getElementById('fitScoreValue').textContent = fitScore + '%';

    // Update summary
    let summaryText = '';
    if (fitScore >= 85) {
      summaryText = 'Excellent fit. This strategy aligns very well with the client\'s risk profile, investment horizon, and stated preferences.';
    } else if (fitScore >= 70) {
      summaryText = 'Good fit with minor adjustments recommended. The strategy generally matches client needs but some parameters could be optimized.';
    } else {
      summaryText = 'Moderate fit. Consider adjusting the strategy or discussing alternative approaches with the client.';
    }
    document.getElementById('fitSummary').innerHTML = `<p>${summaryText}</p>`;

    // Update breakdown
    const breakdowns = [
      { label: 'Risk Alignment', score: Math.floor(60 + Math.random() * 35) },
      { label: 'Return Expectations', score: Math.floor(65 + Math.random() * 30) },
      { label: 'Sector Preferences', score: Math.floor(55 + Math.random() * 40) },
      { label: 'ESG Compliance', score: Math.floor(70 + Math.random() * 25) },
      { label: 'Liquidity Match', score: Math.floor(75 + Math.random() * 20) }
    ];

    document.getElementById('fitBreakdown').innerHTML = breakdowns.map(b => `
      <div class="breakdown-item">
        <span class="breakdown-label">${b.label}</span>
        <div class="breakdown-bar"><div class="bar-fill" style="width: ${b.score}%"></div></div>
        <span class="breakdown-score">${b.score}%</span>
      </div>
    `).join('');

    // Update recommendations
    const recommendations = [];
    if (breakdowns[0].score < 75) {
      recommendations.push({ type: 'warning', text: 'Consider reducing position sizes to better match client risk tolerance' });
    }
    if (breakdowns[2].score < 70) {
      recommendations.push({ type: 'warning', text: 'Strategy has exposure to sectors client has expressed concerns about' });
    }
    if (breakdowns[3].score >= 85) {
      recommendations.push({ type: 'success', text: 'ESG requirements are fully met by this strategy' });
    }
    recommendations.push({ type: 'success', text: `Overall fit score of ${fitScore}% indicates a ${fitScore >= 75 ? 'strong' : 'reasonable'} match` });

    document.getElementById('fitRecommendations').innerHTML = `
      <h4>Recommendations</h4>
      <div class="recommendations-list">
        ${recommendations.map(r => `
          <div class="recommendation-item">
            <span class="rec-icon ${r.type}">${r.type === 'success' ? 'âœ“' : '!'}</span>
            <span class="rec-text">${r.text}</span>
          </div>
        `).join('')}
      </div>
    `;

    showNotification('Fit analysis complete', 'success');
  }, 1500);
}

// Update client context when client changes
function updateClientContext() {
  const badge = document.getElementById('analyticsClientBadge');
  const profileCard = document.getElementById('clientProfileCard');

  if (clientData && clientData.profile) {
    badge.textContent = clientData.profile.name;

    // Update profile card
    const initials = clientData.profile.name.split(' ').map(n => n[0]).join('').slice(0, 2);
    document.getElementById('cfClientAvatar').textContent = initials;
    document.getElementById('cfClientName').textContent = clientData.profile.name;
    document.getElementById('cfClientType').textContent = clientData.profile.investor_type || 'Institutional';

    // Set risk profile
    const riskScore = clientData.profile.risk_score || 6;
    document.getElementById('cfRiskBar').style.width = (riskScore * 10) + '%';
    document.getElementById('cfRiskScore').textContent = `${riskScore}/10`;
  }
}

// ============================================================================
// ENHANCED BACKTEST
// ============================================================================

function exportBacktestPDF() {
  showNotification('Generating backtest PDF report...', 'info');
  setTimeout(() => {
    showNotification('PDF ready for download', 'success');
  }, 2000);
}

function shareBacktest() {
  showNotification('Creating shareable link...', 'info');
  setTimeout(() => {
    navigator.clipboard.writeText('https://app.oddo-bhf.com/backtest/shared/' + Date.now());
    showNotification('Share link copied to clipboard', 'success');
  }, 1000);
}

// Override switchAnalytics to handle new panels
function switchAnalytics(btn, type) {
  document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  document.querySelectorAll('.analytics-panel').forEach(p => p.classList.remove('active'));
  const panel = document.getElementById(`analytics-${type}`);
  if (panel) {
    panel.classList.add('active');
  }

  // Initialize charts when panel becomes visible
  setTimeout(() => {
    if (type === 'optimizer') initEfficientFrontierChart();
    else if (type === 'backtest') initBacktestChart();
    else if (type === 'strategy') initStrategyPreviewChart();
  }, 100);
}

// ============================================================================
// AI PORTFOLIO ADVISOR
// ============================================================================

const ODDO_RESEARCH = {
  'AAPL': { rating: 'Outperform', target: 210, analyst: 'M. Schmidt', date: '2026-01-15', confidence: 0.85 },
  'MSFT': { rating: 'Outperform', target: 450, analyst: 'S. Weber', date: '2026-01-10', confidence: 0.82 },
  'LVMH.PA': { rating: 'Neutral', target: 780, analyst: 'P. Dubois', date: '2026-01-12', confidence: 0.75 },
  'MC.PA': { rating: 'Outperform', target: 420, analyst: 'P. Dubois', date: '2026-01-08', confidence: 0.78 },
  'SAP.DE': { rating: 'Outperform', target: 195, analyst: 'K. MÃ¼ller', date: '2026-01-14', confidence: 0.80 },
  'ASML.AS': { rating: 'Outperform', target: 780, analyst: 'T. van Berg', date: '2026-01-11', confidence: 0.88 },
  'AIR.PA': { rating: 'Neutral', target: 155, analyst: 'J. Laurent', date: '2026-01-09', confidence: 0.72 }
};

const STRATEGIES = [
  { name: 'Momentum', description: 'Trend-following based on price momentum', type: 'quantitative' },
  { name: 'Mean Reversion', description: 'Buy oversold, sell overbought', type: 'quantitative' },
  { name: 'Value Factor', description: 'Low P/E and P/B stocks', type: 'fundamental' },
  { name: 'Quality Growth', description: 'High ROE with stable growth', type: 'fundamental' },
  { name: 'Dividend Income', description: 'High and stable dividend yield', type: 'income' },
  { name: 'Low Volatility', description: 'Minimize portfolio variance', type: 'risk' },
  { name: 'ESG Leaders', description: 'Top ESG rated companies', type: 'thematic' },
  { name: 'ODDO Conviction', description: 'Analyst high-conviction picks', type: 'research' },
  { name: 'Sector Rotation', description: 'Rotate based on cycle', type: 'tactical' },
  { name: 'Risk Parity', description: 'Equal risk contribution', type: 'risk' },
  { name: 'Multi-Factor', description: 'Combined factor exposure', type: 'quantitative' },
  { name: 'Contrarian', description: 'Against consensus bets', type: 'behavioral' }
];

function refreshAdvisorAnalysis() {
  if (!clientData) {
    showNotification('Please select a client first', 'warning');
    return;
  }
  runPortfolioAnalysis();
}

function runPortfolioAnalysis() {
  if (!clientData) {
    showNotification('Please select a client first', 'warning');
    return;
  }

  showNotification('Running comprehensive portfolio analysis...', 'info');

  // Update advisor client badge
  document.getElementById('advisorClientName').textContent = clientData.profile?.name || 'Unknown';

  // Show loading state
  document.getElementById('aiRecommendations').innerHTML = `
    <div class="loading-state" style="text-align: center; padding: 40px;">
      <div class="spinner" style="margin: 0 auto 16px;"></div>
      <p style="color: var(--text-muted);">Analyzing portfolio across 12 strategies...</p>
    </div>
  `;

  setTimeout(() => {
    // Run strategy backtests
    runMultiStrategyBacktest();

    // Generate recommendations
    generateAIRecommendations();

    // Update governance sources
    updateGovernanceSources();

  }, 2000);
}

function runMultiStrategyBacktest() {
  const section = document.getElementById('strategyBacktestSection');
  section.style.display = 'block';

  const results = STRATEGIES.map(strategy => ({
    ...strategy,
    return: (Math.random() * 30 - 5).toFixed(1),
    sharpe: (Math.random() * 1.5 + 0.3).toFixed(2),
    maxDD: (-(Math.random() * 20 + 5)).toFixed(1),
    winRate: (50 + Math.random() * 20).toFixed(0)
  }));

  // Sort by return
  results.sort((a, b) => parseFloat(b.return) - parseFloat(a.return));

  document.getElementById('strategyResultsGrid').innerHTML = results.map((r, i) => `
    <div class="strategy-result-card ${i === 0 ? 'best' : ''}" onclick="selectStrategy('${r.name}')">
      ${i === 0 ? '<span style="position: absolute; top: 8px; right: 8px; background: var(--primary); color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">BEST</span>' : ''}
      <div class="strategy-name">${r.name}</div>
      <div class="strategy-metrics">
        <div class="strategy-metric">
          <span class="label">Return</span>
          <span class="value ${parseFloat(r.return) >= 0 ? 'positive' : 'negative'}">${parseFloat(r.return) >= 0 ? '+' : ''}${r.return}%</span>
        </div>
        <div class="strategy-metric">
          <span class="label">Sharpe</span>
          <span class="value">${r.sharpe}</span>
        </div>
        <div class="strategy-metric">
          <span class="label">Max DD</span>
          <span class="value negative">${r.maxDD}%</span>
        </div>
        <div class="strategy-metric">
          <span class="label">Win Rate</span>
          <span class="value">${r.winRate}%</span>
        </div>
      </div>
    </div>
  `).join('');
}

function generateAIRecommendations() {
  document.getElementById('aiConfidence').textContent = '87%';

  const recommendations = [
    {
      action: 'buy',
      ticker: 'ASML.AS',
      name: 'ASML Holding NV',
      reasoning: 'Strong momentum confirmed by ODDO research (Outperform, PT â‚¬780). Semiconductor demand cycle supports growth thesis.',
      sources: ['ODDO Research', 'Momentum Strategy', 'Sector Analysis'],
      targetWeight: '8%',
      expectedReturn: '+18.5%',
      riskScore: '7.2/10'
    },
    {
      action: 'buy',
      ticker: 'SAP.DE',
      name: 'SAP SE',
      reasoning: 'Cloud transition accelerating. Quality Growth strategy signals entry. ODDO rates Outperform with â‚¬195 target.',
      sources: ['ODDO Research', 'Quality Growth', 'Cloud Thematic'],
      targetWeight: '6%',
      expectedReturn: '+14.2%',
      riskScore: '5.8/10'
    },
    {
      action: 'hold',
      ticker: 'LVMH.PA',
      name: 'LVMH',
      reasoning: 'Current position sized appropriately. ODDO Neutral rating suggests limited near-term upside. China recovery key catalyst to watch.',
      sources: ['ODDO Research', 'Valuation Model'],
      targetWeight: '15%',
      expectedReturn: '+5.8%',
      riskScore: '6.1/10'
    },
    {
      action: 'sell',
      ticker: 'XYZ',
      name: 'Underperformer Corp',
      reasoning: 'Mean reversion signal triggered. Position has underperformed for 6 months. Risk-adjusted return below threshold.',
      sources: ['Mean Reversion', 'Risk Model', 'Performance Attribution'],
      targetWeight: '0%',
      expectedReturn: '-',
      riskScore: '8.5/10'
    }
  ];

  document.getElementById('aiRecommendations').innerHTML = `
    <div class="recommendations-summary" style="margin-bottom: 20px;">
      <div style="display: flex; gap: 20px; justify-content: center;">
        <div style="text-align: center;">
          <span style="font-size: 24px; font-weight: 700; color: #16a34a;">2</span>
          <span style="display: block; font-size: 11px; color: var(--text-muted);">BUY</span>
        </div>
        <div style="text-align: center;">
          <span style="font-size: 24px; font-weight: 700; color: #d97706;">1</span>
          <span style="display: block; font-size: 11px; color: var(--text-muted);">HOLD</span>
        </div>
        <div style="text-align: center;">
          <span style="font-size: 24px; font-weight: 700; color: #dc2626;">1</span>
          <span style="display: block; font-size: 11px; color: var(--text-muted);">SELL</span>
        </div>
      </div>
    </div>
    <div style="font-size: 13px; color: var(--text-muted); text-align: center; margin-bottom: 16px;">
      Expected portfolio improvement: <strong style="color: var(--primary);">+4.2% annually</strong>
    </div>
    <button class="btn-primary full-width" onclick="showDetailedRecommendations()">View Detailed Recommendations</button>
  `;

  // Store for detail view
  window.aiRecommendations = recommendations;
}

function showDetailedRecommendations() {
  const section = document.getElementById('detailedRecommendations');
  section.style.display = 'block';

  const recommendations = window.aiRecommendations || [];

  document.getElementById('recommendationsDetailGrid').innerHTML = recommendations.map(rec => `
    <div class="recommendation-detail-card">
      <div class="rec-action">
        <span class="rec-action-label ${rec.action}">${rec.action.toUpperCase()}</span>
      </div>
      <div class="rec-stock-info">
        <h4>${rec.ticker} - ${rec.name}</h4>
        <p class="rec-reasoning">
          ${rec.reasoning}
          ${rec.sources.map(s => `<span class="source-tag">${s}</span>`).join('')}
        </p>
      </div>
      <div class="rec-metrics">
        <div class="rec-metric">
          <span class="label">Target Weight</span>
          <span class="value">${rec.targetWeight}</span>
        </div>
        <div class="rec-metric">
          <span class="label">Expected Return</span>
          <span class="value">${rec.expectedReturn}</span>
        </div>
        <div class="rec-metric">
          <span class="label">Risk Score</span>
          <span class="value">${rec.riskScore}</span>
        </div>
      </div>
    </div>
  `).join('');

  section.scrollIntoView({ behavior: 'smooth' });
}

function updateGovernanceSources() {
  // Update ODDO Research sources
  document.getElementById('odooResearchSources').innerHTML = Object.entries(ODDO_RESEARCH)
    .slice(0, 4)
    .map(([ticker, data]) => `
      <span class="source-item">${ticker}: ${data.rating} (${data.analyst}, ${data.date})</span>
    `).join('');

  // Update algorithm sources based on what was used
  document.getElementById('algorithmSources').innerHTML = STRATEGIES.slice(0, 5).map(s => `
    <span class="source-item">${s.name}</span>
  `).join('');
}

function selectStrategy(strategyName) {
  showNotification(`Strategy "${strategyName}" selected for detailed analysis`, 'info');
}

function showFullMethodology() {
  alert(`AI Portfolio Advisor Methodology

1. DATA COLLECTION
   - Real-time market data from Yahoo Finance
   - ODDO BHF analyst ratings and price targets
   - Historical price data (5 years)
   - Client risk profile and preferences

2. MULTI-STRATEGY BACKTESTING
   - 12 strategies tested on current portfolio
   - Walk-forward optimization (2020-2025)
   - Transaction costs included (0.1% + slippage)

3. RECOMMENDATION ENGINE
   - Combines top-performing strategy signals
   - Weighted by ODDO Research confidence
   - Filtered by client risk tolerance
   - ESG constraints applied if required

4. GOVERNANCE
   - All data sources documented
   - Confidence scores provided
   - Full audit trail maintained`);
}

function exportRecommendationsPDF() {
  showNotification('Generating PDF report with full governance...', 'info');
  setTimeout(() => {
    showNotification('PDF ready for download', 'success');
  }, 2000);
}

function sendToClient() {
  if (!clientData) {
    showNotification('No client selected', 'warning');
    return;
  }
  showNotification(`Preparing recommendations for ${clientData.profile?.name}...`, 'info');
  setTimeout(() => {
    showNotification('Email draft created with recommendations', 'success');
  }, 1500);
}

// Enhanced Story Functions
function addToClientEmail() {
  showNotification('Adding story to email draft...', 'info');
  setTimeout(() => {
    showNotification('Story added to client email draft', 'success');
  }, 1000);
}

function scheduleFollowUp() {
  showNotification('Opening follow-up scheduler...', 'info');
}

function exportToPDF() {
  showNotification('Generating story PDF...', 'info');
  setTimeout(() => {
    showNotification('PDF ready for download', 'success');
  }, 1500);
}

function regenerateStory() {
  showNotification('Regenerating story with new parameters...', 'info');
}

// Initialize on DOMContentLoaded
document.addEventListener('DOMContentLoaded', () => {
  // Analytics tab
  const analyticsTab = document.querySelector('[data-tab="analytics"]');
  if (analyticsTab) {
    analyticsTab.addEventListener('click', () => {
      setTimeout(() => {
        initStrategyPreviewChart();
        updateClientContext();
      }, 200);
    });
  }

  // AI Advisor tab
  const advisorTab = document.querySelector('[data-tab="advisor"]');
  if (advisorTab) {
    advisorTab.addEventListener('click', () => {
      setTimeout(() => {
        if (clientData) {
          document.getElementById('advisorClientName').textContent = clientData.profile?.name || 'Select a client';
        }
      }, 200);
    });
  }
});

</script>
</body>
</html>
